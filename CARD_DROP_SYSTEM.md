# Система шансів дропа карт

## Огляд

Збалансована система дропу карт з урахуванням рідкості, стихій, стартового пулу та pity-системою (анти-невезіння).

## Базові шанси за рідкістю

Шанси для одного слоту дропа (одна карта):

| Рідкість | Позначення | Шанс |
|----------|-----------|------|
| Звичайна | R1 | 55% |
| Незвичайна | R2 | 25% |
| Рідкісна | R3 | 12% |
| Епічна | R4 | 6% |
| Легендарна | R5 | 1.5% |
| Міфічна | R6 | 0.5% |

**Разом:** 100%

## Шанс дропа стихій

За замовчуванням — рівний розподіл між стихіями:

| Стихія | Шанс |
|--------|------|
| Вогонь (fire) | 25% |
| Вода (water) | 25% |
| Повітря (air) | 25% |
| Земля (earth) | 25% |

## Розрахунок шансу конкретної карти

```
P(карта) = P(рідкість) × P(стихія) × P(карта в пулі)
```

### Приклад:
- Рідкісна карта (12%)
- Вогонь (25%)
- 10 рідкісних карт вогню в базі

```
0.12 × 0.25 × (1 / 10) = 0.003 = 0.3%
```

## Стартовий пул (16 карт)

**Важливо:** Стартові карти випадають **окремо** від основного пулу.

### Правила:
- 16 стартових карт (S01-S16)
- Випадають тільки:
  - З tutorial-паків
  - З перших N боїв (поки не зібрано всі 16)
  - З "навчальних" нагород
  
### Шанс в стартовому пулі:
- Кожна карта: **6.25%** (16 × 6.25% = 100%)

### Після отримання всіх 16 стартових:
- Стартовий пул вимикається автоматично
- Гравець переходить на основну систему дропа

## Pity-система (Анти-невезіння)

Гарантує дроп рідкісних карт після певної кількості спроб без них:

| Рідкість | Гарантія після N дропів |
|----------|------------------------|
| Легендарна (R5) | 40 дропів |
| Міфічна (R6) | 120 дропів |

### Логіка:
```javascript
if (noLegendaryDrops >= 40) {
  forceDrop("legendary");
}

if (noMythicDrops >= 120) {
  forceDrop("mythic");
}
```

### Скидання лічильників:
- Дроп міфічної карти → скидає обидва лічильники
- Дроп легендарної карти → скидає лише лічильник легендарних
- Інші карти → збільшують обидва лічильники на +1

## Шанси дропа за результатами дуелі

| Результат | Шанс дропа карти |
|-----------|-----------------|
| Перемога (win) | 35% |
| Поразка (lose) | 10% |
| Нічия (draw) | 20% |

## Конфігурація (JSON)

```json
{
  "rarity_drop_rates": {
    "R1": 55,
    "R2": 25,
    "R3": 12,
    "R4": 6,
    "R5": 1.5,
    "R6": 0.5
  },
  "element_drop_rates": {
    "fire": 25,
    "water": 25,
    "air": 25,
    "earth": 25
  },
  "starter_pool": {
    "enabled_until_complete": true,
    "total_cards": 16,
    "chance_per_card": 6.25
  },
  "pity_system": {
    "legendary_guarantee_after": 40,
    "mythic_guarantee_after": 120
  }
}
```

## Імплементація

### Файли:
- **`js/game/drop.js`** — система дропу
- **`index.html`** — інтеграція з нагородами після дуелі

### Основні функції:

#### `dropCard(profile, allCards, starterCards, pityCounters)`
Дропає одну карту з урахуванням:
- Стартового пулу (якщо не зібрано всі 16)
- Рідкості (за шансами)
- Стихії (за шансами)
- Pity-системи

**Повертає:**
```javascript
{
  card: {id, rarity, element, ...},
  fromStarterPool: boolean,
  pityCounters: {noLegendary: N, noMythic: N}
}
```

#### `dropCards(profile, allCards, starterCards, count, pityCounters)`
Дропає кілька карт підряд.

**Повертає:**
```javascript
{
  cards: [...],
  pityCounters: {noLegendary: N, noMythic: N}
}
```

#### `shouldDrop(result)`
Визначає, чи має відбутися дроп за результатом дуелі.

**Приклад:**
```javascript
if (dropSystem.shouldDrop('win')) {
  // Виконати дроп
}
```

#### `getDropChance(result)`
Повертає шанс дропа (0-1) для результату дуелі.

## Приклад використання

```javascript
// У функції нагород після дуелі
if (result === 'win' && window.dropSystem.shouldDrop('win')) {
  profile.pityCounters = profile.pityCounters || { noLegendary: 0, noMythic: 0 };
  
  const dropResult = window.dropSystem.dropCard(
    profile,
    window.ALL_CARDS,
    window.STARTER_CARDS,
    profile.pityCounters
  );
  
  if (dropResult.card) {
    const card = dropResult.card;
    
    // Оновити pity лічильники
    profile.pityCounters = dropResult.pityCounters;
    
    // Додати карту в колекцію
    profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;
    
    // Показати повідомлення
    const rarityNames = {
      R1: 'звичайна', R2: 'незвичайна', R3: 'рідкісна',
      R4: 'епічна', R5: 'легендарна', R6: 'міфічна'
    };
    console.log(`Дроп: ${rarityNames[card.rarity]} карта ${card.id}`);
  }
}
```

## Збереження стану

Pity-лічильники зберігаються в профілі гравця:

```javascript
profile.pityCounters = {
  noLegendary: 15,  // Дропів без легендарної
  noMythic: 45      // Дропів без міфічної
}
```

## Майбутні розширення

### Фракційні паки
Можна додати паки з підвищеним шансом конкретної стихії:

```javascript
{
  "element_drop_rates": {
    "fire": 60,   // Підвищений шанс
    "water": 15,
    "air": 15,
    "earth": 10
  }
}
```

### Сезонні події
Тимчасово змінювати шанси для івентів:

```javascript
// Івент "Легендарний тиждень"
DROP_CONFIG.rarity_drop_rates.R5 = 5; // з 1.5% до 5%
```

## Баланс

Система розроблена для:
- ✅ Чесності до гравця
- ✅ Відчуття прогресії
- ✅ Реальних шансів на рідкісні карти
- ✅ Захисту від невезіння (pity)
- ✅ Розділення нових і досвідчених гравців (стартовий пул)

**Середній час до легендарної:** ~30-40 перемог  
**Середній час до міфічної:** ~100-120 перемог
