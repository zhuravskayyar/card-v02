<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steampunk Menu</title>
  <!-- Fonts: Steampunk Pack A (Titles/Numbers: Cinzel, UI: Libre Baskerville) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;600;700&family=Libre+Baskerville:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/steampunk-cards.css">
  <link rel="stylesheet" href="css/styles.css">
  <style>
    /* –ö–æ–ª–ª–µ–∫—Ü—ñ—è: –≥—Ä–∏–¥ –∫–∞—Ä—Ç */
    .collection-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr) !important;
      gap: 10px;
      margin-top: 10px;
    }
    .collection-card-item {
      background: rgba(50,30,20,0.4);
      border: 1.5px solid rgba(242,208,122,0.15);
      border-radius: 8px;
      padding: 10px 6px;
      text-align: center;
      transition: all 0.2s;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .collection-card-item.found {
      background: linear-gradient(180deg, rgba(242,208,122,0.12), rgba(0,0,0,0.18));
      border-color: #8bc34a;
      color: var(--brass-0);
    }
    .collection-card-item.not-found {
      background: linear-gradient(180deg, #222 60%, #111 100%);
      border-color: #444;
      color: #888;
      opacity: 0.6;
    }
    .collection-card-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .collection-card-status {
      font-size: 11px;
      color: #8bc34a;
    }
    .collection-card-item.not-found .collection-card-status {
      color: #aaa;
    }
    /* –°–µ—Ç–∫–∞ —Å–ª–∞–±—à–∏—Ö –∫–∞—Ä—Ç ‚Äî –ø–æ 3 –≤ —Ä—è–¥ */
    .weaker-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .weaker-card-tile {
      background: rgba(30,20,18,0.45);
      border: 1px solid rgba(200,170,120,0.08);
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .weaker-card-footer { display:flex; justify-content:space-between; align-items:center; gap:6px; margin-top:8px; }
    .weaker-card-pct { color: #c6ffb3; font-weight:700; }
    .weaker-add-btn { background:#c85; border:none; color:#111; padding:6px 8px; border-radius:6px; cursor:pointer }
    :root{
      --bg-0:#080605;
      --bg-1:#120d0a;
      --wood:#1a120c;

      --brass-0:#f2d07a;
      --brass-1:#c59b3c;
      --brass-2:#7a5520;

      --copper-0:#d8905b;
      --copper-1:#b56a33;
      --copper-2:#6f3316;

      --steel-0:#2a2f33;
      --steel-1:#14181b;

      --ink:#f4e6c6;
      --muted:#d0bf9a;

      --glow: rgba(255, 210, 110, 0.22);
      --shadow: rgba(0,0,0,0.65);

      --radius: 14px;

      /* –°—Ç–∏—Ö—ñ—ó */
      --fire:#c45a2a;
      --water:#3b6c8e;
      --air:#9fb6c1;
      --earth:#7a6a3a;
      --steam:#8a7f8a;
      --mech:#5a5a5a;
      
      /* –†—ñ–¥–∫–æ—Å—Ç—ñ */
      --common:#b8a27b;
      --rare:#6fb2ff;
      --epic:#b07cff;
      --legend:#ffcc66;
      --tile-radius: 18px;
    }

    /* Base */
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      font-family: Georgia, "Times New Roman", serif;
      background:
        radial-gradient(1200px 800px at 50% -10%, rgba(255,200,120,0.10), transparent 55%),
        radial-gradient(900px 700px at 20% 25%, rgba(212,140,75,0.10), transparent 50%),
        radial-gradient(1000px 900px at 80% 60%, rgba(120,70,40,0.10), transparent 55%),
        linear-gradient(180deg, var(--bg-1), var(--bg-0));
      min-height: 100vh;
      display:block;
    }

    /* Phone frame */
    .phone{
      width:100vw;
      min-height:100vh;
      padding: 0;
      position: relative;
      background: transparent;
      overflow:hidden;
      display: flex;
      flex-direction: column;
    }

    /* Side copper rails */
    .phone::before,
    .phone::after{
      content:"";
      position:absolute;
      top:-30px; bottom:-30px;
      width: 18px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.10), transparent 12%),
        linear-gradient(180deg, #3b2010, #7a3b1a 35%, #a55a2b 50%, #6a2d12 70%, #2b140a);
      box-shadow: inset 0 0 0 1px rgba(255,210,120,0.25), 0 0 18px rgba(0,0,0,0.5);
      filter: saturate(1.1);
      opacity:0.95;
      border-radius: 12px;
    }
    .phone::before{ left:-6px; }
    .phone::after { right:-6px; }

    /* Subtle noise overlay */
    .noise{
      pointer-events:none;
      position:absolute; inset:0;
      opacity:0.10;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.08) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,0.07) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 80%, rgba(255,255,255,0.06) 0 1px, transparent 2px);
      background-size: 60px 60px, 80px 80px, 100px 100px;
      mix-blend-mode: overlay;
    }

    /* Top bar */
    .topbar{
      position: relative;
      padding: 10px 10px 12px;
      border-radius: var(--radius);
      background:
        linear-gradient(180deg, rgba(255,210,110,0.08), rgba(0,0,0,0.35)),
        linear-gradient(180deg, #1b120c, #0c0907);
      box-shadow: 0 10px 24px var(--shadow);
      border: 1px solid rgba(245,210,120,0.20);
    }
    .topbar::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(242,208,122,0.35), rgba(213,143,85,0.18), rgba(90,50,20,0.10));
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      padding: 1px;
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
    }

    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .avatar{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }

    .portrait{
      width:36px; height:36px;
      border-radius: 10px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,230,170,0.18), transparent 55%),
        linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,0.35);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.6), 0 6px 12px rgba(0,0,0,0.55);
      position: relative;
    }
    .portrait::after{
      content:"";
      position:absolute; inset:4px;
      border-radius: 8px;
      background:
        radial-gradient(circle at 45% 35%, rgba(255,210,120,0.18), transparent 55%),
        radial-gradient(circle at 55% 65%, rgba(212,140,75,0.12), transparent 55%);
      opacity:0.8;
    }

    .level{
      font-variant-numeric: tabular-nums;
      color: var(--brass-0);
      font-weight:700;
      letter-spacing:0.02em;
      white-space:nowrap;
    }

    .meters{
      display:flex;
      align-items:center;
      gap:10px;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }

    .meter{
      display:flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.10), rgba(0,0,0,0.35)),
        linear-gradient(180deg, #1a120c, #0c0907);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: inset 0 0 12px rgba(0,0,0,0.6);
    }
    .gem, .coin{
      width:10px; height:10px;
      border-radius: 2px;
      box-shadow: 0 0 10px var(--glow);
    }
    .gem{
      background: linear-gradient(135deg, #bfe8ff, #4aa0d6);
      border: 1px solid rgba(200,245,255,0.35);
    }
    .coin{
      background: linear-gradient(135deg, var(--brass-0), var(--brass-1));
      border: 1px solid rgba(255,230,140,0.35);
      border-radius: 50%;
    }

    .statusbar{
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(180deg, #0b0907, #050403);
      border: 1px solid rgba(242,208,122,0.18);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.85);
      overflow:hidden;
      position:relative;
    }
    .statusbar > span{
      display:block; height:100%;
      width: 78%;
      background:
        linear-gradient(90deg, rgba(255,220,140,0.10), rgba(255,210,120,0.25)),
        linear-gradient(90deg, #4f2a12, #b56a33 40%, #f2d07a 75%, #c59b3c);
      box-shadow: 0 0 14px rgba(255,210,120,0.25);
    }

    /* Tiles grid */
    .tiles{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }

    .tile{
      position:relative;
      border-radius: var(--tile-radius);
      padding: 10px 10px 12px;
      min-height: 96px;
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: 0 10px 20px rgba(0,0,0,0.55), inset 0 0 18px rgba(0,0,0,0.75);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, filter .08s ease;
    }
    .tile:hover{ filter: brightness(1.05); }
    .tile:active{ transform: translateY(1px); }

    /* Ornate brass frame */
    .phone::before,
    .phone::after{
      content: none;
      display: none;
    }

    .tile .label{
      font-size: 13px;
      color: var(--brass-0);
      text-shadow: 0 1px 0 rgba(0,0,0,0.7);
    }
    .tile .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      opacity:0.95;
    }

    .tile .icon{
      width:34px; height:34px;
      border-radius: 12px;
      margin-bottom: 8px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,230,170,0.18), transparent 60%),
        linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,0.25);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.6);
      position: relative;
      overflow:hidden;
    }
    .tile .icon::after{
      content:"";
      position:absolute; inset:-40%;
      background:
        repeating-conic-gradient(from 0deg,
          rgba(242,208,122,0.12) 0 10deg,
          rgba(0,0,0,0.0) 10deg 20deg);
      opacity:0.55;
      transform: rotate(10deg);
    }

    /* Page system */
    #main-content{
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .page{
      display:none;
      animation: fadeIn 0.3s ease;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
    .page.active{
      display:flex;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* Page headers */
    .page-header{
      padding: 12px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.08), rgba(0,0,0,0.45)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border-bottom: 1px solid rgba(242,208,122,0.18);
      box-shadow: 0 4px 12px rgba(0,0,0,0.55);
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }
    .page-title{
      font-size: 18px;
      color: var(--brass-0);
      text-shadow: 0 1px 2px rgba(0,0,0,0.7);
      margin: 0;
      flex: 1;
      text-align: center;
    }
    .back-btn{
      all: unset;
      padding: 8px 12px;
      font-size: 14px;
      color: var(--brass-1);
      cursor: pointer;
      border-radius: 8px;
      background: rgba(242,208,122,0.08);
      border: 1px solid rgba(242,208,122,0.15);
      transition: all 0.15s ease;
    }
    .back-btn:hover{
      background: rgba(242,208,122,0.15);
    }

    /* Page content */
    .page-content{
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      min-height: 0;
    }

    /* Info cards */
    .info-card{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: 0 6px 12px rgba(0,0,0,0.55), inset 0 0 18px rgba(0,0,0,0.75);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 12px;
      text-align: center;
    }
    .info-label{
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .info-value{
      font-size: 24px;
      color: var(--brass-0);
      text-shadow: 0 1px 2px rgba(0,0,0,0.7);
      font-weight: 500;
    }

    /* Action buttons */
    .action-btn{
      all: unset;
      display: block;
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      text-align: center;
      font-size: 15px;
      color: var(--bg-dark);
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      border-radius: var(--radius);
      border: 1px solid rgba(242,208,122,0.35);
      box-shadow: 0 8px 16px rgba(0,0,0,0.55), inset 0 0 0 1px rgba(255,255,255,0.15);
      cursor: pointer;
      transition: all 0.15s ease;
      font-weight: 500;
    }
    .action-btn:hover{
      filter: brightness(1.08);
      transform: translateY(-1px);
    }
    .action-btn:active{
      transform: translateY(0);
    }
    .action-btn.secondary{
      background: linear-gradient(180deg, rgba(242,208,122,0.25), rgba(197,155,60,0.15));
      color: var(--brass-0);
    }

    /* Description */
    .description{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
      margin-top: 15px;
      padding: 12px;
      background: rgba(0,0,0,0.35);
      border-radius: var(--radius);
      border: 1px solid rgba(242,208,122,0.12);
    }

    /* Tasks */
    .task-item{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .task-item.completed{
      opacity: 0.6;
      border-color: rgba(100,200,100,0.35);
    }
    .task-text{
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 6px;
    }
    .task-progress{
      font-size: 13px;
      color: var(--brass-1);
      margin-bottom: 4px;
    }
    .task-reward{
      font-size: 12px;
      color: var(--muted);
    }

    /* Rewards */
    .reward-item{
      display: flex;
      align-items: center;
      gap: 12px;
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .reward-item.locked{
      opacity: 0.5;
    }
    .reward-icon{
      font-size: 32px;
    }
    .reward-text{
      flex: 1;
      font-size: 14px;
      color: var(--brass-0);
    }
    .reward-progress{
      font-size: 12px;
      color: var(--muted);
    }
    .claim-btn{
      all: unset;
      padding: 8px 16px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    /* Equipment */
    .equipment-slot{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .slot-name{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .slot-item{
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 4px;
    }
    .slot-item.equipped{
      color: var(--brass-1);
    }
    .slot-bonus{
      font-size: 13px;
      color: #8bc34a;
    }

    /* Collections */
    .collection-set{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .collection-set.completed{
      border-color: rgba(100,200,100,0.45);
    }
    .set-name{
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 6px;
    }
    .set-progress{
      font-size: 13px;
      color: var(--brass-1);
      margin-bottom: 4px;
    }
    .set-bonus{
      font-size: 12px;
      color: #8bc34a;
    }

    /* Upgrade hint styling */
    .hint {
      transition: all 0.3s ease;
    }
    
    .hint.hot {
      border-color: rgba(120,255,160,.35) !important;
      box-shadow: inset 0 0 14px rgba(0,0,0,.65), 0 0 18px rgba(90,255,120,.18) !important;
      color: rgba(220,255,220,.95) !important;
    }

    /* Card Details Page */
    .card-main-display {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 24px;
      padding: 20px;
      background: linear-gradient(180deg, rgba(242,208,122,0.08), rgba(0,0,0,0.3));
      border: 2px solid rgba(242,208,122,0.3);
      border-radius: 12px;
      margin-bottom: 15px;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –∫–∞—Ä—Ç–∏ */
    .card-info-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: left;
      margin-top: 0;
      margin-left: 0;
    }

    .card-display-image {
      width: 120px;
      height: 160px;
      margin: 0 auto 15px;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid rgba(242,208,122,0.4);
      background: radial-gradient(circle at 30% 30%, rgba(255,230,170,0.1), transparent);
    }

    .card-display-icon {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
    }

    .card-display-name {
      font-size: 18px;
      color: var(--brass-0);
      margin-bottom: 8px;
      font-weight: bold;
    }

    .card-display-element {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .card-display-level {
      display: inline-block;
      background: rgba(242,208,122,0.2);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      color: var(--brass-1);
      margin: 0 5px;
    }

    .card-display-power {
      display: inline-block;
      background: rgba(160,200,100,0.2);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      color: #8bc34a;
      margin: 0 5px;
    }

    .card-stats {
      padding: 15px;
      background: rgba(50,30,20,0.3);
      border-left: 3px solid var(--brass-0);
      margin-bottom: 15px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(242,208,122,0.1);
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: var(--muted);
      font-size: 13px;
    }

    .stat-value {
      color: var(--brass-0);
      font-weight: bold;
    }

    .card-comparison {
      margin-bottom: 15px;
    }

    .comparison-title {
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(242,208,122,0.2);
    }

    .weaker-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .weaker-card-item {
      background: rgba(50,30,20,0.4);
      border: 1px solid rgba(242,208,122,0.15);
      border-radius: 8px;
      padding: 10px;
      transition: all 0.2s;
    }

    .weaker-card-item:hover {
      border-color: rgba(242,208,122,0.3);
      box-shadow: 0 0 10px rgba(242,208,122,0.1);
    }

    .weaker-card-icon {
      font-size: 32px;
      text-align: center;
      margin-bottom: 6px;
    }

    .weaker-card-name {
      font-size: 12px;
      color: var(--brass-0);
      margin-bottom: 4px;
      text-align: center;
    }

    .weaker-card-stats {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .no-weaker-cards {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 13px;
    }

    /* –ö–æ–º–ø–∞–∫—Ç–Ω–∏–π —Å–ø–∏—Å–æ–∫ —Å–ª–∞–±—à–∏—Ö –∫–∞—Ä—Ç */
    .weaker-cards-compact {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
    }
    .compact-card {
      background: rgba(50,30,20,0.7);
      border: 1.5px solid rgba(242,208,122,0.18);
      border-radius: 10px;
      padding: 10px 8px 8px 8px;
      min-width: 90px;
      max-width: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      position: relative;
    }
    .compact-card-icon {
      font-size: 28px;
      margin-bottom: 4px;
    }
    .compact-card-name {
      font-size: 12px;
      color: var(--brass-0);
      margin-bottom: 2px;
      text-align: center;
      font-weight: 600;
    }
    .compact-card-power {
      font-size: 13px;
      color: #f4e6c6;
      margin-bottom: 4px;
      font-weight: 700;
    }
    .absorb-btn {
      background: linear-gradient(180deg, #f2d07a, #c59b3c);
      color: #1a120c;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 2px;
      cursor: pointer;
      transition: background 0.18s;
    }
    .absorb-btn:hover {
      background: linear-gradient(180deg, #ffe7a0, #e0b85c);
    }
    .absorb-bonus {
      font-size: 11px;
      color: #2ecc71;
      font-weight: 700;
      margin-top: 0px;
      margin-bottom: 2px;
      text-align: center;
    }

    /* Card Upgrade Scale (XP System) */
    .card-upgrade {
      margin-top: 14px;
    }

    .upgrade-header {
      display: flex;
      justify-content: space-between;
      font-weight: 900;
      color: rgba(242, 208, 122, 0.95);
    }

    .card-upgrade .xp-bar {
      margin-top: 6px;
      height: 14px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(242, 208, 122, 0.25);
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.65);
      overflow: hidden;
    }

    .card-upgrade .xp-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(
        180deg,
        rgba(242, 208, 122, 0.95),
        rgba(122, 85, 32, 0.95)
      );
      box-shadow: 0 0 12px rgba(242, 208, 122, 0.35);
      transition: width 0.25s ease;
    }

    /* Upgrade arrow on card when guaranteed level-up is possible */
    .sp-card { position: relative; overflow: visible; }
    .upgrade-arrow {
      position: absolute;
      left: 50%;
      transform: translate(-50%, 0);
      bottom: -247px !important;           /* –ü–æ–∫–ª–∞—Å—Ç–∏ –ø–æ–≤–µ—Ä—Ö –∫–∞—Ä—Ç–∏ (–≤—Å–µ—Ä–µ–¥–∏–Ω—ñ) */
      top: auto !important;
      width: 32px;           /* –ú–µ–Ω—à–∏–π —Ä–æ–∑–º—ñ—Ä */
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(180deg, #30c85a, #0ea83a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 14px;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(14, 168, 58, 0.4);
      pointer-events: none;
      z-index: 9999;
      border: 2px solid rgba(255, 255, 255, 0.3);
      animation: pulse-green 1.5s ease-in-out infinite;
    }

    @keyframes pulse-green {
      0%, 100% {
        box-shadow: 0 4px 12px rgba(14, 168, 58, 0.4);
        transform: translateX(-50%) scale(1);
      }
      50% {
        box-shadow: 0 4px 20px rgba(14, 168, 58, 0.6);
        transform: translateX(-50%) scale(1.05);
      }
    }

    /* –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ: —è–∫—â–æ —Ö–æ—á–µ—Ç–µ —Å—Ç—Ä—ñ–ª–∫—É –ø—ñ–¥ –∫–∞—Ä—Ç–∫–æ—é (–∑–æ–≤–Ω—ñ) */
    .upgrade-arrow.outside {
      bottom: -16px;         /* –í–∏—Å—Ç—É–ø–∞—î –ø—ñ–¥ –∫–∞—Ä—Ç–∫–æ—é */
      background: linear-gradient(180deg, #30c85a, #0ea83a);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    #cu-upgrade-btn {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(242, 208, 122, 0.25);
      color: rgba(244, 230, 198, 0.95);
      font-weight: 900;
      cursor: pointer;
      transition: all 0.2s;
    }

    #cu-upgrade-btn:hover:not(:disabled) {
      background: rgba(0, 0, 0, 0.5);
      box-shadow: 0 0 10px rgba(242, 208, 122, 0.2);
    }

    #cu-upgrade-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    /* === Shop Cards Styles === */
    .shop-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 8px;
      color: #d4af37;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .filter-btn:hover {
      background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
      border-color: #d4af37;
      transform: translateY(-2px);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #d4af37, #b8941f);
      color: #1a1a1a;
      border-color: #d4af37;
    }

    .shop-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
      padding: 5px;
    }

    .shop-card {
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .shop-card:hover {
      border-color: #d4af37;
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }

    .shop-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .shop-card-name {
      font-size: 14px;
      font-weight: 600;
      color: #d4af37;
    }

    .shop-card-element {
      font-size: 20px;
    }

    .shop-card-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
      color: #999;
    }

    .shop-card-power {
      color: #4CAF50;
      font-weight: 600;
    }

    .shop-card-price {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #333;
    }

    .shop-price-tag {
      color: #d4af37;
      font-weight: 600;
      font-size: 14px;
    }

    .shop-buy-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .shop-buy-btn:hover {
      background: linear-gradient(135deg, #66BB6A, #4CAF50);
      transform: scale(1.05);
    }

    .shop-buy-btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .shop-card-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      color: white;
    }

    .shop-card-badge.upgrade-only {
      background: linear-gradient(135deg, #FF9800, #E65100);
    }

    /* === Shop Tabs & Products === */
    .shop-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #1a1a1a, #0a0a0a);
      padding: 8px;
      border-radius: 12px;
      border: 2px solid #333;
    }

    .shop-tab {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: #999;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .shop-tab:hover {
      color: #d4af37;
      background: rgba(212, 175, 55, 0.1);
    }

    .shop-tab.active {
      background: linear-gradient(135deg, #d4af37, #b8941f);
      color: #1a1a1a;
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    }

    .shop-tab-content {
      display: none;
    }

    .shop-tab-content.active {
      display: block;
    }

    .shop-products {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .product-card {
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 2px solid rgba(242,208,122,0.22);
      border-radius: 12px;
      padding: 16px;
      position: relative;
      transition: all 0.3s;
    }

    .product-card:hover {
      border-color: #d4af37;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.2);
    }

    .product-badge {
      position: absolute;
      top: -8px;
      right: 16px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      color: white;
      box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
    }

    .product-badge.hot {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      animation: pulse-badge 2s infinite;
    }

    .product-badge.new {
      background: linear-gradient(135deg, #3498db, #2980b9);
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .product-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .product-icon {
      width: 48px;
      height: 48px;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border-radius: 8px;
      border: 2px solid #444;
    }

    .product-info {
      flex: 1;
    }

    .product-title {
      font-size: 16px;
      font-weight: 600;
      color: #d4af37;
      margin-bottom: 4px;
    }

    .product-desc {
      font-size: 13px;
      color: #999;
    }

    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .product-price {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 18px;
      font-weight: 700;
      color: #d4af37;
    }

    .product-price .currency-icon {
      font-size: 20px;
    }

    .product-buy-btn {
      padding: 10px 20px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      border: none;
      border-radius: 8px;
      color: var(--bg-dark);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .product-buy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    }

    .product-buy-btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .product-bonus {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(46, 204, 113, 0.2);
      border: 1px solid #2ecc71;
      border-radius: 4px;
      color: #2ecc71;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }

    /* === Pack Opening Modal === */
    .pack-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }

    .pack-modal.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .pack-modal-content {
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 3px solid #d4af37;
      border-radius: 16px;
      padding: 18px;
      width: min(360px, calc(100vw - 24px));
      max-width: 460px;
      max-height: 80vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      text-align: center;
      align-items: center;
      animation: slideUp 0.4s;
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .pack-modal-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .pack-modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 8px;
    }

    .pack-modal-subtitle {
      font-size: 14px;
      color: #999;
    }

    .pack-rewards {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    /* Fallback: keep grid layout on wider pack-opening screens if desired */
    @media (min-width: 900px) {
      .pack-rewards.grid-view {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
    }

    .pack-card-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      animation: cardReveal 0.5s backwards;
    }

    .pack-card-wrapper:nth-child(1) { animation-delay: 0.1s; }
    .pack-card-wrapper:nth-child(2) { animation-delay: 0.2s; }
    .pack-card-wrapper:nth-child(3) { animation-delay: 0.3s; }
    .pack-card-wrapper:nth-child(4) { animation-delay: 0.4s; }
    .pack-card-wrapper:nth-child(5) { animation-delay: 0.5s; }

    .pack-card-wrapper .sp-card {
      width: 100%;
      max-width: 220px;
      aspect-ratio: 160 / 220;
      height: auto;
      margin: 0;
    }

    /* Mobile-friendly adjustments for pack modal */
    @media (max-width: 480px) {
      .pack-rewards { grid-template-columns: 1fr !important; gap: 14px; }
      .pack-modal-content { max-width: 320px; width: 94%; padding: 18px; }
      .pack-card-wrapper { gap: 8px; }
      .pack-card-wrapper .sp-card { max-width: 160px; aspect-ratio: 3/4; }
      .pack-card-info { font-size: 14px; }
      .pack-modal-title { font-size: 18px; }
    }

    .pack-card-info {
      text-align: center;
      color: var(--brass-0);
    }

    .pack-card-name {
      font-size: 16px;
      font-weight: bold;
      color: var(--brass-0);
      margin-bottom: 4px;
      line-height: 1.15;
      word-break: normal;
      overflow-wrap: anywhere;
    }

    .pack-card-element {
      font-size: 13px;
      color: var(--muted);
    }

    .reward-card {
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 10px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: cardReveal 0.5s backwards;
    }

    .reward-card:nth-child(1) { animation-delay: 0.1s; }
    .reward-card:nth-child(2) { animation-delay: 0.2s; }
    .reward-card:nth-child(3) { animation-delay: 0.3s; }
    .reward-card:nth-child(4) { animation-delay: 0.4s; }
    .reward-card:nth-child(5) { animation-delay: 0.5s; }
    .reward-card:nth-child(n+6) { animation-delay: 0.6s; }

    @keyframes cardReveal {
      from { transform: rotateY(90deg) scale(0.8); opacity: 0; }
      to { transform: rotateY(0) scale(1); opacity: 1; }
    }

    .reward-card-icon {
      font-size: 32px;
      width: 40px;
      text-align: center;
    }

    .reward-card-info {
      flex: 1;
    }

    .reward-card-name {
      font-size: 14px;
      font-weight: 600;
      color: #d4af37;
      margin-bottom: 4px;
    }

    .reward-card-power {
      font-size: 12px;
      color: #4CAF50;
      font-weight: 600;
    }

    /* –ù–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è card-item (–∫—Ä–∞—Å–∏–≤—ñ –∫–∞—Ä—Ç–∏) */
    .card-item {
      background: linear-gradient(135deg, rgba(255,220,140,0.08), rgba(0,0,0,0.4)),
                  linear-gradient(180deg, #1b1410, #0a0805);
      border: 2px solid rgba(242,208,122,0.25);
      border-radius: 12px;
      overflow: hidden;
      animation: cardReveal 0.5s backwards;
      margin-bottom: 12px;
    }

    .card-item:nth-child(1) { animation-delay: 0.1s; }
    .card-item:nth-child(2) { animation-delay: 0.2s; }
    .card-item:nth-child(3) { animation-delay: 0.3s; }
    .card-item:nth-child(4) { animation-delay: 0.4s; }
    .card-item:nth-child(5) { animation-delay: 0.5s; }
    .card-item:nth-child(n+6) { animation-delay: 0.6s; }

    .card-item-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
    }

    .card-item-element {
      font-size: 32px;
      min-width: 40px;
      text-align: center;
    }

    .card-item-details {
      flex: 1;
    }

    .card-item-name {
      font-size: 16px;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 4px;
    }

    .card-item-element-name {
      font-size: 12px;
      color: #999;
      opacity: 0.8;
    }

    .card-item-power {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 14px 14px;
      border-top: 1px solid rgba(242,208,122,0.12);
    }

    .card-power-label {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .card-power-value {
      font-size: 24px;
      font-weight: 800;
      color: #d4af37;
    }

    .pack-modal-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      border: none;
      border-radius: 10px;
      color: var(--bg-dark);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .pack-modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
    }

    /* Duel Result Modal */
    .duel-result-rewards {
      text-align: center;
      padding: 20px;
      font-size: 28px;
      color: var(--brass-0);
      font-weight: 700;
    }
    .duel-result-stats-info {
      text-align: center;
      padding: 10px 20px;
      color: var(--muted);
      font-size: 15px;
    }
    .duel-wins-info {
      font-size: 16px;
      color: var(--brass-1);
    }
    .duel-next-btn {
      background: linear-gradient(180deg, rgba(100,200,100,0.35), rgba(60,150,60,0.35));
      border: 1px solid rgba(100,200,100,0.5);
    }
    .duel-next-btn:hover {
      background: linear-gradient(180deg, rgba(120,220,120,0.45), rgba(80,170,80,0.45));
    }
    .duel-battle-summary {
      margin-top: 20px;
      padding: 20px;
      border-top: 2px solid rgba(242,208,122,0.25);
    }
    .duel-summary-title {
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 10px;
    }
    .duel-summary-hp {
      text-align: center;
      font-size: 20px;
      color: #e74c3c;
      font-weight: 700;
      margin-bottom: 15px;
    }
    .duel-battle-cards {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .duel-battle-card-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      border-left: 3px solid var(--elem);
    }
    .duel-battle-card-player {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .duel-battle-card-enemy {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .duel-battle-card-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: conic-gradient(var(--brass-2) 0 90deg, var(--brass-1) 90deg 180deg, var(--brass-2) 180deg 270deg, var(--brass-1) 270deg 360deg);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .duel-battle-card-icon svg {
      width: 18px;
      height: 18px;
    }
    .duel-battle-card-dmg {
      color: var(--brass-0);
      font-weight: 700;
      font-size: 16px;
    }
    .duel-battle-vs {
      color: var(--muted);
      font-size: 14px;
    }

    /* Multiplier preview badge between cards */
    .mult-badge {
      width: 160px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: rgba(0,0,0,0.70);
      border: 1px solid rgba(242,208,122,0.30);
      border-radius: 999px;
      box-shadow: inset 0 0 12px rgba(0,0,0,0.75), 0 8px 20px rgba(0,0,0,0.60);
    }
    .mult-badge .mult-text {
      color: rgba(244,230,198,0.95);
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }
    .mult-badge .swords::before {
      content: '‚öî';
      font-size: 16px;
      opacity: 0.90;
    }
    .mult-badge.mult-good .mult-text { color: #7dff9a; text-shadow: 0 0 8px rgba(125,255,154,0.5); }
    .mult-badge.mult-bad .mult-text { color: #ff9a7d; text-shadow: 0 0 8px rgba(255,154,125,0.5); }
    .mult-badge.mult-neutral .mult-text { color: rgba(244,230,198,0.95); }

    /* === New Shop Design === */
    .shop-section {
      margin-bottom: 25px;
    }

    .shop-section-title {
      font-size: 18px;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
      border-left: 4px solid #d4af37;
      border-radius: 6px;
    }

    .shop-notice {
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(41, 128, 185, 0.1));
      border: 2px solid rgba(52, 152, 219, 0.4);
      border-radius: 10px;
      padding: 12px 15px;
      margin-bottom: 15px;
      color: #3498db;
      font-size: 13px;
      line-height: 1.5;
      position: relative;
    }

    .shop-notice::before {
      content: 'üí°';
      font-size: 20px;
      margin-right: 8px;
    }

    .shop-item-card {
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 2px solid rgba(242,208,122,0.22);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      gap: 15px;
      align-items: center;
      transition: all 0.3s;
      position: relative;
    }

    .shop-item-card:hover {
      border-color: #d4af37;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.2);
    }

    .shop-item-icon {
      width: 70px;
      height: 70px;
      min-width: 70px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .shop-item-content {
      flex: 1;
    }

    .shop-item-name {
      font-size: 16px;
      font-weight: 600;
      color: #d4af37;
      margin-bottom: 5px;
    }

    .shop-item-desc {
      font-size: 13px;
      color: #999;
      margin-bottom: 8px;
    }

    .shop-item-chance {
      display: inline-block;
      padding: 4px 10px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      border-radius: 15px;
      color: white;
      font-size: 11px;
      font-weight: 700;
      margin-top: 5px;
    }

    .shop-item-chance.rare {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
    }

    .shop-item-chance.uncommon {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
    }

    .shop-item-action {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .shop-item-price {
      font-size: 18px;
      font-weight: 700;
      color: #d4af37;
    }

    .shop-buy-button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .shop-buy-button:hover {
      background: linear-gradient(135deg, #27ae60, #229954);
      transform: scale(1.05);
    }

    .shop-buy-button:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .action-btn {
      all: unset;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid rgba(242,208,122,0.3);
    }

    .upgrade-btn {
      background: linear-gradient(180deg, #a6ff7a, #2ea13a);
      color: #0b180b;
    }

    .upgrade-btn:hover {
      box-shadow: 0 0 15px rgba(166,255,122,0.4);
    }

    .add-btn {
      background: linear-gradient(180deg, rgba(242,208,122,0.4), rgba(197,155,60,0.2));
      color: var(--brass-0);
    }

    .add-btn:hover {
      background: linear-gradient(180deg, rgba(242,208,122,0.6), rgba(197,155,60,0.3));
    }

    .remove-btn {
      background: rgba(255,50,50,0.1);
      color: #ff6666;
      border-color: rgba(255,50,50,0.2);
    }

    .remove-btn:hover {
      background: rgba(255,50,50,0.2);
    }

    /* Shop */
    .shop-item{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .item-name{
      font-size: 15px;
      color: var(--brass-0);
    }
    .item-desc{
      font-size: 13px;
      color: var(--muted);
    }
    .item-price{
      font-size: 14px;
      color: var(--brass-1);
      margin: 4px 0;
    }
    .buy-btn{
      all: unset;
      padding: 10px;
      text-align: center;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }

    /* Gold packs */
    .gold-pack{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 12px;
      text-align: center;
      position: relative;
    }
    .gold-pack.featured{
      border-color: var(--brass-1);
      box-shadow: 0 0 20px rgba(242,208,122,0.25);
    }
    .pack-badge{
      position: absolute;
      top: -8px;
      right: 10px;
      padding: 4px 12px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      font-size: 11px;
      border-radius: 12px;
      font-weight: 500;
    }
    .pack-amount{
      font-size: 20px;
      color: var(--brass-0);
      margin-bottom: 8px;
    }
    .pack-price{
      font-size: 15px;
      color: var(--brass-1);
      margin-bottom: 8px;
    }
    .pack-bonus{
      font-size: 13px;
      color: #8bc34a;
      margin-bottom: 8px;
    }
    .exchange-btn{
      all: unset;
      display: block;
      width: 100%;
      padding: 12px;
      text-align: center;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }

    /* Profile stats */
    .profile-stat{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stat-label{
      font-size: 14px;
      color: var(--muted);
    }
    .stat-value{
      font-size: 16px;
      color: var(--brass-0);
      font-weight: 500;
    }

    /* Guild status */
    .guild-status{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 15px;
      text-align: center;
    }
    .status-text{
      font-size: 15px;
      color: var(--brass-0);
    }

    /* Accordion list */
    .list{
      margin-top: 12px;
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid rgba(242,208,122,0.18);
      box-shadow: 0 12px 22px rgba(0,0,0,0.55);
      background:
        linear-gradient(180deg, rgba(255,220,140,0.06), rgba(0,0,0,0.45)),
        linear-gradient(180deg, #1b120c, #0b0806);
    }

    .item{
      border-top: 1px solid rgba(242,208,122,0.10);
    }
    .item:first-child{ border-top:none; }

    .item > button{
      all:unset;
      display:flex;
      align-items:center;
      width:100%;
      padding: 12px 12px;
      cursor:pointer;
      gap:10px;
    }
    .item > button:hover{ background: rgba(255,210,120,0.05); }

    .item .bullet{
      width:22px; height:22px;
      border-radius: 7px;
      background:
        linear-gradient(180deg, var(--brass-0), var(--brass-2));
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.5), 0 0 10px rgba(255,210,120,0.18);
      position:relative;
    }
    .item .bullet::after{
      content:"";
      position:absolute; inset:5px;
      border-radius: 6px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,255,255,0.22), transparent 55%),
        linear-gradient(180deg, #3a2e1f, #14100c);
      opacity:0.9;
    }

    .item .text{
      flex:1;
      font-size: 15px;
      letter-spacing:0.02em;
    }
    .item .chev{
      width: 10px; height:10px;
      border-right: 2px solid rgba(242,208,122,0.7);
      border-bottom: 2px solid rgba(242,208,122,0.7);
      transform: rotate(-45deg);
      transition: transform .12s ease;
      opacity:0.9;
      margin-right: 4px;
    }

    /* Promo */
    .promo{
      margin-top: 10px;
      border-radius: var(--radius);
      padding: 10px 12px;
      background:
        radial-gradient(400px 200px at 50% 0%, rgba(255,210,120,0.12), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: 0 12px 22px rgba(0,0,0,0.55);
      text-align:center;
    }
    .promo .badge{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--copper-0), var(--copper-2));
      border: 1px solid rgba(255,220,140,0.25);
      color: #1c0f08;
      font-weight: 700;
      letter-spacing:0.03em;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.45);
      margin-bottom: 6px;
    }
    .promo .line{
      color: var(--brass-0);
      font-weight: 700;
      text-shadow: 0 1px 0 rgba(0,0,0,0.75);
    }
    .promo .sub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    /* Bottom nav */
    .bottom{
      position: sticky;
      bottom: 8px;
      margin-top: 12px;
      border-radius: 18px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.06), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      box-shadow: 0 16px 26px rgba(0,0,0,0.65);
      display:flex;
      gap:6px;
      padding: 8px;
    }
    .navbtn{
      flex:1;
      border-radius: 14px;
      padding: 10px 8px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      border: 1px solid rgba(242,208,122,0.10);
      background:
        linear-gradient(180deg, rgba(255,210,120,0.04), rgba(0,0,0,0.45));
      transition: filter .08s ease, transform .08s ease;
    }
    .navbtn:hover{ filter: brightness(1.06); }
    .navbtn:active{ transform: translateY(1px); }

    .navbtn .ico{
      width:24px; height:24px;
      margin: 0 auto 6px;
      border-radius: 10px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,230,170,0.18), transparent 60%),
        linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.6);
      position:relative;
      overflow:hidden;
    }
    .navbtn .ico::after{
      content:"";
      position:absolute; inset:-50%;
      background: repeating-conic-gradient(from 0deg, rgba(242,208,122,0.10) 0 12deg, transparent 12deg 24deg);
      opacity:0.55;
    }
    .navbtn .t{
      font-size: 12px;
      color: var(--muted);
      letter-spacing:0.02em;
    }
    .navbtn.active{
      border-color: rgba(242,208,122,0.32);
      background:
        radial-gradient(220px 80px at 50% 0%, rgba(255,210,120,0.16), transparent 65%),
        linear-gradient(180deg, rgba(255,210,120,0.06), rgba(0,0,0,0.55));
    }
    .navbtn.active .t{ color: var(--brass-0); }

    /* Small screens */
    @media (max-width: 360px){
      .tile{ min-height: 90px; }
      .tile .label{ font-size: 12px; }
      .tile .sub{ font-size: 11px; }
    }

    /* ===== DECK SCREEN ===== */
    .screen {
      width: 100vw;
      max-width: none;
      margin: 0;
      padding: 0;
    }

    /* Topbar –¥–ª—è –∫–æ–ª–æ–¥–∏ */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 16px;
      background: 
        linear-gradient(180deg, rgba(255,210,120,.06), rgba(0,0,0,.55)),
        linear-gradient(180deg, #1b120c, #070503);
      border: 1px solid rgba(242,208,122,.20);
      box-shadow: 0 14px 26px rgba(0,0,0,.65);
      margin-bottom: 10px;
    }

    .topbar-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(242,208,122,.18);
      box-shadow: inset 0 0 10px rgba(0,0,0,.65);
      font-size: 14px;
      color: var(--brass-0);
      font-weight: 600;
    }

    .gem, .coin {
      width: 10px;
      height: 10px;
      display: inline-block;
    }

    .gem {
      border-radius: 2px;
      background: linear-gradient(135deg, #bfe8ff, #4aa0d6);
      box-shadow: 0 0 6px rgba(79, 180, 240, 0.5);
    }

    .coin {
      border-radius: 50%;
      background: linear-gradient(135deg, var(--brass-0), var(--brass-1));
      box-shadow: 0 0 6px rgba(242,208,122, 0.5);
    }

    /* Panel helper */
    .panel {
      background:
        linear-gradient(180deg, rgba(255,210,120,.05), rgba(0,0,0,.55)),
        linear-gradient(180deg, #1b120c, #070503);
      border: 1px solid rgba(242,208,122,.18);
      box-shadow: 0 14px 24px rgba(0,0,0,.6), inset 0 0 14px rgba(0,0,0,.7);
      border-radius: 14px;
    }

    .subtle {
      opacity: 0.95;
    }

    /* Deck header */
    .deck-header {
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .deck-title {
      font-weight: 800;
      letter-spacing: 0.06em;
      color: var(--brass-0);
      font-size: 14px;
    }

    .deck-power {
      font-weight: 800;
      color: var(--brass-0);
      font-size: 16px;
    }

    /* Hint */
    .hint {
      padding: 8px 12px;
      text-align: center;
      color: rgba(244,230,198,.92);
      font-size: 13px;
      margin-bottom: 10px;
    }

    /* Card base styles */
    .sp-card {
      /* –ö–æ–º–ø–∞–∫—Ç–Ω–∏–π —Ä–æ–∑–º—ñ—Ä */
      width: 200px;
      height: 280px;
      border-radius: 20px;
      position: relative;
      padding: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;

      --elem: var(--fire); /* default */
      --rar: var(--legend); /* default rarity */

      background:
        radial-gradient(200px 180px at 40% 20%, rgba(255,220,140,.14), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.72)),
        linear-gradient(180deg, #1b120c, #080604);

      box-shadow:
        0 15px 30px var(--shadow),
        inset 0 0 18px rgba(0,0,0,.78),
        0 0 18px color-mix(in srgb, var(--elem) 22%, transparent);

      border: 1px solid rgba(242,208,122,.22);
    }

    .sp-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow:
        0 20px 40px var(--shadow),
        inset 0 0 18px rgba(0,0,0,.78),
        0 0 25px color-mix(in srgb, var(--elem) 35%, transparent);
    }

    .sp-card.selected {
      box-shadow:
        0 20px 40px var(--shadow),
        inset 0 0 18px rgba(0,0,0,.78),
        0 0 35px color-mix(in srgb, var(--elem) 50%, transparent),
        0 0 0 3px var(--rar);
    }

    /* Metal rim with rarity color */
    .sp-card::before{
      content:"";
      position:absolute;
      inset: 8px;
      border-radius: 16px;
      background:
        linear-gradient(135deg,
          color-mix(in srgb, var(--rar) 30%, rgba(242,208,122,.62)),
          color-mix(in srgb, var(--rar) 20%, rgba(181,106,51,.25)),
          color-mix(in srgb, var(--rar) 15%, rgba(122,85,32,.2)));
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,.6),
        inset 0 0 16px rgba(0,0,0,.6);
      pointer-events:none;
      opacity:.95;
      z-index: 1;
    }

    /* Inner plate */
    .sp-card::after{
      content:"";
      position:absolute;
      inset: 14px;
      border-radius: 14px;
      background:
        radial-gradient(400px 320px at 50% 20%, rgba(255,210,120,.08), transparent 58%),
        linear-gradient(180deg, rgba(255,210,120,.04), rgba(0,0,0,.40)),
        linear-gradient(180deg, #241a12, #120c08);
      box-shadow:
        inset 0 0 0 1px rgba(242,208,122,.10),
        inset 0 0 14px rgba(0,0,0,.65);
      pointer-events:none;
      z-index: 1;
    }

    /* Content layer */
    .sp-card > *{ position:relative; z-index:2; }

    /* Upgradable card - green arrow indicator (—è–∫ –æ–∫—Ä–µ–º–∏–π –µ–ª–µ–º–µ–Ω—Ç) */
    .upgrade-dot {
      position: absolute;
      top: -12px;
      right: 8px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      
      color: #0b180b;
      background: linear-gradient(180deg, #a6ff7a, #2ea13a);
      border: 1px solid rgba(0,0,0,.45);
      box-shadow: 0 6px 14px rgba(0,0,0,.6), 0 0 16px rgba(90,255,120,.25);
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      animation: pulse-upgrade 1.5s ease-in-out infinite;
      z-index: 10;
    }
    .corner-gear {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      z-index: 3;
      
      background:
        conic-gradient(
          from 0deg,
          var(--brass-2) 0 15deg,
          var(--brass-1) 15deg 30deg,
          var(--brass-2) 30deg 45deg,
          var(--brass-1) 45deg 60deg,
          var(--brass-2) 60deg 75deg,
          var(--brass-1) 75deg 90deg,
          var(--brass-2) 90deg 105deg,
          var(--brass-1) 105deg 120deg,
          var(--brass-2) 120deg 135deg,
          var(--brass-1) 135deg 150deg,
          var(--brass-2) 150deg 165deg,
          var(--brass-1) 165deg 180deg,
          var(--brass-2) 180deg 195deg,
          var(--brass-1) 195deg 210deg,
          var(--brass-2) 210deg 225deg,
          var(--brass-1) 225deg 240deg,
          var(--brass-2) 240deg 255deg,
          var(--brass-1) 255deg 270deg,
          var(--brass-2) 270deg 285deg,
          var(--brass-1) 285deg 300deg,
          var(--brass-2) 300deg 315deg,
          var(--brass-1) 315deg 330deg,
          var(--brass-2) 330deg 345deg,
          var(--brass-1) 345deg 360deg
        );
      
      box-shadow:
        inset 0 0 0 2px rgba(0,0,0,.6),
        0 5px 12px rgba(0,0,0,.7),
        0 0 12px color-mix(in srgb, var(--elem) 40%, transparent);
      
      display: grid;
      place-items: center;
      transition: transform 0.6s ease;
    }

    .sp-card:hover .corner-gear {
      transform: rotate(180deg);
    }

    /* –¶–µ–Ω—Ç—Ä —à–µ—Å—Ç–µ—Ä–Ω—ñ */
    .corner-gear::before{
      content:"";
      position:absolute;
      inset: 8px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 60%),
        linear-gradient(180deg, #2a1c12, #0a0604);
      box-shadow: inset 0 0 8px rgba(0,0,0,.8);
      z-index: -1;
    }

    /* –Ü–∫–æ–Ω–∫–∞ —Å—Ç–∏—Ö—ñ—ó –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —à–µ—Å—Ç–µ—Ä–Ω—ñ */
    .corner-gear svg{
      width: 22px;
      height: 22px;
      fill: var(--elem);
      filter:
        drop-shadow(0 0 6px color-mix(in srgb, var(--elem) 60%, transparent))
        drop-shadow(0 2px 4px rgba(0,0,0,.8));
      position: relative;
      z-index: 2;
    }
    
    .power-plate {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      height: 50px;
      border-radius: 12px;
      
      background:
        radial-gradient(180px 60px at 50% 0%, rgba(255,210,120,.15), transparent 70%),
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.65)),
        linear-gradient(180deg, #1b120c, #080604);
      
      border: 1px solid rgba(242,208,122,.25);
      box-shadow: 
        inset 0 0 12px rgba(0,0,0,.75),
        0 6px 16px rgba(0,0,0,.6),
        inset 0 0 0 1px rgba(0,0,0,.6);
      
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 3;
    }

    .sp-card:hover .power-plate {
      box-shadow: 
        inset 0 0 12px rgba(0,0,0,.75),
        0 8px 20px rgba(0,0,0,.7),
        inset 0 0 0 1px rgba(0,0,0,.6),
        0 0 15px color-mix(in srgb, var(--elem) 30%, transparent);
    }

    .sp-card.selected .power-plate {
      background:
        radial-gradient(180px 60px at 50% 0%, rgba(255,210,120,.20), transparent 70%),
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.65)),
        linear-gradient(180deg, color-mix(in srgb, var(--rar) 15%, #1b120c), color-mix(in srgb, var(--rar) 10%, #080604));
    }
    
    .power-value {
      font-size: 32px;
      font-weight: 900;
      color: var(--brass-0);
      font-variant-numeric: tabular-nums;
      text-shadow:
        0 2px 0 rgba(0,0,0,.75),
        0 0 12px rgba(255,210,120,.25);
      transition: all 0.3s ease;
    }

    .sp-card.selected .power-value {
      color: color-mix(in srgb, var(--rar) 40%, var(--brass-0));
      text-shadow:
        0 2px 0 rgba(0,0,0,.75),
        0 0 20px color-mix(in srgb, var(--rar) 50%, transparent);
    }
    
    .rarity-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 4px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,0.8);
      border: 1px solid var(--rar);
      color: var(--rar);
      font-size: 10px;
      font-weight: bold;
      letter-spacing: 1px;
      z-index: 3;
      text-transform: uppercase;
    }

    /* Deck Grid 3x3 */
    .deck-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
      align-items: start;
      justify-items: center;
    }

    /* –ö–∞—Ä—Ç–∏ –≤ –∫–æ–ª–æ–¥—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —Å—Ç–∏–ª—ñ –∑ steampunk-cards.css */


    /* ===== DUEL SCREEN ===== */
    .duel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .duel-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--brass-0);
    }
    .duel-start-btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(242,208,122,.25);
      background: linear-gradient(180deg, rgba(242,208,122,.25), rgba(0,0,0,.35));
      color: var(--brass-0);
      cursor: pointer;
    }
    .duel-hud {
      display: flex;
      gap: 12px;
      margin-bottom: 10px;
    }
    .duel-hp {
      flex: 1;
      padding: 10px;
      border: 1px solid rgba(242,208,122,.18);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,220,140,.06), rgba(0,0,0,.35));
      color: var(--brass-0);
    }
    .enemy-hand, .player-hand {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 10px 0 0px;
    }
    .player-hand {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 0px 0 8px;
    }
    .duel-multipliers {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 12px 0;
      min-height: 32px;
    }
    .duel-log {
      min-height: 50px;
      padding: 8px;
      margin: 0px 0 10px;
      border: 1px dashed rgba(242,208,122,.2);
      border-radius: 10px;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.4;
      text-align: center;
    }

    /* HUD: avatar + HP bar for enemy/player */
    .hud-status{
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:center;
      margin:8px 0;
    }
    .hud-status .avatar{
      width:56px;
      height:56px;
      border-radius:10px;
      background: linear-gradient(180deg, #2f1f14, #120c08);
      border: 2px solid rgba(242,208,122,0.16);
      box-shadow: inset 0 0 6px rgba(0,0,0,0.6), 0 6px 12px rgba(0,0,0,0.5);
      display:flex; align-items:center; justify-content:center; color:var(--brass-0); font-weight:800;
    }
    .hud-status .avatar.enemy-avatar{ box-shadow: inset 0 0 8px rgba(120,40,20,0.6), 0 6px 12px rgba(0,0,0,0.6); }
    .hud-status .avatar.player-avatar{ box-shadow: inset 0 0 8px rgba(40,120,20,0.6), 0 6px 12px rgba(0,0,0,0.6); }
    .hud-status .hp-wrapper{ flex:1; min-width:220px; }
    .hp-label{ font-size:13px; color:var(--muted); margin-bottom:6px; text-align:left; }
    .hp-bar{ height:12px; background: rgba(0,0,0,0.35); border-radius:10px; border:1px solid rgba(242,208,122,0.12); overflow:hidden; }
    .hp-fill{ height:100%; width:0%; background: linear-gradient(90deg, #4CAF50, #2e7d32); box-shadow: 0 0 8px rgba(46,204,113,0.12); transition: width 0.28s ease; }

    .preduel-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
    }
    .preduel-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,220,140,0.06), rgba(0,0,0,0.25));
      color: var(--ink);
      font-weight: 600;
    }
    .preduel-label { color: var(--muted); font-weight: 500; }
    .preduel-value { color: var(--brass-0); }
    .preduel-actions { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
    .duel-hand .sp-card, .enemy-hand .sp-card, .player-hand .sp-card {
      width: 160px;
      height: 220px;
    }
    /* Ensure duel grid cards have consistent size (desktop + mobile grid) */
    .duel-deck .sp-card,
    .duel-deck.mobile-grid .sp-card {
      width: 140px;
      height: 200px;
      min-width: 120px;
      min-height: 180px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* Slightly smaller cards for narrow screens */
    @media (max-width: 600px) {
      .duel-deck .sp-card,
      .duel-deck.mobile-grid .sp-card {
        width: 110px;
        height: 160px;
        min-width: 100px;
        min-height: 140px;
      }
    }
    /* Extras section */
    .extras-title {
      margin: 14px 4px 8px;
      color: rgba(242,208,122,.85);
      letter-spacing: 0.06em;
      text-align: center;
      font-weight: 700;
      font-size: 13px;
    }

    .extras-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 8px;
    }

    /* === –ï–õ–ï–ú–ï–ù–¢–ò –°–¢–ò–•–Ü–á === */
    .sp-card.fire  { --elem: var(--fire); }
    .sp-card.water { --elem: var(--water); }
    .sp-card.air   { --elem: var(--air); }
    .sp-card.earth { --elem: var(--earth); }
    .sp-card.steam { --elem: var(--steam); }
    .sp-card.mech  { --elem: var(--mech); }

    /* === –†–Ü–î–ö–û–°–¢–Ü === */
    .sp-card.common  { --rar: var(--common); }
    .sp-card.rare    { --rar: var(--rare); }
    .sp-card.epic    { --rar: var(--epic); }
    .sp-card.legend  { --rar: var(--legend); }

    /* –ê–Ω—ñ–º–∞—Ü—ñ—è —Å–≤—ñ—Ç—ñ–Ω–Ω—è */
    @media (prefers-reduced-motion: no-preference){
      .sp-card{
        animation: subtle-glow 3s ease-in-out infinite;
      }
      @keyframes subtle-glow{
        0%,100%{ filter: brightness(1.00); }
        50%    { filter: brightness(1.05); }
      }
    }

    .extra-slot {
      padding: 10px 8px;
      text-align: center;
      min-height: 90px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 8px;
    }

    .slot-icon {
      width: 38px;
      height: 38px;
      margin: 0 auto;
      border-radius: 12px;
      background: linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,.20);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.6);
      opacity: 0.75;
    }

    .slot-text {
      font-size: 12px;
      color: rgba(244,230,198,.86);
    }

    /* Link-like button */
    .link-like {
      text-align: center;
      color: rgba(159, 214, 255, .85);
      font-size: 12px;
      text-decoration: underline;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .link-like:hover {
      color: rgba(159, 214, 255, 1);
    }

    /* Menu list */
    .menu-list {
      padding: 6px;
    }

    .menu-row {
      width: 100%;
      background: transparent;
      color: rgba(244,230,198,.92);
      border: 1px solid rgba(242,208,122,.10);
      border-radius: 12px;
      padding: 12px 10px;
      margin: 6px 0;
      text-align: left;
      cursor: pointer;
      font-family: Georgia, "Times New Roman", serif;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .menu-row:hover {
      border-color: rgba(242,208,122,.25);
      background: rgba(255,210,120,.04);
    }

    .menu-row:active {
      transform: translateY(1px);
    }

    /* Auth overlay */
    .auth-overlay{
      position: fixed;
      inset: 0;
      background: rgba(8, 6, 5, 0.95);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .auth-overlay.hidden{
      opacity: 0;
      pointer-events: none;
      display: none;
    }

    .auth-box{
      width: min(380px, 90vw);
      background:
        linear-gradient(180deg, rgba(255,220,140,0.08), rgba(0,0,0,0.45)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 24px 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.75);
      position: relative;
    }
    .auth-box::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(242,208,122,0.35), rgba(213,143,85,0.18), rgba(90,50,20,0.10));
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      padding: 1px;
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
    }

    .auth-title{
      font-size: 24px;
      font-weight: 700;
      color: var(--brass-0);
      text-align: center;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.7);
    }
    .auth-subtitle{
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      margin-bottom: 24px;
    }

    .auth-tabs{
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 4px;
    }
    .auth-tab{
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      color: var(--muted);
      font-size: 14px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    .auth-tab:hover{
      background: rgba(255,210,120,0.05);
    }
    .auth-tab.active{
      background: linear-gradient(180deg, var(--brass-0), var(--brass-2));
      color: #14100c;
      font-weight: 700;
      border-color: rgba(255,230,140,0.3);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.4);
    }

    .auth-form{
      display: none;
    }
    .auth-form.active{
      display: block;
    }

    .form-group{
      margin-bottom: 16px;
    }
    .form-label{
      display: block;
      font-size: 13px;
      color: var(--brass-0);
      margin-bottom: 6px;
      font-weight: 600;
    }
    .form-input{
      width: 100%;
      padding: 12px 14px;
      background:
        linear-gradient(180deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6)),
        linear-gradient(180deg, #1a120c, #0c0907);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: 10px;
      color: var(--ink);
      font-family: Georgia, "Times New Roman", serif;
      font-size: 15px;
      box-shadow: inset 0 0 12px rgba(0,0,0,0.6);
      transition: border-color 0.2s ease;
    }
    .form-input:focus{
      outline: none;
      border-color: rgba(242,208,122,0.45);
      box-shadow: inset 0 0 12px rgba(0,0,0,0.6), 0 0 0 2px rgba(242,208,122,0.15);
    }
    .form-input::placeholder{
      color: rgba(208, 191, 154, 0.5);
    }

    .auth-btn{
      width: 100%;
      padding: 14px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-2));
      border: 1px solid rgba(255,230,140,0.35);
      border-radius: 12px;
      color: #14100c;
      font-family: Georgia, "Times New Roman", serif;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35), 0 6px 16px rgba(0,0,0,0.4);
      text-shadow: 0 1px 0 rgba(255,255,255,0.2);
    }
    .auth-btn:hover{
      filter: brightness(1.08);
      transform: translateY(-1px);
    }
    .auth-btn:active{
      transform: translateY(0);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.4);
    }

    .auth-error{
      display: none;
      margin-top: 12px;
      padding: 10px 12px;
      background: rgba(180, 50, 40, 0.2);
      border: 1px solid rgba(220, 80, 60, 0.4);
      border-radius: 8px;
      color: #ffcccc;
      font-size: 13px;
      text-align: center;
    }
    .auth-error.show{
      display: block;
    }
    .burn-arrow {
      position: absolute;
      left: 8px;
      bottom: 8px;
      font-size: 1.5rem;
      color: #3cff3c;
      line-height: 1;
      font-weight: bold;
      pointer-events: none;
      z-index: 2;
      text-shadow: 0 2px 8px #000a, 0 0 6px #3cff3c99;
      filter: drop-shadow(0 0 2px #000) drop-shadow(0 0 4px #3cff3c);
      background: none;
      border-radius: 50%;
      padding: 0;
    }
    .weaker-card-item {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 180px;
    }
    /* Mobile: force 3 cards per row and compact card tiles */
    @media (max-width: 480px) {
      .collection-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 6px;
      }
      .collection-card-item {
        padding: 6px 4px;
        min-height: 70px;
      }
      .collection-card-name { font-size: 12px; }
      .collection-card-status { font-size: 10px; }
    }
    /* Canonical 3x3 layout for narrow screens (<=425px) to prevent reflow/pulsation */
    @media (max-width: 430px) {
      /* remove extra container paddings that break available width */
      #app-shell { padding-left: 4px; padding-right: 4px; }
      #root, .container { padding-left: 0; padding-right: 0; }

      /* canonical grid for decks and lists */
      .deck-grid, .grid-3x3, .duel-deck {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 6px;
        width: 100%;
        margin: 0;
        padding: 0 4px;
        align-items: start;
        align-content: start;
      }

      /* card sizing: grid controls width, card keeps fixed aspect-ratio (no px widths) */
      .deck-grid .sp-card,
      .grid-3x3 .sp-card,
      .duel-deck .sp-card,
      .sp-card {
        width: 100%;
        aspect-ratio: 3 / 4.4;
        min-height: 0;

        position: relative;
        overflow: hidden;

        border-radius: 14px;
        box-shadow:
          0 6px 18px rgba(0,0,0,.6),
          inset 0 0 18px rgba(0,0,0,.75);

        transform: translateZ(0);
        will-change: transform;
        padding: 6px;
      }
    }
  </style>
</head>
<body>
  <!-- Auth overlay -->
  <div class="auth-overlay hidden" id="authOverlay">
    <div class="auth-box">
      <h1 class="auth-title">‚öôÔ∏è cardastika</h1>
      <p class="auth-subtitle">–°—Ç—ñ–º–ø–∞–Ω–∫ –∫–∞—Ä—Ç–æ–≤–∞ –≥—Ä–∞</p>

      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">–í—Ö—ñ–¥</div>
        <div class="auth-tab" data-tab="register">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</div>
      </div>

      <!-- Login Form -->
      <form class="auth-form active" id="loginForm">
        <div class="form-group">
          <label for="loginUsername" class="form-label">–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
          <input type="text" class="form-input" id="loginUsername" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è" required>
        </div>
        <button type="submit" class="auth-btn">–£–≤—ñ–π—Ç–∏</button>
        <div class="auth-error" id="loginError"></div>
      </form>

      <!-- Register Form -->
      <form class="auth-form" id="registerForm">
        <div class="form-group">
          <label for="registerUsername" class="form-label">–Ü–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</label>
          <input type="text" class="form-input" id="registerUsername" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è" required minlength="3" maxlength="20">
        </div>
        <button type="submit" class="auth-btn">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è</button>
        <div class="auth-error" id="registerError"></div>
      </form>
    </div>
  </div>

  <div class="phone" id="app">
    <div class="noise"></div>

    <header class="topbar">
      <!-- HUD XP Row moved above toprow so XP bar appears above HUD -->
      <div class="hud-xp-row" aria-label="HUD XP Row">
        <div id="xpFill" class="hud-xp-row__fill" style="transform: scaleX(0);"></div>
        <div id="xpPct" class="hud-xp-row__label">0% (0 / 0)</div>
      </div>
      <div class="toprow">
        <div class="avatar">
          <div class="portrait" aria-hidden="true"></div>
          <div class="level">–†—ñ–≤–µ–Ω—å: <span>1</span></div>
        </div>

        <div class="meters">
          <div class="meter" title="–ë–æ–ª—Ç–∏"><span>üî©</span><strong id="home-bolts">500</strong></div>
          <div class="meter" title="–®–µ—Å—Ç–µ—Ä–Ω—ñ"><span>‚öôÔ∏è</span><strong id="home-gears">0</strong></div>
          <div class="meter" title="–ü–∞—Ä–æ–≤—ñ —è–¥—Ä–∞"><span>‚ú¥Ô∏é</span><strong id="home-cores">0</strong></div>
        </div>
      </div>
      <div class="hud-xpline" aria-label="–î–æ—Å–≤—ñ–¥">
        <span class="hud-xpfill"></span>
      </div>
    </header>

    <!-- Main content container -->
    <div id="main-content">
      <!-- Bag Page -->
      <section class="page" id="page-bag">
        <div class="page-header">
          <button class="back-btn" id="bag-back-btn">‚Üê –ù–∞–∑–∞–¥</button>
          <h2 class="page-title">–°—É–º–∫–∞</h2>
        </div>
        <div class="page-content">
          <div id="bag-cards-list" class="cards-list"></div>
        </div>
      </section>
      
      <!-- Home Page -->
      <section class="page active" id="page-home">
        <section class="tiles" aria-label="–†–µ–∂–∏–º–∏">
          <div class="tile" data-page="duels">
            <div class="rivets">
              <span class="rivet r1"></span><span class="rivet r2"></span><span class="rivet r3"></span><span class="rivet r4"></span>
            </div>
            <div class="icon" aria-hidden="true"></div>
            <div class="label">–î—É–µ–ª—ñ</div>
            <div class="sub">–°–ø—Ä–æ–±–∏: 10</div>
          </div>

          <div class="tile" data-page="arena">
            <div class="rivets">
              <span class="rivet r1"></span><span class="rivet r2"></span><span class="rivet r3"></span><span class="rivet r4"></span>
            </div>
            <div class="icon" aria-hidden="true"></div>
            <div class="label">–ê—Ä–µ–Ω–∞</div>
            <div class="sub">–ë—ñ–π</div>
          </div>

          <div class="tile" data-page="deck">
            <div class="rivets">
              <span class="rivet r1"></span><span class="rivet r2"></span><span class="rivet r3"></span><span class="rivet r4"></span>
            </div>
            <div class="icon" aria-hidden="true"></div>
            <div class="label">–ë–æ–π–æ–≤–∞ –∫–æ–ª–æ–¥–∞</div>
            <div class="sub">–°–∏–ª–∞: <span id="deck-power-home">0</span></div>
          </div>
        </section>

        <section class="list" aria-label="–ú–µ–Ω—é">
          <div class="item" data-page="tasks">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">–ó–∞–≤–¥–∞–Ω–Ω—è</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="rewards">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">–î—ñ–∞–º–∞–Ω—Ç–æ–≤—ñ –Ω–∞–≥–æ—Ä–æ–¥–∏</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          

          <div class="item" data-page="collections">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">–ö–æ–ª–µ–∫—Ü—ñ—ó</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="bag">
            <button type="button" id="menu-bag-btn">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">–°—É–º–∫–∞</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="shop">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">–ú–∞–≥–∞–∑–∏–Ω</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="buy-gold">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">–ö—É–ø–∏—Ç–∏ –∑–æ–ª–æ—Ç–æ</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>
        </section>

        <section class="promo" aria-label="–ê–∫—Ü—ñ—è">
          <div class="badge">–ê–∫—Ü—ñ—è</div>
          <div class="line">–í—ñ–¥ 250 –¥–æ 1250 —É –ø–æ–¥–∞—Ä—É–Ω–æ–∫</div>
          <div class="sub">–û—Å—Ç–∞–Ω–Ω—ñ–π –¥–µ–Ω—å. –ü–∞—Ä–∞ —Ç–∞ –º–µ—Ö–∞–Ω—ñ–∫–∞ –Ω–µ —á–µ–∫–∞—é—Ç—å.</div>
        </section>
      </section>

      <!-- Duels Page -->
      <section class="page" id="page-duels">
        <div class="page-header">
          <button class="back-btn" data-page="home">‚Üê –ù–∞–∑–∞–¥</button>
          <h2 class="page-title">–î—É–µ–ª—ñ</h2>
        </div>
        <div class="page-content panel">
          <div class="duel-header">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–±—Ä–∞–Ω: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è -->
            <button class="duel-start-btn" id="duel-start-btn">–ü–æ—á–∞—Ç–∏ –¥—É–µ–ª—å</button>
          </div>
          <div class="duel-hud">
            <div class="duel-hp duel-power"><strong>–°–∏–ª–∞ –∫–æ–ª–æ–¥:</strong> <span id="enemyPower">0</span> / <span id="playerPower">0</span></div>
          </div>

          <!-- HUD –Ω–∞–¥ —Ä—É–∫–æ—é –≤–æ—Ä–æ–≥–∞: –∞–≤–∞—Ç–∞—Ä —ñ —Å–º—É–≥–∞ HP -->
          <div class="enemy-status hud-status">
            <div class="avatar enemy-avatar" id="enemyAvatar">üëæ</div>
            <div class="hp-wrapper">
              <div class="hp-label"><strong>–í–æ—Ä–æ–≥:</strong> <span id="enemyHpText">0/0</span></div>
              <div class="hp-bar"><div id="enemyHpBar" class="hp-fill" style="width:0%"></div></div>
            </div>
          </div>

          <div class="enemy-hand" id="enemyHand"></div>
          <div class="duel-multipliers" id="duelMultipliers"></div>
          <div class="player-hand" id="playerHand"></div>

          <!-- HUD –ø—ñ–¥ —Ä—É–∫–æ—é –≥—Ä–∞–≤—Ü—è: –∞–≤–∞—Ç–∞—Ä —ñ —Å–º—É–≥–∞ HP -->
          <div class="player-status hud-status">
            <div class="avatar player-avatar" id="playerAvatar">üôÇ</div>
            <div class="hp-wrapper">
              <div class="hp-label"><strong>–í–∏:</strong> <span id="playerHpText">0/0</span></div>
              <div class="hp-bar"><div id="playerHpBar" class="hp-fill" style="width:0%"></div></div>
            </div>
          </div>
          <div class="duel-log" id="duelLog"></div>
        </div>
      </section>

      <!-- Arena Page -->
      <section class="page" id="page-arena">
        <div class="page-header">
          <button class="back-btn" data-page="home">‚Üê –ù–∞–∑–∞–¥</button>
          <h2 class="page-title">–ê—Ä–µ–Ω–∞</h2>
        </div>
        <div class="page-content">
          <div class="info-card">
            <div class="info-label">–ü–æ—Ç–æ—á–Ω–∏–π —Ä–∞–Ω–≥</div>
            <div class="info-value">–ó–æ–ª–æ—Ç–æ III</div>
          </div>
          <div class="info-card">
            <div class="info-label">–†–µ–π—Ç–∏–Ω–≥</div>
            <div class="info-value">1847</div>
          </div>
          <button class="action-btn">–£–≤—ñ–π—Ç–∏ –≤ –∞—Ä–µ–Ω—É</button>
          <div class="description">
            –†–µ–π—Ç–∏–Ω–≥–æ–≤—ñ –±–æ—ó –∑–∞ —Ä–∞–Ω–≥–∏. –ü—ñ–¥–Ω—ñ–º–∞–π—Ç–µ—Å—è –≤–≥–æ—Ä—É –∑–∞ —Ç–∞–±–ª–∏—Ü–µ—é –ª—ñ–¥–µ—Ä—ñ–≤ —ñ –æ—Ç—Ä–∏–º—É–π—Ç–µ –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω—ñ –Ω–∞–≥–æ—Ä–æ–¥–∏.
          </div>
        </div>
      </section>

      <!-- Deck Page -->
      <section class="page" id="page-deck">
        <div class="screen">
          
          <!-- Topbar -->
          <header class="topbar">
            <button class="back-btn" data-page="home" style="flex: 0; padding: 6px 10px; font-size: 13px;">‚Üê –ù–∞–∑–∞–¥</button>
          </header>

          <!-- Deck Header -->
          <div class="deck-header panel">
            <div class="deck-title">–ë–û–ô–û–í–ê –ö–û–õ–û–î–ê</div>
            <div class="deck-power">‚öô <span id="deck-power-value">190</span></div>
          </div>

          <div class="hint panel subtle" id="deck-hint">‚¨Ü –ü–æ–ª—ñ–ø—à—É–π—Ç–µ –∫–∞—Ä—Ç–∏!</div>

          <!-- 3x3 Grid -->
          <section class="deck-grid" id="deckGrid">
            <!-- –ö–∞—Ä—Ç–∏ —Ä–µ–Ω–¥–µ—Ä–∏–º–æ JavaScript -->
          </section>

          <!-- Extras Section -->
          <div class="extras-title">–î–æ–¥–∞—Ç–∫–æ–≤—ñ –∫–∞—Ä—Ç–∏</div>

          <section class="extras-grid">
            <div class="extra-slot panel subtle">
              <div class="slot-icon"></div>
              <div class="slot-text">–°–æ—é–∑–Ω–∏–∫</div>
            </div>
            <div class="extra-slot panel subtle">
              <div class="slot-icon"></div>
              <div class="slot-text">–ì—ñ–ª—å–¥—ñ—è</div>
            </div>
            <div class="extra-slot panel subtle">
              <div class="slot-icon"></div>
              <div class="slot-text">–ê—Ä—Ç–µ—Ñ–∞–∫—Ç</div>
            </div>
          </section>

          <div class="link-like">‚ìò –î–µ –≤–∑—è—Ç–∏ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –∫–∞—Ä—Ç–∏</div>

          <!-- Menu List -->
          <section class="menu-list panel">
            <button class="menu-row" data-page="duels">‚öî –î—É–µ–ª—ñ</button>
            <button class="menu-row" data-page="arena">üèõ –ê—Ä–µ–Ω–∞</button>
            <button class="menu-row" data-page="shop">üõç –ú–∞–≥–∞–∑–∏–Ω</button>
          </section>

        </div>
      </section>

      <!-- Tasks Page -->
      <section class="page" id="page-tasks">
        <div class="page-header">
          <button class="back-btn" data-page="home">‚Üê –ù–∞–∑–∞–¥</button>
          <h2 class="page-title">–ó–∞–≤–¥–∞–Ω–Ω—è</h2>
        </div>
        <div class="page-content">
          <div class="task-item">
            <div class="task-text">–í–∏–≥—Ä–∞–π—Ç–µ 3 –¥—É–µ–ª—ñ</div>
            <div class="task-progress">1/3</div>
            <div class="task-reward">+50 XP, 5 –∑–æ–ª–æ—Ç–∞</div>
          </div>
          <div class="task-item completed">
            <div class="task-text">–£–≤—ñ–π–¥—ñ—Ç—å —É –≥—Ä—É</div>
            <div class="task-progress">‚úì</div>
            <div class="task-reward">+10 XP</div>
          </div>
          <div class="task-item">
            <div class="task-text">–ó–±–µ—Ä—ñ—Ç—å 100 –∫—Ä–∏—Å—Ç–∞–ª—ñ–≤</div>
            <div class="task-progress">67/100</div>
            <div class="task-reward">+100 XP, 20 –∑–æ–ª–æ—Ç–∞</div>
          </div>
        </div>
      </section>

      <!-- Rewards Page -->
      <section class="page" id="page-rewards">
        <div class="page-header">
          <button class="back-btn" data-page="home">‚Üê –ù–∞–∑–∞–¥</button>
          <h2 class="page-title">–î—ñ–∞–º–∞–Ω—Ç–æ–≤—ñ –Ω–∞–≥–æ—Ä–æ–¥–∏</h2>
        </div>
        <div class="page-content">
          <div class="reward-item available">
            <div class="reward-icon">üíé</div>
            <div class="reward-text">–©–æ–¥–µ–Ω–Ω–∞ –Ω–∞–≥–æ—Ä–æ–¥–∞</div>
            <button class="claim-btn">–û—Ç—Ä–∏–º–∞—Ç–∏</button>
          </div>
          <div class="reward-item locked">
            <div class="reward-icon">üèÜ</div>
            <div class="reward-text">–î–æ—Å—è–≥–Ω–µ–Ω–Ω—è: 10 –ø–µ—Ä–µ–º–æ–≥</div>
            <div class="reward-progress">8/10</div>
          </div>
          <div class="reward-item locked">
            <div class="reward-icon">‚≠ê</div>
            <div class="reward-text">–†–∞–Ω–≥–æ–≤–∞ –Ω–∞–≥–æ—Ä–æ–¥–∞</div>
            <div class="reward-progress">–°—Ä—ñ–±–ª–æ II –ø–æ—Ç—Ä—ñ–±–Ω–æ</div>
          </div>
        </div>
      </section>

      

      <!-- Collections Page -->
      <section class="page" id="page-collections">
        <div class="page-header">
          <button class="back-btn" data-page="home">‚Üê –ù–∞–∑–∞–¥</button>
          <h2 class="page-title">–ö–æ–ª–µ–∫—Ü—ñ—ó</h2>
        </div>
        <div class="page-content">
          <div class="collection-set">
            <div class="collection-set" id="fire-set">
              <div class="set-name">–í–æ–≥–Ω—è–Ω–∞ —Å—Ç–∏—Ö—ñ—è</div>
              <div class="set-progress" id="fire-progress">0/4 –∫–∞—Ä—Ç</div>
              <div class="set-bonus">+10% –¥–æ –≤–æ–≥–Ω—è–Ω–æ—ó —à–∫–æ–¥–∏</div>
              <div class="collection-grid" id="fire-collection"></div>
            </div>
            <div class="collection-set" id="water-set">
              <div class="set-name">–í–æ–¥—è–Ω–∞ —Å—Ç–∏—Ö—ñ—è</div>
              <div class="set-progress" id="water-progress">0/4 –∫–∞—Ä—Ç</div>
              <div class="set-bonus">+10% –¥–æ –≤–æ–¥—è–Ω–æ—ó —à–∫–æ–¥–∏</div>
              <div class="collection-grid" id="water-collection"></div>
            </div>
            <div class="collection-set" id="air-set">
              <div class="set-name">–ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Å—Ç–∏—Ö—ñ—è</div>
              <div class="set-progress" id="air-progress">0/4 –∫–∞—Ä—Ç</div>
              <div class="set-bonus">+10% –¥–æ –ø–æ–≤—ñ—Ç—Ä—è–Ω–æ—ó —à–∫–æ–¥–∏</div>
              <div class="collection-grid" id="air-collection"></div>
            </div>
            <div class="collection-set" id="earth-set">
              <div class="set-name">–ó–µ–º–ª—è–Ω–∞ —Å—Ç–∏—Ö—ñ—è</div>
              <div class="set-progress" id="earth-progress">0/4 –∫–∞—Ä—Ç</div>
              <div class="set-bonus">+10% –¥–æ –∑–µ–º–ª—è–Ω–æ—ó —à–∫–æ–¥–∏</div>
              <div class="collection-grid" id="earth-collection"></div>
            </div>
        </div>
      </section>

      <!-- Card Details Page -->
      <section class="page" id="page-card-details">
        <div class="page-header">
          <button class="back-btn" id="card-details-back">‚Üê –ù–∞–∑–∞–¥</button>
          <h2 class="page-title">–î–µ—Ç–∞–ª—ñ –∫–∞—Ä—Ç–∏</h2>
        </div>
        <div class="page-content">
          <!-- Main Card Display -->
          <div class="card-main-display panel" id="card-main-info">
            <!-- –†–µ–Ω–¥–µ—Ä–∏–º–æ —á–µ—Ä–µ–∑ JavaScript -->
          </div>

          <!-- Card Upgrade Scale (–Ω–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞ XP) -->
          <div class="card-upgrade" id="card-upgrade-section">
            <div class="upgrade-header">
              <span id="cu-level">LV 1</span>
              <span id="cu-xp-text">0 / 20 XP</span>
            </div>
            <div class="xp-bar">
              <div class="xp-fill" id="cu-xp-fill"></div>
            </div>
            
          </div>

          <!-- Comparison Section -->
          <div class="card-comparison">
            <h3 class="comparison-title" id="weaker-cards-header">üìä –°–ª–∞–±—à—ñ –∫–∞—Ä—Ç–∏ —Ç—ñ—î—ó –∂ —Å—Ç–∏—Ö—ñ—ó</h3>
            <div id="weaker-cards-list" class="weaker-cards">
              <!-- –°–ø–∏—Å–æ–∫ —Å–ª–∞–±—à–∏—Ö –∫–∞—Ä—Ç -->
            </div>
          </div>

          <!-- Action Buttons -->
        </div>
      </section>

      <!-- Shop Page -->
      <section class="page" id="page-shop">
        <div class="page-header">
          <button class="back-btn" data-page="home">‚Üê –ù–∞–∑–∞–¥</button>
          <h2 class="page-title">–ú–∞–≥—ñ—á–Ω—ñ –ö–∞—Ä—Ç–∏</h2>
        </div>
        <div class="page-content">
          
          <!-- Special Offers Section -->
          <div class="shop-section">
            <div class="shop-section-title">‚≠ê –ù–∞–±–æ—Ä–∏ –ø–æ –∞–∫—Ü—ñ—ó!</div>
            <div class="shop-notice">
              –ö—É–ø—É–π—Ç–µ –Ω–∞–±–æ—Ä–∏ –ø–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ–π —Ü—ñ–Ω—ñ! –î–æ—Å—Ç—É–ø–Ω–æ —Ç—ñ–ª—å–∫–∏ —Ä–∞–∑!
            </div>
            <div id="offers-container">
              <!-- Special offers will be rendered here -->
            </div>
          </div>

          <!-- Single Cards Section -->
          <div class="shop-section">
            <div class="shop-section-title">üÉè –ü–æ –æ–¥–Ω—ñ–π –∫–∞—Ä—Ç—ñ</div>
            <div id="single-cards-container">
              <!-- Single card offers will be rendered here -->
            </div>
          </div>

        </div>
      </section>

      <!-- Pack Opening Modal -->
      <div class="pack-modal" id="pack-modal">
        <div class="pack-modal-content">
          <div class="pack-modal-header">
            <div class="pack-modal-title">–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏:</div>
            <div class="pack-modal-subtitle">–ö–∞—Ä—Ç–∏ –¥–æ–¥–∞–Ω–æ –≤ –∫–æ–ª–µ–∫—Ü—ñ—é</div>
          </div>
          <div class="pack-rewards" id="pack-rewards">
            <!-- Rewards will be rendered here -->
          </div>
          <button class="pack-modal-btn" id="pack-modal-close">–ü—Ä–∏–π–Ω—è—Ç–∏</button>
        </div>
      </div>

      <!-- Duel Result Modal -->
      <div class="pack-modal" id="duel-result-modal">
        <div class="pack-modal-content">
          <div class="pack-modal-header">
            <div class="pack-modal-title" id="duel-result-title">–ü–µ—Ä–µ–º–æ–≥–∞!</div>
            <div class="pack-modal-subtitle" id="duel-result-subtitle">–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏:</div>
          </div>
          <div class="duel-result-rewards" id="duel-result-rewards">
            <!-- Rewards displayed here -->
          </div>
          <div class="duel-result-stats-info">
            <div class="duel-wins-info" id="duel-wins-info">–ü–æ–±—ñ–¥ –≤ –¥—É–µ–ª—è—Ö: üèÜ 0</div>
          </div>
          <button class="pack-modal-btn duel-next-btn" id="duel-result-close">–©–µ –¥—É–µ–ª—å</button>
          <div class="duel-battle-summary">
            <div class="duel-summary-title">–ü—ñ–¥—Å—É–º–∫–∏ –±–æ—é</div>
            <div class="duel-summary-hp">
              <span>‚ô• <span id="duel-summary-player-hp">0</span></span>
            </div>
            <div class="duel-battle-cards" id="duel-battle-cards">
              <!-- Battle cards summary -->
            </div>
          </div>
        </div>
      </div>

      <!-- Pre-duel modal -->
      <div class="pack-modal" id="duel-pre-modal">
        <div class="pack-modal-content" style="max-width:460px; text-align:center;">
          <div class="pack-modal-header">
            <div class="pack-modal-title">–ó–Ω–∞–π–¥–µ–Ω–æ —Å—É–ø–µ—Ä–Ω–∏–∫–∞</div>
            <div class="pack-modal-subtitle">–ü–µ—Ä–µ–≤—ñ—Ä —Å–∏–ª—É –∫–æ–ª–æ–¥ —ñ –Ω–∞—Ç–∏—Å–Ω–∏ ¬´–ù–∞–ø–∞—Å—Ç–∏¬ª</div>
          </div>
          <div class="preduel-body">
            <div class="preduel-row">
              <div class="preduel-label">–°—É–ø–µ—Ä–Ω–∏–∫</div>
              <div class="preduel-value" id="duel-pre-name">‚Äî</div>
            </div>
            <div class="preduel-row">
              <div class="preduel-label">–°–∏–ª–∞ –≤–æ—Ä–æ–≥–∞</div>
              <div class="preduel-value" id="duel-pre-power">0</div>
            </div>
            <div class="preduel-row">
              <div class="preduel-label">–¢–≤–æ—è —Å–∏–ª–∞</div>
              <div class="preduel-value" id="duel-pre-player-power">0</div>
            </div>
          </div>
          <div class="preduel-actions">
            <button class="pack-modal-btn" id="duel-pre-attack">–ù–∞–ø–∞—Å—Ç–∏</button>
            <button class="pack-modal-btn secondary" id="duel-pre-reroll">–®—É–∫–∞—Ç–∏ —â–µ</button>
          </div>
        </div>
      </div>

      <!-- Buy Gold Page -->
      <section class="page" id="page-buy-gold">
        <div class="page-header">
          <button class="back-btn" data-page="home">‚Üê –ù–∞–∑–∞–¥</button>
          <h2 class="page-title">–ö—É–ø–∏—Ç–∏ –∑–æ–ª–æ—Ç–æ</h2>
        </div>
        <div class="page-content">
          <div class="gold-pack">
            <div class="pack-amount">100 –∑–æ–ª–æ—Ç–∞</div>
            <div class="pack-price">50 –∫—Ä–∏—Å—Ç–∞–ª—ñ–≤</div>
            <button class="exchange-btn">–û–±–º—ñ–Ω—è—Ç–∏</button>
          </div>
          <div class="gold-pack featured">
            <div class="pack-badge">–ê–∫—Ü—ñ—è</div>
            <div class="pack-amount">500 –∑–æ–ª–æ—Ç–∞</div>
            <div class="pack-price">200 –∫—Ä–∏—Å—Ç–∞–ª—ñ–≤</div>
            <div class="pack-bonus">+50 –±–æ–Ω—É—Å</div>
            <button class="exchange-btn">–û–±–º—ñ–Ω—è—Ç–∏</button>
          </div>
          <div class="gold-pack">
            <div class="pack-amount">1000 –∑–æ–ª–æ—Ç–∞</div>
            <div class="pack-price">350 –∫—Ä–∏—Å—Ç–∞–ª—ñ–≤</div>
            <button class="exchange-btn">–û–±–º—ñ–Ω—è—Ç–∏</button>
          </div>
        </div>
      </section>

      <!-- Profile Page -->
      <section class="page" id="page-profile">
        <div class="page-header">
          <h2 class="page-title">–ü—Ä–æ—Ñ—ñ–ª—å</h2>
        </div>
        <div class="page-content">
          <div class="profile-stat">
            <div class="stat-label">–†—ñ–≤–µ–Ω—å</div>
            <div class="stat-value" id="profile-level">1</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">–î–æ—Å–≤—ñ–¥</div>
            <div class="stat-value" id="profile-xp">0/100</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">–ü–µ—Ä–µ–º–æ–≥</div>
            <div class="stat-value" id="profile-wins">0</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">–ü–æ—Ä–∞–∑–æ–∫</div>
            <div class="stat-value" id="profile-losses">0</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">–Ü–≥–æ—Ä –∑—ñ–≥—Ä–∞–Ω–æ</div>
            <div class="stat-value" id="profile-games">0</div>
          </div>
          <button class="action-btn logout-btn">–í–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É</button>
        </div>
      </section>

      <!-- Guild Page -->
      <section class="page" id="page-guild">
        <div class="page-header">
          <h2 class="page-title">–ì—ñ–ª—å–¥—ñ—è</h2>
        </div>
        <div class="page-content">
          <div class="guild-status">
            <div class="status-text">–í–∏ –Ω–µ –≤ –≥—ñ–ª—å–¥—ñ—ó</div>
          </div>
          <button class="action-btn">–°—Ç–≤–æ—Ä–∏—Ç–∏ –≥—ñ–ª—å–¥—ñ—é</button>
          <button class="action-btn secondary">–ó–Ω–∞–π—Ç–∏ –≥—ñ–ª—å–¥—ñ—é</button>
          <div class="description">
            –ü—Ä–∏—î–¥–Ω–∞–π—Ç–µ—Å—è –¥–æ –≥—ñ–ª—å–¥—ñ—ó, —â–æ–± —Å–ø—ñ–≤–ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑ —ñ–Ω—à–∏–º–∏ –≥—Ä–∞–≤—Ü—è–º–∏, –±—Ä–∞—Ç–∏ —É—á–∞—Å—Ç—å —É –≥—ñ–ª—å–¥—ñ–π—Å—å–∫–∏—Ö –ø–æ–¥—ñ—è—Ö —Ç–∞ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –æ—Å–æ–±–ª–∏–≤—ñ –±–æ–Ω—É—Å–∏.
          </div>
        </div>
      </section>

    </div>

    <nav class="bottom" aria-label="–ù–∞–≤—ñ–≥–∞—Ü—ñ—è">
      <div class="navbtn active" id="nav-home" data-tab="home">
        <div class="ico" aria-hidden="true"></div>
        <div class="t">–ì–æ–ª–æ–≤–Ω–∞</div>
      </div>
      <div class="navbtn" id="nav-profile" data-tab="profile">
        <div class="ico" aria-hidden="true"></div>
        <div class="t">–ü—Ä–æ—Ñ—ñ–ª—å</div>
      </div>
      <div class="navbtn" id="nav-guild" data-tab="guild">
        <div class="ico" aria-hidden="true"></div>
        <div class="t">–ì—ñ–ª—å–¥—ñ—è</div>
      </div>
    </nav>
  </div>

  <!-- Card System Scripts -->
  <script src="js/data/cards.js"></script>
  <script src="js/game/power.js"></script>
  <script src="js/game/drop.js"></script>
  <script src="js/data/cards_index.js"></script>
  <script src="js/game/currencies.js"></script>
  <script src="card-renderer.js"></script>
  <!-- Duel Engine Scripts -->
  <script src="js/game/elements.js"></script>

  <script src="js/game/duel_runtime.js"></script>
  <!-- CardView global for modal rendering -->
  <script src="js/ui/components/CardView.global.js"></script>

  <script>
    // Initialize CardRenderer
    window.addEventListener('DOMContentLoaded', () => {
      window.cardRenderer = new CardRenderer();
      console.log('CardRenderer initialized');
    });
    
    // –î–µ–ª–µ–≥–æ–≤–∞–Ω–∏–π –ø–∞—Ä–∞–ª–∞–∫—Å –µ—Ñ–µ–∫—Ç –¥–ª—è –≤—Å—ñ—Ö –∫–∞—Ä—Ç
    function initCardParallax() {
      document.addEventListener('mousemove', (e) => {
        const card = e.target.closest('.sp-card');
        if (!card) return;
        
        // –ù–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—é –Ω–∞ –∫–∞—Ä—Ç—É, —è–∫—â–æ –≤–æ–Ω–∞ –Ω–µ –≤ :hover
        // —Ü–µ –∑–∞–ø–æ–±—ñ–≥–∞—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞–º –∑ –ø–æ–∑–∏—Ü—ñ—é–≤–∞–Ω–Ω—è–º –¥—ñ—Ç–µ–π
        if (!card.matches(':hover')) {
          return;
        }

        const rect = card.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        const x = (e.clientX - centerX) / 50;
        const y = (e.clientY - centerY) / 50;

        // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –±–∞–∑–æ–≤—ñ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—ó, —è–∫—ñ –Ω–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—é—Ç—å –∑ –¥—ñ—Ç—å–º–∏
        card.style.transform = `perspective(1000px) rotateX(${5 - y}deg) rotateY(${-2 + x}deg)`;
      });

      // –°–∫–∏–¥–∞–Ω–Ω—è —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–∏ –≤–∏—Ö–æ–¥—ñ
      document.addEventListener('mouseleave', (e) => {
        const card = e.target.closest?.('.sp-card');
        if (card) {
          card.style.transform = '';
        }
      }, true);
    }
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ø–∞—Ä–∞–ª–∞–∫—Å –ø—ñ—Å–ª—è DOMContentLoaded
    window.addEventListener('DOMContentLoaded', () => {
      initCardParallax();
    });

    // LocalStorage management
    const storage = {
      get(key, defaultValue = null) {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : defaultValue;
        } catch (error) {
          console.error(`Error reading localStorage (${key}):`, error);
          return defaultValue;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
          return true;
        } catch (error) {
          console.error(`Error writing localStorage (${key}):`, error);
          return false;
        }
      }
    };

    // Helper: update full HUD XP bar + text
    function updateHudXP(currentXP, maxXP) {
      const pctNum = (maxXP && maxXP > 0) ? Math.max(0, Math.min(1, currentXP / maxXP)) : 0;
      const pctText = Math.round(pctNum * 100);

      // Preferred: new row-based HUD using transform: scaleX
      const xpFillEl = document.getElementById('xpFill');
      const xpPctEl = document.getElementById('xpPct');
      try {
        if (!xpFillEl) console.warn('HUD XP: #xpFill not found');
        if (!xpPctEl) console.warn('HUD XP: #xpPct not found');
        if (xpFillEl) {
          xpFillEl.style.transform = `scaleX(${pctNum})`;
          xpFillEl.style.transformOrigin = 'left center';
        }
        if (xpPctEl) {
          xpPctEl.textContent = `${pctText}% (${currentXP} / ${maxXP})`;
        }

        // Fallback: legacy hud-xp element (width-based)
        const legacyFill = document.querySelector('.hud-xp .xp-fill');
        const legacyText = document.querySelector('.hud-xp-text');
        if (legacyFill) legacyFill.style.width = pctText + '%';
        if (legacyText && !xpPctEl) legacyText.textContent = `${pctText}% (${currentXP} / ${maxXP})`;
      } catch (e) {
        console.warn('updateHudXP error', e);
      }
    }

    // expose to global for console/debugging
    try { window.updateHudXP = updateHudXP; } catch (e) { /* ignore */ }

    // User profile management
    const userProfile = {
      STORAGE_KEY: 'elem_user_profile',
      USERS_KEY: 'elem_users',
      
      // Get all registered users
      getAllUsers() {
        return storage.get(this.USERS_KEY, {});
      },
      
      // Save all users
      saveAllUsers(users) {
        return storage.set(this.USERS_KEY, users);
      },
      
      // Check if username exists
      userExists(username) {
        const users = this.getAllUsers();
        return users.hasOwnProperty(username);
      },
      
      // Register new user
      registerUser(username) {
        if (this.userExists(username)) {
          return { success: false, error: '–¶–µ —ñ–º\'—è –≤–∂–µ –∑–∞–π–Ω—è—Ç–µ' };
        }
        
        if (username.length < 3) {
          return { success: false, error: '–Ü–º\'—è –º–∞—î –±—É—Ç–∏ –Ω–µ –º–µ–Ω—à–µ 3 —Å–∏–º–≤–æ–ª—ñ–≤' };
        }
        
        // Generate random 16 starter cards (4 per element)
        const starterIds = (window.getRandomStarterCardIds && window.getRandomStarterCardIds(16))
          || (window.getStarterCardIds && window.getStarterCardIds())
          || [];

        // Fallback to any cards if starters unavailable
        const pool = starterIds.length ? starterIds : (window.ALL_CARDS || []).map(c => c.id);

        // Shuffle ids
        const shuffled = [...pool];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }

        const selectedIds = shuffled.slice(0, 16);
        const selectedCards = selectedIds
          .map(id => (window.getCardById ? window.getCardById(id) : null))
          .filter(Boolean);
        
        // First 9 go to deck, rest go to collection
        const deckCards = selectedCards.slice(0, 9).map(card => ({
          id: card.id,
          level: 1
        }));
        const collectionCards = selectedCards.slice(9, 16).map(card => ({
          id: card.id,
          level: 1
        }));
        
        // Initialize progress (XP) for each card
        const progress = {};
        selectedCards.forEach(card => {
          progress[card.id] = { level: 1, xp: 0 };
        });
        
        // Initialize inventory: count of each card
        const inventory = {};
        selectedCards.forEach(card => {
          inventory[card.id] = (inventory[card.id] || 0) + 1;
        });
        
        const users = this.getAllUsers();
        users[username] = {
          name: username,
          level: 1,
          xp: 0,
          bolts: 500,         // –ë–æ–ª—Ç–∏ üî© (–±–∞–∑–æ–≤–∞ –≤–∞–ª—é—Ç–∞)
          gears: 0,           // –®–µ—Å—Ç–µ—Ä–Ω—ñ ‚öôÔ∏è (—Å–µ—Ä–µ–¥–Ω—è –≤–∞–ª—é—Ç–∞)
          cores: 0,           // –ü–∞—Ä–æ–≤—ñ —è–¥—Ä–∞ ‚ú¥Ô∏é (–ø—Ä–µ–º—ñ—É–º –≤–∞–ª—é—Ç–∞)
          wins: 0,
          losses: 0,
          gamesPlayed: 0,
          createdAt: Date.now(),
          deckCards: deckCards,
          collectionCards: collectionCards,
          progress: progress,    // XP –¥–ª—è –∫–æ–∂–Ω–æ—ó –∫–∞—Ä—Ç–∏
          inventory: inventory   // –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–æ–ø—ñ–π
        };
        
        this.saveAllUsers(users);
        return { success: true, profile: users[username] };
      },
      
      // Login user
      loginUser(username) {
        // Special-case: if someone attempts to login as the admin test user,
        // create the admin profile automatically with full currencies.
        if (!this.userExists(username)) {
          if (username === 'delta5977525') {
            const users = this.getAllUsers();
            const now = Date.now();
            // Build starter pool similar to registerUser()
            const starterIds = (window.getRandomStarterCardIds && window.getRandomStarterCardIds(16))
              || (window.getStarterCardIds && window.getStarterCardIds())
              || [];
            const pool = starterIds.length ? starterIds : (window.ALL_CARDS || []).map(c => c.id);
            const shuffled = [...pool];
            for (let i = shuffled.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            const selectedIds = shuffled.slice(0, 16);
            const selectedCards = selectedIds
              .map(id => (window.getCardById ? window.getCardById(id) : null))
              .filter(Boolean);

            const deckCards = selectedCards.slice(0, 9).map(card => ({ id: card.id, level: 1 }));
            const collectionCards = selectedCards.slice(9, 16).map(card => ({ id: card.id, level: 1 }));

            const progress = {};
            selectedCards.forEach(card => {
              progress[card.id] = { level: 1, xp: 0 };
            });

            const inventory = {};
            selectedCards.forEach(card => {
              inventory[card.id] = (inventory[card.id] || 0) + 1;
            });

            const profile = {
              name: username,
              level: 1,
              xp: 0,
              bolts: 9999,
              gears: 9999,
              cores: 9999,
              wins: 0,
              losses: 0,
              gamesPlayed: 0,
              createdAt: now,
              deckCards: deckCards,
              collectionCards: collectionCards,
              progress: progress,
              inventory: inventory
            };
            users[username] = profile;
            this.saveAllUsers(users);
            storage.set(this.STORAGE_KEY, profile);
            return { success: true, profile };
          }
          return { success: false, error: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ' };
        }

        const users = this.getAllUsers();
        const profile = users[username];
        storage.set(this.STORAGE_KEY, profile);
        return { success: true, profile: profile };
      },
      
      // Get current logged in profile
      getCurrentUser() {
        return storage.get(this.STORAGE_KEY);
      },
      
      // Check if user is logged in
      isLoggedIn() {
        return this.getCurrentUser() !== null;
      },
      
      // Logout
      logout() {
        storage.set('currentUser', null);
        localStorage.removeItem(this.STORAGE_KEY);
      },
      
      // Update current user profile
      updateCurrentUser(updates) {
        const profile = this.getCurrentUser();
        if (!profile) return false;
        
        Object.assign(profile, updates);
        storage.set(this.STORAGE_KEY, profile);
        
        // Also update in users list
        const users = this.getAllUsers();
        if (users[profile.name]) {
          users[profile.name] = profile;
          this.saveAllUsers(users);
        }
        
        return profile;
      },
      
      getProfile() {
        return this.getCurrentUser();
      },
      
      saveProfile(profile) {
        return this.updateCurrentUser(profile);
      },

      autoAddToDeck(profile, cardEntry) {
        if (!profile || !cardEntry) {
          return { added: false, replaced: false, replacedPower: null };
        }

        if (!profile.deckCards) profile.deckCards = [];

        // Ensure we work with a proper card instance (with uid and cardId).
        // Use global `createCardInstance` when available; otherwise fall back
        // to a minimal inline creator so code can run before `js/main.js` loads.
        function _makeInstance(input) {
          // input may be an id or an object
          const entry = (input && typeof input === 'object') ? input : { id: input };
          if (typeof window !== 'undefined' && typeof window.createCardInstance === 'function') {
            try {
              return window.createCardInstance(entry.id || entry.cardId || entry, {
                level: entry.level || 1,
                xp: entry.xp || 0,
                power: entry.power || 0
              });
            } catch (e) {
              // fallback to minimal instance below
            }
          }
          const _gen = (typeof window !== 'undefined' && typeof window.genUID === 'function') ? window.genUID : function(p){ return (p||'c') + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,10); };
          return {
            uid: entry.uid || _gen('card'),
            cardId: entry.cardId || entry.id,
            level: entry.level || 1,
            xp: entry.xp || 0,
            power: entry.power || 0
          };
        }

        const inst = _makeInstance(cardEntry || (cardEntry && (cardEntry.id || cardEntry.cardId)));

        // Prevent duplicate cardId in deck
        if (profile.deckCards.some(dc => (dc.cardId || dc.id) === inst.cardId)) {
          return { added: false, replaced: false, replacedPower: null };
        }

        const cardObj = window.getCardById && window.getCardById(inst.cardId);
        const cardPower = window.getPower
          ? window.getPower(cardObj, inst.level || 1)
          : (cardObj ? (cardObj.basePower || inst.power || 0) : (inst.power || 0));

        if (profile.deckCards.length < 9) {
          profile.deckCards.push(inst);
          return { added: true, replaced: false, replacedPower: null };
        }

        let weakestIdx = -1;
        let weakestPower = Infinity;

        profile.deckCards.forEach((dc, idx) => {
          const dcObj = window.getCardById && window.getCardById(dc.cardId || dc.id);
          const pwr = window.getPower
            ? window.getPower(dcObj, dc.level || 1)
            : (dcObj ? (dcObj.basePower || dc.power || 0) : (dc.power || 0));

          if (pwr < weakestPower) {
            weakestPower = pwr;
            weakestIdx = idx;
          }
        });

        if (weakestIdx >= 0 && cardPower > weakestPower) {
          profile.deckCards[weakestIdx] = inst;
          return { added: false, replaced: true, replacedPower: weakestPower };
        }

        return { added: false, replaced: false, replacedPower: null };
      },
      
      // Compact number formatter: 1500 -> 1.5k; always uses 'k' for >=1000
      formatCompact(number) {
        const n = Number(number) || 0;
        const neg = n < 0;
        const abs = Math.abs(n);
        if (abs < 1000) return String(n);
        let v = abs / 1000;
        // show one decimal for values < 10k, integer otherwise
        let out;
        if (v < 10) {
          out = Math.round(v * 10) / 10; // one decimal
        } else {
          out = Math.round(v); // integer
        }
        // strip trailing .0
        out = String(out).replace(/\.0$/, '');
        return (neg ? '-' : '') + out + 'k';
      },

      updateUI() {
        const profile = this.getCurrentUser();
        if (!profile) return;
        
        // Update level
        const levelSpan = document.querySelector('.level span');
        if (levelSpan) {
          levelSpan.textContent = profile.level;
        }
        
        // Update currencies on HOME PAGE
        const homeBolts = document.getElementById('home-bolts');
        const homeGears = document.getElementById('home-gears');
        const homeCores = document.getElementById('home-cores');
        
        if (homeBolts) homeBolts.textContent = this.formatCompact(profile.bolts || 0);
        if (homeGears) homeGears.textContent = this.formatCompact(profile.gears || 0);
        if (homeCores) homeCores.textContent = this.formatCompact(profile.cores || 0);
        
        // Update currencies on DECK PAGE
        const boltVal = document.getElementById('deck-bolts');
        const gearVal = document.getElementById('deck-gears');
        const coreVal = document.getElementById('deck-cores');
        
        if (boltVal) boltVal.textContent = this.formatCompact(profile.bolts || 0);
        if (gearVal) gearVal.textContent = this.formatCompact(profile.gears || 0);
        if (coreVal) coreVal.textContent = this.formatCompact(profile.cores || 0);
        
        // Update thin HUD XP line (fill only)
        const xpFill = document.querySelector('.hud-xpfill');
        if (!xpFill) console.warn('HUD XP: .hud-xpfill not found');

        const xp = (profile && profile.xp) ? profile.xp : 0;
        const need = (typeof navigation !== 'undefined' && navigation.xpNeededForLevel) ? navigation.xpNeededForLevel(profile.level || 1) : 0;
        const percent = need > 0 ? Math.min(100, Math.round((xp / need) * 100)) : 0;

        if (xpFill) xpFill.style.width = percent + '%';

        // Update full HUD XP bar + text
        try {
          if (typeof updateHudXP === 'function') updateHudXP(xp, need);
        } catch (e) {
          console.warn('updateHudXP failed', e);
        }
        
        // Update deck power on home screen (use actual progress levels)
        if (profile.deckCards && profile.deckCards.length > 0) {
          let totalPower = 0;
          profile.deckCards.forEach(dc => {
            const card = window.getCardById && window.getCardById(dc.cardId || dc.id);
            if (card) {
              const prog = window.getProgress ? window.getProgress(profile, dc.uid || dc.id) : { level: dc.level || 1, xp: 0 };
              const level = (prog && prog.level) ? prog.level : (dc.level || 1);
              const power = window.getPower ? window.getPower(card, level) : (typeof getPower === 'function' ? getPower(card, level) : 0);
              totalPower += power || 0;
            }
          });
          const deckPowerHome = document.getElementById('deck-power-home');
          if (deckPowerHome) {
            deckPowerHome.textContent = this.formatCompact ? this.formatCompact(totalPower) : String(totalPower);
          }
        }
        
        // Update username in portrait
        const portrait = document.querySelector('.portrait');
        if (portrait) {
          portrait.title = profile.name;
        }
      }
    };

    // Auth UI management
    const authUI = {
      overlay: null,
      
      init() {
        this.overlay = document.getElementById('authOverlay');
        
        // Tab switching
        document.querySelectorAll('.auth-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            this.switchTab(tabName);
          });
        });
        
        // Login form
        document.getElementById('loginForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });
        
        // Register form
        document.getElementById('registerForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleRegister();
        });
        
        // Check if already logged in
        if (userProfile.isLoggedIn()) {
          this.hideAuth();
        } else {
          this.showAuth();
        }
      },
      
      switchTab(tabName) {
        // Update tabs
        document.querySelectorAll('.auth-tab').forEach(t => {
          t.classList.toggle('active', t.dataset.tab === tabName);
        });
        
        // Update forms
        document.querySelectorAll('.auth-form').forEach(f => {
          f.classList.toggle('active', f.id === tabName + 'Form');
        });
        
        // Clear errors
        this.hideError('login');
        this.hideError('register');
      },
      
      handleLogin() {
        const username = document.getElementById('loginUsername').value.trim();
        
        if (!username) {
          this.showError('login', '–í–≤–µ–¥—ñ—Ç—å —ñ–º\'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');
          return;
        }
        
        const result = userProfile.loginUser(username);
        
        if (result.success) {
          console.log('Login successful:', result.profile);
          this.hideAuth();
          userProfile.updateUI();
        } else {
          this.showError('login', result.error);
        }
      },
      
      handleRegister() {
        const username = document.getElementById('registerUsername').value.trim();
        
        if (!username) {
          this.showError('register', '–í–≤–µ–¥—ñ—Ç—å —ñ–º\'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞');
          return;
        }
        
        const result = userProfile.registerUser(username);
        
        if (result.success) {
          console.log('Registration successful:', result.profile);
          // Auto-login after registration
          userProfile.loginUser(username);
          this.hideAuth();
          userProfile.updateUI();
        } else {
          this.showError('register', result.error);
        }
      },
      
      showError(formType, message) {
        const errorEl = document.getElementById(formType + 'Error');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.classList.add('show');
        }
      },
      
      hideError(formType) {
        const errorEl = document.getElementById(formType + 'Error');
        if (errorEl) {
          errorEl.classList.remove('show');
        }
      },
      
      showAuth() {
        if (this.overlay) {
          this.overlay.style.display = 'flex';
          setTimeout(() => {
            this.overlay.classList.remove('hidden');
          }, 10);
        }
      },
      
      hideAuth() {
        if (this.overlay) {
          this.overlay.classList.add('hidden');
        }
      }
    };

    // Page navigation system
    const navigation = {
        // ========== BAG SYSTEM ========== 
        loadBagCards() {
          const profile = userProfile.getProfile();
          if (!profile) return;
          // –í —Å—É–º—Ü—ñ ‚Äî –ª–∏—à–µ —Ç—ñ –∫–∞—Ä—Ç–∏ –∑ collectionCards, —è–∫–∏—Ö –Ω–µ–º–∞—î –≤ deckCards
          let deckIds = new Set((profile.deckCards || []).map(c => c.id));
          const bagCards = (profile.collectionCards || []).filter(c => !deckIds.has(c.id));
          const container = document.getElementById('bag-cards-list');
          if (!container) return;
          if (bagCards.length === 0) {
            container.innerHTML = '<div class="no-bag-cards">–ù–µ–º–∞—î –∫–∞—Ä—Ç —É —Å—É–º—Ü—ñ</div>';
            return;
          }
          const elementEmojis = {
            fire: 'üî•',
            water: 'üíß',
            air: '‚ô®Ô∏è',
            earth: 'üçÉ'
          };
          container.innerHTML = bagCards.map(card => {
            const cardData = getCardById(card.id);
            if (!cardData) return '';
            const emoji = elementEmojis[cardData.element] || '‚öô';
            return `
              <div class="bag-card-item" data-card-id="${card.id}">
                <span class="bag-card-emoji">${emoji}</span>
                <span class="bag-card-name">${cardData.name}</span>
                <span class="bag-card-status">–ó–Ω–∞–π–¥–µ–Ω–æ</span>
              </div>
            `;
          }).join('');
        },
        // ========== END BAG SYSTEM ========== 
          // –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–∞—Ä—Ç–∏ –∑ —Å—É–º–∫–∏ (—è–∫—ñ –Ω–µ –≤ –∫–æ–ª–æ–¥—ñ)
          getBagCards(profile) {
            if (!profile) return [];
            let deckIds = new Set((profile.deckCards || []).map(c => c.id));
            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç—ñ –∫–∞—Ä—Ç–∏ –∑ collectionCards, —è–∫–∏—Ö –Ω–µ–º–∞—î –≤ deckCards
            return (profile.collectionCards || []).filter(c => !deckIds.has(c.id));
          },
      currentPage: 'home',
      
      showPage(pageId) {
        // Remove active class from all pages
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        
        // Add active class to target page
        const targetPage = document.getElementById(`page-${pageId}`);
        if (targetPage) {
          targetPage.classList.add('active');
          this.currentPage = pageId;
          
          // Update profile stats if on profile page
          if (pageId === 'profile') {
            this.updateProfilePage();
          }
          
          // Load deck cards if on deck page
          if (pageId === 'deck') {
            this.loadDeckCards();
          }
          
          // Load collection cards if on collections page
          if (pageId === 'collections') {
            this.loadCollectionCards();
          }
          
          // Load shop if on shop page
          if (pageId === 'shop') {
            this.loadShop();
          }

          // Initialize duels UI
          if (pageId === 'duels') {
            this.initDuelsPage();
          }
        }
      },
      
      updateProfilePage() {
        const profile = userProfile.getProfile();
        document.getElementById('profile-level').textContent = profile.level;
        const need = (typeof navigation !== 'undefined' && navigation.xpNeededForLevel) ? navigation.xpNeededForLevel(profile.level || 1) : 100;
        document.getElementById('profile-xp').textContent = `${this.formatCompact ? this.formatCompact(profile.xp) : profile.xp}/${this.formatCompact ? this.formatCompact(need) : need}`;
        document.getElementById('profile-wins').textContent = profile.wins;
        document.getElementById('profile-losses').textContent = profile.losses;
        document.getElementById('profile-games').textContent = profile.gamesPlayed;
      },

      

      // ========== UPGRADE SYSTEM ==========
      
      // Build inventory from deck + collection
      getInventory(profile) {
        const inventory = {};
        
        // Count cards from both deck and collection
        [...profile.deckCards, ...profile.collectionCards].forEach(userCard => {
          inventory[userCard.id] = (inventory[userCard.id] || 0) + 1;
        });
        
        return inventory;
      },

      // Get count of extra copies available for upgrade
      getExtraCopies(inventory, cardId) {
        const total = inventory[cardId] || 0;
        return Math.max(0, total - 1); // -1 because one copy is in deck
      },

      // Get cost to upgrade from current level to next
      getUpgradeCost(level) {
        return level; // lvl 1->2 costs 1, lvl 2->3 costs 2, etc
      },

      // Check if a deck card can be upgraded
      canUpgradeCard(deckItem, inventory) {
        const cost = this.getUpgradeCost(deckItem.level);
        const extra = this.getExtraCopies(inventory, deckItem.id);
        return extra >= cost;
      },

      // Check if deck has any upgradable cards
      hasAnyUpgradable(deck, inventory) {
        return deck.some(item => this.canUpgradeCard(item, inventory));
      },

      // Check if a target card can be guaranteed to level up by burning owned weaker cards
      canGuaranteedLevelByBurning(profile, targetCardId) {
        if (!profile || !targetCardId) return false;
        // get current progress
          const prog = window.getProgress ? window.getProgress(profile, targetCardId) : (profile.progress && profile.progress[targetCardId]) || { level: 1, xp: 0 };
        const need = window.xpNeed ? window.xpNeed(prog.level) : this.xpNeededForLevel(prog.level);
        const remaining = Math.max(0, need - (prog.xp || 0));
        if (remaining <= 0) return true;

        const targetCard = window.getCardById ? window.getCardById(targetCardId) : null;
        if (!targetCard) return false;

          const deckIds = new Set((profile.deckCards || []).map(d => d.id));
          // If target card is in deck, never show guarantee indicator
          if (deckIds.has(targetCardId)) return false;

        // Sum available XP from collection entries (excluding deck copies)
        let totalXp = 0;
        if (Array.isArray(profile.collectionCards)) {
          for (let i = 0; i < profile.collectionCards.length; i++) {
            const entry = profile.collectionCards[i];
            if (!entry || !entry.id) continue;
            if (entry.id === targetCardId) continue;
            if (deckIds.has(entry.id)) continue;
            const c = window.getCardById ? window.getCardById(entry.id) : null;
            if (!c || c.element !== targetCard.element) continue;
            const lvl = entry.level || 1;
            const gain = window.xpValue ? window.xpValue(lvl) : (c.basePower || 10);
            totalXp += gain;
            if (totalXp >= remaining) return true;
          }
        }

        // Sum available XP from inventory counters (assume level 1 for inventory entries)
        const inv = profile.inventory || {};
        for (const id in inv) {
          if (!Object.prototype.hasOwnProperty.call(inv, id)) continue;
          const count = inv[id] || 0;
          if (count <= 0) continue;
          if (id === targetCardId) continue;
          if (deckIds.has(id)) continue;
          const c = window.getCardById ? window.getCardById(id) : null;
          if (!c || c.element !== targetCard.element) continue;
          const gain = window.xpValue ? window.xpValue(1) : (c.basePower || 10);
          totalXp += gain * count;
          if (totalXp >= remaining) return true;
        }

        return false;
      },

      // Perform upgrade on a deck card
      performUpgrade(deckItem, inventory, profile) {
        const cost = this.getUpgradeCost(deckItem.level);
        const extra = this.getExtraCopies(inventory, deckItem.id);

        if (extra < cost) return false;

        // Remove used copies from collection
        let toRemove = cost;
        for (let i = profile.collectionCards.length - 1; i >= 0 && toRemove > 0; i--) {
          if (profile.collectionCards[i].id === deckItem.id) {
            profile.collectionCards.splice(i, 1);
            toRemove--;
          }
        }

        // Increase level
        deckItem.level += 1;

        // Save profile
        userProfile.updateCurrentUser(profile);

        return true;
      },

      // ========== END UPGRADE SYSTEM ==========

      // ========== SHOP SYSTEM ==========
      
      // Shop products catalog
      getShopProducts() {
        return {
          offers: [
            {
              sku: 'offer_elements',
              title: '–ö–æ–ª–µ–∫—Ü—ñ—è –µ–ª–µ–º–µ–Ω—Ç–∞–ª—ñ–≤',
              description: '–í—Å—ñ —á–æ—Ç–∏—Ä–∏ –∫–∞—Ä—Ç–∏ –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó ¬´–ï–ª–µ–º–µ–Ω—Ç–∞–ª—ñ¬ª',
              icon: 'üî•',
              price: { currency: 'gears', amount: 20 },
              contents: { cards: 4 },
              limited: true
            }
          ],
          packs: [],
          singleCards: [
            {
              sku: 'card_legendary',
              title: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞ –∫–∞—Ä—Ç–∞',
              description: '–ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∞ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞ –∫–∞—Ä—Ç–∞',
              icon: '‚ö°',
              price: { currency: 'gears', amount: 150 },
              contents: { cards: 1 },
              chance: { text: '40% —à–∞–Ω—Å –º—ñ—Ñ—ñ—á–Ω–æ—ó', class: '' }
            },
            {
              sku: 'card_epic',
              title: '–ï–ø—ñ—á–Ω–∞ –∫–∞—Ä—Ç–∞',
              description: '–ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∞ –µ–ø—ñ—á–Ω–∞ –∫–∞—Ä—Ç–∞',
              icon: 'üíú',
              price: { currency: 'gears', amount: 50 },
              contents: { cards: 1 },
              chance: { text: '30% —à–∞–Ω—Å –º—ñ—Ñ—ñ—á–Ω–æ—ó', class: 'rare' }
            },
            {
              sku: 'card_uncommon',
              title: '–ù–µ–∑–≤–∏—á–∞–π–Ω–∞ –∫–∞—Ä—Ç–∞',
              description: '–ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∞ –Ω–µ–∑–≤–∏—á–∞–π–Ω–∞ –∫–∞—Ä—Ç–∞',
              icon: 'üíö',
              price: { currency: 'bolts', amount: 500 },
              contents: { cards: 1 },
              chance: { text: '15% —à–∞–Ω—Å –µ–ø—ñ—á–Ω–æ—ó', class: 'uncommon' }
            }
          ]
        };
      },

      loadShop() {
        const products = this.getShopProducts();
        this.renderNewShopItems('offers-container', products.offers, true);
        this.renderNewShopItems('single-cards-container', products.singleCards, false, true);
      },

      renderNewShopItems(containerId, items, isLimited = false, hasChance = false) {
        const container = document.getElementById(containerId);
        if (!container) {
          console.warn(`Container not found: ${containerId}`);
          return;
        }

        const profile = userProfile.getProfile();
        container.innerHTML = '';

        console.log(`Rendering ${items.length} items to ${containerId}`);

        items.forEach(item => {
          // Check if this is a one-time purchase that was already bought
          if (item.sku === 'offer_elements' && profile && profile.purchasedOffers && profile.purchasedOffers.includes('offer_elements')) {
            console.log(`Skipping already purchased: ${item.sku}`);
            return; // Skip rendering this item
          }

          const card = document.createElement('div');
          card.className = 'shop-item-card';

          const currencyEmojis = {
            bolts: 'üî©',
            gears: '‚öôÔ∏è',
            cores: '‚ú¥Ô∏é'
          };
          const currencyIcon = currencyEmojis[item.price.currency] || '?';
          
          const chanceHTML = hasChance && item.chance 
            ? `<div class="shop-item-chance ${item.chance.class}">${item.chance.text}</div>`
            : '';

          card.innerHTML = `
            <div class="shop-item-icon">${item.icon}</div>
            <div class="shop-item-content">
              <div class="shop-item-name">${item.title}</div>
              <div class="shop-item-desc">${item.description}</div>
              ${chanceHTML}
            </div>
            <div class="shop-item-action">
              <div class="shop-item-price">${currencyIcon} ${item.price.amount}</div>
              <button class="shop-buy-button" data-sku="${item.sku}">
                –ö—É–ø–∏—Ç–∏
              </button>
            </div>
          `;

          container.appendChild(card);
        });

        // Add click handlers
        container.querySelectorAll('.shop-buy-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const sku = btn.dataset.sku;
            console.log('Buying product:', sku);
            navigation.buyProduct(sku);
          });
        });
      },

      loadShopCards(elementFilter = 'all') {
        const profile = userProfile.getProfile();
        if (!profile) return;

        const container = document.getElementById('cards-container');
        if (!container) return;

        container.innerHTML = '';

        // Get all cards
        let allCards = window.ALL_CARDS || [];
        
        // Filter by element
        const filteredCards = elementFilter === 'all' 
          ? allCards 
          : allCards.filter(c => c.element === elementFilter);

        // Display cards with prices (use cardRenderer/createCardView if available)
        filteredCards.forEach(card => {
          const cardDiv = document.createElement('div');
          cardDiv.className = 'product-card';

          const displayPower = window.getPower ? window.getPower(card, 1) : (card.basePower || card.power || 0);
          // Price based on rarity/power
          const prices = {
            gears: Math.max(1, Math.ceil(displayPower * 2)),
            bolts: Math.max(1, Math.ceil(displayPower / 1.5)),
            cores: Math.max(1, Math.ceil(displayPower / 3))
          };

          // Render visual: prefer cardRenderer, then createCardView, fallback to element emoji
          let visualHtml = '';
          if (window.cardRenderer && typeof window.cardRenderer.render === 'function') {
            try {
              visualHtml = window.cardRenderer.render({ ...card, power: displayPower });
            } catch (err) {
              console.warn('cardRenderer.render failed for shop card', card.id, err);
              visualHtml = '';
            }
          }
          if (!visualHtml && window.createCardView) {
            try {
              const el = window.createCardView(card);
              visualHtml = el ? el.outerHTML : '';
            } catch (err) {
              console.warn('createCardView failed for shop card', card.id, err);
            }
          }
          if (!visualHtml) {
            const elementEmoji = this.getElementEmoji(card.element);
            visualHtml = `<div class="product-icon">${elementEmoji}</div>`;
          } else {
            // wrap visual into container matching product-icon slot
            visualHtml = `<div class="product-icon">${visualHtml}</div>`;
          }

          cardDiv.innerHTML = `
            <div class="product-header">
              ${visualHtml}
              <div class="product-info">
                <div class="product-title">${card.name}</div>
                <div class="product-desc">–°–∏–ª–∞: ${displayPower}</div>
              </div>
            </div>
            <div class="product-footer">
              <div style="display: flex; gap: 8px; flex-direction: column; width: 100%;">
                <button class="product-buy-btn" data-card-id="${card.id}" data-currency="gears" data-price="${prices.gears}" title="–®–µ—Å—Ç–µ—Ä–Ω—ñ">
                  üîß ${prices.gears}
                </button>
                <button class="product-buy-btn" data-card-id="${card.id}" data-currency="bolts" data-price="${prices.bolts}" title="–ë–æ–ª—Ç–∏">
                  ‚öôÔ∏è ${prices.bolts}
                </button>
                <button class="product-buy-btn" data-card-id="${card.id}" data-currency="cores" data-price="${prices.cores}" title="–ü–∞—Ä–æ–≤—ñ —è–¥—Ä–∞">
                  üî• ${prices.cores}
                </button>
              </div>
            </div>
          `;

          container.appendChild(cardDiv);
        });

        // Add click handlers for card purchase
        container.querySelectorAll('.product-buy-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const cardId = btn.dataset.cardId;
            const currency = btn.dataset.currency;
            const price = parseInt(btn.dataset.price);
            this.buyCard(cardId, currency, price);
          });
        });
      },

      buyCard(cardId, currency, price) {
        const profile = this.getProfile();
        if (!profile) return;

        // Check balance using Currency System
        if (!window.CurrencySystem.canAfford(profile, currency, price)) {
          const currencyName = window.CurrencySystem.getCurrencyNameGenitive(currency);
          alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ ${currencyName}! –ü–æ—Ç—Ä—ñ–±–Ω–æ ${price}`);
          return;
        }

        const card = window.getCardById(cardId);
        if (!card) return;

        // Deduct currency using Currency System
        window.CurrencySystem.deduct(profile, currency, price);

        // Add card to collection
        if (!profile.collectionCards) {
          profile.collectionCards = [];
        }
        const newCardEntry = { id: card.id, level: 1 };
        profile.collectionCards.push(newCardEntry);

        // –ê–≤—Ç–æ-–¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤ –∫–æ–ª–æ–¥—É: —è–∫—â–æ –º–µ–Ω—à–µ 9 –∫–∞—Ä—Ç ‚Äì –¥–æ–¥–∞—î–º–æ;
        // —ñ–Ω–∞–∫—à–µ –∑–∞–º—ñ–Ω—é—î–º–æ –Ω–∞–π—Å–ª–∞–±—à—É –∫–∞—Ä—Ç—É, —è–∫—â–æ –Ω–æ–≤–∞ —Å–∏–ª—å–Ω—ñ—à–∞
        userProfile.autoAddToDeck(profile, newCardEntry);

        // –î–æ–¥–∞—Ç–∏ –≤ inventory (–¥–ª—è –ø—Ä–æ–∫–∞—á–∫–∏)
        if (!profile.inventory) {
          profile.inventory = {};
        }
        profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å –∫–∞—Ä—Ç–∏
        const prog = window.getProgress ? window.getProgress(profile, card.id) : null;

        // Save profile (includes collection + deck changes)
        this.saveProfile(profile);

        // Update UI
        this.loadDeckCards(); // This will update topbar

        // Show success message
        const currencyEmojis = {
          gears: '‚öôÔ∏è',
          bolts: 'üî©',
          cores: '‚ú¥Ô∏é'
        };
        alert(`‚úÖ ${card.name} –∫—É–ø–ª–µ–Ω–æ –∑–∞ ${price} ${currencyEmojis[currency]}!`);

        // Reload cards
        this.loadShopCards(this.currentCardFilter || 'all');
      },

      renderProducts(containerId, products) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';

        products.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';

          const currencyEmojis = {
            bolts: 'üî©',
            gears: '‚öôÔ∏è',
            cores: '‚ú¥Ô∏é'
          };
          const currencyIcon = currencyEmojis[product.price.currency] || '?';
          const badgeHTML = product.badge 
            ? `<div class="product-badge ${product.badge.class}">${product.badge.text}</div>` 
            : '';
          const bonusHTML = product.bonus 
            ? `<div class="product-bonus">${product.bonus}</div>` 
            : '';

          card.innerHTML = `
            ${badgeHTML}
            <div class="product-header">
              <div class="product-icon">${product.icon}</div>
              <div class="product-info">
                <div class="product-title">${product.title}</div>
                <div class="product-desc">${product.description}</div>
                ${bonusHTML}
              </div>
            </div>
            <div class="product-footer">
              <div class="product-price">
                <span class="currency-icon">${currencyIcon}</span>
                <span>${product.price.amount}</span>
              </div>
              <button class="product-buy-btn" data-sku="${product.sku}">–ö—É–ø–∏—Ç–∏</button>
            </div>
          `;

          container.appendChild(card);
        });

        // Add click handlers
        container.querySelectorAll('.product-buy-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const sku = btn.dataset.sku;
            this.buyProduct(sku);
          });
        });
      },

      canAfford(product) {
        const profile = this.getProfile();
        if (!profile) return false;

        const currency = product.price.currency;
        return profile[currency] >= product.price.amount;
      },

      buyProduct(sku) {
        console.log('[BUY] Starting purchase for SKU:', sku);
        const profile = userProfile.getProfile();
        if (!profile) {
          console.error('[BUY] No profile found!');
          return;
        }
        console.log('[BUY] Profile loaded:', profile);

        const allProducts = this.getShopProducts();
        const product = [...allProducts.offers, ...allProducts.singleCards]
          .find(p => p.sku === sku);

        if (!product) {
          console.error('[BUY] Product not found:', sku);
          alert('–¢–æ–≤–∞—Ä –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
          return;
        }

        // –ö–†–û–ö 1: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –ø–æ–∫—É–ø–∫–∏
        const canAfford = this.canAfford(profile, product.price);
        if (!canAfford) {
          console.warn('[BUY] Cannot afford. Need:', product.price.amount, 'Have:', profile[product.price.currency]);
          const currencyNames = {
            bolts: '–±–æ–ª—Ç—ñ–≤',
            gears: '—à–µ—Å—Ç–µ—Ä–µ–Ω—å',
            cores: '–ø–∞—Ä–æ–≤–∏—Ö —è–¥–µ—Ä'
          };
          const currencyName = currencyNames[product.price.currency] || '–≤–∞–ª—é—Ç–∏';
          alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ ${currencyName}! –ü–æ—Ç—Ä—ñ–±–Ω–æ ${product.price.amount}`);
          return;
        }

        // –ö–†–û–ö 2: –°–ø–∏—Å–∞–Ω–Ω—è –≤–∞–ª—é—Ç–∏
        const currency = product.price.currency;
        profile[currency] -= product.price.amount;
        console.log('[BUY] Currency deducted. New balance:', profile[currency]);

        // –ö–†–û–ö 3: –í–∏–¥–∞—á–∞ –Ω–∞–≥–æ—Ä–æ–¥ (–∫–∞—Ä—Ç–∏ –∞–±–æ –≤–∞–ª—é—Ç–∞)
        const rewards = [];

        if (product.contents.cards) {
          console.log('[BUY] Granting pack of', product.contents.cards, 'cards');
          // Mark SKU so grantPack can apply product-specific drop options
          profile._lastPurchasedSku = sku;
          const cards = this.grantPack(profile, product.contents.cards);
          // cleanup helper flag
          delete profile._lastPurchasedSku;
          rewards.push(...cards);
        }

        // –í–∏–¥–∞—á–∞ —ñ–Ω—à–∏—Ö –Ω–∞–≥–æ—Ä–æ–¥ (–≥–∞—Ä–Ω–∏–π –±–æ–Ω—É—Å)
        if (product.contents.gears) {
          profile.gears = (profile.gears || 0) + product.contents.gears;
        }
        if (product.contents.cores) {
          profile.cores = (profile.cores || 0) + product.contents.cores;
        }
        if (product.contents.bolts) {
          profile.bolts = (profile.bolts || 0) + product.contents.bolts;
        }

        // –ö–†–û–ö 4: –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ñ —Ç–æ–≤–∞—Ä–∏ —è–∫ –∫—É–ø–ª–µ–Ω—ñ
        if (sku === 'offer_elements') {
          if (!profile.purchasedOffers) {
            profile.purchasedOffers = [];
          }
          profile.purchasedOffers.push(sku);
        }

        // –ö–†–û–ö 5: –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é
        userProfile.updateCurrentUser(profile);
        console.log('[BUY] Profile saved');

        // –ö–†–û–ö 6: –û–Ω–æ–≤–ª–µ–Ω–Ω—è UI
        userProfile.updateUI();
        console.log('[BUY] UI updated');

        // –ö–†–û–ö 7: –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–∞–≥–∞–∑–∏–Ω (–ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ñ —Ç–æ–≤–∞—Ä–∏)
        if (sku === 'offer_elements') {
          this.loadShop();
        }

        // –ö–†–û–ö 8: –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª–∫–∏ –∑ –Ω–∞–≥–æ—Ä–æ–¥–∞–º–∏
        console.log('[BUY] Purchase complete! Rewards:', rewards.length, 'cards');
        if (rewards.length > 0) {
          this.showPackModal(rewards);
        } else {
          alert(`‚úÖ –ü–æ–∫—É–ø–∫–∞ —É—Å–ø—ñ—à–Ω–∞!`);
        }
      },

      // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –ø–æ–∫—É–ø–∫–∏
      canAfford(profile, price) {
        const { currency, amount } = price;
        return (profile[currency] ?? 0) >= amount;
      },

      grantPack(profile, count) {
        let allCards = window.ALL_CARDS || [];
        const rewards = [];

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
        if (!profile.inventory) {
          profile.inventory = {};
        }
        if (!profile.collectionCards) {
          profile.collectionCards = [];
        }

        for (let i = 0; i < count; i++) {
          let card = null;
          const sku = profile._lastPurchasedSku || '';

          // –†–Ü–ó–ù–Ü –¢–ò–ü–ò –ü–ê–ö–Ü–í –ó –†–Ü–ó–ù–ò–ú–ò –û–ë–ú–ï–ñ–ï–ù–ù–Ø–ú–ò
          if (sku === 'card_uncommon') {
            // "–ù–µ–∑–≤–∏—á–∞–π–Ω–∞ –∫–∞—Ä—Ç–∞" - 500 –±–æ–ª—Ç—ñ–≤
            // –û–ë–ú–ï–ñ–ï–ù–ù–Ø: –¢—ñ–ª—å–∫–∏ R1-R4 (–±–µ–∑ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∏—Ö/–º—ñ—Ñ—ñ—á–Ω–∏—Ö)
            const rarityRoll = Math.random() * 100;
            let targetRarity;
            
            if (rarityRoll < 60) {
              targetRarity = 'common';       // 60% - –ó–≤–∏—á–∞–π–Ω–∞ (R1)
            } else if (rarityRoll < 75) {
              targetRarity = 'uncommon';     // 15% - –ù–µ–∑–≤–∏—á–∞–π–Ω–∞ (R2)
            } else if (rarityRoll < 90) {
              targetRarity = 'rare';         // 15% - –†—ñ–¥–∫—ñ—Å–Ω–∞ (R3)
            } else {
              targetRarity = 'epic';         // 10% - –ï–ø—ñ—á–Ω–∞ (R4)
            }
            
            // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –∫–∞—Ä—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∑ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–º–∏ —Ä—ñ–¥–∫–æ—Å—Ç—è–º–∏
            const allowedRarities = ['common', 'uncommon', 'rare', 'epic'];
            const candidates = allCards.filter(c => 
              allowedRarities.includes(c.rarity) && c.rarity === targetRarity
            );
            
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              // –†–µ–∑–µ—Ä–≤–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç: –±—É–¥—å-—è–∫–∞ –∫–∞—Ä—Ç–∞ R1-R4
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else if (sku === 'card_epic') {
            // "–ï–ø—ñ—á–Ω–∞ –∫–∞—Ä—Ç–∞" - 50 —à–µ—Å—Ç–µ—Ä–µ–Ω—å
            // –û–ë–ú–ï–ñ–ï–ù–ù–Ø: R4-R6 –∑ —à–∞–Ω—Å–∞–º–∏ 50%/30%/20%
            const rarityRoll = Math.random() * 100;
            let targetRarity;
            
            if (rarityRoll < 50) {
              targetRarity = 'epic';       // 50% - –ï–ø—ñ—á–Ω–∞ (R4)
            } else if (rarityRoll < 80) {
              targetRarity = 'legendary';  // 30% - –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞ (R5)
            } else {
              targetRarity = 'mythic';     // 20% - –ú—ñ—Ñ—ñ—á–Ω–∞ (R6)
            }
            
            // –§—ñ–ª—å—Ç—Ä—É—î–º–æ –∫–∞—Ä—Ç–∏ —Ç—ñ–ª—å–∫–∏ –∑ –¥–æ–∑–≤–æ–ª–µ–Ω–∏–º–∏ —Ä—ñ–¥–∫–æ—Å—Ç—è–º–∏
            const allowedRarities = ['epic', 'legendary', 'mythic'];
            const candidates = allCards.filter(c => 
              allowedRarities.includes(c.rarity) && c.rarity === targetRarity
            );
            
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              // –Ø–∫—â–æ –Ω–µ–º–∞—î –∫–∞—Ä—Ç —Ü—ñ—î—ó —Ä—ñ–¥–∫–æ—Å—Ç—ñ, –±–µ—Ä–µ–º–æ –±—É–¥—å-—è–∫—É –∑ –¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else if (sku === 'card_legendary') {
            // "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞ –∫–∞—Ä—Ç–∞" - 150 —à–µ—Å—Ç–µ—Ä–µ–Ω—å
            // –û–ë–ú–ï–ñ–ï–ù–ù–Ø: –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞ (R5) –∞–±–æ –º—ñ—Ñ—ñ—á–Ω–∞ (R6)
            const allowedRarities = ['legendary', 'mythic'];
            
            // 80% —à–∞–Ω—Å –Ω–∞ R5, 20% –Ω–∞ R6
            const isMythic = Math.random() < 0.2;
            const targetRarity = isMythic ? 'mythic' : 'legendary';
            
            const candidates = allCards.filter(c => c.rarity === targetRarity);
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              // –Ø–∫—â–æ –Ω–µ–º–∞—î –º—ñ—Ñ—ñ—á–Ω–∏—Ö, –±–µ—Ä–µ–º–æ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω—É, —ñ –Ω–∞–≤–ø–∞–∫–∏
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else if (sku === 'offer_elements') {
            // "–ö–æ–ª–µ–∫—Ü—ñ—è –µ–ª–µ–º–µ–Ω—Ç–∞–ª—ñ–≤" - 20 —à–µ—Å—Ç–µ—Ä–µ–Ω—å
            // –û–ë–ú–ï–ñ–ï–ù–ù–Ø: –¢—ñ–ª—å–∫–∏ R1-R4 (–±–µ–∑ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∏—Ö/–º—ñ—Ñ—ñ—á–Ω–∏—Ö)
            const allowedRarities = ['common', 'uncommon', 'rare', 'epic'];
            
            // –î–ª—è –Ω–∞–±–æ—Ä—ñ–≤ - —Ä—ñ–≤–Ω–æ–º—ñ—Ä–Ω–∏–π —Ä–æ–∑–ø–æ–¥—ñ–ª
            const rarityRoll = Math.random() * 100;
            let targetRarity;
            
            if (rarityRoll < 25) {
              targetRarity = 'common'; // 25% - –ó–≤–∏—á–∞–π–Ω–∞
            } else if (rarityRoll < 50) {
              targetRarity = 'uncommon'; // 25% - –ù–µ–∑–≤–∏—á–∞–π–Ω–∞
            } else if (rarityRoll < 75) {
              targetRarity = 'rare'; // 25% - –†—ñ–¥–∫—ñ—Å–Ω–∞
            } else {
              targetRarity = 'epic'; // 25% - –ï–ø—ñ—á–Ω–∞
            }
            
            const candidates = allCards.filter(c => c.rarity === targetRarity);
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else {
            // –î–ª—è —ñ–Ω—à–∏—Ö —Ç–æ–≤–∞—Ä—ñ–≤ (—è–∫—â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è dropSystem)
            if (window.dropSystem && typeof window.dropSystem.dropCardWithOptions === 'function') {
              let opts = {};
              
              // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö SKU
              if (sku && sku.startsWith('card_')) {
                opts = { maxRarity: 'epic' }; // –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º - –±–µ–∑ –ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∏—Ö
              }
              
              const res = window.dropSystem.dropCardWithOptions(
                profile, 
                allCards, 
                window.STARTER_CARDS || [], 
                profile.pityCounters || {noLegendary:0, noMythic:0}, 
                opts
              );
              card = res.card;
              profile.pityCounters = res.pityCounters;
              console.log(`[GRANTPACK] ${sku}: DropSystem ${card.rarity} - ${card.name}`);
            } else {
              // Fallback: –≤–∏–ø–∞–¥–∫–æ–≤–∞ –∫–∞—Ä—Ç–∞ –∑ –æ–±–º–µ–∂–µ–Ω–Ω—è–º–∏
              const allowedRarities = ['common', 'uncommon', 'rare', 'epic'];
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
          }

          const newEntry = { id: card.id, level: 1 };

          // –î–û–î–ê–¢–ò –í –ö–û–õ–ï–ö–¶–Ü–Æ
          profile.collectionCards.push(newEntry);
          userProfile.autoAddToDeck(profile, newEntry);

          // –î–û–î–ê–¢–ò –í –Ü–ù–í–ï–ù–¢–ê–† (–¥–ª—è –ø—Ä–æ–∫–∞—á–∫–∏)
          profile.inventory[card.id] = (profile.inventory[card.id] ?? 0) + 1;

          // –ó–ë–ï–†–ï–ì–¢–ò –î–õ–Ø –ü–û–ö–ê–ó–£ –í –ú–û–î–ê–õ–¶–Ü
          rewards.push(card);
        }

        return rewards;
      },

      showPackModal(rewards) {
        const modal = document.getElementById('pack-modal');
        const rewardsContainer = document.getElementById('pack-rewards');
        if (!modal || !rewardsContainer) return;
        rewardsContainer.innerHTML = '';

        // Render rewards: prefer createCardView, then cardRenderer, otherwise fallback HTML
        rewards.forEach(card => {
          const wrapper = document.createElement('div');
          wrapper.className = 'pack-card-wrapper';

          let visualAppended = false;
          if (window.createCardView) {
            try {
              const cardEl = window.createCardView(card);
              if (cardEl) {
                wrapper.appendChild(cardEl);
                visualAppended = true;
              }
            } catch (err) {
              console.warn('createCardView failed in pack modal', err);
            }
          }

          if (!visualAppended && window.cardRenderer && typeof window.cardRenderer.render === 'function') {
            try {
              const html = window.cardRenderer.render(card);
              const frag = document.createElement('div');
              frag.innerHTML = html;
              // append first node
              if (frag.firstElementChild) wrapper.appendChild(frag.firstElementChild);
              visualAppended = true;
            } catch (err) {
              console.warn('cardRenderer.render failed in pack modal', err);
            }
          }

          if (!visualAppended) {
            // Minimal fallback visual
            const el = document.createElement('div');
            el.className = 'sp-card pack-fallback-card ' + (card.element || '');
            el.innerHTML = `
              <div class="corner-gear">${card.element || ''}</div>
              <div class="power-plate"><div class="power-value">${card.basePower || card.power || ''}</div></div>
            `;
            wrapper.appendChild(el);
          }

          // Info under card
          const info = document.createElement('div');
          info.className = 'pack-card-info';
          const nameDiv = document.createElement('div');
          nameDiv.className = 'pack-card-name';
          nameDiv.textContent = card.name || '';
          info.appendChild(nameDiv);
          const elDiv = document.createElement('div');
          elDiv.className = 'pack-card-element';
          let elementName = card.element;
          if (window.ELEMENT_INFO && window.ELEMENT_INFO[card.element] && window.ELEMENT_INFO[card.element].name) {
            elementName = window.ELEMENT_INFO[card.element].name;
          }
          elDiv.textContent = elementName || '';
          info.appendChild(elDiv);

          wrapper.appendChild(info);
          rewardsContainer.appendChild(wrapper);
        });
        modal.classList.add('active');
      },

      closePackModal() {
        const modal = document.getElementById('pack-modal');
        if (modal) {
          modal.classList.remove('active');
        }
      },

      // ========== END SHOP SYSTEM ==========

      loadDeckCards() {
        // –û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–∞ —Ç–æ–ø–±–∞—Ä—ñ
        const profile = userProfile.getProfile();
        if (!profile) {
          console.error('No user profile found');
          return;
        }

        const boltsEl = document.getElementById('deck-bolts');
        const gearsEl = document.getElementById('deck-gears');
        const coresEl = document.getElementById('deck-cores');
        
        if (boltsEl) boltsEl.textContent = this.formatCompact ? this.formatCompact(profile.bolts || 0) : String(profile.bolts || 0);
        if (gearsEl) gearsEl.textContent = this.formatCompact ? this.formatCompact(profile.gears || 0) : String(profile.gears || 0);
        if (coresEl) coresEl.textContent = this.formatCompact ? this.formatCompact(profile.cores || 0) : String(profile.cores || 0);

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫–∞—Ä—Ç–∏ —è–∫—â–æ —ó—Ö –Ω–µ–º–∞—î (–¥–ª—è —Å—Ç–∞—Ä–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤)
        if (!profile.deckCards || !profile.collectionCards) {
          console.log('Initializing cards for existing user...');
          const selectedCards = getRandomCards(16);
          profile.deckCards = selectedCards.slice(0, 9).map(card => ({
            id: card.id,
            level: 1
          }));
          profile.collectionCards = selectedCards.slice(9, 16).map(card => ({
            id: card.id,
            level: 1
          }));
          userProfile.updateCurrentUser(profile);
        }

        // –ú—ñ–≥—Ä–∞—Ü—ñ—è —Å—Ç–∞—Ä–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: –¥–æ–¥–∞—Ç–∏ progress —ñ inventory
        if (!profile.progress) {
          console.log('Migrating profile: adding progress...');
          profile.progress = {};
          const allCards = profile.deckCards.concat(profile.collectionCards || []);
          allCards.forEach(dc => {
            if (dc && dc.id) {
              profile.progress[dc.id] = { level: dc.level || 1, xp: 0 };
            }
          });
        }

        if (!profile.inventory) {
          console.log('Migrating profile: adding inventory...');
          profile.inventory = {};
          const allCards = profile.deckCards.concat(profile.collectionCards || []);
          allCards.forEach(dc => {
            if (dc && dc.id) {
              profile.inventory[dc.id] = (profile.inventory[dc.id] || 0) + 1;
            }
          });
        }

        // –í–∏–±—Ä–∞—Ç–∏ –∫–∞—Ä—Ç–∏ –∑ 16 –∑–≤–∏—á–∞–π–Ω–∏—Ö –∫–∞—Ä—Ç
        const deckCardIds = profile.deckCards.map(dc => dc.id);
        const deckCards = deckCardIds.map(cardId => getCardById(cardId))
          .filter(card => card !== undefined);
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –∫–∞—Ä—Ç–∏ –∑–Ω–∞–π–¥–µ–Ω—ñ
        if (deckCards.length === 0) {
          console.error('No cards found! Check if card scripts are loaded.');
          document.getElementById('deckGrid').innerHTML = '<p style="color: red; text-align: center; padding: 20px;">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ä—Ç</p>';
          return;
        }
        
        console.log('Loading deck cards:', deckCards.length, 'cards found');
        console.log('First card:', deckCards[0]);
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç ‚Äî —Å—Ç–≤–æ—Ä—é—î–º–æ –ø–∞—Ä–∏ {card, level, originalIndex}, —Å–æ—Ä—Ç—É—î–º–æ –∑–∞ –∑—Ä–æ—Å—Ç–∞–Ω–Ω—è–º –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ
        const deckGrid = document.getElementById('deckGrid');
        if (deckGrid) {
          const deckPairs = deckCards.map((card, index) => {
            const lvl = (profile.deckCards[index] && profile.deckCards[index].level) || 1;
            return { card, level: lvl, originalIndex: index };
          });

          // –§—É–Ω–∫—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç—É–∂–Ω–æ—Å—Ç—ñ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ä—ñ–≤–Ω—è
          const getCardPower = (c, lvl) => {
            try { return (window.getPower ? window.getPower(c, lvl) : getPower(c, lvl)) || 0; }
            catch (e) { return 0; }
          };

          // Sort descending: strongest first
          deckPairs.sort((a, b) => {
            const pa = getCardPower(a.card, a.level);
            const pb = getCardPower(b.card, b.level);
            if (pa === pb) return (b.card.id || '').localeCompare(a.card.id || '');
            return pb - pa;
          });

          const cardsHTML = deckPairs.map(p => this.renderDeckCard(p.card, p.level, p.originalIndex)).join('');

          console.log('Generated HTML length:', cardsHTML.length);
          deckGrid.innerHTML = cardsHTML;
          console.log('Cards rendered to grid (sorted ascending by power)');
          // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–∞—Ä–∞–ª–∞–∫—Å—É –¥–ª—è –∫–∞—Ä—Ç –ø—ñ—Å–ª—è —Ä–µ–Ω–¥–µ—Ä—É
          initCardParallax();

          // –û–Ω–æ–≤–∏—Ç–∏ —Å–∏–ª—É –∫–æ–ª–æ–¥–∏ (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è)
          let totalPower = 0;
          deckPairs.forEach((p) => {
            totalPower += getCardPower(p.card, p.level);
          });
          const powerDisplay = document.getElementById('deck-power-value');
          if (powerDisplay) powerDisplay.textContent = totalPower;

          // –ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏—Ö —ñ–Ω–¥–µ–∫—Å—ñ–≤
          const profileForUpgrade = userProfile.getProfile();
          const inventory = this.getInventory(profileForUpgrade);

          const hintEl = document.getElementById('deck-hint');
          if (hintEl) {
            if (this.hasAnyUpgradable(profileForUpgrade.deckCards, inventory)) {
              hintEl.classList.add('hot');
            } else {
              hintEl.classList.remove('hot');
            }
          }

          document.querySelectorAll('#deckGrid .sp-card').forEach((cardEl) => {
            const origAttr = cardEl.getAttribute('data-original-index');
            let originalIndex = origAttr ? parseInt(origAttr, 10) : -1;
            let deckItem = (originalIndex >= 0 && Array.isArray(profileForUpgrade.deckCards)) ? profileForUpgrade.deckCards[originalIndex] : undefined;

            // Fallback: try to resolve deckItem by card-id if originalIndex is invalid
            if (!deckItem) {
              const cardIdAttr = cardEl.getAttribute('data-card-id') || cardEl.getAttribute('data-id');
              if (cardIdAttr && Array.isArray(profileForUpgrade.deckCards)) {
                const foundIndex = profileForUpgrade.deckCards.findIndex(c => c && String(c.id) === String(cardIdAttr));
                if (foundIndex >= 0) {
                  deckItem = profileForUpgrade.deckCards[foundIndex];
                  originalIndex = foundIndex;
                }
              }
            }

            const canUpgrade = deckItem ? this.canUpgradeCard(deckItem, inventory) : false;

            cardEl.addEventListener('click', (e) => {
              e.preventDefault();
              const cardId = deckItem ? deckItem.id : cardEl.getAttribute('data-card-id') || cardEl.getAttribute('data-id');
              this.showCardDetails(cardId, true, originalIndex);
            });
          });
        }
        
        // –û–Ω–æ–≤–∏—Ç–∏ —Å–∏–ª—É –∫–æ–ª–æ–¥–∏ (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ä—ñ–≤–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É)
        let totalPower = 0;
        deckCards.forEach((card) => {
          const prog = window.getProgress ? window.getProgress(profile, card.id) : { level: 1, xp: 0 };
          const cardLevel = prog.level;
          totalPower += window.getPower ? window.getPower(card, cardLevel) : getPower(card, cardLevel);
        });
        
        const powerDisplay = document.getElementById('deck-power-value');
        if (powerDisplay) {
          powerDisplay.textContent = totalPower;
        }
        
        // –ü—Ä–∏–∫—Ä—ñ–ø–∏—Ç–∏ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
        const profileForUpgrade = userProfile.getProfile();
        const inventory = this.getInventory(profileForUpgrade);
        
        // –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–∞–Ω hint-—É
        const hintEl = document.getElementById('deck-hint');
        if (hintEl) {
          if (this.hasAnyUpgradable(profileForUpgrade.deckCards, inventory)) {
            hintEl.classList.add('hot');
          } else {
            hintEl.classList.remove('hot');
          }
        }
        
        // NOTE: event handlers for deck cards are attached above using sorted `deckPairs`
        // (we avoid attaching duplicate handlers here to prevent index mismatch bugs)
      },

      renderDeckCard(cardData, level = 1, originalIndex = -1) {
        const profile = userProfile.getProfile();
        const inventory = this.getInventory(profile);
        const prog = window.getProgress ? window.getProgress(profile, cardData.id) : { level: level, xp: 0 };
        const displayLevel = prog.level || level;
        const displayPower = window.getPower ? window.getPower(cardData, displayLevel) : getPower(cardData, displayLevel);
        const canUpgrade = this.canUpgradeCard({ id: cardData.id, level: displayLevel }, inventory);
        const canAutoLevel = canUpgrade && this.canGuaranteedLevelByBurning(profile, cardData.id);
        
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ CardRenderer —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∏–π
          if (window.cardRenderer) {
          // –ü–µ—Ä–µ–¥–∞—î–º–æ –∞—Ç–∞–∫—É —è–∫ –∞–∫—Ç—É–∞–ª—å–Ω—É —Å–∏–ª—É, —â–æ–± —Ä–µ–Ω–¥–µ—Ä –ø–æ–∫–∞–∑—É–≤–∞–≤ –ø—Ä–æ–∫–∞—á–∫—É
          const boostedCard = { 
            ...cardData, 
            attack: displayPower,
            power: displayPower,
            stats: { ...(cardData.stats || {}), power: displayPower }
          };
          let html = window.cardRenderer.render(boostedCard, { level: displayLevel, power: displayPower, showUpgrade: canAutoLevel, interactive: true });
          return html;
        }

        // Fallback —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ - –æ–¥–Ω–∞–∫–æ–≤–∏–π —à–∞–±–ª–æ–Ω —è–∫ CardRenderer
        const {
          id = 'unknown',
          element = 'fire',
          rarity = 'R1',
          basePower = 0,
          attack = displayPower
        } = cardData;

        const rarityNames = {
          'R1': '–ó–í–ò–ß–ê–ô–ù–ê',
          'R2': '–ù–ï–ó–í–ò–ß–ê–ô–ù–ê',
          'R3': '–†–Ü–î–ö–Ü–°–ù–ê',
          'R4': '–ï–ü–Ü–ß–ù–ê',
          'R5': '–õ–ï–ì–ï–ù–î–ê–†–ù–ê',
          'R6': '–ú–Ü–§–Ü–ß–ù–ê'
        };

        const rarityBadge = rarityNames[rarity] || '–ó–í–ò–ß–ê–ô–ù–ê';
        const shownPower = attack || basePower;

        const elementIcons = {
          fire: `<div class="element-emoji fire-emoji">üî•</div>`,
          water: `<div class="element-emoji water-emoji">üíß</div>`,
          air: `<div class="element-emoji air-emoji">üí®</div>`,
          earth: `<div class="element-emoji earth-emoji">üçÉ</div>`
        };

        const elementIcon = elementIcons[element] || elementIcons.fire;

        return `
          <div class="sp-card ${element} ${rarity} ${canUpgrade ? 'upgradable' : ''}" 
               data-id="${id}"
               data-card-id="${id}"
               data-original-index="${originalIndex}"
               data-element="${element}"
               data-rarity="${rarity}"
               data-power="${shownPower}"
               data-attack="${attack}">
            <!-- –î–ï–ö–û–†–ê–¢–ò–í–ù–Ü –õ–Ü–ù–Ü–á -->
            <div class="decor-line line-top"></div>
            <div class="decor-line line-bottom"></div>
            <!-- –ë–ï–ô–î–ñ –†–Ü–î–ö–û–°–¢–Ü -->
            <div class="rarity-badge">${rarityBadge}</div>
            <!-- –í–ï–õ–ò–ö–ê –î–ï–¢–ê–õ–¨–ù–ê –®–ï–°–¢–ï–†–ù–Ø -->
            <div class="corner-gear">
              <div class="gear-inner">
                ${elementIcon}
              </div>
            </div>
            <!-- –ü–õ–ê–®–ö–ê –°–ò–õ–ò –≤–Ω–∏–∑—É -->
            <div class="power-plate">
              <div class="power-value">${shownPower}</div>
            </div>
            ${canAutoLevel ? '<div class="upgrade-arrow">‚ñ≤</div>' : ''}
          </div>
        `;
      },

      // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–∏–ª–∏ –∫–∞—Ä—Ç–∏ –≤ DOM –ø—ñ—Å–ª—è –ø—Ä–æ–∫–∞—á–∫–∏
      refreshCardPowerInDeck(cardId) {
        const profile = userProfile.getProfile();
        const cardData = window.getCardById(cardId);
        if (!cardData) return;

        const prog = window.getProgress ? window.getProgress(profile, cardId) : { level: 1, xp: 0 };
        const newPower = window.getPower ? window.getPower(cardData, prog.level) : cardData.basePower;

        // –û–Ω–æ–≤–∏—Ç–∏ —Å–∏–ª—É –≤ DOM
        const powerEl = document.querySelector(
          `.sp-card[data-card-id="${cardId}"] .power-value`
        );
        if (powerEl) {
          powerEl.textContent = String(newPower);
        }

        // –û–Ω–æ–≤–∏—Ç–∏ –∞—Ç—Ä–∏–±—É—Ç–∏ data-power —Ç–∞ data-attack
        const cardEl = document.querySelector(`.sp-card[data-card-id="${cardId}"]`);
        if (cardEl) {
          cardEl.setAttribute('data-power', newPower);
          cardEl.setAttribute('data-attack', newPower);
        }

        // –û–Ω–æ–≤–∏—Ç–∏ –∑–∞–≥–∞–ª—å–Ω—É —Å–∏–ª—É –∫–æ–ª–æ–¥–∏
        this.loadDeckCards();
      },

      loadCollectionCards() {
        const profile = userProfile.getProfile();
        if (!profile) {
          console.error('No profile found');
          return;
        }

        // –ó–Ω–∞–π–¥–µ–Ω—ñ –∫–∞—Ä—Ç–∏ (ID): –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó —Ç–∞ –∫–æ–ª–æ–¥–∏
        let foundIds = new Set([
          ...((profile.collectionCards || []).map(c => c.id)),
          ...((profile.deckCards || []).map(c => c.id))
        ]);

        // –í—Å–µ –∫–∞—Ä—Ç—ã –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º
        let allCards = window.ALL_CARDS || [];
        const elements = ['fire', 'water', 'air', 'earth'];
        const elementNames = {
          fire: '–í–æ–≥–Ω—è–Ω–∞ —Å—Ç–∏—Ö—ñ—è',
          water: '–í–æ–¥—è–Ω–∞ —Å—Ç–∏—Ö—ñ—è',
          air: '–ü–æ–≤—ñ—Ç—Ä—è–Ω–∞ —Å—Ç–∏—Ö—ñ—è',
          earth: '–ó–µ–º–ª—è–Ω–∞ —Å—Ç–∏—Ö—ñ—è'
        };

        elements.forEach(element => {
          const grid = document.getElementById(element + '-collection');
          if (!grid) return;
          const cards = allCards.filter(card => card.element === element);
          let foundCount = 0;
          grid.innerHTML = cards.map(card => {
            const found = foundIds.has(card.id);
            if (found) foundCount++;
            return `
              <div class="collection-card-item${found ? ' found' : ' not-found'}">
                <span class="collection-card-name">${card.name}</span>
                <span class="collection-card-status">${found ? '–ó–Ω–∞–π–¥–µ–Ω–æ' : '–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ'}</span>
              </div>
            `;
          }).join('');
          // –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
          const progress = document.getElementById(element + '-progress');
          if (progress) progress.textContent = `${foundCount}/${cards.length} –∫–∞—Ä—Ç`;
        });
      },

      // ========== CARD DETAILS PAGE ==========

      showCardDetails(cardId, fromDeck = false, deckIndex = -1) {
        const profile = userProfile.getProfile();
        const cardData = getCardById(cardId);

        if (!cardData) {
          console.error('Card not found:', cardId);
          return;
        }

        // –í–∏–∑–Ω–∞—á–∏—Ç–∏ —Ä—ñ–≤–µ–Ω—å –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å–æ–º (–ø—Ä–æ–∫–∞—á–∫–∞)
        const prog = window.getProgress ? window.getProgress(profile, cardId) : { level: 1, xp: 0 };
        const cardLevel = prog.level;
        const actualPower = window.getPower ? window.getPower(cardData, cardLevel) : Math.round(cardData.basePower * Math.pow(cardData.upgradeMult, cardLevel - 1));

        // –†–µ–Ω–¥–µ—Ä–∏—Ç–∏ –æ—Å–Ω–æ–≤–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –∫–∞—Ä—Ç—É
        this.renderCardDetails(cardData, cardLevel, actualPower, deckIndex);

        // –ó–Ω–∞–π–¥–µ–Ω—ñ –∫–∞—Ä—Ç–∏ (ID): –∑ –∫–æ–ª–µ–∫—Ü—ñ—ó —Ç–∞ –∫–æ–ª–æ–¥–∏
        const foundIds = new Set([
          ...((profile.collectionCards || []).map(c => c.id)),
          ...((profile.deckCards || []).map(c => c.id))
        ]);
        // –ó–Ω–∞–π—Ç–∏ –≤—Å—ñ –∫–∞—Ä—Ç–∏ —Ü—ñ—î—ó —Å—Ç–∏—Ö—ñ—ó (–∑ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö)
        const allCards = window.ALL_CARDS || window.CARDS_COMMON || [];
        const sameElementCards = allCards.filter(c => c.element === cardData.element);
        // –í–∏–∑–Ω–∞—á–∏—Ç–∏ —Å–∏–ª—É —Ü—ñ–ª—å–æ–≤–æ—ó –∫–∞—Ä—Ç–∏ —á–µ—Ä–µ–∑ getPower (–∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ä—ñ–≤–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É)
        const targetPower = window.getPower ? (window.getPower(cardData, cardLevel)) : (cardData.basePower || cardData.power || 0);
        const deckIds = new Set((profile.deckCards || []).map(c => c.id));
        // –í—Å—ñ —Å–ª–∞–±—à—ñ –∫–∞—Ä—Ç–∏ —Ü—ñ—î—ó —Å—Ç–∏—Ö—ñ—ó, —è–∫—ñ –∑–Ω–∞–π–¥–µ–Ω—ñ —É –ø—Ä–æ—Ñ—ñ–ª—ñ, –∞–ª–µ –ù–ï –≤ –∫–æ–ª–æ–¥—ñ
        const weakerCards = sameElementCards.filter(c => {
          if (!c || !c.id) return false;
          if (!foundIds.has(c.id)) return false;
          if (deckIds.has(c.id)) return false;
          // –≤—ã—á–∏—Å–ª–∏–º —Å–∏–ª—É –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º getPower –µ—Å–ª–∏ –µ—Å—Ç—å –∏ —É—á–∏—Ç—ã–≤–∞–µ–º –µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å)
          const candProg = window.getProgress ? window.getProgress(profile, c.id) : { level: 1, xp: 0 };
          const candPower = window.getPower ? window.getPower(c, candProg.level) : (c.basePower || c.power || 0);
          return candPower < targetPower && c.id !== cardId;
        });

        // –ü–æ–∫–∞–∑/—Å–∫—Ä—ã—Ç–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ —Å–ø–∏—Å–∫–∞ —Å–ª–∞–±—à–∏—Ö –∫–∞—Ä—Ç
        const weakerHeader = document.getElementById('weaker-cards-header');
        const weakerList = document.getElementById('weaker-cards-list');
        if (weakerCards.length > 0) {
          if (weakerHeader) weakerHeader.style.display = '';
          if (weakerList) weakerList.style.display = '';
          this.renderWeakerCards(weakerCards, cardId, profile);
        } else {
          if (weakerHeader) weakerHeader.style.display = 'none';
          if (weakerList) {
            weakerList.style.display = 'none';
            weakerList.innerHTML = '';
          }
        }

        // === –ü–†–û–°–¢–ê –í–Ü–ó–£–ê–õ–Ü–ó–ê–¶–Ü–Ø –ü–†–û–ö–ê–ß–ö–ò ===
        // –ü–æ–∫–∞–∂–µ–º–æ –ø—Ä–æ—Å—Ç–∏–π XP-–±–∞—Ä –∞–±–æ –≤–∏–∫–ª–∏—á–µ–º–æ –≤–Ω–µ—à–Ω—é—é –æ—Ç—Ä–∏—Å–æ–≤–∫—É, —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∞
        const cardMain = document.getElementById('card-main-info');
        const xpBar = cardMain ? cardMain.querySelector('.xp-bar') : null;
        if (window.renderUpgradeBar) {
          window.renderUpgradeBar(profile, cardId);
        } else if (xpBar) {
          const need = this.xpNeededForLevel(prog.level || 1) || 100;
          xpBar.style.width = `${Math.min(100, Math.round(((prog.xp || 0) / need) * 100))}%`;
        }
        // –û–±–Ω–æ–≤–∏—Ç–∏ –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
        const backBtn = document.getElementById('card-details-back');
        if (backBtn) {
          backBtn.onclick = (e) => {
            e.preventDefault();
            if (fromDeck) {
              this.showPage('deck');
            } else {
              this.showPage('collections');
            }
          };
        }

        // –ü–æ–∫–∞–∑–∞—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É
        this.showPage('card-details');
      },
      renderCardDetails(cardData, level, power, deckIndex) {
        const mainDisplay = document.getElementById('card-main-info');
        if (!mainDisplay) return;

        // –í–∏–∑—É–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º cardRenderer –∏–ª–∏ createCardView, –∏–Ω–∞—á–µ fallback
        let visualHtml = '';
        if (window.cardRenderer && typeof window.cardRenderer.render === 'function') {
          // –ü–µ—Ä–µ–¥–∞–µ–º power & level —á–µ—Ä–µ–∑ opts, —á—Ç–æ–±—ã —Ä–µ–Ω–¥–µ—Ä–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å–∏–ª—É
          visualHtml = window.cardRenderer.render({ ...cardData }, { level, power });
        } else if (window.createCardView) {
          try {
            // –ï—Å–ª–∏ createCardView —É–º–µ–µ—Ç —á–∏—Ç–∞—Ç—å –ø–æ–ª–µ power –≤ –æ–±—ä–µ–∫—Ç–µ ‚Äî –ø—Ä–æ–∫–∏–Ω–µ–º –µ–≥–æ
            const el = window.createCardView({ ...cardData, power, level });
            visualHtml = el ? el.outerHTML : '';
          } catch (err) {
            console.warn('createCardView failed', err);
            visualHtml = '';
          }
        }

        if (!visualHtml) {
          // –ü—Ä–æ—Å—Ç–æ–π fallback –≤–∏–∑—É–∞–ª
          const elem = cardData.element || '';
          const shownPower = power || cardData.basePower || 0;
          visualHtml = `
            <div class="sp-card large ${elem}">
              <div class="corner-gear">${elem}</div>
              <div class="power-plate"><div class="power-value">${shownPower}</div></div>
              <div class="card-name">${cardData.name || ''}</div>
            </div>`;
        }

        // –ò–Ω—Ñ–æ —Å–ø—Ä–∞–≤–∞: –∏–º—è, —Å—Ç–∏—Ö–∏—è, —Ä–µ–¥–∫–æ—Å—Ç—å, —É—Ä–æ–≤–µ–Ω—å
        const prog = (userProfile.getProfile && window.getProgress) ? window.getProgress(userProfile.getProfile(), cardData.id) : { level: level || 1, xp: 0 };
        const levelText = `LV ${prog.level || level || 1}`;
        const need = this.xpNeededForLevel(prog.level || 1) || 100;
        const xpText = `${prog.xp || 0} / ${need} XP`;

        mainDisplay.innerHTML = `
          <div style="display:flex; gap:14px; align-items:flex-start;">
            <div class="card-visual-area">${visualHtml}</div>
            <div class="card-meta" style="flex:1">
              <div class="card-meta-name" style="font-size:18px; font-weight:700; margin-bottom:6px">${cardData.name || ''}</div>
              <div class="card-meta-row">–°—Ç–∏—Ö—ñ—è: <strong>${(cardData.element || '').toUpperCase()}</strong></div>
              <div class="card-meta-row">–†—ñ–¥–∫—ñ—Å—Ç—å: <strong>${cardData.rarity || ''}</strong></div>
              <div class="card-meta-row" style="margin-top:8px">–†—ñ–≤–µ–Ω—å: <span id="cu-level-inner">${levelText}</span></div>
              <div class="card-meta-row">XP: <span id="cu-xp-text-inner">${xpText}</span></div>
            </div>
          </div>`;

        // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–∞–Ω–µ–ª—å –ø—Ä–æ–∫–∞—á–∫–∏ –≤ —Å–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π
        const cuLevel = document.getElementById('cu-level');
        const cuXpText = document.getElementById('cu-xp-text');
        const cuXpFill = document.getElementById('cu-xp-fill');
        if (cuLevel) cuLevel.textContent = levelText;
        if (cuXpText) cuXpText.textContent = xpText;
        if (cuXpFill) cuXpFill.style.width = `${Math.min(100, Math.round(((prog.xp || 0) / need) * 100))}%`;

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
        const addBtn = document.getElementById('card-add-to-deck-btn');
        const removeBtn = document.getElementById('card-remove-btn');
        const upgradeBtn = document.getElementById('card-upgrade-btn');

        if (addBtn) {
          addBtn.onclick = (e) => {
            e.preventDefault();
            const profile = userProfile.getProfile();
            const res = userProfile.autoAddToDeck(profile, { id: cardData.id, level: prog.level || 1 });
            if (res.added || res.replaced) {
              userProfile.updateCurrentUser(profile);
              this.loadDeckCards();
              this.loadCollectionCards();
              alert('–ö–∞—Ä—Ç–∞ –¥–æ–¥–∞–Ω–∞ –≤ –∫–æ–ª–æ–¥—É');
            } else {
              alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –¥–æ–¥–∞—Ç–∏ –∫–∞—Ä—Ç—É –≤ –∫–æ–ª–æ–¥—É');
            }
          };
        }

        if (removeBtn) {
          removeBtn.onclick = (e) => {
            e.preventDefault();
            const profile = userProfile.getProfile();
            // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç—É –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏/–∏–ª–∏ –∏–∑ –∫–æ–ª–æ–¥—ã
            if (profile.collectionCards) {
              for (let i = profile.collectionCards.length - 1; i >= 0; i--) {
                if (profile.collectionCards[i].id === cardData.id) {
                  profile.collectionCards.splice(i, 1);
                  break;
                }
              }
            }
            if (profile.deckCards) {
              for (let i = profile.deckCards.length - 1; i >= 0; i--) {
                if (profile.deckCards[i].id === cardData.id) {
                  profile.deckCards.splice(i, 1);
                  break;
                }
              }
            }
            userProfile.updateCurrentUser(profile);
            this.loadDeckCards();
            this.loadCollectionCards();
            this.showPage('collections');
          };
        }

        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–∫–∞—á–∫–∏ —É–¥–∞–ª–µ–Ω–∞ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        try {
          const upgradeBtnEl = document.getElementById('card-upgrade-btn');
          if (upgradeBtnEl) {
            upgradeBtnEl.style.display = 'none';
            upgradeBtnEl.onclick = null;
          }
          const cuBtn = document.getElementById('cu-upgrade-btn');
          if (cuBtn) cuBtn.remove();
        } catch (err) {
          console.warn('upgrade button cleanup failed', err);
        }
      },

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ —Å–ª–∞–±—à–∏—Ö –∫–∞—Ä—Ç: –ø–ª–∏—Ç–∫–∏ —Å –≤–∏–∑—É–∞–ª–æ–º (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç cardRenderer, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
        renderWeakerCards(weakerCards, targetCardId, profile) {
          const list = document.getElementById('weaker-cards-list');
          if (!list) return;
          const targetCard = window.getCardById ? window.getCardById(targetCardId) : null;

          // –°–æ–∑–¥–∞—ë–º —Å–µ—Ç–∫—É
          const tiles = weakerCards.map(c => {
            const card = (c && c.id && window.getCardById) ? window.getCardById(c.id) : c;
            if (!card) return '';

            // –ü—Ä–æ—Ü–µ–Ω—Ç–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å: —Å–∫–æ–ª—å–∫–æ XP –¥–∞—Å—Ç —Å–ø–∞–ª–µ–Ω–Ω—è —ç—Ç–æ–π –∫–∞—Ä—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ–≥–æ XP –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
            const progTarget = (profile && profile.progress && profile.progress[targetCardId]) ? profile.progress[targetCardId] : { level: 1, xp: 0 };
            const need = this.xpNeededForLevel(progTarget.level) || 100;
            const cardPower = card.basePower || card.power || 0;
            const xpGain = cardPower || 10;
            const pct = Math.max(0, Math.min(100, Math.round((xpGain / need) * 100)));

            // –†–µ–Ω–¥–µ—Ä —á–µ—Ä–µ–∑ cardRenderer –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
            let cardHtml = '';
            if (window.cardRenderer && typeof window.cardRenderer.render === 'function') {
              cardHtml = window.cardRenderer.render({ ...card, power: cardPower });
            } else if (window.createCardView) {
              const el = window.createCardView(card);
              cardHtml = el ? el.outerHTML : '';
            } else {
              // fallback –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–∏–∑—É–∞–ª
              cardHtml = `
                <div class="sp-card ${card.element || ''}">
                  <div class="corner-gear">${card.element || ''}</div>
                  <div class="power-plate"><div class="power-value">${cardPower}</div></div>
                  <div class="card-name">${card.name}</div>
                </div>`;
            }

            return `
              <div class="weaker-card-tile" data-card-id="${card.id}">
                <div class="weaker-card-visual">${cardHtml}</div>
                <div class="weaker-card-footer">
                  <div class="weaker-card-power">${cardPower}</div>
                  <div class="weaker-card-pct">+${pct}%</div>
                </div>
              </div>`;
          }).join('');

          list.innerHTML = `<div class="weaker-grid">${tiles}</div>`;

          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –ø–ª–∏—Ç–∫—É: –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–∏–º–∞–µ—à—å –Ω–∞ –∫–∞—Ä—Ç—É ‚Äî –æ–Ω–∞ —Å–≥–æ—Ä–∞–µ—Ç
          list.querySelectorAll('.weaker-card-tile').forEach(tile => {
            tile.addEventListener('click', (e) => {
              const srcId = tile.dataset.cardId;
              if (!srcId) return;
              const result = this.burnCardForXP(profile, srcId, targetCardId);
              if (result && result.success) {
                // –£–¥–∞–ª—è–µ–º –ø–ª–∏—Ç–∫—É –∏–∑ DOM
                tile.remove();
                userProfile.updateCurrentUser(profile);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
                this.loadCollectionCards();
                this.loadDeckCards();
                // –û–±–Ω–æ–≤–∏–º –¥–µ—Ç–∞–ª–∏ –µ—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞—Ä—Ç–∫–∏
                if (this.currentPage === 'card-details') {
                  this.renderCardDetails(window.getCardById(targetCardId), result.newLevel, result.newPower || 0, -1);
                  if (window.renderUpgradeBar) window.renderUpgradeBar(profile, targetCardId);
                }
                // –ë–µ–∑ alert'–∞ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∞ –∏—Å—á–µ–∑–ª–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±–Ω–æ–≤–ª—ë–Ω
              } else {
                console.warn(result && result.error ? result.error : '–ù–µ –≤–¥–∞–ª–æ—Å—è —Å–ø–∞–ª–∏—Ç–∏ –∫–∞—Ä—Ç—É');
              }
            });
          });
        },

        // –°–∂–µ—á—å –∫–∞—Ä—Ç—É –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏/—ñ–Ω–≤–µ–Ω—Ç–∞—Ä—è —Ä–∞–¥–∏ XP —Ü–µ–ª–µ–≤–æ–π –∫–∞—Ä—Ç—ã (–±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π)
        burnCardForXP(profile, sourceCardId, targetCardId) {
          if (!profile || !sourceCardId || !targetCardId) return { success: false, error: '–ù–µ–≤—ñ—Ä–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏' };

          // –ù–∞–π—Ç–∏ –∏ —É–¥–∞–ª–∏—Ç—å –æ–¥–Ω—É –∫–æ–ø–∏—é –∏–∑ collectionCards (–ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –∞ –Ω–µ –∏–∑ –∫–æ–ª–æ–¥—ã)
          let removed = false;
          let removedFromInventory = false;
          if (Array.isArray(profile.collectionCards)) {
            for (let i = profile.collectionCards.length - 1; i >= 0; i--) {
              if (profile.collectionCards[i].id === sourceCardId) {
                profile.collectionCards.splice(i, 1);
                removed = true;
                break;
              }
            }
          }

          // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –ø–æ–ø—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞–ø—Ä—è–º—É—é (inventory —Å—á–µ—Ç—á–∏–∫)
          if (!removed && profile.inventory && profile.inventory[sourceCardId] > 0) {
            profile.inventory[sourceCardId] = Math.max(0, profile.inventory[sourceCardId] - 1);
            removed = true;
            removedFromInventory = true;
          }

          if (!removed) return { success: false, error: '–ö–æ–ø—ñ—è –∫–∞—Ä—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —Å–ø–∞–ª–µ–Ω–Ω—è' };

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º XP-–≥–∏–≤ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–ª—É –∫–∞—Ä—Ç—ã –∫–∞–∫ –±–∞–∑–æ–≤—ã–π XP)
          const srcCard = window.getCardById ? window.getCardById(sourceCardId) : null;
          const tgtCard = window.getCardById ? window.getCardById(targetCardId) : null;
          const xpGain = srcCard ? (srcCard.basePower || srcCard.power || 10) : 10;

          // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ progress –µ—Å—Ç—å
          if (!profile.progress) profile.progress = {};
          if (!profile.progress[targetCardId]) profile.progress[targetCardId] = { level: 1, xp: 0 };

          // –î–æ–±–∞–≤–ª—è–µ–º XP –∏—Å–ø–æ–ª—å–∑—É—è –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞), —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∞
          if (window.addXp && window.getProgress) {
            window.addXp(profile, targetCardId, xpGain);
            const prog = window.getProgress(profile, targetCardId);
            var newLevel = prog.level || 1;
            var leveled = true; // –Ω–µ–≤–∞–∂–Ω–æ —Ç–æ—á–Ω–æ —á–∏—Å–ª–æ ‚Äî –º—ã –≤–µ—Ä–Ω—ë–º —Ñ–∞–∫—Ç —É—Å–ø–µ—Ö–∞
          } else {
            // fallback: –ª–æ–∫–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (—É—Å—Ç–∞—Ä–µ–≤—à–∞—è –ª–æ–≥–∏–∫–∞)
            profile.progress[targetCardId].xp = (profile.progress[targetCardId].xp || 0) + xpGain;
            let leveledLocal = false;
            let newLevelLocal = profile.progress[targetCardId].level || 1;
            while (profile.progress[targetCardId].xp >= this.xpNeededForLevel(newLevelLocal)) {
              profile.progress[targetCardId].xp -= this.xpNeededForLevel(newLevelLocal);
              newLevelLocal += 1;
              leveledLocal = true;
            }
            profile.progress[targetCardId].level = newLevelLocal;
            var newLevel = newLevelLocal;
            var leveled = leveledLocal;
          }

          // –ï—Å–ª–∏ –∫–∞—Ä—Ç–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º inventory; –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∞ –∏–∑ inventory, —É–∂–µ —É–º–µ–Ω—å—à–∏–ª–∏ –≤—ã—à–µ

          // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å –≤ –∑–∞–ø–∏—Å–∏ –∫–æ–ª–æ–¥—ã, –µ—Å–ª–∏ –∫–∞—Ä—Ç–∞ —Ç–∞–º –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
          if (Array.isArray(profile.deckCards)) {
            for (let i = 0; i < profile.deckCards.length; i++) {
              if (profile.deckCards[i] && profile.deckCards[i].id === targetCardId) {
                profile.deckCards[i].level = newLevel;
                break;
              }
            }
          }

          // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—ã–∑—ã–≤–∞—é—â–µ–π —Å—Ç–æ—Ä–æ–Ω–æ–π
          const newPower = tgtCard ? (window.getPower ? window.getPower(tgtCard, newLevel) : (tgtCard.basePower || 0)) : null;

          return { success: true, leveled, newLevel, newPower };
        },

      // ========== DUELS (MVP) ==========
      
      // ========== DUELS (MVP) ========== 
      updatePlayerMultiplierPreview() {
        if (!window.CURRENT_DUEL) return;
        const duel = window.CURRENT_DUEL;
        const container = document.getElementById('duelMultipliers');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Create 3 multiplier badges for 3 slots
        for (let i = 0; i < 3; i++) {
          const pCard = duel.player.hand[i];
          const eCard = duel.enemy.hand[i];
          
          if (!pCard || !eCard) {
            container.innerHTML += '<div class="mult-badge" style="opacity:0.3"><span class="mult-text">‚Äî</span></div>';
            continue;
          }
          
          const mult = (window.MULT[pCard.element]?.[eCard.element]) ?? 1;
          const multClass = mult > 1 ? 'mult-good' : mult < 1 ? 'mult-bad' : 'mult-neutral';
          const multText = mult === 1 ? '√ó 1' : `√ó ${mult.toFixed(1)}`;
          
          container.innerHTML += `
            <div class="mult-badge ${multClass}">
              <span class="swords"></span>
              <span class="mult-text">${multText}</span>
            </div>
          `;
        }
      },
      
      initDuelsPage() {
        const btn = document.getElementById('duel-start-btn');
        if (btn) {
          // –°–∫—Ä—ã–≤–∞–µ–º —Ä—É—á–Ω—É—é –∫–Ω–æ–ø–∫—É ‚Äî –ø–æ–∏—Å–∫ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º
          btn.style.display = 'none';
        }
        // Clear UI and show searching state
        const enemyHpEl = document.getElementById('enemyHp');
        const playerHpEl = document.getElementById('playerHp');
        const enemyHandEl = document.getElementById('enemyHand');
        const playerHandEl = document.getElementById('playerHand');
        const duelLogEl = document.getElementById('duelLog');
        // update both legacy text nodes and new HUD elements
        if (enemyHpEl) enemyHpEl.textContent = '0/0';
        if (playerHpEl) playerHpEl.textContent = '0/0';
        const enemyHpText = document.getElementById('enemyHpText');
        const playerHpText = document.getElementById('playerHpText');
        const enemyHpBar = document.getElementById('enemyHpBar');
        const playerHpBar = document.getElementById('playerHpBar');
        if (enemyHpText) enemyHpText.textContent = '0/0';
        if (playerHpText) playerHpText.textContent = '0/0';
        if (enemyHpBar) enemyHpBar.style.width = '0%';
        if (playerHpBar) playerHpBar.style.width = '0%';
        if (enemyHandEl) enemyHandEl.innerHTML = '';
        if (playerHandEl) playerHandEl.innerHTML = '';
        if (duelLogEl) duelLogEl.innerHTML = '–ü–æ—à—É–∫ –≤–æ—Ä–æ–≥–∞...';

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ—á–∏–Ω–∞—î–º–æ –ø–æ—à—É–∫/–∑–∞–ø—É—Å–∫ –¥—É–µ–ª—ñ
        setTimeout(() => this.startRandomDuel(), 250);
      },

      buildDuelDeckFromProfile(profile) {
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ level –∑ progress –¥–ª—è —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É —Å–∏–ª–∏ –≤ –¥—É–µ–ª—ñ
        return profile.deckCards.map(dc => {
          const card = getCardById(dc.cardId || dc.id);
          const prog = window.getProgress ? window.getProgress(profile, dc.uid || dc.id) : { level: 1, xp: 0 };
          const cardLevel = prog.level;
          const power = window.getPower ? window.getPower(card, cardLevel) : Math.round(card.basePower * Math.pow(card.upgradeMult, cardLevel - 1));
          return { id: card.id, element: card.element, power };
        });
      },

      calcDeckPower(deck) {
        return deck.reduce((s, c) => s + (c.power || 0), 0);
      },

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ–π –∫–æ–ª–æ–¥—ã –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞: –ø—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–±–ª–∏–∑–∏—Ç—å—Å—è –∫ —Å—É–º–º–∞—Ä–Ω–æ–π —Å–∏–ª–µ –∏–≥—Ä–æ–∫–∞ ¬±100
      generateAdaptiveEnemyDeck(playerDeck9, profile) {
        const calcPower = (card, level = 1) => {
          if (window.getPower) return window.getPower(card, level);
          return card.attack || card.basePower || 0;
        };

        // –≤—ã—á–∏—Å–ª—è–µ–º —Å—É–º–º–∞—Ä–Ω—É—é —Å–∏–ª—É –∏–≥—Ä–æ–∫–∞, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
        let playerTotal = 0;
        try {
          if (profile && profile.deckCards && profile.deckCards.length) {
            profile.deckCards.forEach(dc => {
              const src = (window.ALL_CARDS || []).find(x => x.id === (dc.cardId || dc.id)) || null;
              const prog = window.getProgress ? window.getProgress(profile, dc.uid || dc.id) : { level: dc.level || 1 };
              const lvl = (prog && prog.level) ? prog.level : (dc.level || 1);
              if (src) playerTotal += calcPower(src, lvl) || 0;
            });
          } else {
            playerTotal = playerDeck9.reduce((s, c) => s + (calcPower(c, 1) || 0), 0);
          }
        } catch (err) {
          playerTotal = playerDeck9.reduce((s, c) => s + (calcPower(c, 1) || 0), 0);
        }

        const offset = Math.floor(Math.random() * 201) - 100; // -100..+100
        const targetTotal = Math.max(0, playerTotal + offset);

        // pool: –µ—Å–ª–∏ –º–∞–ª–æ –∫–∞—Ä—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º ALL_CARDS
        const allCards = window.ALL_CARDS || window.CARDS_COMMON || [];
        let pool = allCards.slice().filter(c => !(String(c.id).startsWith('S')));
        if (pool.length < 9) pool = allCards.slice();

        const cardPower = c => calcPower(c, 1) || 0;

        // Greedy selection
        const selected = [];
        let currentSum = 0;
        for (let slot = 0; slot < 9; slot++) {
          let bestIdx = -1;
          let bestDelta = Infinity;
          for (let i = 0; i < pool.length; i++) {
            const p = cardPower(pool[i]);
            const newSum = currentSum + p;
            const delta = Math.abs(newSum - targetTotal);
            if (delta < bestDelta) { bestDelta = delta; bestIdx = i; }
          }
          if (bestIdx === -1) break;
          const pick = pool.splice(bestIdx, 1)[0];
          selected.push(pick);
          currentSum += cardPower(pick);
        }

        // Fill if not enough
        if (selected.length < 9) {
          const extras = (allCards.concat(selected)).slice(0, 9 - selected.length);
          selected.push(...extras);
        }

        // Level-up selected cards to approach targetTotal
        const enriched = selected.map(c => ({ src: c, level: 1, power: cardPower(c) }));
        let selectedSum = enriched.reduce((s, e) => s + e.power, 0);
        let attempts = 0;
        const maxAttempts = 500;
        while (selectedSum < targetTotal && attempts < maxAttempts) {
          let bestIdx = -1;
          let bestGain = 0;
          for (let i = 0; i < enriched.length; i++) {
            const e = enriched[i];
            const nextLevel = Math.min((e.level || 1) + 1, 20);
            const nextPower = calcPower(e.src, nextLevel) || e.power;
            const gain = nextPower - e.power;
            if (gain > bestGain) { bestGain = gain; bestIdx = i; }
          }
          if (bestIdx === -1 || bestGain <= 0) break;
          enriched[bestIdx].level = Math.min((enriched[bestIdx].level || 1) + 1, 20);
          enriched[bestIdx].power = calcPower(enriched[bestIdx].src, enriched[bestIdx].level) || enriched[bestIdx].power;
          selectedSum = enriched.reduce((s, e) => s + e.power, 0);
          attempts++;
        }

        // Map to lightweight enemy objects compatible with legacy duel
        const enemyDeck9 = enriched.map(e => ({ id: e.src.id, element: e.src.element, power: Math.max(1, Math.round(e.power || 1)) }));
        return enemyDeck9;
      },

      xpNeededForLevel(level) {
        const L = Math.max(1, Number(level) || 1);
        const BASE = 200;    // XP –¥–ª—è —Ä—ñ–≤–Ω—è 1‚Üí2
        const GROWTH = 1.12; // —Ç–µ–º–ø —Ä–æ—Å—Ç—É (1.08..1.18 —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ)
        return Math.round(BASE * Math.pow(GROWTH, L - 1));
      },

      pendingDuel: null,

      createCardNode(card, isPlayer, slotIdx) {
        const elementIcons = {
          fire: '<div class="element-emoji fire-emoji">üî•</div>',
          water: '<div class="element-emoji water-emoji">üíß</div>',
          air: '<div class="element-emoji air-emoji">üí®</div>',
          earth: '<div class="element-emoji earth-emoji">üçÉ</div>'
        };
        const elementIcon = elementIcons[card.element] || elementIcons.fire;
        const el = document.createElement('div');
        el.className = `sp-card ${card.element} common`;
        if (slotIdx !== undefined) el.dataset.slot = slotIdx;
        
        el.innerHTML = `
          <div class="corner-gear">
            ${elementIcon}
          </div>
          <div class="power-plate"><div class="power-value">${card.power}</div></div>
        `;
        return el;
      },

      startRandomDuel() {
        const profile = userProfile.getProfile();
        if (!profile || !profile.deckCards || profile.deckCards.length < 9) {
          alert('–ö–æ–ª–æ–¥–∞ –Ω–µ–ø–æ–≤–Ω–∞. –ü–æ—Ç—Ä—ñ–±–Ω–æ 9 –∫–∞—Ä—Ç.');
          return;
        }
        const playerDeck9 = this.buildDuelDeckFromProfile(profile);
        const playerPower = this.calcDeckPower(playerDeck9);

        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–¥–∞–ø—Ç–∏–≤–Ω—É—é –∫–æ–ª–æ–¥—É –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ (–ø—Ä–∏–±–ª–∏–∂–µ–Ω–Ω–æ –∫ playerPower ¬±100)
        const enemyDeck9 = this.generateAdaptiveEnemyDeck(playerDeck9, profile);
        let enemyPower = this.calcDeckPower(enemyDeck9);

        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ pending
        this.pendingDuel = { playerDeck9, enemyDeck9, playerPower, enemyPower };
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫/–ø–æ—á–∞—Ç–æ–∫ –±–æ—é ‚Äî –º—ñ–Ω—ñ-—Ç–∞–π–º–∞—É—Ç –¥–ª—è –≤—ñ–¥—á—É—Ç—Ç—è –ø–æ—à—É–∫—É
        const logEl = document.getElementById('duelLog');
        if (logEl) logEl.textContent = '–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫ –∑–Ω–∞–π–¥–µ–Ω–∏–π ‚Äî –≥–æ—Ç—É—î–º–æ—Å—å...';
        setTimeout(() => {
          window.CURRENT_DUEL = window.createDuel(this.pendingDuel.playerDeck9, this.pendingDuel.enemyDeck9);
          this.renderDuel();
        }, 700);
      },

      showPreDuelDialog() {
        const modal = document.getElementById('duel-pre-modal');
        if (!modal || !this.pendingDuel) return;
        const profile = userProfile.getProfile();
        const enemyNameEl = document.getElementById('duel-pre-name');
        const enemyPowerEl = document.getElementById('duel-pre-power');
        const playerPowerEl = document.getElementById('duel-pre-player-power');

        // –ì–µ–Ω–µ—Ä—É—î–º–æ —ñ–º'—è –≤–æ—Ä–æ–≥–∞
        const names = ['Lucky Harry','Steam Witch','Rust Baron','Copper Shade','Gearmancer','Brass Vex','Coal Phantom'];
        const picked = names[Math.floor(Math.random()*names.length)];
        this.pendingDuel.enemyName = picked;

        if (enemyNameEl) enemyNameEl.textContent = picked;
        if (enemyPowerEl) enemyPowerEl.textContent = this.pendingDuel.enemyPower;
        if (playerPowerEl) playerPowerEl.textContent = this.pendingDuel.playerPower;

        modal.classList.add('active');

        const attackBtn = document.getElementById('duel-pre-attack');
        const rerollBtn = document.getElementById('duel-pre-reroll');
        if (attackBtn) {
          attackBtn.onclick = () => {
            modal.classList.remove('active');
            window.CURRENT_DUEL = window.createDuel(this.pendingDuel.playerDeck9, this.pendingDuel.enemyDeck9);
            this.renderDuel();
          };
        }
        if (rerollBtn) {
          rerollBtn.onclick = () => {
            modal.classList.remove('active');
            this.startRandomDuel();
          };
        }
      },

      renderDuel() {
        const duel = window.CURRENT_DUEL;
        if (!duel) return;

        // Update legacy text nodes if present
        const legacyEnemyHp = document.getElementById('enemyHp');
        const legacyPlayerHp = document.getElementById('playerHp');
        if (legacyEnemyHp) legacyEnemyHp.textContent = `${duel.enemy.hp}/${duel.enemy.maxHp}`;
        if (legacyPlayerHp) legacyPlayerHp.textContent = `${duel.player.hp}/${duel.player.maxHp}`;

        // Update new HUD bars and labels
        const enemyHpText = document.getElementById('enemyHpText');
        const playerHpText = document.getElementById('playerHpText');
        const enemyHpBar = document.getElementById('enemyHpBar');
        const playerHpBar = document.getElementById('playerHpBar');
        if (enemyHpText) enemyHpText.textContent = `${duel.enemy.hp}/${duel.enemy.maxHp}`;
        if (playerHpText) playerHpText.textContent = `${duel.player.hp}/${duel.player.maxHp}`;
        if (enemyHpBar) {
          const pct = Math.max(0, Math.min(100, Math.round((duel.enemy.hp / Math.max(1, duel.enemy.maxHp)) * 100)));
          enemyHpBar.style.width = pct + '%';
        }
        if (playerHpBar) {
          const pctP = Math.max(0, Math.min(100, Math.round((duel.player.hp / Math.max(1, duel.player.maxHp)) * 100)));
          playerHpBar.style.width = pctP + '%';
        }

        const enemyPowerEl = document.getElementById('enemyPower');
        const playerPowerEl = document.getElementById('playerPower');
        if (enemyPowerEl) enemyPowerEl.textContent = duel.enemy.maxHp;
        if (playerPowerEl) playerPowerEl.textContent = duel.player.maxHp;

        const enemyHandEl  = document.getElementById('enemyHand');
        const playerHandEl = document.getElementById('playerHand');
        enemyHandEl.innerHTML = '';
        playerHandEl.innerHTML = '';

        // Render enemy hand (no interactions)
        duel.enemy.hand.forEach((c, idx) => {
          const node = this.createCardNode(c, false, idx);
          enemyHandEl.appendChild(node);
        });

        // Render player hand (click to play)
        duel.player.hand.forEach((c, idx) => {
          const node = this.createCardNode(c, true, idx);
          node.addEventListener('click', () => {
            if (duel.finished) return;
            window.CURRENT_DUEL = window.playTurn(duel, idx);
            this.renderDuel();
            if (window.CURRENT_DUEL.finished) {
              this.showDuelResult(window.CURRENT_DUEL);
            }
          });
          playerHandEl.appendChild(node);
        });

        const logEl = document.getElementById('duelLog');
        logEl.innerHTML = duel.log.map(r => `–•—ñ–¥ ${r.turn}: –í–∏(${r.player.element}) ${r.player.dmg} √ó${r.player.mult} ‚Üî –í–æ—Ä–æ–≥(${r.enemy.element}) ${r.enemy.dmg} √ó${r.enemy.mult}`).join('<br>');
        
        this.updatePlayerMultiplierPreview();
      },

      showDuelResult(duel) {
        const profile = userProfile.getProfile();
        if (!profile) return;

        const modal = document.getElementById('duel-result-modal');
        const titleEl = document.getElementById('duel-result-title');
        const subtitleEl = document.getElementById('duel-result-subtitle');
        const rewardsEl = document.getElementById('duel-result-rewards');
        const winsInfoEl = document.getElementById('duel-wins-info');
        const summaryHpEl = document.getElementById('duel-summary-player-hp');
        const battleCardsEl = document.getElementById('duel-battle-cards');

        if (!modal) return;

        // –í–∏–∑–Ω–∞—á–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞ HP (—è–∫—â–æ HP –≥—Ä–∞–≤—Ü—è 0 - –ø–æ—Ä–∞–∑–∫–∞, —è–∫—â–æ –≤–æ—Ä–æ–≥–∞ 0 - –ø–µ—Ä–µ–º–æ–≥–∞)
        let result = duel.result;
        if (duel.player.hp === 0 && duel.enemy.hp > 0) {
          result = 'lose';
        } else if (duel.enemy.hp === 0 && duel.player.hp > 0) {
          result = 'win';
        }

        let xpGain = 0;
        let boltsGain = 0;

        // Helper: exponential bolts reward based on player level
        const boltsReward = (base, growth, level) => {
          const L = Math.max(1, Number(level) || 1);
          return Math.round(base * Math.pow(growth, L - 1));
        };
        let dropInfo = '';

        if (result === 'win') {
          titleEl.textContent = 'üèÜ –ü–ï–†–ï–ú–û–ì–ê';
          xpGain = Math.round(80 * Math.pow(1.08, (profile.level||1)-1));
          boltsGain = boltsReward(55, 1.12, profile.level);
          profile.wins = (profile.wins || 0) + 1;
          // –°–∏—Å—Ç–µ–º–∞ –¥—Ä–æ–ø–∞ –∫–∞—Ä—Ç –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ä—ñ–¥–∫–æ—Å—Ç—ñ
          if (window.dropSystem && window.dropSystem.shouldDrop('win')) {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è pity –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤
            profile.pityCounters = profile.pityCounters || { noLegendary: 0, noMythic: 0 };
            
            const allCards = window.ALL_CARDS || [];
            const starterCards = window.STARTER_CARDS || [];
            
            const dropResult = window.dropSystem.dropCard(
              profile,
              allCards,
              starterCards,
              profile.pityCounters
            );
            
            if (dropResult.card) {
              const card = dropResult.card;
              
              // –û–Ω–æ–≤–∏—Ç–∏ pity –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏
              profile.pityCounters = dropResult.pityCounters;
              
              // –î–æ–¥–∞—Ç–∏ –∫–∞—Ä—Ç—É –≤ –∫–æ–ª–µ–∫—Ü—ñ—é
              profile.collectionCards = profile.collectionCards || [];
              const newEntry = { id: card.id, level: 1 };
              profile.collectionCards.push(newEntry);
              userProfile.autoAddToDeck(profile, newEntry);

              // –û–Ω–æ–≤–∏—Ç–∏ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä
              profile.inventory = profile.inventory || {};
              profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;
              
              // –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –¥—Ä–æ–ø
              const rarityNames = { R1: '–∑–≤–∏—á–∞–π–Ω–∞', R2: '–Ω–µ–∑–≤–∏—á–∞–π–Ω–∞', R3: '—Ä—ñ–¥–∫—ñ—Å–Ω–∞', R4: '–µ–ø—ñ—á–Ω–∞', R5: '–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞', R6: '–º—ñ—Ñ—ñ—á–Ω–∞' };
              const rarityName = rarityNames[card.rarity] || card.rarity;
              const sourceInfo = dropResult.fromStarterPool ? ' (—Å—Ç–∞—Ä—Ç–æ–≤–∞)' : '';
              dropInfo = ` + ${rarityName} –∫–∞—Ä—Ç–∞ ${card.id}${sourceInfo}`;
            }
          }
        } else if (result === 'lose') {
          titleEl.textContent = 'üíÄ –ü–û–†–ê–ó–ö–ê';
          xpGain = Math.round(30 * Math.pow(1.05, (profile.level||1)-1));
          boltsGain = boltsReward(12, 1.08, profile.level);
          profile.losses = (profile.losses || 0) + 1;
          
          // –ú–µ–Ω—à–∏–π —à–∞–Ω—Å –¥—Ä–æ–ø–∞ –ø—Ä–∏ –ø–æ—Ä–∞–∑—Ü—ñ (10%)
          if (window.dropSystem && window.dropSystem.shouldDrop('lose')) {
            profile.pityCounters = profile.pityCounters || { noLegendary: 0, noMythic: 0 };
            
            const allCards = window.ALL_CARDS || [];
            const starterCards = window.STARTER_CARDS || [];
            
            const dropResult = window.dropSystem.dropCard(
              profile,
              allCards,
              starterCards,
              profile.pityCounters
            );
            
            if (dropResult.card) {
              const card = dropResult.card;
              profile.pityCounters = dropResult.pityCounters;
              
              profile.collectionCards = profile.collectionCards || [];
              const newEntry = { id: card.id, level: 1 };
              profile.collectionCards.push(newEntry);
              userProfile.autoAddToDeck(profile, newEntry);

              profile.inventory = profile.inventory || {};
              profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;
              
              const rarityNames = { R1: '–∑–≤–∏—á–∞–π–Ω–∞', R2: '–Ω–µ–∑–≤–∏—á–∞–π–Ω–∞', R3: '—Ä—ñ–¥–∫—ñ—Å–Ω–∞', R4: '–µ–ø—ñ—á–Ω–∞', R5: '–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞', R6: '–º—ñ—Ñ—ñ—á–Ω–∞' };
              const rarityName = rarityNames[card.rarity] || card.rarity;
              const sourceInfo = dropResult.fromStarterPool ? ' (—Å—Ç–∞—Ä—Ç–æ–≤–∞)' : '';
              dropInfo = ` + ${rarityName} –∫–∞—Ä—Ç–∞ ${card.id}${sourceInfo}`;
            }
          }
        } else {
          titleEl.textContent = '‚öñÔ∏è –ù–Ü–ß–ò–Ø';
          xpGain = Math.round(45 * Math.pow(1.06, (profile.level||1)-1));
          boltsGain = boltsReward(28, 1.10, profile.level);
          
          // –°–µ—Ä–µ–¥–Ω—ñ–π —à–∞–Ω—Å –¥—Ä–æ–ø–∞ –ø—Ä–∏ –Ω—ñ—á–∏—ó (20%)
          if (window.dropSystem && window.dropSystem.shouldDrop('draw')) {
            profile.pityCounters = profile.pityCounters || { noLegendary: 0, noMythic: 0 };
            
            const allCards = window.ALL_CARDS || [];
            const starterCards = window.STARTER_CARDS || [];
            
            const dropResult = window.dropSystem.dropCard(
              profile,
              allCards,
              starterCards,
              profile.pityCounters
            );
            
            if (dropResult.card) {
              const card = dropResult.card;
              profile.pityCounters = dropResult.pityCounters;
              
              profile.collectionCards = profile.collectionCards || [];
              const newEntry = { id: card.id, level: 1 };
              profile.collectionCards.push(newEntry);
              userProfile.autoAddToDeck(profile, newEntry);

              profile.inventory = profile.inventory || {};
              profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;
              
              const rarityNames = { R1: '–∑–≤–∏—á–∞–π–Ω–∞', R2: '–Ω–µ–∑–≤–∏—á–∞–π–Ω–∞', R3: '—Ä—ñ–¥–∫—ñ—Å–Ω–∞', R4: '–µ–ø—ñ—á–Ω–∞', R5: '–ª–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞', R6: '–º—ñ—Ñ—ñ—á–Ω–∞' };
              const rarityName = rarityNames[card.rarity] || card.rarity;
              const sourceInfo = dropResult.fromStarterPool ? ' (—Å—Ç–∞—Ä—Ç–æ–≤–∞)' : '';
              dropInfo = ` + ${rarityName} –∫–∞—Ä—Ç–∞ ${card.id}${sourceInfo}`;
            }
          }
        }

        subtitleEl.textContent = '–í–∏ –æ—Ç—Ä–∏–º–∞–ª–∏:';

        // –û–Ω–æ–≤–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å
        profile.xp = (profile.xp || 0) + xpGain;
        // Ensure level is numeric to avoid string/undefined edge cases
        profile.level = Number(profile.level) || 1;
        profile.bolts = (profile.bolts || 0) + boltsGain;
        profile.gamesPlayed = (profile.gamesPlayed || 0) + 1;

        // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä—ñ–≤–µ–Ω—å (—à–µ—Å—Ç–µ—Ä–Ω—ñ –Ω–∞—Ä–∞—Ö–æ–≤—É—é—Ç—å—Å—è –ª–∏—à–µ –ø—Ä–∏ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—ñ —Ä—ñ–≤–Ω—è)
        let leveled = 0;
        let gearsGained = 0;
        // Diagnostic: log initial values to help debug failed level-ups
        try {
          const needInitial = this.xpNeededForLevel(profile.level || 1);
          console.debug('Level check start:', { level: profile.level, xp: profile.xp, needInitial });
        } catch (e) {
          console.warn('xpNeededForLevel threw', e);
        }

        while (profile.xp >= this.xpNeededForLevel(profile.level || 1)) {
          const need = this.xpNeededForLevel(profile.level || 1);
          console.debug('Leveling: before subtract', { level: profile.level, xp: profile.xp, need });
          profile.xp -= need;
          // –ó–±—ñ–ª—å—à—É—î–º–æ —Ä—ñ–≤–µ–Ω—å
          profile.level = Number(profile.level) + 1;
          console.info('Leveled up to', profile.level);
          // –ù–∞—Ä–∞—Ö–æ–≤—É—î–º–æ —à–µ—Å—Ç–µ—Ä–Ω—ñ –∑–∞ —Ü–µ–π —Ä—ñ–≤–µ–Ω—å (–ª–æ–≥—ñ–∫–∞: –¥–æ–¥–∞—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —à–µ—Å—Ç–µ—Ä–µ–Ω—å —Ä—ñ–≤–Ω—è)
          const gearForThisLevel = profile.level;
          profile.gears = (profile.gears || 0) + gearForThisLevel;
          gearsGained += gearForThisLevel;
          leveled += 1;
        }

        userProfile.updateCurrentUser(profile);
        userProfile.updateUI();

        // –ü–æ–∫–∞–∑–∞—Ç–∏ –ª–∏—à–µ —Ç–µ, —â–æ –æ—Ç—Ä–∏–º–∞–Ω–æ —É –±–æ—é: XP, –±–æ–ª—Ç–∏, –¥—Ä–æ–ø, —Ç–∞ —à–µ—Å—Ç–µ—Ä–Ω—ñ (—è–∫—â–æ –±—É–ª–∏ –æ—Ç—Ä–∏–º–∞–Ω—ñ —á–µ—Ä–µ–∑ —Ä—ñ–≤–µ–Ω—å)
        const parts = [];
        if (xpGain > 0) parts.push(`XP: +${this.formatCompact ? this.formatCompact(xpGain) : xpGain}`);
        if (boltsGain > 0) parts.push(`üî© +${this.formatCompact ? this.formatCompact(boltsGain) : boltsGain}`);
        if (gearsGained > 0) parts.push(`‚öôÔ∏è +${gearsGained}`);
        if (dropInfo) parts.push(dropInfo.trim());
        rewardsEl.textContent = parts.join('  ‚Ä¢  ') || '–ù—ñ—á–æ–≥–æ –Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–æ';
        winsInfoEl.textContent = `–ü–æ–±—ñ–¥ –≤ –¥—É–µ–ª—è—Ö: üèÜ ${profile.wins || 0}`;
        summaryHpEl.textContent = duel.player.hp;

        // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥—Å—É–º–∫–∏ –±–æ—é –∑ –∫–∞—Ä—Ç–∞–º–∏
        const elementEmojis = {
          fire: 'üî•',
          water: 'üíß',
          air: 'üí®',
          earth: 'üçÉ'
        };

        battleCardsEl.innerHTML = duel.log.map(log => {
          const pEmoji = elementEmojis[log.player.element] || elementEmojis.fire;
          const eEmoji = elementEmojis[log.enemy.element] || elementEmojis.fire;
          return `
            <div class="duel-battle-card-row">
              <div class="duel-battle-card-player">
                <div class="duel-battle-card-icon" style="--elem: var(--${log.player.element})">
                  <span class="element-emoji">${pEmoji}</span>
                </div>
                <span class="duel-battle-card-dmg">${log.player.dmg}</span>
              </div>
              <span class="duel-battle-vs">‚öî</span>
              <div class="duel-battle-card-enemy">
                <span class="duel-battle-card-dmg">${log.enemy.dmg}</span>
                <div class="duel-battle-card-icon" style="--elem: var(--${log.enemy.element})">
                  <span class="element-emoji">${eEmoji}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');

        modal.classList.add('active');
      },

      closeDuelResult() {
        const modal = document.getElementById('duel-result-modal');
        if (modal) {
          modal.classList.remove('active');
          // –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –¥—É–µ–ª—å
          this.startRandomDuel();
        }
      }
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // –ú–µ–Ω—é "–°—É–º–∫–∞"
      document.getElementById('menu-bag-btn')?.addEventListener('click', () => navigation.showPage('bag'));
      document.getElementById('bag-back-btn')?.addEventListener('click', () => navigation.showPage('home'));
      // Initialize auth UI
      authUI.init();
      
      // Update UI with profile data if logged in
      if (userProfile.isLoggedIn()) {
        userProfile.updateUI();
        console.log('User profile loaded:', userProfile.getCurrentUser());
      }
      
      // Navigation handlers for tiles
      document.querySelectorAll('[data-page]').forEach(element => {
        element.addEventListener('click', (e) => {
          e.preventDefault();
          const pageId = element.dataset.page;
          navigation.showPage(pageId);
        });
      });
      
      // Bottom nav handlers
      const navButtons = {
        'nav-home': 'home',
        'nav-profile': 'profile',
        'nav-guild': 'guild'
      };
      
      document.querySelectorAll('.navbtn').forEach(btn => {
        btn.addEventListener('click', () => {
          // Update active state
          document.querySelectorAll('.navbtn').forEach(x => x.classList.remove('active'));
          btn.classList.add('active');
          
          // Navigate to page
          const pageId = navButtons[btn.id];
          if (pageId) {
            navigation.showPage(pageId);
          }
        });
      });
      
      // Logout button handler
      document.querySelector('.logout-btn')?.addEventListener('click', () => {
        if (confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–π—Ç–∏?')) {
          userProfile.logout();
          location.reload();
        }
      });
      
      // Shop tab handlers
      document.querySelectorAll('.shop-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          // Update active tab
          document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Show corresponding content
          const tabId = this.dataset.tab;
          document.querySelectorAll('.shop-tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`shop-tab-${tabId}`)?.classList.add('active');
        });
      });

      // Card filter handlers
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Update active state
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Load filtered cards
          const element = this.dataset.element;
          navigation.currentCardFilter = element;
          navigation.loadShopCards(element);
        });
      });

      // Pack modal close handler
      document.getElementById('pack-modal-close')?.addEventListener('click', () => {
        navigation.closePackModal();
      });

      

      // Click outside modal to close
      document.getElementById('pack-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'pack-modal') {
          navigation.closePackModal();
        }
      });

      // Duel result modal close handler
      document.getElementById('duel-result-close')?.addEventListener('click', () => {
        navigation.closeDuelResult();
      });

      // Click outside duel modal to close
      document.getElementById('duel-result-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'duel-result-modal') {
          navigation.closeDuelResult();
        }
      });
    });

    // Accordion (removed since we're using page navigation now)

    // Tiles (removed since we're using page navigation now)

  </script>
</body>
</html>
