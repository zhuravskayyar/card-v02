<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steampunk Menu</title>
  <link rel="stylesheet" href="css/steampunk-cards.css">
  <style>
    /* ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ñ–Ñ: Ð³Ñ€Ð¸Ð´ ÐºÐ°Ñ€Ñ‚ */
    .collection-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr) !important;
      gap: 10px;
      margin-top: 10px;
    }
    .collection-card-item {
      background: rgba(50,30,20,0.4);
      border: 1.5px solid rgba(242,208,122,0.15);
      border-radius: 8px;
      padding: 10px 6px;
      text-align: center;
      transition: all 0.2s;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .collection-card-item.found {
      background: linear-gradient(180deg, rgba(242,208,122,0.12), rgba(0,0,0,0.18));
      border-color: #8bc34a;
      color: var(--brass-0);
    }
    .collection-card-item.not-found {
      background: linear-gradient(180deg, #222 60%, #111 100%);
      border-color: #444;
      color: #888;
      opacity: 0.6;
    }
    .collection-card-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .collection-card-status {
      font-size: 11px;
      color: #8bc34a;
    }
    .collection-card-item.not-found .collection-card-status {
      color: #aaa;
    }
    /* Ð¡ÐµÑ‚ÐºÐ° ÑÐ»Ð°Ð±ÑˆÐ¸Ñ… ÐºÐ°Ñ€Ñ‚ â€” Ð¿Ð¾ 3 Ð² Ñ€ÑÐ´ */
    .weaker-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    .weaker-card-tile {
      background: rgba(30,20,18,0.45);
      border: 1px solid rgba(200,170,120,0.08);
      padding: 8px;
      border-radius: 8px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .weaker-card-footer { display:flex; justify-content:space-between; align-items:center; gap:6px; margin-top:8px; }
    .weaker-card-pct { color: #c6ffb3; font-weight:700; }
    .weaker-add-btn { background:#c85; border:none; color:#111; padding:6px 8px; border-radius:6px; cursor:pointer }
    :root{
      --bg-0:#080605;
      --bg-1:#120d0a;
      --wood:#1a120c;

      --brass-0:#f2d07a;
      --brass-1:#c59b3c;
      --brass-2:#7a5520;

      --copper-0:#d8905b;
      --copper-1:#b56a33;
      --copper-2:#6f3316;

      --steel-0:#2a2f33;
      --steel-1:#14181b;

      --ink:#f4e6c6;
      --muted:#d0bf9a;

      --glow: rgba(255, 210, 110, 0.22);
      --shadow: rgba(0,0,0,0.65);

      --radius: 14px;

      /* Ð¡Ñ‚Ð¸Ñ…Ñ–Ñ— */
      --fire:#c45a2a;
      --water:#3b6c8e;
      --air:#9fb6c1;
      --earth:#7a6a3a;
      --steam:#8a7f8a;
      --mech:#5a5a5a;
      
      /* Ð Ñ–Ð´ÐºÐ¾ÑÑ‚Ñ– */
      --common:#b8a27b;
      --rare:#6fb2ff;
      --epic:#b07cff;
      --legend:#ffcc66;
      --tile-radius: 18px;
    }

    /* Base */
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--ink);
      font-family: Georgia, "Times New Roman", serif;
      background:
        radial-gradient(1200px 800px at 50% -10%, rgba(255,200,120,0.10), transparent 55%),
        radial-gradient(900px 700px at 20% 25%, rgba(212,140,75,0.10), transparent 50%),
        radial-gradient(1000px 900px at 80% 60%, rgba(120,70,40,0.10), transparent 55%),
        linear-gradient(180deg, var(--bg-1), var(--bg-0));
      min-height: 100vh;
      display:block;
    }

    /* Phone frame */
    .phone{
      width:100vw;
      min-height:100vh;
      padding: 0;
      position: relative;
      background: transparent;
      overflow:hidden;
      display: flex;
      flex-direction: column;
    }

    /* Side copper rails */
    .phone::before,
    .phone::after{
      content:"";
      position:absolute;
      top:-30px; bottom:-30px;
      width: 18px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.10), transparent 12%),
        linear-gradient(180deg, #3b2010, #7a3b1a 35%, #a55a2b 50%, #6a2d12 70%, #2b140a);
      box-shadow: inset 0 0 0 1px rgba(255,210,120,0.25), 0 0 18px rgba(0,0,0,0.5);
      filter: saturate(1.1);
      opacity:0.95;
      border-radius: 12px;
    }
    .phone::before{ left:-6px; }
    .phone::after { right:-6px; }

    /* Subtle noise overlay */
    .noise{
      pointer-events:none;
      position:absolute; inset:0;
      opacity:0.10;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(255,255,255,0.08) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 60%, rgba(255,255,255,0.07) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 80%, rgba(255,255,255,0.06) 0 1px, transparent 2px);
      background-size: 60px 60px, 80px 80px, 100px 100px;
      mix-blend-mode: overlay;
    }

    /* Top bar */
    .topbar{
      position: relative;
      padding: 10px 10px 12px;
      border-radius: var(--radius);
      background:
        linear-gradient(180deg, rgba(255,210,110,0.08), rgba(0,0,0,0.35)),
        linear-gradient(180deg, #1b120c, #0c0907);
      box-shadow: 0 10px 24px var(--shadow);
      border: 1px solid rgba(245,210,120,0.20);
    }
    .topbar::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(242,208,122,0.35), rgba(213,143,85,0.18), rgba(90,50,20,0.10));
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      padding: 1px;
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
    }

    .toprow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .avatar{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }

    .portrait{
      width:36px; height:36px;
      border-radius: 10px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,230,170,0.18), transparent 55%),
        linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,0.35);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.6), 0 6px 12px rgba(0,0,0,0.55);
      position: relative;
    }
    .portrait::after{
      content:"";
      position:absolute; inset:4px;
      border-radius: 8px;
      background:
        radial-gradient(circle at 45% 35%, rgba(255,210,120,0.18), transparent 55%),
        radial-gradient(circle at 55% 65%, rgba(212,140,75,0.12), transparent 55%);
      opacity:0.8;
    }

    .level{
      font-variant-numeric: tabular-nums;
      color: var(--brass-0);
      font-weight:700;
      letter-spacing:0.02em;
      white-space:nowrap;
    }

    .meters{
      display:flex;
      align-items:center;
      gap:10px;
      font-variant-numeric: tabular-nums;
      white-space:nowrap;
    }

    .meter{
      display:flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.10), rgba(0,0,0,0.35)),
        linear-gradient(180deg, #1a120c, #0c0907);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: inset 0 0 12px rgba(0,0,0,0.6);
    }
    .gem, .coin{
      width:10px; height:10px;
      border-radius: 2px;
      box-shadow: 0 0 10px var(--glow);
    }
    .gem{
      background: linear-gradient(135deg, #bfe8ff, #4aa0d6);
      border: 1px solid rgba(200,245,255,0.35);
    }
    .coin{
      background: linear-gradient(135deg, var(--brass-0), var(--brass-1));
      border: 1px solid rgba(255,230,140,0.35);
      border-radius: 50%;
    }

    .statusbar{
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      background: linear-gradient(180deg, #0b0907, #050403);
      border: 1px solid rgba(242,208,122,0.18);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.85);
      overflow:hidden;
      position:relative;
    }
    .statusbar > span{
      display:block; height:100%;
      width: 78%;
      background:
        linear-gradient(90deg, rgba(255,220,140,0.10), rgba(255,210,120,0.25)),
        linear-gradient(90deg, #4f2a12, #b56a33 40%, #f2d07a 75%, #c59b3c);
      box-shadow: 0 0 14px rgba(255,210,120,0.25);
    }

    /* Tiles grid */
    .tiles{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }

    .tile{
      position:relative;
      border-radius: var(--tile-radius);
      padding: 10px 10px 12px;
      min-height: 96px;
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: 0 10px 20px rgba(0,0,0,0.55), inset 0 0 18px rgba(0,0,0,0.75);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, filter .08s ease;
    }
    .tile:hover{ filter: brightness(1.05); }
    .tile:active{ transform: translateY(1px); }

    /* Ornate brass frame */
    .phone::before,
    .phone::after{
      content: none;
      display: none;
    }

    .tile .label{
      font-size: 13px;
      color: var(--brass-0);
      text-shadow: 0 1px 0 rgba(0,0,0,0.7);
    }
    .tile .sub{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      opacity:0.95;
    }

    .tile .icon{
      width:34px; height:34px;
      border-radius: 12px;
      margin-bottom: 8px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,230,170,0.18), transparent 60%),
        linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,0.25);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.6);
      position: relative;
      overflow:hidden;
    }
    .tile .icon::after{
      content:"";
      position:absolute; inset:-40%;
      background:
        repeating-conic-gradient(from 0deg,
          rgba(242,208,122,0.12) 0 10deg,
          rgba(0,0,0,0.0) 10deg 20deg);
      opacity:0.55;
      transform: rotate(10deg);
    }

    /* Page system */
    #main-content{
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .page{
      display:none;
      animation: fadeIn 0.3s ease;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
    .page.active{
      display:flex;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* Page headers */
    .page-header{
      padding: 12px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.08), rgba(0,0,0,0.45)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border-bottom: 1px solid rgba(242,208,122,0.18);
      box-shadow: 0 4px 12px rgba(0,0,0,0.55);
      position: relative;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
    }
    .page-title{
      font-size: 18px;
      color: var(--brass-0);
      text-shadow: 0 1px 2px rgba(0,0,0,0.7);
      margin: 0;
      flex: 1;
      text-align: center;
    }
    .back-btn{
      all: unset;
      padding: 8px 12px;
      font-size: 14px;
      color: var(--brass-1);
      cursor: pointer;
      border-radius: 8px;
      background: rgba(242,208,122,0.08);
      border: 1px solid rgba(242,208,122,0.15);
      transition: all 0.15s ease;
    }
    .back-btn:hover{
      background: rgba(242,208,122,0.15);
    }

    /* Page content */
    .page-content{
      flex: 1;
      padding: 15px;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      min-height: 0;
    }

    /* Info cards */
    .info-card{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: 0 6px 12px rgba(0,0,0,0.55), inset 0 0 18px rgba(0,0,0,0.75);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 12px;
      text-align: center;
    }
    .info-label{
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .info-value{
      font-size: 24px;
      color: var(--brass-0);
      text-shadow: 0 1px 2px rgba(0,0,0,0.7);
      font-weight: 500;
    }

    /* Action buttons */
    .action-btn{
      all: unset;
      display: block;
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      text-align: center;
      font-size: 15px;
      color: var(--bg-dark);
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      border-radius: var(--radius);
      border: 1px solid rgba(242,208,122,0.35);
      box-shadow: 0 8px 16px rgba(0,0,0,0.55), inset 0 0 0 1px rgba(255,255,255,0.15);
      cursor: pointer;
      transition: all 0.15s ease;
      font-weight: 500;
    }
    .action-btn:hover{
      filter: brightness(1.08);
      transform: translateY(-1px);
    }
    .action-btn:active{
      transform: translateY(0);
    }
    .action-btn.secondary{
      background: linear-gradient(180deg, rgba(242,208,122,0.25), rgba(197,155,60,0.15));
      color: var(--brass-0);
    }

    /* Description */
    .description{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.5;
      margin-top: 15px;
      padding: 12px;
      background: rgba(0,0,0,0.35);
      border-radius: var(--radius);
      border: 1px solid rgba(242,208,122,0.12);
    }

    /* Tasks */
    .task-item{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .task-item.completed{
      opacity: 0.6;
      border-color: rgba(100,200,100,0.35);
    }
    .task-text{
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 6px;
    }
    .task-progress{
      font-size: 13px;
      color: var(--brass-1);
      margin-bottom: 4px;
    }
    .task-reward{
      font-size: 12px;
      color: var(--muted);
    }

    /* Rewards */
    .reward-item{
      display: flex;
      align-items: center;
      gap: 12px;
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .reward-item.locked{
      opacity: 0.5;
    }
    .reward-icon{
      font-size: 32px;
    }
    .reward-text{
      flex: 1;
      font-size: 14px;
      color: var(--brass-0);
    }
    .reward-progress{
      font-size: 12px;
      color: var(--muted);
    }
    .claim-btn{
      all: unset;
      padding: 8px 16px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      border-radius: 8px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 500;
    }

    /* Equipment */
    .equipment-slot{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .slot-name{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .slot-item{
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 4px;
    }
    .slot-item.equipped{
      color: var(--brass-1);
    }
    .slot-bonus{
      font-size: 13px;
      color: #8bc34a;
    }

    /* Collections */
    .collection-set{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
    }
    .collection-set.completed{
      border-color: rgba(100,200,100,0.45);
    }
    .set-name{
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 6px;
    }
    .set-progress{
      font-size: 13px;
      color: var(--brass-1);
      margin-bottom: 4px;
    }
    .set-bonus{
      font-size: 12px;
      color: #8bc34a;
    }

    /* Upgrade hint styling */
    .hint {
      transition: all 0.3s ease;
    }
    
    .hint.hot {
      border-color: rgba(120,255,160,.35) !important;
      box-shadow: inset 0 0 14px rgba(0,0,0,.65), 0 0 18px rgba(90,255,120,.18) !important;
      color: rgba(220,255,220,.95) !important;
    }

    /* Card Details Page */
    .card-main-display {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 24px;
      padding: 20px;
      background: linear-gradient(180deg, rgba(242,208,122,0.08), rgba(0,0,0,0.3));
      border: 2px solid rgba(242,208,122,0.3);
      border-radius: 12px;
      margin-bottom: 15px;
    }

    /* ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ— ÐºÐ°Ñ€Ñ‚Ð¸ */
    .card-info-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: left;
      margin-top: 0;
      margin-left: 0;
    }

    .card-display-image {
      width: 120px;
      height: 160px;
      margin: 0 auto 15px;
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid rgba(242,208,122,0.4);
      background: radial-gradient(circle at 30% 30%, rgba(255,230,170,0.1), transparent);
    }

    .card-display-icon {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
    }

    .card-display-name {
      font-size: 18px;
      color: var(--brass-0);
      margin-bottom: 8px;
      font-weight: bold;
    }

    .card-display-element {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .card-display-level {
      display: inline-block;
      background: rgba(242,208,122,0.2);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      color: var(--brass-1);
      margin: 0 5px;
    }

    .card-display-power {
      display: inline-block;
      background: rgba(160,200,100,0.2);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      color: #8bc34a;
      margin: 0 5px;
    }

    .card-stats {
      padding: 15px;
      background: rgba(50,30,20,0.3);
      border-left: 3px solid var(--brass-0);
      margin-bottom: 15px;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(242,208,122,0.1);
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: var(--muted);
      font-size: 13px;
    }

    .stat-value {
      color: var(--brass-0);
      font-weight: bold;
    }

    .card-comparison {
      margin-bottom: 15px;
    }

    .comparison-title {
      font-size: 14px;
      color: var(--brass-0);
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(242,208,122,0.2);
    }

    .weaker-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .weaker-card-item {
      background: rgba(50,30,20,0.4);
      border: 1px solid rgba(242,208,122,0.15);
      border-radius: 8px;
      padding: 10px;
      transition: all 0.2s;
    }

    .weaker-card-item:hover {
      border-color: rgba(242,208,122,0.3);
      box-shadow: 0 0 10px rgba(242,208,122,0.1);
    }

    .weaker-card-icon {
      font-size: 32px;
      text-align: center;
      margin-bottom: 6px;
    }

    .weaker-card-name {
      font-size: 12px;
      color: var(--brass-0);
      margin-bottom: 4px;
      text-align: center;
    }

    .weaker-card-stats {
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }

    .no-weaker-cards {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 13px;
    }

    /* ÐšÐ¾Ð¼Ð¿Ð°ÐºÑ‚Ð½Ð¸Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº ÑÐ»Ð°Ð±ÑˆÐ¸Ñ… ÐºÐ°Ñ€Ñ‚ */
    .weaker-cards-compact {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 10px;
    }
    .compact-card {
      background: rgba(50,30,20,0.7);
      border: 1.5px solid rgba(242,208,122,0.18);
      border-radius: 10px;
      padding: 10px 8px 8px 8px;
      min-width: 90px;
      max-width: 110px;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
      position: relative;
    }
    .compact-card-icon {
      font-size: 28px;
      margin-bottom: 4px;
    }
    .compact-card-name {
      font-size: 12px;
      color: var(--brass-0);
      margin-bottom: 2px;
      text-align: center;
      font-weight: 600;
    }
    .compact-card-power {
      font-size: 13px;
      color: #f4e6c6;
      margin-bottom: 4px;
      font-weight: 700;
    }
    .absorb-btn {
      background: linear-gradient(180deg, #f2d07a, #c59b3c);
      color: #1a120c;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 2px;
      cursor: pointer;
      transition: background 0.18s;
    }
    .absorb-btn:hover {
      background: linear-gradient(180deg, #ffe7a0, #e0b85c);
    }
    .absorb-bonus {
      font-size: 11px;
      color: #2ecc71;
      font-weight: 700;
      margin-top: 0px;
      margin-bottom: 2px;
      text-align: center;
    }

    /* Card Upgrade Scale (XP System) */
    .card-upgrade {
      margin-top: 14px;
    }

    .upgrade-header {
      display: flex;
      justify-content: space-between;
      font-weight: 900;
      color: rgba(242, 208, 122, 0.95);
    }

    .card-upgrade .xp-bar {
      margin-top: 6px;
      height: 14px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(242, 208, 122, 0.25);
      box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.65);
      overflow: hidden;
    }

    .card-upgrade .xp-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(
        180deg,
        rgba(242, 208, 122, 0.95),
        rgba(122, 85, 32, 0.95)
      );
      box-shadow: 0 0 12px rgba(242, 208, 122, 0.35);
      transition: width 0.25s ease;
    }

    /* Upgrade arrow on card when guaranteed level-up is possible */
    .sp-card { position: relative; overflow: visible; }
    .upgrade-arrow {
      position: absolute;
      left: 50%;
      transform: translate(-50%, 0);
      bottom: -247px !important;           /* ÐŸÐ¾ÐºÐ»Ð°ÑÑ‚Ð¸ Ð¿Ð¾Ð²ÐµÑ€Ñ… ÐºÐ°Ñ€Ñ‚Ð¸ (Ð²ÑÐµÑ€ÐµÐ´Ð¸Ð½Ñ–) */
      top: auto !important;
      width: 32px;           /* ÐœÐµÐ½ÑˆÐ¸Ð¹ Ñ€Ð¾Ð·Ð¼Ñ–Ñ€ */
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(180deg, #30c85a, #0ea83a);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 14px;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(14, 168, 58, 0.4);
      pointer-events: none;
      z-index: 9999;
      border: 2px solid rgba(255, 255, 255, 0.3);
      animation: pulse-green 1.5s ease-in-out infinite;
    }

    @keyframes pulse-green {
      0%, 100% {
        box-shadow: 0 4px 12px rgba(14, 168, 58, 0.4);
        transform: translateX(-50%) scale(1);
      }
      50% {
        box-shadow: 0 4px 20px rgba(14, 168, 58, 0.6);
        transform: translateX(-50%) scale(1.05);
      }
    }

    /* ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ð¾: ÑÐºÑ‰Ð¾ Ñ…Ð¾Ñ‡ÐµÑ‚Ðµ ÑÑ‚Ñ€Ñ–Ð»ÐºÑƒ Ð¿Ñ–Ð´ ÐºÐ°Ñ€Ñ‚ÐºÐ¾ÑŽ (Ð·Ð¾Ð²Ð½Ñ–) */
    .upgrade-arrow.outside {
      bottom: -16px;         /* Ð’Ð¸ÑÑ‚ÑƒÐ¿Ð°Ñ” Ð¿Ñ–Ð´ ÐºÐ°Ñ€Ñ‚ÐºÐ¾ÑŽ */
      background: linear-gradient(180deg, #30c85a, #0ea83a);
      border: 2px solid rgba(255, 255, 255, 0.2);
    }

    #cu-upgrade-btn {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      border-radius: 12px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(242, 208, 122, 0.25);
      color: rgba(244, 230, 198, 0.95);
      font-weight: 900;
      cursor: pointer;
      transition: all 0.2s;
    }

    #cu-upgrade-btn:hover:not(:disabled) {
      background: rgba(0, 0, 0, 0.5);
      box-shadow: 0 0 10px rgba(242, 208, 122, 0.2);
    }

    #cu-upgrade-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    /* === Shop Cards Styles === */
    .shop-filters {
      display: flex;
      gap: 8px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 8px;
      color: #d4af37;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .filter-btn:hover {
      background: linear-gradient(135deg, #3a3a3a, #2a2a2a);
      border-color: #d4af37;
      transform: translateY(-2px);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, #d4af37, #b8941f);
      color: #1a1a1a;
      border-color: #d4af37;
    }

    .shop-cards {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
      padding: 5px;
    }

    .shop-card {
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .shop-card:hover {
      border-color: #d4af37;
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }

    .shop-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .shop-card-name {
      font-size: 14px;
      font-weight: 600;
      color: #d4af37;
    }

    .shop-card-element {
      font-size: 20px;
    }

    .shop-card-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
      color: #999;
    }

    .shop-card-power {
      color: #4CAF50;
      font-weight: 600;
    }

    .shop-card-price {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid #333;
    }

    .shop-price-tag {
      color: #d4af37;
      font-weight: 600;
      font-size: 14px;
    }

    .shop-buy-btn {
      padding: 6px 12px;
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .shop-buy-btn:hover {
      background: linear-gradient(135deg, #66BB6A, #4CAF50);
      transform: scale(1.05);
    }

    .shop-buy-btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .shop-card-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 8px;
      background: linear-gradient(135deg, #4CAF50, #2e7d32);
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      color: white;
    }

    .shop-card-badge.upgrade-only {
      background: linear-gradient(135deg, #FF9800, #E65100);
    }

    /* === Shop Tabs & Products === */
    .shop-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: linear-gradient(135deg, #1a1a1a, #0a0a0a);
      padding: 8px;
      border-radius: 12px;
      border: 2px solid #333;
    }

    .shop-tab {
      flex: 1;
      padding: 12px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: #999;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .shop-tab:hover {
      color: #d4af37;
      background: rgba(212, 175, 55, 0.1);
    }

    .shop-tab.active {
      background: linear-gradient(135deg, #d4af37, #b8941f);
      color: #1a1a1a;
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    }

    .shop-tab-content {
      display: none;
    }

    .shop-tab-content.active {
      display: block;
    }

    .shop-products {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .product-card {
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 2px solid rgba(242,208,122,0.22);
      border-radius: 12px;
      padding: 16px;
      position: relative;
      transition: all 0.3s;
    }

    .product-card:hover {
      border-color: #d4af37;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.2);
    }

    .product-badge {
      position: absolute;
      top: -8px;
      right: 16px;
      padding: 6px 12px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      color: white;
      box-shadow: 0 2px 8px rgba(231, 76, 60, 0.4);
    }

    .product-badge.hot {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      animation: pulse-badge 2s infinite;
    }

    .product-badge.new {
      background: linear-gradient(135deg, #3498db, #2980b9);
    }

    @keyframes pulse-badge {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .product-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .product-icon {
      width: 48px;
      height: 48px;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border-radius: 8px;
      border: 2px solid #444;
    }

    .product-info {
      flex: 1;
    }

    .product-title {
      font-size: 16px;
      font-weight: 600;
      color: #d4af37;
      margin-bottom: 4px;
    }

    .product-desc {
      font-size: 13px;
      color: #999;
    }

    .product-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .product-price {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 18px;
      font-weight: 700;
      color: #d4af37;
    }

    .product-price .currency-icon {
      font-size: 20px;
    }

    .product-buy-btn {
      padding: 10px 20px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      border: none;
      border-radius: 8px;
      color: var(--bg-dark);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .product-buy-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
    }

    .product-buy-btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .product-bonus {
      display: inline-block;
      padding: 4px 8px;
      background: rgba(46, 204, 113, 0.2);
      border: 1px solid #2ecc71;
      border-radius: 4px;
      color: #2ecc71;
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }

    /* === Pack Opening Modal === */
    .pack-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }

    .pack-modal.active {
      display: flex;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .pack-modal-content {
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 3px solid #d4af37;
      border-radius: 16px;
      padding: 18px;
      width: min(360px, calc(100vw - 24px));
      max-width: 460px;
      max-height: 80vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      text-align: center;
      align-items: center;
      animation: slideUp 0.4s;
    }

    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .pack-modal-header {
      text-align: center;
      margin-bottom: 20px;
    }

    .pack-modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 8px;
    }

    .pack-modal-subtitle {
      font-size: 14px;
      color: #999;
    }

    .pack-rewards {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }

    /* Fallback: keep grid layout on wider pack-opening screens if desired */
    @media (min-width: 900px) {
      .pack-rewards.grid-view {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
      }
    }

    .pack-card-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      animation: cardReveal 0.5s backwards;
    }

    .pack-card-wrapper:nth-child(1) { animation-delay: 0.1s; }
    .pack-card-wrapper:nth-child(2) { animation-delay: 0.2s; }
    .pack-card-wrapper:nth-child(3) { animation-delay: 0.3s; }
    .pack-card-wrapper:nth-child(4) { animation-delay: 0.4s; }
    .pack-card-wrapper:nth-child(5) { animation-delay: 0.5s; }

    .pack-card-wrapper .sp-card {
      width: 100%;
      max-width: 220px;
      aspect-ratio: 160 / 220;
      height: auto;
      margin: 0;
    }

    /* Mobile-friendly adjustments for pack modal */
    @media (max-width: 480px) {
      .pack-rewards { grid-template-columns: 1fr !important; gap: 14px; }
      .pack-modal-content { max-width: 320px; width: 94%; padding: 18px; }
      .pack-card-wrapper { gap: 8px; }
      .pack-card-wrapper .sp-card { max-width: 160px; aspect-ratio: 3/4; }
      .pack-card-info { font-size: 14px; }
      .pack-modal-title { font-size: 18px; }
    }

    .pack-card-info {
      text-align: center;
      color: var(--brass-0);
    }

    .pack-card-name {
      font-size: 16px;
      font-weight: bold;
      color: var(--brass-0);
      margin-bottom: 4px;
      line-height: 1.15;
      word-break: normal;
      overflow-wrap: anywhere;
    }

    .pack-card-element {
      font-size: 13px;
      color: var(--muted);
    }

    .reward-card {
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 10px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: cardReveal 0.5s backwards;
    }

    .reward-card:nth-child(1) { animation-delay: 0.1s; }
    .reward-card:nth-child(2) { animation-delay: 0.2s; }
    .reward-card:nth-child(3) { animation-delay: 0.3s; }
    .reward-card:nth-child(4) { animation-delay: 0.4s; }
    .reward-card:nth-child(5) { animation-delay: 0.5s; }
    .reward-card:nth-child(n+6) { animation-delay: 0.6s; }

    @keyframes cardReveal {
      from { transform: rotateY(90deg) scale(0.8); opacity: 0; }
      to { transform: rotateY(0) scale(1); opacity: 1; }
    }

    .reward-card-icon {
      font-size: 32px;
      width: 40px;
      text-align: center;
    }

    .reward-card-info {
      flex: 1;
    }

    .reward-card-name {
      font-size: 14px;
      font-weight: 600;
      color: #d4af37;
      margin-bottom: 4px;
    }

    .reward-card-power {
      font-size: 12px;
      color: #4CAF50;
      font-weight: 600;
    }

    /* ÐÐ¾Ð²Ñ– ÑÑ‚Ð¸Ð»Ñ– Ð´Ð»Ñ card-item (ÐºÑ€Ð°ÑÐ¸Ð²Ñ– ÐºÐ°Ñ€Ñ‚Ð¸) */
    .card-item {
      background: linear-gradient(135deg, rgba(255,220,140,0.08), rgba(0,0,0,0.4)),
                  linear-gradient(180deg, #1b1410, #0a0805);
      border: 2px solid rgba(242,208,122,0.25);
      border-radius: 12px;
      overflow: hidden;
      animation: cardReveal 0.5s backwards;
      margin-bottom: 12px;
    }

    .card-item:nth-child(1) { animation-delay: 0.1s; }
    .card-item:nth-child(2) { animation-delay: 0.2s; }
    .card-item:nth-child(3) { animation-delay: 0.3s; }
    .card-item:nth-child(4) { animation-delay: 0.4s; }
    .card-item:nth-child(5) { animation-delay: 0.5s; }
    .card-item:nth-child(n+6) { animation-delay: 0.6s; }

    .card-item-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
    }

    .card-item-element {
      font-size: 32px;
      min-width: 40px;
      text-align: center;
    }

    .card-item-details {
      flex: 1;
    }

    .card-item-name {
      font-size: 16px;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 4px;
    }

    .card-item-element-name {
      font-size: 12px;
      color: #999;
      opacity: 0.8;
    }

    .card-item-power {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 14px 14px;
      border-top: 1px solid rgba(242,208,122,0.12);
    }

    .card-power-label {
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .card-power-value {
      font-size: 24px;
      font-weight: 800;
      color: #d4af37;
    }

    .pack-modal-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      border: none;
      border-radius: 10px;
      color: var(--bg-dark);
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
    }

    .pack-modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
    }

    /* Duel Result Modal */
    .duel-result-rewards {
      text-align: center;
      padding: 20px;
      font-size: 28px;
      color: var(--brass-0);
      font-weight: 700;
    }
    .duel-result-stats-info {
      text-align: center;
      padding: 10px 20px;
      color: var(--muted);
      font-size: 15px;
    }
    .duel-wins-info {
      font-size: 16px;
      color: var(--brass-1);
    }
    .duel-next-btn {
      background: linear-gradient(180deg, rgba(100,200,100,0.35), rgba(60,150,60,0.35));
      border: 1px solid rgba(100,200,100,0.5);
    }
    .duel-next-btn:hover {
      background: linear-gradient(180deg, rgba(120,220,120,0.45), rgba(80,170,80,0.45));
    }
    .duel-battle-summary {
      margin-top: 20px;
      padding: 20px;
      border-top: 2px solid rgba(242,208,122,0.25);
    }
    .duel-summary-title {
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 10px;
    }
    .duel-summary-hp {
      text-align: center;
      font-size: 20px;
      color: #e74c3c;
      font-weight: 700;
      margin-bottom: 15px;
    }
    .duel-battle-cards {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .duel-battle-card-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      border-left: 3px solid var(--elem);
    }
    .duel-battle-card-player {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .duel-battle-card-enemy {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .duel-battle-card-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: conic-gradient(var(--brass-2) 0 90deg, var(--brass-1) 90deg 180deg, var(--brass-2) 180deg 270deg, var(--brass-1) 270deg 360deg);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .duel-battle-card-icon svg {
      width: 18px;
      height: 18px;
    }
    .duel-battle-card-dmg {
      color: var(--brass-0);
      font-weight: 700;
      font-size: 16px;
    }
    .duel-battle-vs {
      color: var(--muted);
      font-size: 14px;
    }

    /* Multiplier preview badge between cards */
    .mult-badge {
      width: 160px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: rgba(0,0,0,0.70);
      border: 1px solid rgba(242,208,122,0.30);
      border-radius: 999px;
      box-shadow: inset 0 0 12px rgba(0,0,0,0.75), 0 8px 20px rgba(0,0,0,0.60);
    }
    .mult-badge .mult-text {
      color: rgba(244,230,198,0.95);
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }
    .mult-badge .swords::before {
      content: 'âš”';
      font-size: 16px;
      opacity: 0.90;
    }
    .mult-badge.mult-good .mult-text { color: #7dff9a; text-shadow: 0 0 8px rgba(125,255,154,0.5); }
    .mult-badge.mult-bad .mult-text { color: #ff9a7d; text-shadow: 0 0 8px rgba(255,154,125,0.5); }
    .mult-badge.mult-neutral .mult-text { color: rgba(244,230,198,0.95); }

    /* === New Shop Design === */
    .shop-section {
      margin-bottom: 25px;
    }

    .shop-section-title {
      font-size: 18px;
      font-weight: 700;
      color: #d4af37;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.05));
      border-left: 4px solid #d4af37;
      border-radius: 6px;
    }

    .shop-notice {
      background: linear-gradient(135deg, rgba(52, 152, 219, 0.2), rgba(41, 128, 185, 0.1));
      border: 2px solid rgba(52, 152, 219, 0.4);
      border-radius: 10px;
      padding: 12px 15px;
      margin-bottom: 15px;
      color: #3498db;
      font-size: 13px;
      line-height: 1.5;
      position: relative;
    }

    .shop-notice::before {
      content: 'ðŸ’¡';
      font-size: 20px;
      margin-right: 8px;
    }

    .shop-item-card {
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 2px solid rgba(242,208,122,0.22);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      display: flex;
      gap: 15px;
      align-items: center;
      transition: all 0.3s;
      position: relative;
    }

    .shop-item-card:hover {
      border-color: #d4af37;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.2);
    }

    .shop-item-icon {
      width: 70px;
      height: 70px;
      min-width: 70px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 2px solid #444;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
    }

    .shop-item-content {
      flex: 1;
    }

    .shop-item-name {
      font-size: 16px;
      font-weight: 600;
      color: #d4af37;
      margin-bottom: 5px;
    }

    .shop-item-desc {
      font-size: 13px;
      color: #999;
      margin-bottom: 8px;
    }

    .shop-item-chance {
      display: inline-block;
      padding: 4px 10px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      border-radius: 15px;
      color: white;
      font-size: 11px;
      font-weight: 700;
      margin-top: 5px;
    }

    .shop-item-chance.rare {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
    }

    .shop-item-chance.uncommon {
      background: linear-gradient(135deg, #2ecc71, #27ae60);
    }

    .shop-item-action {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
    }

    .shop-item-price {
      font-size: 18px;
      font-weight: 700;
      color: #d4af37;
    }

    .shop-buy-button {
      padding: 10px 20px;
      background: linear-gradient(135deg, #2ecc71, #27ae60);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .shop-buy-button:hover {
      background: linear-gradient(135deg, #27ae60, #229954);
      transform: scale(1.05);
    }

    .shop-buy-button:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .action-btn {
      all: unset;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid rgba(242,208,122,0.3);
    }

    .upgrade-btn {
      background: linear-gradient(180deg, #a6ff7a, #2ea13a);
      color: #0b180b;
    }

    .upgrade-btn:hover {
      box-shadow: 0 0 15px rgba(166,255,122,0.4);
    }

    .add-btn {
      background: linear-gradient(180deg, rgba(242,208,122,0.4), rgba(197,155,60,0.2));
      color: var(--brass-0);
    }

    .add-btn:hover {
      background: linear-gradient(180deg, rgba(242,208,122,0.6), rgba(197,155,60,0.3));
    }

    .remove-btn {
      background: rgba(255,50,50,0.1);
      color: #ff6666;
      border-color: rgba(255,50,50,0.2);
    }

    .remove-btn:hover {
      background: rgba(255,50,50,0.2);
    }

    /* Shop */
    .shop-item{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .item-name{
      font-size: 15px;
      color: var(--brass-0);
    }
    .item-desc{
      font-size: 13px;
      color: var(--muted);
    }
    .item-price{
      font-size: 14px;
      color: var(--brass-1);
      margin: 4px 0;
    }
    .buy-btn{
      all: unset;
      padding: 10px;
      text-align: center;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }

    /* Gold packs */
    .gold-pack{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 15px;
      margin-bottom: 12px;
      text-align: center;
      position: relative;
    }
    .gold-pack.featured{
      border-color: var(--brass-1);
      box-shadow: 0 0 20px rgba(242,208,122,0.25);
    }
    .pack-badge{
      position: absolute;
      top: -8px;
      right: 10px;
      padding: 4px 12px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      font-size: 11px;
      border-radius: 12px;
      font-weight: 500;
    }
    .pack-amount{
      font-size: 20px;
      color: var(--brass-0);
      margin-bottom: 8px;
    }
    .pack-price{
      font-size: 15px;
      color: var(--brass-1);
      margin-bottom: 8px;
    }
    .pack-bonus{
      font-size: 13px;
      color: #8bc34a;
      margin-bottom: 8px;
    }
    .exchange-btn{
      all: unset;
      display: block;
      width: 100%;
      padding: 12px;
      text-align: center;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-1));
      color: var(--bg-dark);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      font-weight: 500;
    }

    /* Profile stats */
    .profile-stat{
      background:
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.55)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .stat-label{
      font-size: 14px;
      color: var(--muted);
    }
    .stat-value{
      font-size: 16px;
      color: var(--brass-0);
      font-weight: 500;
    }

    /* Guild status */
    .guild-status{
      background:
        radial-gradient(140px 120px at 30% 25%, rgba(255,220,140,0.16), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,0.25), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 15px;
      text-align: center;
    }
    .status-text{
      font-size: 15px;
      color: var(--brass-0);
    }

    /* Accordion list */
    .list{
      margin-top: 12px;
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid rgba(242,208,122,0.18);
      box-shadow: 0 12px 22px rgba(0,0,0,0.55);
      background:
        linear-gradient(180deg, rgba(255,220,140,0.06), rgba(0,0,0,0.45)),
        linear-gradient(180deg, #1b120c, #0b0806);
    }

    .item{
      border-top: 1px solid rgba(242,208,122,0.10);
    }
    .item:first-child{ border-top:none; }

    .item > button{
      all:unset;
      display:flex;
      align-items:center;
      width:100%;
      padding: 12px 12px;
      cursor:pointer;
      gap:10px;
    }
    .item > button:hover{ background: rgba(255,210,120,0.05); }

    .item .bullet{
      width:22px; height:22px;
      border-radius: 7px;
      background:
        linear-gradient(180deg, var(--brass-0), var(--brass-2));
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.5), 0 0 10px rgba(255,210,120,0.18);
      position:relative;
    }
    .item .bullet::after{
      content:"";
      position:absolute; inset:5px;
      border-radius: 6px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,255,255,0.22), transparent 55%),
        linear-gradient(180deg, #3a2e1f, #14100c);
      opacity:0.9;
    }

    .item .text{
      flex:1;
      font-size: 15px;
      letter-spacing:0.02em;
    }
    .item .chev{
      width: 10px; height:10px;
      border-right: 2px solid rgba(242,208,122,0.7);
      border-bottom: 2px solid rgba(242,208,122,0.7);
      transform: rotate(-45deg);
      transition: transform .12s ease;
      opacity:0.9;
      margin-right: 4px;
    }

    /* Promo */
    .promo{
      margin-top: 10px;
      border-radius: var(--radius);
      padding: 10px 12px;
      background:
        radial-gradient(400px 200px at 50% 0%, rgba(255,210,120,0.12), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: 0 12px 22px rgba(0,0,0,0.55);
      text-align:center;
    }
    .promo .badge{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: linear-gradient(180deg, var(--copper-0), var(--copper-2));
      border: 1px solid rgba(255,220,140,0.25);
      color: #1c0f08;
      font-weight: 700;
      letter-spacing:0.03em;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.45);
      margin-bottom: 6px;
    }
    .promo .line{
      color: var(--brass-0);
      font-weight: 700;
      text-shadow: 0 1px 0 rgba(0,0,0,0.75);
    }
    .promo .sub{
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    /* Bottom nav */
    .bottom{
      position: sticky;
      bottom: 8px;
      margin-top: 12px;
      border-radius: 18px;
      background:
        linear-gradient(180deg, rgba(255,220,140,0.06), rgba(0,0,0,0.65)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.18);
      box-shadow: 0 16px 26px rgba(0,0,0,0.65);
      display:flex;
      gap:6px;
      padding: 8px;
    }
    .navbtn{
      flex:1;
      border-radius: 14px;
      padding: 10px 8px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      border: 1px solid rgba(242,208,122,0.10);
      background:
        linear-gradient(180deg, rgba(255,210,120,0.04), rgba(0,0,0,0.45));
      transition: filter .08s ease, transform .08s ease;
    }
    .navbtn:hover{ filter: brightness(1.06); }
    .navbtn:active{ transform: translateY(1px); }

    .navbtn .ico{
      width:24px; height:24px;
      margin: 0 auto 6px;
      border-radius: 10px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,230,170,0.18), transparent 60%),
        linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,0.22);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.6);
      position:relative;
      overflow:hidden;
    }
    .navbtn .ico::after{
      content:"";
      position:absolute; inset:-50%;
      background: repeating-conic-gradient(from 0deg, rgba(242,208,122,0.10) 0 12deg, transparent 12deg 24deg);
      opacity:0.55;
    }
    .navbtn .t{
      font-size: 12px;
      color: var(--muted);
      letter-spacing:0.02em;
    }
    .navbtn.active{
      border-color: rgba(242,208,122,0.32);
      background:
        radial-gradient(220px 80px at 50% 0%, rgba(255,210,120,0.16), transparent 65%),
        linear-gradient(180deg, rgba(255,210,120,0.06), rgba(0,0,0,0.55));
    }
    .navbtn.active .t{ color: var(--brass-0); }

    /* Small screens */
    @media (max-width: 360px){
      .tile{ min-height: 90px; }
      .tile .label{ font-size: 12px; }
      .tile .sub{ font-size: 11px; }
    }

    /* ===== DECK SCREEN ===== */
    .screen {
      width: 100vw;
      max-width: none;
      margin: 0;
      padding: 0;
    }

    /* Topbar Ð´Ð»Ñ ÐºÐ¾Ð»Ð¾Ð´Ð¸ */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 16px;
      background: 
        linear-gradient(180deg, rgba(255,210,120,.06), rgba(0,0,0,.55)),
        linear-gradient(180deg, #1b120c, #070503);
      border: 1px solid rgba(242,208,122,.20);
      box-shadow: 0 14px 26px rgba(0,0,0,.65);
      margin-bottom: 10px;
    }

    .topbar-right {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .pill {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(242,208,122,.18);
      box-shadow: inset 0 0 10px rgba(0,0,0,.65);
      font-size: 14px;
      color: var(--brass-0);
      font-weight: 600;
    }

    .gem, .coin {
      width: 10px;
      height: 10px;
      display: inline-block;
    }

    .gem {
      border-radius: 2px;
      background: linear-gradient(135deg, #bfe8ff, #4aa0d6);
      box-shadow: 0 0 6px rgba(79, 180, 240, 0.5);
    }

    .coin {
      border-radius: 50%;
      background: linear-gradient(135deg, var(--brass-0), var(--brass-1));
      box-shadow: 0 0 6px rgba(242,208,122, 0.5);
    }

    /* Panel helper */
    .panel {
      background:
        linear-gradient(180deg, rgba(255,210,120,.05), rgba(0,0,0,.55)),
        linear-gradient(180deg, #1b120c, #070503);
      border: 1px solid rgba(242,208,122,.18);
      box-shadow: 0 14px 24px rgba(0,0,0,.6), inset 0 0 14px rgba(0,0,0,.7);
      border-radius: 14px;
    }

    .subtle {
      opacity: 0.95;
    }

    /* Deck header */
    .deck-header {
      padding: 10px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .deck-title {
      font-weight: 800;
      letter-spacing: 0.06em;
      color: var(--brass-0);
      font-size: 14px;
    }

    .deck-power {
      font-weight: 800;
      color: var(--brass-0);
      font-size: 16px;
    }

    /* Hint */
    .hint {
      padding: 8px 12px;
      text-align: center;
      color: rgba(244,230,198,.92);
      font-size: 13px;
      margin-bottom: 10px;
    }

    /* Card base styles */
    .sp-card {
      /* ÐšÐ¾Ð¼Ð¿Ð°ÐºÑ‚Ð½Ð¸Ð¹ Ñ€Ð¾Ð·Ð¼Ñ–Ñ€ */
      width: 200px;
      height: 280px;
      border-radius: 20px;
      position: relative;
      padding: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;

      --elem: var(--fire); /* default */
      --rar: var(--legend); /* default rarity */

      background:
        radial-gradient(200px 180px at 40% 20%, rgba(255,220,140,.14), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.72)),
        linear-gradient(180deg, #1b120c, #080604);

      box-shadow:
        0 15px 30px var(--shadow),
        inset 0 0 18px rgba(0,0,0,.78),
        0 0 18px color-mix(in srgb, var(--elem) 22%, transparent);

      border: 1px solid rgba(242,208,122,.22);
    }

    .sp-card:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow:
        0 20px 40px var(--shadow),
        inset 0 0 18px rgba(0,0,0,.78),
        0 0 25px color-mix(in srgb, var(--elem) 35%, transparent);
    }

    .sp-card.selected {
      box-shadow:
        0 20px 40px var(--shadow),
        inset 0 0 18px rgba(0,0,0,.78),
        0 0 35px color-mix(in srgb, var(--elem) 50%, transparent),
        0 0 0 3px var(--rar);
    }

    /* Metal rim with rarity color */
    .sp-card::before{
      content:"";
      position:absolute;
      inset: 8px;
      border-radius: 16px;
      background:
        linear-gradient(135deg,
          color-mix(in srgb, var(--rar) 30%, rgba(242,208,122,.62)),
          color-mix(in srgb, var(--rar) 20%, rgba(181,106,51,.25)),
          color-mix(in srgb, var(--rar) 15%, rgba(122,85,32,.2)));
      box-shadow:
        inset 0 0 0 1px rgba(0,0,0,.6),
        inset 0 0 16px rgba(0,0,0,.6);
      pointer-events:none;
      opacity:.95;
      z-index: 1;
    }

    /* Inner plate */
    .sp-card::after{
      content:"";
      position:absolute;
      inset: 14px;
      border-radius: 14px;
      background:
        radial-gradient(400px 320px at 50% 20%, rgba(255,210,120,.08), transparent 58%),
        linear-gradient(180deg, rgba(255,210,120,.04), rgba(0,0,0,.40)),
        linear-gradient(180deg, #241a12, #120c08);
      box-shadow:
        inset 0 0 0 1px rgba(242,208,122,.10),
        inset 0 0 14px rgba(0,0,0,.65);
      pointer-events:none;
      z-index: 1;
    }

    /* Content layer */
    .sp-card > *{ position:relative; z-index:2; }

    /* Upgradable card - green arrow indicator (ÑÐº Ð¾ÐºÑ€ÐµÐ¼Ð¸Ð¹ ÐµÐ»ÐµÐ¼ÐµÐ½Ñ‚) */
    .upgrade-dot {
      position: absolute;
      top: -12px;
      right: 8px;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      
      color: #0b180b;
      background: linear-gradient(180deg, #a6ff7a, #2ea13a);
      border: 1px solid rgba(0,0,0,.45);
      box-shadow: 0 6px 14px rgba(0,0,0,.6), 0 0 16px rgba(90,255,120,.25);
      font-weight: 900;
      font-size: 14px;
      cursor: pointer;
      animation: pulse-upgrade 1.5s ease-in-out infinite;
      z-index: 10;
    }
    .corner-gear {
      position: absolute;
      top: 16px;
      left: 16px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      z-index: 3;
      
      background:
        conic-gradient(
          from 0deg,
          var(--brass-2) 0 15deg,
          var(--brass-1) 15deg 30deg,
          var(--brass-2) 30deg 45deg,
          var(--brass-1) 45deg 60deg,
          var(--brass-2) 60deg 75deg,
          var(--brass-1) 75deg 90deg,
          var(--brass-2) 90deg 105deg,
          var(--brass-1) 105deg 120deg,
          var(--brass-2) 120deg 135deg,
          var(--brass-1) 135deg 150deg,
          var(--brass-2) 150deg 165deg,
          var(--brass-1) 165deg 180deg,
          var(--brass-2) 180deg 195deg,
          var(--brass-1) 195deg 210deg,
          var(--brass-2) 210deg 225deg,
          var(--brass-1) 225deg 240deg,
          var(--brass-2) 240deg 255deg,
          var(--brass-1) 255deg 270deg,
          var(--brass-2) 270deg 285deg,
          var(--brass-1) 285deg 300deg,
          var(--brass-2) 300deg 315deg,
          var(--brass-1) 315deg 330deg,
          var(--brass-2) 330deg 345deg,
          var(--brass-1) 345deg 360deg
        );
      
      box-shadow:
        inset 0 0 0 2px rgba(0,0,0,.6),
        0 5px 12px rgba(0,0,0,.7),
        0 0 12px color-mix(in srgb, var(--elem) 40%, transparent);
      
      display: grid;
      place-items: center;
      transition: transform 0.6s ease;
    }

    .sp-card:hover .corner-gear {
      transform: rotate(180deg);
    }

    /* Ð¦ÐµÐ½Ñ‚Ñ€ ÑˆÐµÑÑ‚ÐµÑ€Ð½Ñ– */
    .corner-gear::before{
      content:"";
      position:absolute;
      inset: 8px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 60%),
        linear-gradient(180deg, #2a1c12, #0a0604);
      box-shadow: inset 0 0 8px rgba(0,0,0,.8);
      z-index: -1;
    }

    /* Ð†ÐºÐ¾Ð½ÐºÐ° ÑÑ‚Ð¸Ñ…Ñ–Ñ— Ð²ÑÐµÑ€ÐµÐ´Ð¸Ð½Ñ– ÑˆÐµÑÑ‚ÐµÑ€Ð½Ñ– */
    .corner-gear svg{
      width: 22px;
      height: 22px;
      fill: var(--elem);
      filter:
        drop-shadow(0 0 6px color-mix(in srgb, var(--elem) 60%, transparent))
        drop-shadow(0 2px 4px rgba(0,0,0,.8));
      position: relative;
      z-index: 2;
    }
    
    .power-plate {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: 70%;
      height: 50px;
      border-radius: 12px;
      
      background:
        radial-gradient(180px 60px at 50% 0%, rgba(255,210,120,.15), transparent 70%),
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.65)),
        linear-gradient(180deg, #1b120c, #080604);
      
      border: 1px solid rgba(242,208,122,.25);
      box-shadow: 
        inset 0 0 12px rgba(0,0,0,.75),
        0 6px 16px rgba(0,0,0,.6),
        inset 0 0 0 1px rgba(0,0,0,.6);
      
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 3;
    }

    .sp-card:hover .power-plate {
      box-shadow: 
        inset 0 0 12px rgba(0,0,0,.75),
        0 8px 20px rgba(0,0,0,.7),
        inset 0 0 0 1px rgba(0,0,0,.6),
        0 0 15px color-mix(in srgb, var(--elem) 30%, transparent);
    }

    .sp-card.selected .power-plate {
      background:
        radial-gradient(180px 60px at 50% 0%, rgba(255,210,120,.20), transparent 70%),
        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.65)),
        linear-gradient(180deg, color-mix(in srgb, var(--rar) 15%, #1b120c), color-mix(in srgb, var(--rar) 10%, #080604));
    }
    
    .power-value {
      font-size: 32px;
      font-weight: 900;
      color: var(--brass-0);
      font-variant-numeric: tabular-nums;
      text-shadow:
        0 2px 0 rgba(0,0,0,.75),
        0 0 12px rgba(255,210,120,.25);
      transition: all 0.3s ease;
    }

    .sp-card.selected .power-value {
      color: color-mix(in srgb, var(--rar) 40%, var(--brass-0));
      text-shadow:
        0 2px 0 rgba(0,0,0,.75),
        0 0 20px color-mix(in srgb, var(--rar) 50%, transparent);
    }
    
    .rarity-badge {
      position: absolute;
      top: 16px;
      right: 16px;
      padding: 4px 10px;
      border-radius: 10px;
      background: rgba(0,0,0,0.8);
      border: 1px solid var(--rar);
      color: var(--rar);
      font-size: 10px;
      font-weight: bold;
      letter-spacing: 1px;
      z-index: 3;
      text-transform: uppercase;
    }

    /* Deck Grid 3x3 */
    .deck-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 16px;
      align-items: start;
      justify-items: center;
    }

    /* ÐšÐ°Ñ€Ñ‚Ð¸ Ð² ÐºÐ¾Ð»Ð¾Ð´Ñ– Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑŽÑ‚ÑŒ ÑÑ‚Ð¸Ð»Ñ– Ð· steampunk-cards.css */


    /* ===== DUEL SCREEN ===== */
    .duel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .duel-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--brass-0);
    }
    .duel-start-btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid rgba(242,208,122,.25);
      background: linear-gradient(180deg, rgba(242,208,122,.25), rgba(0,0,0,.35));
      color: var(--brass-0);
      cursor: pointer;
    }
    .duel-hud {
      display: flex;
      gap: 12px;
      margin-bottom: 10px;
    }
    .duel-hp {
      flex: 1;
      padding: 10px;
      border: 1px solid rgba(242,208,122,.18);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,220,140,.06), rgba(0,0,0,.35));
      color: var(--brass-0);
    }
    .enemy-hand, .player-hand {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 10px 0 0px;
    }
    .player-hand {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 0px 0 8px;
    }
    .duel-multipliers {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin: 12px 0;
      min-height: 32px;
    }
    .duel-log {
      min-height: 50px;
      padding: 8px;
      margin: 0px 0 10px;
      border: 1px dashed rgba(242,208,122,.2);
      border-radius: 10px;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.4;
      text-align: center;
    }

    /* HUD: avatar + HP bar for enemy/player */
    .hud-status{
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:center;
      margin:8px 0;
    }
    .hud-status .avatar{
      width:56px;
      height:56px;
      border-radius:10px;
      background: linear-gradient(180deg, #2f1f14, #120c08);
      border: 2px solid rgba(242,208,122,0.16);
      box-shadow: inset 0 0 6px rgba(0,0,0,0.6), 0 6px 12px rgba(0,0,0,0.5);
      display:flex; align-items:center; justify-content:center; color:var(--brass-0); font-weight:800;
    }
    .hud-status .avatar.enemy-avatar{ box-shadow: inset 0 0 8px rgba(120,40,20,0.6), 0 6px 12px rgba(0,0,0,0.6); }
    .hud-status .avatar.player-avatar{ box-shadow: inset 0 0 8px rgba(40,120,20,0.6), 0 6px 12px rgba(0,0,0,0.6); }
    .hud-status .hp-wrapper{ flex:1; min-width:220px; }
    .hp-label{ font-size:13px; color:var(--muted); margin-bottom:6px; text-align:left; }
    .hp-bar{ height:12px; background: rgba(0,0,0,0.35); border-radius:10px; border:1px solid rgba(242,208,122,0.12); overflow:hidden; }
    .hp-fill{ height:100%; width:0%; background: linear-gradient(90deg, #4CAF50, #2e7d32); box-shadow: 0 0 8px rgba(46,204,113,0.12); transition: width 0.28s ease; }

    .preduel-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
    }
    .preduel-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      border: 1px solid rgba(242,208,122,0.18);
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,220,140,0.06), rgba(0,0,0,0.25));
      color: var(--ink);
      font-weight: 600;
    }
    .preduel-label { color: var(--muted); font-weight: 500; }
    .preduel-value { color: var(--brass-0); }
    .preduel-actions { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
    .duel-hand .sp-card, .enemy-hand .sp-card, .player-hand .sp-card {
      width: 160px;
      height: 220px;
    }
    /* Extras section */
    .extras-title {
      margin: 14px 4px 8px;
      color: rgba(242,208,122,.85);
      letter-spacing: 0.06em;
      text-align: center;
      font-weight: 700;
      font-size: 13px;
    }

    .extras-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 8px;
    }

    /* === Ð•Ð›Ð•ÐœÐ•ÐÐ¢Ð˜ Ð¡Ð¢Ð˜Ð¥Ð†Ð‡ === */
    .sp-card.fire  { --elem: var(--fire); }
    .sp-card.water { --elem: var(--water); }
    .sp-card.air   { --elem: var(--air); }
    .sp-card.earth { --elem: var(--earth); }
    .sp-card.steam { --elem: var(--steam); }
    .sp-card.mech  { --elem: var(--mech); }

    /* === Ð Ð†Ð”ÐšÐžÐ¡Ð¢Ð† === */
    .sp-card.common  { --rar: var(--common); }
    .sp-card.rare    { --rar: var(--rare); }
    .sp-card.epic    { --rar: var(--epic); }
    .sp-card.legend  { --rar: var(--legend); }

    /* ÐÐ½Ñ–Ð¼Ð°Ñ†Ñ–Ñ ÑÐ²Ñ–Ñ‚Ñ–Ð½Ð½Ñ */
    @media (prefers-reduced-motion: no-preference){
      .sp-card{
        animation: subtle-glow 3s ease-in-out infinite;
      }
      @keyframes subtle-glow{
        0%,100%{ filter: brightness(1.00); }
        50%    { filter: brightness(1.05); }
      }
    }

    .extra-slot {
      padding: 10px 8px;
      text-align: center;
      min-height: 90px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 8px;
    }

    .slot-icon {
      width: 38px;
      height: 38px;
      margin: 0 auto;
      border-radius: 12px;
      background: linear-gradient(180deg, #2f1f14, #120c08);
      border: 1px solid rgba(242,208,122,.20);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.6);
      opacity: 0.75;
    }

    .slot-text {
      font-size: 12px;
      color: rgba(244,230,198,.86);
    }

    /* Link-like button */
    .link-like {
      text-align: center;
      color: rgba(159, 214, 255, .85);
      font-size: 12px;
      text-decoration: underline;
      cursor: pointer;
      margin-bottom: 12px;
    }

    .link-like:hover {
      color: rgba(159, 214, 255, 1);
    }

    /* Menu list */
    .menu-list {
      padding: 6px;
    }

    .menu-row {
      width: 100%;
      background: transparent;
      color: rgba(244,230,198,.92);
      border: 1px solid rgba(242,208,122,.10);
      border-radius: 12px;
      padding: 12px 10px;
      margin: 6px 0;
      text-align: left;
      cursor: pointer;
      font-family: Georgia, "Times New Roman", serif;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .menu-row:hover {
      border-color: rgba(242,208,122,.25);
      background: rgba(255,210,120,.04);
    }

    .menu-row:active {
      transform: translateY(1px);
    }

    /* Auth overlay */
    .auth-overlay{
      position: fixed;
      inset: 0;
      background: rgba(8, 6, 5, 0.95);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .auth-overlay.hidden{
      opacity: 0;
      pointer-events: none;
      display: none;
    }

    .auth-box{
      width: min(380px, 90vw);
      background:
        linear-gradient(180deg, rgba(255,220,140,0.08), rgba(0,0,0,0.45)),
        linear-gradient(180deg, #1b120c, #0b0806);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: var(--radius);
      padding: 24px 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.75);
      position: relative;
    }
    .auth-box::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: var(--radius);
      background: linear-gradient(135deg, rgba(242,208,122,0.35), rgba(213,143,85,0.18), rgba(90,50,20,0.10));
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      padding: 1px;
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events:none;
    }

    .auth-title{
      font-size: 24px;
      font-weight: 700;
      color: var(--brass-0);
      text-align: center;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.7);
    }
    .auth-subtitle{
      font-size: 13px;
      color: var(--muted);
      text-align: center;
      margin-bottom: 24px;
    }

    .auth-tabs{
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      padding: 4px;
    }
    .auth-tab{
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      color: var(--muted);
      font-size: 14px;
      transition: all 0.2s ease;
      border: 1px solid transparent;
    }
    .auth-tab:hover{
      background: rgba(255,210,120,0.05);
    }
    .auth-tab.active{
      background: linear-gradient(180deg, var(--brass-0), var(--brass-2));
      color: #14100c;
      font-weight: 700;
      border-color: rgba(255,230,140,0.3);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.4);
    }

    .auth-form{
      display: none;
    }
    .auth-form.active{
      display: block;
    }

    .form-group{
      margin-bottom: 16px;
    }
    .form-label{
      display: block;
      font-size: 13px;
      color: var(--brass-0);
      margin-bottom: 6px;
      font-weight: 600;
    }
    .form-input{
      width: 100%;
      padding: 12px 14px;
      background:
        linear-gradient(180deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6)),
        linear-gradient(180deg, #1a120c, #0c0907);
      border: 1px solid rgba(242,208,122,0.22);
      border-radius: 10px;
      color: var(--ink);
      font-family: Georgia, "Times New Roman", serif;
      font-size: 15px;
      box-shadow: inset 0 0 12px rgba(0,0,0,0.6);
      transition: border-color 0.2s ease;
    }
    .form-input:focus{
      outline: none;
      border-color: rgba(242,208,122,0.45);
      box-shadow: inset 0 0 12px rgba(0,0,0,0.6), 0 0 0 2px rgba(242,208,122,0.15);
    }
    .form-input::placeholder{
      color: rgba(208, 191, 154, 0.5);
    }

    .auth-btn{
      width: 100%;
      padding: 14px;
      background: linear-gradient(180deg, var(--brass-0), var(--brass-2));
      border: 1px solid rgba(255,230,140,0.35);
      border-radius: 12px;
      color: #14100c;
      font-family: Georgia, "Times New Roman", serif;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.15s ease;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35), 0 6px 16px rgba(0,0,0,0.4);
      text-shadow: 0 1px 0 rgba(255,255,255,0.2);
    }
    .auth-btn:hover{
      filter: brightness(1.08);
      transform: translateY(-1px);
    }
    .auth-btn:active{
      transform: translateY(0);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.35), 0 2px 8px rgba(0,0,0,0.4);
    }

    .auth-error{
      display: none;
      margin-top: 12px;
      padding: 10px 12px;
      background: rgba(180, 50, 40, 0.2);
      border: 1px solid rgba(220, 80, 60, 0.4);
      border-radius: 8px;
      color: #ffcccc;
      font-size: 13px;
      text-align: center;
    }
    .auth-error.show{
      display: block;
    }
    .burn-arrow {
      position: absolute;
      left: 8px;
      bottom: 8px;
      font-size: 1.5rem;
      color: #3cff3c;
      line-height: 1;
      font-weight: bold;
      pointer-events: none;
      z-index: 2;
      text-shadow: 0 2px 8px #000a, 0 0 6px #3cff3c99;
      filter: drop-shadow(0 0 2px #000) drop-shadow(0 0 4px #3cff3c);
      background: none;
      border-radius: 50%;
      padding: 0;
    }
    .weaker-card-item {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 180px;
    }
    /* Mobile: force 3 cards per row and compact card tiles */
    @media (max-width: 480px) {
      .collection-grid {
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 6px;
      }
      .collection-card-item {
        padding: 6px 4px;
        min-height: 70px;
      }
      .collection-card-name { font-size: 12px; }
      .collection-card-status { font-size: 10px; }
    }
    /* Canonical 3x3 layout for narrow screens (<=425px) to prevent reflow/pulsation */
    @media (max-width: 430px) {
      /* remove extra container paddings that break available width */
      #app-shell { padding-left: 4px; padding-right: 4px; }
      #root, .container { padding-left: 0; padding-right: 0; }

      /* canonical grid for decks and lists */
      .deck-grid, .grid-3x3, .duel-deck {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 6px;
        width: 100%;
        margin: 0;
        padding: 0 4px;
        align-items: start;
        align-content: start;
      }

      /* card sizing: grid controls width, card keeps fixed aspect-ratio (no px widths) */
      .deck-grid .sp-card,
      .grid-3x3 .sp-card,
      .duel-deck .sp-card,
      .sp-card {
        width: 100%;
        aspect-ratio: 3 / 4.4;
        min-height: 0;

        position: relative;
        overflow: hidden;

        border-radius: 14px;
        box-shadow:
          0 6px 18px rgba(0,0,0,.6),
          inset 0 0 18px rgba(0,0,0,.75);

        transform: translateZ(0);
        will-change: transform;
        padding: 6px;
      }
    }
  </style>
</head>
<body>
  <!-- Auth overlay -->
  <div class="auth-overlay hidden" id="authOverlay">
    <div class="auth-box">
      <h1 class="auth-title">âš™ï¸ Elem Clone</h1>
      <p class="auth-subtitle">Ð¡Ñ‚Ñ–Ð¼Ð¿Ð°Ð½Ðº ÐºÐ°Ñ€Ñ‚Ð¾Ð²Ð° Ð³Ñ€Ð°</p>

      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">Ð’Ñ…Ñ–Ð´</div>
        <div class="auth-tab" data-tab="register">Ð ÐµÑ”ÑÑ‚Ñ€Ð°Ñ†Ñ–Ñ</div>
      </div>

      <!-- Login Form -->
      <form class="auth-form active" id="loginForm">
        <div class="form-group">
          <label class="form-label">Ð†Ð¼'Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°</label>
          <input type="text" class="form-input" id="loginUsername" placeholder="Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ñ–Ð¼'Ñ" required>
        </div>
        <button type="submit" class="auth-btn">Ð£Ð²Ñ–Ð¹Ñ‚Ð¸</button>
        <div class="auth-error" id="loginError"></div>
      </form>

      <!-- Register Form -->
      <form class="auth-form" id="registerForm">
        <div class="form-group">
          <label class="form-label">Ð†Ð¼'Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°</label>
          <input type="text" class="form-input" id="registerUsername" placeholder="Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ñ–Ð¼'Ñ" required minlength="3" maxlength="20">
        </div>
        <button type="submit" class="auth-btn">Ð—Ð°Ñ€ÐµÑ”ÑÑ‚Ñ€ÑƒÐ²Ð°Ñ‚Ð¸ÑÑ</button>
        <div class="auth-error" id="registerError"></div>
      </form>
    </div>
  </div>

  <div class="phone" id="app">
    <div class="noise"></div>

    <header class="topbar">
      <!-- HUD XP Row moved above toprow so XP bar appears above HUD -->
      <div class="hud-xp-row" aria-label="HUD XP Row">
        <div id="xpFill" class="hud-xp-row__fill" style="transform: scaleX(0);"></div>
        <div id="xpPct" class="hud-xp-row__label">0% (0 / 0)</div>
      </div>
      <div class="toprow">
        <div class="avatar">
          <div class="portrait" aria-hidden="true"></div>
          <div class="level">Ð Ñ–Ð²ÐµÐ½ÑŒ: <span>1</span></div>
        </div>

        <div class="meters">
          <div class="meter" title="Ð‘Ð¾Ð»Ñ‚Ð¸"><span>ðŸ”©</span><strong id="home-bolts">500</strong></div>
          <div class="meter" title="Ð¨ÐµÑÑ‚ÐµÑ€Ð½Ñ–"><span>âš™ï¸</span><strong id="home-gears">0</strong></div>
          <div class="meter" title="ÐŸÐ°Ñ€Ð¾Ð²Ñ– ÑÐ´Ñ€Ð°"><span>âœ´ï¸Ž</span><strong id="home-cores">0</strong></div>
        </div>
      </div>
      <div class="hud-xpline" aria-label="Ð”Ð¾ÑÐ²Ñ–Ð´">
        <span class="hud-xpfill"></span>
      </div>
    </header>

    <!-- Main content container -->
    <div id="main-content">
      <!-- Bag Page -->
      <section class="page" id="page-bag">
        <div class="page-header">
          <button class="back-btn" id="bag-back-btn">â† ÐÐ°Ð·Ð°Ð´</button>
          <h2 class="page-title">Ð¡ÑƒÐ¼ÐºÐ°</h2>
        </div>
        <div class="page-content">
          <div id="bag-cards-list" class="cards-list"></div>
        </div>
      </section>
      
      <!-- Home Page -->
      <section class="page active" id="page-home">
        <section class="tiles" aria-label="Ð ÐµÐ¶Ð¸Ð¼Ð¸">
          <div class="tile" data-page="duels">
            <div class="rivets">
              <span class="rivet r1"></span><span class="rivet r2"></span><span class="rivet r3"></span><span class="rivet r4"></span>
            </div>
            <div class="icon" aria-hidden="true"></div>
            <div class="label">Ð”ÑƒÐµÐ»Ñ–</div>
            <div class="sub">Ð¡Ð¿Ñ€Ð¾Ð±Ð¸: 10</div>
          </div>

          <div class="tile" data-page="arena">
            <div class="rivets">
              <span class="rivet r1"></span><span class="rivet r2"></span><span class="rivet r3"></span><span class="rivet r4"></span>
            </div>
            <div class="icon" aria-hidden="true"></div>
            <div class="label">ÐÑ€ÐµÐ½Ð°</div>
            <div class="sub">Ð‘Ñ–Ð¹</div>
          </div>

          <div class="tile" data-page="deck">
            <div class="rivets">
              <span class="rivet r1"></span><span class="rivet r2"></span><span class="rivet r3"></span><span class="rivet r4"></span>
            </div>
            <div class="icon" aria-hidden="true"></div>
            <div class="label">Ð‘Ð¾Ð¹Ð¾Ð²Ð° ÐºÐ¾Ð»Ð¾Ð´Ð°</div>
            <div class="sub">Ð¡Ð¸Ð»Ð°: <span id="deck-power-home">0</span></div>
          </div>
        </section>

        <section class="list" aria-label="ÐœÐµÐ½ÑŽ">
          <div class="item" data-page="tasks">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">Ð—Ð°Ð²Ð´Ð°Ð½Ð½Ñ</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="rewards">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">Ð”Ñ–Ð°Ð¼Ð°Ð½Ñ‚Ð¾Ð²Ñ– Ð½Ð°Ð³Ð¾Ñ€Ð¾Ð´Ð¸</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          

          <div class="item" data-page="collections">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">ÐšÐ¾Ð»ÐµÐºÑ†Ñ–Ñ—</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="bag">
            <button type="button" id="menu-bag-btn">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">Ð¡ÑƒÐ¼ÐºÐ°</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="shop">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">ÐœÐ°Ð³Ð°Ð·Ð¸Ð½</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>

          <div class="item" data-page="buy-gold">
            <button type="button">
              <span class="bullet" aria-hidden="true"></span>
              <span class="text">ÐšÑƒÐ¿Ð¸Ñ‚Ð¸ Ð·Ð¾Ð»Ð¾Ñ‚Ð¾</span>
              <span class="chev" aria-hidden="true"></span>
            </button>
          </div>
        </section>

        <section class="promo" aria-label="ÐÐºÑ†Ñ–Ñ">
          <div class="badge">ÐÐºÑ†Ñ–Ñ</div>
          <div class="line">Ð’Ñ–Ð´ 250 Ð´Ð¾ 1250 Ñƒ Ð¿Ð¾Ð´Ð°Ñ€ÑƒÐ½Ð¾Ðº</div>
          <div class="sub">ÐžÑÑ‚Ð°Ð½Ð½Ñ–Ð¹ Ð´ÐµÐ½ÑŒ. ÐŸÐ°Ñ€Ð° Ñ‚Ð° Ð¼ÐµÑ…Ð°Ð½Ñ–ÐºÐ° Ð½Ðµ Ñ‡ÐµÐºÐ°ÑŽÑ‚ÑŒ.</div>
        </section>
      </section>

      <!-- Duels Page -->
      <section class="page" id="page-duels">
        <div class="page-header">
          <button class="back-btn" data-page="home">â† ÐÐ°Ð·Ð°Ð´</button>
          <h2 class="page-title">Ð”ÑƒÐµÐ»Ñ–</h2>
        </div>
        <div class="page-content panel">
          <div class="duel-header">
            <!-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº ÑƒÐ±Ñ€Ð°Ð½: Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð¿Ð¾Ð¸ÑÐº Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÑ‚ÑÑ Ð±ÐµÐ· Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ð¾Ð³Ð¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ -->
            <button class="duel-start-btn" id="duel-start-btn">ÐŸÐ¾Ñ‡Ð°Ñ‚Ð¸ Ð´ÑƒÐµÐ»ÑŒ</button>
          </div>
          <div class="duel-hud">
            <div class="duel-hp duel-power"><strong>Ð¡Ð¸Ð»Ð° ÐºÐ¾Ð»Ð¾Ð´:</strong> <span id="enemyPower">0</span> / <span id="playerPower">0</span></div>
          </div>

          <!-- HUD Ð½Ð°Ð´ Ñ€ÑƒÐºÐ¾ÑŽ Ð²Ð¾Ñ€Ð¾Ð³Ð°: Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ñ– ÑÐ¼ÑƒÐ³Ð° HP -->
          <div class="enemy-status hud-status">
            <div class="avatar enemy-avatar" id="enemyAvatar">ðŸ‘¾</div>
            <div class="hp-wrapper">
              <div class="hp-label"><strong>Ð’Ð¾Ñ€Ð¾Ð³:</strong> <span id="enemyHpText">0/0</span></div>
              <div class="hp-bar"><div id="enemyHpBar" class="hp-fill" style="width:0%"></div></div>
            </div>
          </div>

          <div class="enemy-hand" id="enemyHand"></div>
          <div class="duel-multipliers" id="duelMultipliers"></div>
          <div class="player-hand" id="playerHand"></div>

          <!-- HUD Ð¿Ñ–Ð´ Ñ€ÑƒÐºÐ¾ÑŽ Ð³Ñ€Ð°Ð²Ñ†Ñ: Ð°Ð²Ð°Ñ‚Ð°Ñ€ Ñ– ÑÐ¼ÑƒÐ³Ð° HP -->
          <div class="player-status hud-status">
            <div class="avatar player-avatar" id="playerAvatar">ðŸ™‚</div>
            <div class="hp-wrapper">
              <div class="hp-label"><strong>Ð’Ð¸:</strong> <span id="playerHpText">0/0</span></div>
              <div class="hp-bar"><div id="playerHpBar" class="hp-fill" style="width:0%"></div></div>
            </div>
          </div>
          <div class="duel-log" id="duelLog"></div>
        </div>
      </section>

      <!-- Arena Page -->
      <section class="page" id="page-arena">
        <div class="page-header">
          <button class="back-btn" data-page="home">â† ÐÐ°Ð·Ð°Ð´</button>
          <h2 class="page-title">ÐÑ€ÐµÐ½Ð°</h2>
        </div>
        <div class="page-content">
          <div class="info-card">
            <div class="info-label">ÐŸÐ¾Ñ‚Ð¾Ñ‡Ð½Ð¸Ð¹ Ñ€Ð°Ð½Ð³</div>
            <div class="info-value">Ð—Ð¾Ð»Ð¾Ñ‚Ð¾ III</div>
          </div>
          <div class="info-card">
            <div class="info-label">Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³</div>
            <div class="info-value">1847</div>
          </div>
          <button class="action-btn">Ð£Ð²Ñ–Ð¹Ñ‚Ð¸ Ð² Ð°Ñ€ÐµÐ½Ñƒ</button>
          <div class="description">
            Ð ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¾Ð²Ñ– Ð±Ð¾Ñ— Ð·Ð° Ñ€Ð°Ð½Ð³Ð¸. ÐŸÑ–Ð´Ð½Ñ–Ð¼Ð°Ð¹Ñ‚ÐµÑÑ Ð²Ð³Ð¾Ñ€Ñƒ Ð·Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†ÐµÑŽ Ð»Ñ–Ð´ÐµÑ€Ñ–Ð² Ñ– Ð¾Ñ‚Ñ€Ð¸Ð¼ÑƒÐ¹Ñ‚Ðµ ÐµÐºÑÐºÐ»ÑŽÐ·Ð¸Ð²Ð½Ñ– Ð½Ð°Ð³Ð¾Ñ€Ð¾Ð´Ð¸.
          </div>
        </div>
      </section>

      <!-- Deck Page -->
      <section class="page" id="page-deck">
        <div class="screen">
          
          <!-- Topbar -->
          <header class="topbar">
            <button class="back-btn" data-page="home" style="flex: 0; padding: 6px 10px; font-size: 13px;">â† ÐÐ°Ð·Ð°Ð´</button>
          </header>

          <!-- Deck Header -->
          <div class="deck-header panel">
            <div class="deck-title">Ð‘ÐžÐ™ÐžÐ’Ð ÐšÐžÐ›ÐžÐ”Ð</div>
            <div class="deck-power">âš™ <span id="deck-power-value">190</span></div>
          </div>

          <div class="hint panel subtle" id="deck-hint">â¬† ÐŸÐ¾Ð»Ñ–Ð¿ÑˆÑƒÐ¹Ñ‚Ðµ ÐºÐ°Ñ€Ñ‚Ð¸!</div>

          <!-- 3x3 Grid -->
          <section class="deck-grid" id="deckGrid">
            <!-- ÐšÐ°Ñ€Ñ‚Ð¸ Ñ€ÐµÐ½Ð´ÐµÑ€Ð¸Ð¼Ð¾ JavaScript -->
          </section>

          <!-- Extras Section -->
          <div class="extras-title">Ð”Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ñ– ÐºÐ°Ñ€Ñ‚Ð¸</div>

          <section class="extras-grid">
            <div class="extra-slot panel subtle">
              <div class="slot-icon"></div>
              <div class="slot-text">Ð¡Ð¾ÑŽÐ·Ð½Ð¸Ðº</div>
            </div>
            <div class="extra-slot panel subtle">
              <div class="slot-icon"></div>
              <div class="slot-text">Ð“Ñ–Ð»ÑŒÐ´Ñ–Ñ</div>
            </div>
            <div class="extra-slot panel subtle">
              <div class="slot-icon"></div>
              <div class="slot-text">ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚</div>
            </div>
          </section>

          <div class="link-like">â“˜ Ð”Ðµ Ð²Ð·ÑÑ‚Ð¸ Ð´Ð¾Ð´Ð°Ñ‚ÐºÐ¾Ð²Ñ– ÐºÐ°Ñ€Ñ‚Ð¸</div>

          <!-- Menu List -->
          <section class="menu-list panel">
            <button class="menu-row" data-page="duels">âš” Ð”ÑƒÐµÐ»Ñ–</button>
            <button class="menu-row" data-page="arena">ðŸ› ÐÑ€ÐµÐ½Ð°</button>
            <button class="menu-row" data-page="shop">ðŸ› ÐœÐ°Ð³Ð°Ð·Ð¸Ð½</button>
          </section>

        </div>
      </section>

      <!-- Tasks Page -->
      <section class="page" id="page-tasks">
        <div class="page-header">
          <button class="back-btn" data-page="home">â† ÐÐ°Ð·Ð°Ð´</button>
          <h2 class="page-title">Ð—Ð°Ð²Ð´Ð°Ð½Ð½Ñ</h2>
        </div>
        <div class="page-content">
          <div class="task-item">
            <div class="task-text">Ð’Ð¸Ð³Ñ€Ð°Ð¹Ñ‚Ðµ 3 Ð´ÑƒÐµÐ»Ñ–</div>
            <div class="task-progress">1/3</div>
            <div class="task-reward">+50 XP, 5 Ð·Ð¾Ð»Ð¾Ñ‚Ð°</div>
          </div>
          <div class="task-item completed">
            <div class="task-text">Ð£Ð²Ñ–Ð¹Ð´Ñ–Ñ‚ÑŒ Ñƒ Ð³Ñ€Ñƒ</div>
            <div class="task-progress">âœ“</div>
            <div class="task-reward">+10 XP</div>
          </div>
          <div class="task-item">
            <div class="task-text">Ð—Ð±ÐµÑ€Ñ–Ñ‚ÑŒ 100 ÐºÑ€Ð¸ÑÑ‚Ð°Ð»Ñ–Ð²</div>
            <div class="task-progress">67/100</div>
            <div class="task-reward">+100 XP, 20 Ð·Ð¾Ð»Ð¾Ñ‚Ð°</div>
          </div>
        </div>
      </section>

      <!-- Rewards Page -->
      <section class="page" id="page-rewards">
        <div class="page-header">
          <button class="back-btn" data-page="home">â† ÐÐ°Ð·Ð°Ð´</button>
          <h2 class="page-title">Ð”Ñ–Ð°Ð¼Ð°Ð½Ñ‚Ð¾Ð²Ñ– Ð½Ð°Ð³Ð¾Ñ€Ð¾Ð´Ð¸</h2>
        </div>
        <div class="page-content">
          <div class="reward-item available">
            <div class="reward-icon">ðŸ’Ž</div>
            <div class="reward-text">Ð©Ð¾Ð´ÐµÐ½Ð½Ð° Ð½Ð°Ð³Ð¾Ñ€Ð¾Ð´Ð°</div>
            <button class="claim-btn">ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸</button>
          </div>
          <div class="reward-item locked">
            <div class="reward-icon">ðŸ†</div>
            <div class="reward-text">Ð”Ð¾ÑÑÐ³Ð½ÐµÐ½Ð½Ñ: 10 Ð¿ÐµÑ€ÐµÐ¼Ð¾Ð³</div>
            <div class="reward-progress">8/10</div>
          </div>
          <div class="reward-item locked">
            <div class="reward-icon">â­</div>
            <div class="reward-text">Ð Ð°Ð½Ð³Ð¾Ð²Ð° Ð½Ð°Ð³Ð¾Ñ€Ð¾Ð´Ð°</div>
            <div class="reward-progress">Ð¡Ñ€Ñ–Ð±Ð»Ð¾ II Ð¿Ð¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾</div>
          </div>
        </div>
      </section>

      

      <!-- Collections Page -->
      <section class="page" id="page-collections">
        <div class="page-header">
          <button class="back-btn" data-page="home">â† ÐÐ°Ð·Ð°Ð´</button>
          <h2 class="page-title">ÐšÐ¾Ð»ÐµÐºÑ†Ñ–Ñ—</h2>
        </div>
        <div class="page-content">
          <div class="collection-set">
            <div class="collection-set" id="fire-set">
              <div class="set-name">Ð’Ð¾Ð³Ð½ÑÐ½Ð° ÑÑ‚Ð¸Ñ…Ñ–Ñ</div>
              <div class="set-progress" id="fire-progress">0/4 ÐºÐ°Ñ€Ñ‚</div>
              <div class="set-bonus">+10% Ð´Ð¾ Ð²Ð¾Ð³Ð½ÑÐ½Ð¾Ñ— ÑˆÐºÐ¾Ð´Ð¸</div>
              <div class="collection-grid" id="fire-collection"></div>
            </div>
            <div class="collection-set" id="water-set">
              <div class="set-name">Ð’Ð¾Ð´ÑÐ½Ð° ÑÑ‚Ð¸Ñ…Ñ–Ñ</div>
              <div class="set-progress" id="water-progress">0/4 ÐºÐ°Ñ€Ñ‚</div>
              <div class="set-bonus">+10% Ð´Ð¾ Ð²Ð¾Ð´ÑÐ½Ð¾Ñ— ÑˆÐºÐ¾Ð´Ð¸</div>
              <div class="collection-grid" id="water-collection"></div>
            </div>
            <div class="collection-set" id="air-set">
              <div class="set-name">ÐŸÐ¾Ð²Ñ–Ñ‚Ñ€ÑÐ½Ð° ÑÑ‚Ð¸Ñ…Ñ–Ñ</div>
              <div class="set-progress" id="air-progress">0/4 ÐºÐ°Ñ€Ñ‚</div>
              <div class="set-bonus">+10% Ð´Ð¾ Ð¿Ð¾Ð²Ñ–Ñ‚Ñ€ÑÐ½Ð¾Ñ— ÑˆÐºÐ¾Ð´Ð¸</div>
              <div class="collection-grid" id="air-collection"></div>
            </div>
            <div class="collection-set" id="earth-set">
              <div class="set-name">Ð—ÐµÐ¼Ð»ÑÐ½Ð° ÑÑ‚Ð¸Ñ…Ñ–Ñ</div>
              <div class="set-progress" id="earth-progress">0/4 ÐºÐ°Ñ€Ñ‚</div>
              <div class="set-bonus">+10% Ð´Ð¾ Ð·ÐµÐ¼Ð»ÑÐ½Ð¾Ñ— ÑˆÐºÐ¾Ð´Ð¸</div>
              <div class="collection-grid" id="earth-collection"></div>
            </div>
        </div>
      </section>

      <!-- Card Details Page -->
      <section class="page" id="page-card-details">
        <div class="page-header">
          <button class="back-btn" id="card-details-back">â† ÐÐ°Ð·Ð°Ð´</button>
          <h2 class="page-title">Ð”ÐµÑ‚Ð°Ð»Ñ– ÐºÐ°Ñ€Ñ‚Ð¸</h2>
        </div>
        <div class="page-content">
          <!-- Main Card Display -->
          <div class="card-main-display panel" id="card-main-info">
            <!-- Ð ÐµÐ½Ð´ÐµÑ€Ð¸Ð¼Ð¾ Ñ‡ÐµÑ€ÐµÐ· JavaScript -->
          </div>

          <!-- Card Upgrade Scale (Ð½Ð¾Ð²Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð° XP) -->
          <div class="card-upgrade" id="card-upgrade-section">
            <div class="upgrade-header">
              <span id="cu-level">LV 1</span>
              <span id="cu-xp-text">0 / 20 XP</span>
            </div>
            <div class="xp-bar">
              <div class="xp-fill" id="cu-xp-fill"></div>
            </div>
            
          </div>

          <!-- Comparison Section -->
          <div class="card-comparison">
            <h3 class="comparison-title" id="weaker-cards-header">ðŸ“Š Ð¡Ð»Ð°Ð±ÑˆÑ– ÐºÐ°Ñ€Ñ‚Ð¸ Ñ‚Ñ–Ñ”Ñ— Ð¶ ÑÑ‚Ð¸Ñ…Ñ–Ñ—</h3>
            <div id="weaker-cards-list" class="weaker-cards">
              <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐ»Ð°Ð±ÑˆÐ¸Ñ… ÐºÐ°Ñ€Ñ‚ -->
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="card-actions">
            
            <button id="card-add-to-deck-btn" class="action-btn add-btn">Ð”Ð¾Ð´Ð°Ñ‚Ð¸ Ð² ÐºÐ¾Ð»Ð¾Ð´Ñƒ</button>
            <button id="card-remove-btn" class="action-btn remove-btn">Ð’Ð¸Ð´Ð°Ð»Ð¸Ñ‚Ð¸</button>
          </div>
        </div>
      </section>

      <!-- Shop Page -->
      <section class="page" id="page-shop">
        <div class="page-header">
          <button class="back-btn" data-page="home">â† ÐÐ°Ð·Ð°Ð´</button>
          <h2 class="page-title">ÐœÐ°Ð³Ñ–Ñ‡Ð½Ñ– ÐšÐ°Ñ€Ñ‚Ð¸</h2>
        </div>
        <div class="page-content">
          
          <!-- Special Offers Section -->
          <div class="shop-section">
            <div class="shop-section-title">â­ ÐÐ°Ð±Ð¾Ñ€Ð¸ Ð¿Ð¾ Ð°ÐºÑ†Ñ–Ñ—!</div>
            <div class="shop-notice">
              ÐšÑƒÐ¿ÑƒÐ¹Ñ‚Ðµ Ð½Ð°Ð±Ð¾Ñ€Ð¸ Ð¿Ð¾ ÑÐ¿ÐµÑ†Ñ–Ð°Ð»ÑŒÐ½Ñ–Ð¹ Ñ†Ñ–Ð½Ñ–! Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ñ€Ð°Ð·!
            </div>
            <div id="offers-container">
              <!-- Special offers will be rendered here -->
            </div>
          </div>

          <!-- Single Cards Section -->
          <div class="shop-section">
            <div class="shop-section-title">ðŸƒ ÐŸÐ¾ Ð¾Ð´Ð½Ñ–Ð¹ ÐºÐ°Ñ€Ñ‚Ñ–</div>
            <div id="single-cards-container">
              <!-- Single card offers will be rendered here -->
            </div>
          </div>

        </div>
      </section>

      <!-- Pack Opening Modal -->
      <div class="pack-modal" id="pack-modal">
        <div class="pack-modal-content">
          <div class="pack-modal-header">
            <div class="pack-modal-title">Ð’Ð¸ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð»Ð¸:</div>
            <div class="pack-modal-subtitle">ÐšÐ°Ñ€Ñ‚Ð¸ Ð´Ð¾Ð´Ð°Ð½Ð¾ Ð² ÐºÐ¾Ð»ÐµÐºÑ†Ñ–ÑŽ</div>
          </div>
          <div class="pack-rewards" id="pack-rewards">
            <!-- Rewards will be rendered here -->
          </div>
          <button class="pack-modal-btn" id="pack-modal-close">ÐŸÑ€Ð¸Ð¹Ð½ÑÑ‚Ð¸</button>
        </div>
      </div>

      <!-- Duel Result Modal -->
      <div class="pack-modal" id="duel-result-modal">
        <div class="pack-modal-content">
          <div class="pack-modal-header">
            <div class="pack-modal-title" id="duel-result-title">ÐŸÐµÑ€ÐµÐ¼Ð¾Ð³Ð°!</div>
            <div class="pack-modal-subtitle" id="duel-result-subtitle">Ð’Ð¸ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð»Ð¸:</div>
          </div>
          <div class="duel-result-rewards" id="duel-result-rewards">
            <!-- Rewards displayed here -->
          </div>
          <div class="duel-result-stats-info">
            <div class="duel-wins-info" id="duel-wins-info">ÐŸÐ¾Ð±Ñ–Ð´ Ð² Ð´ÑƒÐµÐ»ÑÑ…: ðŸ† 0</div>
          </div>
          <button class="pack-modal-btn duel-next-btn" id="duel-result-close">Ð©Ðµ Ð´ÑƒÐµÐ»ÑŒ</button>
          <div class="duel-battle-summary">
            <div class="duel-summary-title">ÐŸÑ–Ð´ÑÑƒÐ¼ÐºÐ¸ Ð±Ð¾ÑŽ</div>
            <div class="duel-summary-hp">
              <span>â™¥ <span id="duel-summary-player-hp">0</span></span>
            </div>
            <div class="duel-battle-cards" id="duel-battle-cards">
              <!-- Battle cards summary -->
            </div>
          </div>
        </div>
      </div>

      <!-- Pre-duel modal -->
      <div class="pack-modal" id="duel-pre-modal">
        <div class="pack-modal-content" style="max-width:460px; text-align:center;">
          <div class="pack-modal-header">
            <div class="pack-modal-title">Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ ÑÑƒÐ¿ÐµÑ€Ð½Ð¸ÐºÐ°</div>
            <div class="pack-modal-subtitle">ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ ÑÐ¸Ð»Ñƒ ÐºÐ¾Ð»Ð¾Ð´ Ñ– Ð½Ð°Ñ‚Ð¸ÑÐ½Ð¸ Â«ÐÐ°Ð¿Ð°ÑÑ‚Ð¸Â»</div>
          </div>
          <div class="preduel-body">
            <div class="preduel-row">
              <div class="preduel-label">Ð¡ÑƒÐ¿ÐµÑ€Ð½Ð¸Ðº</div>
              <div class="preduel-value" id="duel-pre-name">â€”</div>
            </div>
            <div class="preduel-row">
              <div class="preduel-label">Ð¡Ð¸Ð»Ð° Ð²Ð¾Ñ€Ð¾Ð³Ð°</div>
              <div class="preduel-value" id="duel-pre-power">0</div>
            </div>
            <div class="preduel-row">
              <div class="preduel-label">Ð¢Ð²Ð¾Ñ ÑÐ¸Ð»Ð°</div>
              <div class="preduel-value" id="duel-pre-player-power">0</div>
            </div>
          </div>
          <div class="preduel-actions">
            <button class="pack-modal-btn" id="duel-pre-attack">ÐÐ°Ð¿Ð°ÑÑ‚Ð¸</button>
            <button class="pack-modal-btn secondary" id="duel-pre-reroll">Ð¨ÑƒÐºÐ°Ñ‚Ð¸ Ñ‰Ðµ</button>
          </div>
        </div>
      </div>

      <!-- Buy Gold Page -->
      <section class="page" id="page-buy-gold">
        <div class="page-header">
          <button class="back-btn" data-page="home">â† ÐÐ°Ð·Ð°Ð´</button>
          <h2 class="page-title">ÐšÑƒÐ¿Ð¸Ñ‚Ð¸ Ð·Ð¾Ð»Ð¾Ñ‚Ð¾</h2>
        </div>
        <div class="page-content">
          <div class="gold-pack">
            <div class="pack-amount">100 Ð·Ð¾Ð»Ð¾Ñ‚Ð°</div>
            <div class="pack-price">50 ÐºÑ€Ð¸ÑÑ‚Ð°Ð»Ñ–Ð²</div>
            <button class="exchange-btn">ÐžÐ±Ð¼Ñ–Ð½ÑÑ‚Ð¸</button>
          </div>
          <div class="gold-pack featured">
            <div class="pack-badge">ÐÐºÑ†Ñ–Ñ</div>
            <div class="pack-amount">500 Ð·Ð¾Ð»Ð¾Ñ‚Ð°</div>
            <div class="pack-price">200 ÐºÑ€Ð¸ÑÑ‚Ð°Ð»Ñ–Ð²</div>
            <div class="pack-bonus">+50 Ð±Ð¾Ð½ÑƒÑ</div>
            <button class="exchange-btn">ÐžÐ±Ð¼Ñ–Ð½ÑÑ‚Ð¸</button>
          </div>
          <div class="gold-pack">
            <div class="pack-amount">1000 Ð·Ð¾Ð»Ð¾Ñ‚Ð°</div>
            <div class="pack-price">350 ÐºÑ€Ð¸ÑÑ‚Ð°Ð»Ñ–Ð²</div>
            <button class="exchange-btn">ÐžÐ±Ð¼Ñ–Ð½ÑÑ‚Ð¸</button>
          </div>
        </div>
      </section>

      <!-- Profile Page -->
      <section class="page" id="page-profile">
        <div class="page-header">
          <h2 class="page-title">ÐŸÑ€Ð¾Ñ„Ñ–Ð»ÑŒ</h2>
        </div>
        <div class="page-content">
          <div class="profile-stat">
            <div class="stat-label">Ð Ñ–Ð²ÐµÐ½ÑŒ</div>
            <div class="stat-value" id="profile-level">1</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">Ð”Ð¾ÑÐ²Ñ–Ð´</div>
            <div class="stat-value" id="profile-xp">0/100</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">ÐŸÐµÑ€ÐµÐ¼Ð¾Ð³</div>
            <div class="stat-value" id="profile-wins">0</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">ÐŸÐ¾Ñ€Ð°Ð·Ð¾Ðº</div>
            <div class="stat-value" id="profile-losses">0</div>
          </div>
          <div class="profile-stat">
            <div class="stat-label">Ð†Ð³Ð¾Ñ€ Ð·Ñ–Ð³Ñ€Ð°Ð½Ð¾</div>
            <div class="stat-value" id="profile-games">0</div>
          </div>
          <button class="action-btn logout-btn">Ð’Ð¸Ð¹Ñ‚Ð¸ Ð· Ð°ÐºÐ°ÑƒÐ½Ñ‚Ñƒ</button>
        </div>
      </section>

      <!-- Guild Page -->
      <section class="page" id="page-guild">
        <div class="page-header">
          <h2 class="page-title">Ð“Ñ–Ð»ÑŒÐ´Ñ–Ñ</h2>
        </div>
        <div class="page-content">
          <div class="guild-status">
            <div class="status-text">Ð’Ð¸ Ð½Ðµ Ð² Ð³Ñ–Ð»ÑŒÐ´Ñ–Ñ—</div>
          </div>
          <button class="action-btn">Ð¡Ñ‚Ð²Ð¾Ñ€Ð¸Ñ‚Ð¸ Ð³Ñ–Ð»ÑŒÐ´Ñ–ÑŽ</button>
          <button class="action-btn secondary">Ð—Ð½Ð°Ð¹Ñ‚Ð¸ Ð³Ñ–Ð»ÑŒÐ´Ñ–ÑŽ</button>
          <div class="description">
            ÐŸÑ€Ð¸Ñ”Ð´Ð½Ð°Ð¹Ñ‚ÐµÑÑ Ð´Ð¾ Ð³Ñ–Ð»ÑŒÐ´Ñ–Ñ—, Ñ‰Ð¾Ð± ÑÐ¿Ñ–Ð²Ð¿Ñ€Ð°Ñ†ÑŽÐ²Ð°Ñ‚Ð¸ Ð· Ñ–Ð½ÑˆÐ¸Ð¼Ð¸ Ð³Ñ€Ð°Ð²Ñ†ÑÐ¼Ð¸, Ð±Ñ€Ð°Ñ‚Ð¸ ÑƒÑ‡Ð°ÑÑ‚ÑŒ Ñƒ Ð³Ñ–Ð»ÑŒÐ´Ñ–Ð¹ÑÑŒÐºÐ¸Ñ… Ð¿Ð¾Ð´Ñ–ÑÑ… Ñ‚Ð° Ð¾Ñ‚Ñ€Ð¸Ð¼ÑƒÐ²Ð°Ñ‚Ð¸ Ð¾ÑÐ¾Ð±Ð»Ð¸Ð²Ñ– Ð±Ð¾Ð½ÑƒÑÐ¸.
          </div>
        </div>
      </section>

    </div>

    <nav class="bottom" aria-label="ÐÐ°Ð²Ñ–Ð³Ð°Ñ†Ñ–Ñ">
      <div class="navbtn active" id="nav-home" data-tab="home">
        <div class="ico" aria-hidden="true"></div>
        <div class="t">Ð“Ð¾Ð»Ð¾Ð²Ð½Ð°</div>
      </div>
      <div class="navbtn" id="nav-profile" data-tab="profile">
        <div class="ico" aria-hidden="true"></div>
        <div class="t">ÐŸÑ€Ð¾Ñ„Ñ–Ð»ÑŒ</div>
      </div>
      <div class="navbtn" id="nav-guild" data-tab="guild">
        <div class="ico" aria-hidden="true"></div>
        <div class="t">Ð“Ñ–Ð»ÑŒÐ´Ñ–Ñ</div>
      </div>
    </nav>
  </div>

  <!-- Card System Scripts -->
  <script src="js/data/cards.js"></script>
  <script src="js/game/power.js"></script>
  <script src="js/game/drop.js"></script>
  <script src="js/data/cards_index.js"></script>
  <script src="js/game/currencies.js"></script>
  <script src="card-renderer.js"></script>
  <!-- Duel Engine Scripts -->
  <script src="js/game/elements.js"></script>

  <script src="js/game/duel_runtime.js"></script>
  <!-- CardView global for modal rendering -->
  <script src="js/ui/components/CardView.global.js"></script>

  <script>
    // Initialize CardRenderer
    window.addEventListener('DOMContentLoaded', () => {
      window.cardRenderer = new CardRenderer();
      console.log('CardRenderer initialized');
    });
    
    // Ð”ÐµÐ»ÐµÐ³Ð¾Ð²Ð°Ð½Ð¸Ð¹ Ð¿Ð°Ñ€Ð°Ð»Ð°ÐºÑ ÐµÑ„ÐµÐºÑ‚ Ð´Ð»Ñ Ð²ÑÑ–Ñ… ÐºÐ°Ñ€Ñ‚
    function initCardParallax() {
      document.addEventListener('mousemove', (e) => {
        const card = e.target.closest('.sp-card');
        if (!card) return;
        
        // ÐÐµ Ð·Ð°ÑÑ‚Ð¾ÑÐ¾Ð²ÑƒÑ”Ð¼Ð¾ Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ñƒ, ÑÐºÑ‰Ð¾ Ð²Ð¾Ð½Ð° Ð½Ðµ Ð² :hover
        // Ñ†Ðµ Ð·Ð°Ð¿Ð¾Ð±Ñ–Ð³Ð°Ñ” ÐºÐ¾Ð½Ñ„Ð»Ñ–ÐºÑ‚Ð°Ð¼ Ð· Ð¿Ð¾Ð·Ð¸Ñ†Ñ–ÑŽÐ²Ð°Ð½Ð½ÑÐ¼ Ð´Ñ–Ñ‚ÐµÐ¹
        if (!card.matches(':hover')) {
          return;
        }

        const rect = card.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;

        const x = (e.clientX - centerX) / 50;
        const y = (e.clientY - centerY) / 50;

        // Ð—Ð°ÑÑ‚Ð¾ÑÐ¾Ð²ÑƒÑ”Ð¼Ð¾ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð±Ð°Ð·Ð¾Ð²Ñ– Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ—, ÑÐºÑ– Ð½Ðµ ÐºÐ¾Ð½Ñ„Ð»Ñ–ÐºÑ‚ÑƒÑŽÑ‚ÑŒ Ð· Ð´Ñ–Ñ‚ÑŒÐ¼Ð¸
        card.style.transform = `perspective(1000px) rotateX(${5 - y}deg) rotateY(${-2 + x}deg)`;
      });

      // Ð¡ÐºÐ¸Ð´Ð°Ð½Ð½Ñ Ñ‚Ñ€Ð°Ð½ÑÑ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ— Ð¿Ñ€Ð¸ Ð²Ð¸Ñ…Ð¾Ð´Ñ–
      document.addEventListener('mouseleave', (e) => {
        const card = e.target.closest?.('.sp-card');
        if (card) {
          card.style.transform = '';
        }
      }, true);
    }
    
    // Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÑ”Ð¼Ð¾ Ð¿Ð°Ñ€Ð°Ð»Ð°ÐºÑ Ð¿Ñ–ÑÐ»Ñ DOMContentLoaded
    window.addEventListener('DOMContentLoaded', () => {
      initCardParallax();
    });

    // LocalStorage management
    const storage = {
      get(key, defaultValue = null) {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : defaultValue;
        } catch (error) {
          console.error(`Error reading localStorage (${key}):`, error);
          return defaultValue;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
          return true;
        } catch (error) {
          console.error(`Error writing localStorage (${key}):`, error);
          return false;
        }
      }
    };

    // Helper: update full HUD XP bar + text
    function updateHudXP(currentXP, maxXP) {
      const pctNum = (maxXP && maxXP > 0) ? Math.max(0, Math.min(1, currentXP / maxXP)) : 0;
      const pctText = Math.round(pctNum * 100);

      // Preferred: new row-based HUD using transform: scaleX
      const xpFillEl = document.getElementById('xpFill');
      const xpPctEl = document.getElementById('xpPct');
      try {
        if (!xpFillEl) console.warn('HUD XP: #xpFill not found');
        if (!xpPctEl) console.warn('HUD XP: #xpPct not found');
        if (xpFillEl) {
          xpFillEl.style.transform = `scaleX(${pctNum})`;
          xpFillEl.style.transformOrigin = 'left center';
        }
        if (xpPctEl) {
          xpPctEl.textContent = `${pctText}% (${currentXP} / ${maxXP})`;
        }

        // Fallback: legacy hud-xp element (width-based)
        const legacyFill = document.querySelector('.hud-xp .xp-fill');
        const legacyText = document.querySelector('.hud-xp-text');
        if (legacyFill) legacyFill.style.width = pctText + '%';
        if (legacyText && !xpPctEl) legacyText.textContent = `${pctText}% (${currentXP} / ${maxXP})`;
      } catch (e) {
        console.warn('updateHudXP error', e);
      }
    }

    // expose to global for console/debugging
    try { window.updateHudXP = updateHudXP; } catch (e) { /* ignore */ }

    // User profile management
    const userProfile = {
      STORAGE_KEY: 'elem_user_profile',
      USERS_KEY: 'elem_users',
      
      // Get all registered users
      getAllUsers() {
        return storage.get(this.USERS_KEY, {});
      },
      
      // Save all users
      saveAllUsers(users) {
        return storage.set(this.USERS_KEY, users);
      },
      
      // Check if username exists
      userExists(username) {
        const users = this.getAllUsers();
        return users.hasOwnProperty(username);
      },
      
      // Register new user
      registerUser(username) {
        if (this.userExists(username)) {
          return { success: false, error: 'Ð¦Ðµ Ñ–Ð¼\'Ñ Ð²Ð¶Ðµ Ð·Ð°Ð¹Ð½ÑÑ‚Ðµ' };
        }
        
        if (username.length < 3) {
          return { success: false, error: 'Ð†Ð¼\'Ñ Ð¼Ð°Ñ” Ð±ÑƒÑ‚Ð¸ Ð½Ðµ Ð¼ÐµÐ½ÑˆÐµ 3 ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ–Ð²' };
        }
        
        // Generate random 16 starter cards (4 per element)
        const starterIds = (window.getRandomStarterCardIds && window.getRandomStarterCardIds(16))
          || (window.getStarterCardIds && window.getStarterCardIds())
          || [];

        // Fallback to any cards if starters unavailable
        const pool = starterIds.length ? starterIds : (window.ALL_CARDS || []).map(c => c.id);

        // Shuffle ids
        const shuffled = [...pool];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }

        const selectedIds = shuffled.slice(0, 16);
        const selectedCards = selectedIds
          .map(id => (window.getCardById ? window.getCardById(id) : null))
          .filter(Boolean);
        
        // First 9 go to deck, rest go to collection
        const deckCards = selectedCards.slice(0, 9).map(card => ({
          id: card.id,
          level: 1
        }));
        const collectionCards = selectedCards.slice(9, 16).map(card => ({
          id: card.id,
          level: 1
        }));
        
        // Initialize progress (XP) for each card
        const progress = {};
        selectedCards.forEach(card => {
          progress[card.id] = { level: 1, xp: 0 };
        });
        
        // Initialize inventory: count of each card
        const inventory = {};
        selectedCards.forEach(card => {
          inventory[card.id] = (inventory[card.id] || 0) + 1;
        });
        
        const users = this.getAllUsers();
        users[username] = {
          name: username,
          level: 1,
          xp: 0,
          bolts: 500,         // Ð‘Ð¾Ð»Ñ‚Ð¸ ðŸ”© (Ð±Ð°Ð·Ð¾Ð²Ð° Ð²Ð°Ð»ÑŽÑ‚Ð°)
          gears: 0,           // Ð¨ÐµÑÑ‚ÐµÑ€Ð½Ñ– âš™ï¸ (ÑÐµÑ€ÐµÐ´Ð½Ñ Ð²Ð°Ð»ÑŽÑ‚Ð°)
          cores: 0,           // ÐŸÐ°Ñ€Ð¾Ð²Ñ– ÑÐ´Ñ€Ð° âœ´ï¸Ž (Ð¿Ñ€ÐµÐ¼Ñ–ÑƒÐ¼ Ð²Ð°Ð»ÑŽÑ‚Ð°)
          wins: 0,
          losses: 0,
          gamesPlayed: 0,
          createdAt: Date.now(),
          deckCards: deckCards,
          collectionCards: collectionCards,
          progress: progress,    // XP Ð´Ð»Ñ ÐºÐ¾Ð¶Ð½Ð¾Ñ— ÐºÐ°Ñ€Ñ‚Ð¸
          inventory: inventory   // ÐºÑ–Ð»ÑŒÐºÑ–ÑÑ‚ÑŒ ÐºÐ¾Ð¿Ñ–Ð¹
        };
        
        this.saveAllUsers(users);
        return { success: true, profile: users[username] };
      },
      
      // Login user
      loginUser(username) {
        if (!this.userExists(username)) {
          return { success: false, error: 'ÐšÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð° Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾' };
        }
        
        const users = this.getAllUsers();
        const profile = users[username];
        storage.set(this.STORAGE_KEY, profile);
        return { success: true, profile: profile };
      },
      
      // Get current logged in profile
      getCurrentUser() {
        return storage.get(this.STORAGE_KEY);
      },
      
      // Check if user is logged in
      isLoggedIn() {
        return this.getCurrentUser() !== null;
      },
      
      // Logout
      logout() {
        storage.set('currentUser', null);
        localStorage.removeItem(this.STORAGE_KEY);
      },
      
      // Update current user profile
      updateCurrentUser(updates) {
        const profile = this.getCurrentUser();
        if (!profile) return false;
        
        Object.assign(profile, updates);
        storage.set(this.STORAGE_KEY, profile);
        
        // Also update in users list
        const users = this.getAllUsers();
        if (users[profile.name]) {
          users[profile.name] = profile;
          this.saveAllUsers(users);
        }
        
        return profile;
      },
      
      getProfile() {
        return this.getCurrentUser();
      },
      
      saveProfile(profile) {
        return this.updateCurrentUser(profile);
      },

      autoAddToDeck(profile, cardEntry) {
        if (!profile || !cardEntry) {
          return { added: false, replaced: false, replacedPower: null };
        }

        if (!profile.deckCards) profile.deckCards = [];

        const cardObj = window.getCardById && window.getCardById(cardEntry.id);
        const cardPower = window.getPower
          ? window.getPower(cardObj, cardEntry.level || 1)
          : (cardObj ? cardObj.basePower : 0);

        if (profile.deckCards.length < 9) {
          profile.deckCards.push(cardEntry);
          return { added: true, replaced: false, replacedPower: null };
        }

        let weakestIdx = -1;
        let weakestPower = Infinity;

        profile.deckCards.forEach((dc, idx) => {
          const dcObj = window.getCardById && window.getCardById(dc.id);
          const pwr = window.getPower
            ? window.getPower(dcObj, dc.level || 1)
            : (dcObj ? dcObj.basePower : 0);

          if (pwr < weakestPower) {
            weakestPower = pwr;
            weakestIdx = idx;
          }
        });

        if (weakestIdx >= 0 && cardPower > weakestPower) {
          profile.deckCards[weakestIdx] = cardEntry;
          return { added: false, replaced: true, replacedPower: weakestPower };
        }

        return { added: false, replaced: false, replacedPower: weakestPower };
      },
      
      // Compact number formatter: 1500 -> 1.5k
      formatCompact(number) {
        const n = Number(number) || 0;
        const abs = Math.abs(n);
        if (abs < 1000) return String(n);
        let v = n / 1000;
        if (Math.abs(v) >= 10) v = Math.round(v);
        else v = Math.round(v * 10) / 10;
        return `${v}k`;
      },

      updateUI() {
        const profile = this.getCurrentUser();
        if (!profile) return;
        
        // Update level
        const levelSpan = document.querySelector('.level span');
        if (levelSpan) {
          levelSpan.textContent = profile.level;
        }
        
        // Update currencies on HOME PAGE
        const homeBolts = document.getElementById('home-bolts');
        const homeGears = document.getElementById('home-gears');
        const homeCores = document.getElementById('home-cores');
        
        if (homeBolts) homeBolts.textContent = this.formatCompact(profile.bolts || 0);
        if (homeGears) homeGears.textContent = this.formatCompact(profile.gears || 0);
        if (homeCores) homeCores.textContent = this.formatCompact(profile.cores || 0);
        
        // Update currencies on DECK PAGE
        const boltVal = document.getElementById('deck-bolts');
        const gearVal = document.getElementById('deck-gears');
        const coreVal = document.getElementById('deck-cores');
        
        if (boltVal) boltVal.textContent = this.formatCompact(profile.bolts || 0);
        if (gearVal) gearVal.textContent = this.formatCompact(profile.gears || 0);
        if (coreVal) coreVal.textContent = this.formatCompact(profile.cores || 0);
        
        // Update thin HUD XP line (fill only)
        const xpFill = document.querySelector('.hud-xpfill');
        if (!xpFill) console.warn('HUD XP: .hud-xpfill not found');

        const xp = (profile && profile.xp) ? profile.xp : 0;
        const need = (typeof navigation !== 'undefined' && navigation.xpNeededForLevel) ? navigation.xpNeededForLevel(profile.level || 1) : 0;
        const percent = need > 0 ? Math.min(100, Math.round((xp / need) * 100)) : 0;

        if (xpFill) xpFill.style.width = percent + '%';

        // Update full HUD XP bar + text
        try {
          if (typeof updateHudXP === 'function') updateHudXP(xp, need);
        } catch (e) {
          console.warn('updateHudXP failed', e);
        }
        
        // Update deck power on home screen (use actual progress levels)
        if (profile.deckCards && profile.deckCards.length > 0) {
          let totalPower = 0;
          profile.deckCards.forEach(dc => {
            const card = window.getCardById && window.getCardById(dc.id);
            if (card) {
              const prog = window.getProgress ? window.getProgress(profile, dc.id) : { level: dc.level || 1, xp: 0 };
              const level = (prog && prog.level) ? prog.level : (dc.level || 1);
              const power = window.getPower ? window.getPower(card, level) : (typeof getPower === 'function' ? getPower(card, level) : 0);
              totalPower += power || 0;
            }
          });
          const deckPowerHome = document.getElementById('deck-power-home');
          if (deckPowerHome) {
            deckPowerHome.textContent = totalPower;
          }
        }
        
        // Update username in portrait
        const portrait = document.querySelector('.portrait');
        if (portrait) {
          portrait.title = profile.name;
        }
      }
    };

    // Auth UI management
    const authUI = {
      overlay: null,
      
      init() {
        this.overlay = document.getElementById('authOverlay');
        
        // Tab switching
        document.querySelectorAll('.auth-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            this.switchTab(tabName);
          });
        });
        
        // Login form
        document.getElementById('loginForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleLogin();
        });
        
        // Register form
        document.getElementById('registerForm').addEventListener('submit', (e) => {
          e.preventDefault();
          this.handleRegister();
        });
        
        // Check if already logged in
        if (userProfile.isLoggedIn()) {
          this.hideAuth();
        } else {
          this.showAuth();
        }
      },
      
      switchTab(tabName) {
        // Update tabs
        document.querySelectorAll('.auth-tab').forEach(t => {
          t.classList.toggle('active', t.dataset.tab === tabName);
        });
        
        // Update forms
        document.querySelectorAll('.auth-form').forEach(f => {
          f.classList.toggle('active', f.id === tabName + 'Form');
        });
        
        // Clear errors
        this.hideError('login');
        this.hideError('register');
      },
      
      handleLogin() {
        const username = document.getElementById('loginUsername').value.trim();
        
        if (!username) {
          this.showError('login', 'Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ñ–Ð¼\'Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°');
          return;
        }
        
        const result = userProfile.loginUser(username);
        
        if (result.success) {
          console.log('Login successful:', result.profile);
          this.hideAuth();
          userProfile.updateUI();
        } else {
          this.showError('login', result.error);
        }
      },
      
      handleRegister() {
        const username = document.getElementById('registerUsername').value.trim();
        
        if (!username) {
          this.showError('register', 'Ð’Ð²ÐµÐ´Ñ–Ñ‚ÑŒ Ñ–Ð¼\'Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°');
          return;
        }
        
        const result = userProfile.registerUser(username);
        
        if (result.success) {
          console.log('Registration successful:', result.profile);
          // Auto-login after registration
          userProfile.loginUser(username);
          this.hideAuth();
          userProfile.updateUI();
        } else {
          this.showError('register', result.error);
        }
      },
      
      showError(formType, message) {
        const errorEl = document.getElementById(formType + 'Error');
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.classList.add('show');
        }
      },
      
      hideError(formType) {
        const errorEl = document.getElementById(formType + 'Error');
        if (errorEl) {
          errorEl.classList.remove('show');
        }
      },
      
      showAuth() {
        if (this.overlay) {
          this.overlay.style.display = 'flex';
          setTimeout(() => {
            this.overlay.classList.remove('hidden');
          }, 10);
        }
      },
      
      hideAuth() {
        if (this.overlay) {
          this.overlay.classList.add('hidden');
        }
      }
    };

    // Page navigation system
    const navigation = {
        // ========== BAG SYSTEM ========== 
        loadBagCards() {
          const profile = userProfile.getProfile();
          if (!profile) return;
          // Ð’ ÑÑƒÐ¼Ñ†Ñ– â€” Ð»Ð¸ÑˆÐµ Ñ‚Ñ– ÐºÐ°Ñ€Ñ‚Ð¸ Ð· collectionCards, ÑÐºÐ¸Ñ… Ð½ÐµÐ¼Ð°Ñ” Ð² deckCards
          let deckIds = new Set((profile.deckCards || []).map(c => c.id));
          const bagCards = (profile.collectionCards || []).filter(c => !deckIds.has(c.id));
          const container = document.getElementById('bag-cards-list');
          if (!container) return;
          if (bagCards.length === 0) {
            container.innerHTML = '<div class="no-bag-cards">ÐÐµÐ¼Ð°Ñ” ÐºÐ°Ñ€Ñ‚ Ñƒ ÑÑƒÐ¼Ñ†Ñ–</div>';
            return;
          }
          const elementEmojis = {
            fire: 'ðŸ”¥',
            water: 'ðŸ’§',
            air: 'â™¨ï¸',
            earth: 'ðŸƒ'
          };
          container.innerHTML = bagCards.map(card => {
            const cardData = getCardById(card.id);
            if (!cardData) return '';
            const emoji = elementEmojis[cardData.element] || 'âš™';
            return `
              <div class="bag-card-item" data-card-id="${card.id}">
                <span class="bag-card-emoji">${emoji}</span>
                <span class="bag-card-name">${cardData.name}</span>
                <span class="bag-card-status">Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾</span>
              </div>
            `;
          }).join('');
        },
        // ========== END BAG SYSTEM ========== 
          // ÐžÑ‚Ñ€Ð¸Ð¼Ð°Ñ‚Ð¸ ÐºÐ°Ñ€Ñ‚Ð¸ Ð· ÑÑƒÐ¼ÐºÐ¸ (ÑÐºÑ– Ð½Ðµ Ð² ÐºÐ¾Ð»Ð¾Ð´Ñ–)
          getBagCards(profile) {
            if (!profile) return [];
            let deckIds = new Set((profile.deckCards || []).map(c => c.id));
            // ÐŸÐ¾Ð²ÐµÑ€Ñ‚Ð°Ñ”Ð¼Ð¾ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ñ‚Ñ– ÐºÐ°Ñ€Ñ‚Ð¸ Ð· collectionCards, ÑÐºÐ¸Ñ… Ð½ÐµÐ¼Ð°Ñ” Ð² deckCards
            return (profile.collectionCards || []).filter(c => !deckIds.has(c.id));
          },
      currentPage: 'home',
      
      showPage(pageId) {
        // Remove active class from all pages
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        
        // Add active class to target page
        const targetPage = document.getElementById(`page-${pageId}`);
        if (targetPage) {
          targetPage.classList.add('active');
          this.currentPage = pageId;
          
          // Update profile stats if on profile page
          if (pageId === 'profile') {
            this.updateProfilePage();
          }
          
          // Load deck cards if on deck page
          if (pageId === 'deck') {
            this.loadDeckCards();
          }
          
          // Load collection cards if on collections page
          if (pageId === 'collections') {
            this.loadCollectionCards();
          }
          
          // Load shop if on shop page
          if (pageId === 'shop') {
            this.loadShop();
          }

          // Initialize duels UI
          if (pageId === 'duels') {
            this.initDuelsPage();
          }
        }
      },
      
      updateProfilePage() {
        const profile = userProfile.getProfile();
        document.getElementById('profile-level').textContent = profile.level;
        const need = (typeof navigation !== 'undefined' && navigation.xpNeededForLevel) ? navigation.xpNeededForLevel(profile.level || 1) : 100;
        document.getElementById('profile-xp').textContent = `${profile.xp}/${need}`;
        document.getElementById('profile-wins').textContent = profile.wins;
        document.getElementById('profile-losses').textContent = profile.losses;
        document.getElementById('profile-games').textContent = profile.gamesPlayed;
      },

      

      // ========== UPGRADE SYSTEM ==========
      
      // Build inventory from deck + collection
      getInventory(profile) {
        const inventory = {};
        
        // Count cards from both deck and collection
        [...profile.deckCards, ...profile.collectionCards].forEach(userCard => {
          inventory[userCard.id] = (inventory[userCard.id] || 0) + 1;
        });
        
        return inventory;
      },

      // Get count of extra copies available for upgrade
      getExtraCopies(inventory, cardId) {
        const total = inventory[cardId] || 0;
        return Math.max(0, total - 1); // -1 because one copy is in deck
      },

      // Get cost to upgrade from current level to next
      getUpgradeCost(level) {
        return level; // lvl 1->2 costs 1, lvl 2->3 costs 2, etc
      },

      // Check if a deck card can be upgraded
      canUpgradeCard(deckItem, inventory) {
        const cost = this.getUpgradeCost(deckItem.level);
        const extra = this.getExtraCopies(inventory, deckItem.id);
        return extra >= cost;
      },

      // Check if deck has any upgradable cards
      hasAnyUpgradable(deck, inventory) {
        return deck.some(item => this.canUpgradeCard(item, inventory));
      },

      // Check if a target card can be guaranteed to level up by burning owned weaker cards
      canGuaranteedLevelByBurning(profile, targetCardId) {
        if (!profile || !targetCardId) return false;
        // get current progress
          const prog = window.getProgress ? window.getProgress(profile, targetCardId) : (profile.progress && profile.progress[targetCardId]) || { level: 1, xp: 0 };
        const need = window.xpNeed ? window.xpNeed(prog.level) : this.xpNeededForLevel(prog.level);
        const remaining = Math.max(0, need - (prog.xp || 0));
        if (remaining <= 0) return true;

        const targetCard = window.getCardById ? window.getCardById(targetCardId) : null;
        if (!targetCard) return false;

          const deckIds = new Set((profile.deckCards || []).map(d => d.id));
          // If target card is in deck, never show guarantee indicator
          if (deckIds.has(targetCardId)) return false;

        // Sum available XP from collection entries (excluding deck copies)
        let totalXp = 0;
        if (Array.isArray(profile.collectionCards)) {
          for (let i = 0; i < profile.collectionCards.length; i++) {
            const entry = profile.collectionCards[i];
            if (!entry || !entry.id) continue;
            if (entry.id === targetCardId) continue;
            if (deckIds.has(entry.id)) continue;
            const c = window.getCardById ? window.getCardById(entry.id) : null;
            if (!c || c.element !== targetCard.element) continue;
            const lvl = entry.level || 1;
            const gain = window.xpValue ? window.xpValue(lvl) : (c.basePower || 10);
            totalXp += gain;
            if (totalXp >= remaining) return true;
          }
        }

        // Sum available XP from inventory counters (assume level 1 for inventory entries)
        const inv = profile.inventory || {};
        for (const id in inv) {
          if (!Object.prototype.hasOwnProperty.call(inv, id)) continue;
          const count = inv[id] || 0;
          if (count <= 0) continue;
          if (id === targetCardId) continue;
          if (deckIds.has(id)) continue;
          const c = window.getCardById ? window.getCardById(id) : null;
          if (!c || c.element !== targetCard.element) continue;
          const gain = window.xpValue ? window.xpValue(1) : (c.basePower || 10);
          totalXp += gain * count;
          if (totalXp >= remaining) return true;
        }

        return false;
      },

      // Perform upgrade on a deck card
      performUpgrade(deckItem, inventory, profile) {
        const cost = this.getUpgradeCost(deckItem.level);
        const extra = this.getExtraCopies(inventory, deckItem.id);

        if (extra < cost) return false;

        // Remove used copies from collection
        let toRemove = cost;
        for (let i = profile.collectionCards.length - 1; i >= 0 && toRemove > 0; i--) {
          if (profile.collectionCards[i].id === deckItem.id) {
            profile.collectionCards.splice(i, 1);
            toRemove--;
          }
        }

        // Increase level
        deckItem.level += 1;

        // Save profile
        userProfile.updateCurrentUser(profile);

        return true;
      },

      // ========== END UPGRADE SYSTEM ==========

      // ========== SHOP SYSTEM ==========
      
      // Shop products catalog
      getShopProducts() {
        return {
          offers: [
            {
              sku: 'offer_elements',
              title: 'ÐšÐ¾Ð»ÐµÐºÑ†Ñ–Ñ ÐµÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð»Ñ–Ð²',
              description: 'Ð’ÑÑ– Ñ‡Ð¾Ñ‚Ð¸Ñ€Ð¸ ÐºÐ°Ñ€Ñ‚Ð¸ Ð· ÐºÐ¾Ð»ÐµÐºÑ†Ñ–Ñ— Â«Ð•Ð»ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð»Ñ–Â»',
              icon: 'ðŸ”¥',
              price: { currency: 'gears', amount: 20 },
              contents: { cards: 4 },
              limited: true
            }
          ],
          packs: [],
          singleCards: [
            {
              sku: 'card_legendary',
              title: 'Ð›ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð°',
              description: 'Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¾Ð²Ð°Ð½Ð° Ð»ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð°',
              icon: 'âš¡',
              price: { currency: 'gears', amount: 150 },
              contents: { cards: 1 },
              chance: { text: '40% ÑˆÐ°Ð½Ñ Ð¼Ñ–Ñ„Ñ–Ñ‡Ð½Ð¾Ñ—', class: '' }
            },
            {
              sku: 'card_epic',
              title: 'Ð•Ð¿Ñ–Ñ‡Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð°',
              description: 'Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¾Ð²Ð°Ð½Ð° ÐµÐ¿Ñ–Ñ‡Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð°',
              icon: 'ðŸ’œ',
              price: { currency: 'gears', amount: 50 },
              contents: { cards: 1 },
              chance: { text: '30% ÑˆÐ°Ð½Ñ Ð¼Ñ–Ñ„Ñ–Ñ‡Ð½Ð¾Ñ—', class: 'rare' }
            },
            {
              sku: 'card_uncommon',
              title: 'ÐÐµÐ·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð°',
              description: 'Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¾Ð²Ð°Ð½Ð° Ð½ÐµÐ·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð°',
              icon: 'ðŸ’š',
              price: { currency: 'bolts', amount: 500 },
              contents: { cards: 1 },
              chance: { text: '15% ÑˆÐ°Ð½Ñ ÐµÐ¿Ñ–Ñ‡Ð½Ð¾Ñ—', class: 'uncommon' }
            }
          ]
        };
      },

      loadShop() {
        const products = this.getShopProducts();
        this.renderNewShopItems('offers-container', products.offers, true);
        this.renderNewShopItems('single-cards-container', products.singleCards, false, true);
      },

      renderNewShopItems(containerId, items, isLimited = false, hasChance = false) {
        const container = document.getElementById(containerId);
        if (!container) {
          console.warn(`Container not found: ${containerId}`);
          return;
        }

        const profile = userProfile.getProfile();
        container.innerHTML = '';

        console.log(`Rendering ${items.length} items to ${containerId}`);

        items.forEach(item => {
          // Check if this is a one-time purchase that was already bought
          if (item.sku === 'offer_elements' && profile && profile.purchasedOffers && profile.purchasedOffers.includes('offer_elements')) {
            console.log(`Skipping already purchased: ${item.sku}`);
            return; // Skip rendering this item
          }

          const card = document.createElement('div');
          card.className = 'shop-item-card';

          const currencyEmojis = {
            bolts: 'ðŸ”©',
            gears: 'âš™ï¸',
            cores: 'âœ´ï¸Ž'
          };
          const currencyIcon = currencyEmojis[item.price.currency] || '?';
          
          const chanceHTML = hasChance && item.chance 
            ? `<div class="shop-item-chance ${item.chance.class}">${item.chance.text}</div>`
            : '';

          card.innerHTML = `
            <div class="shop-item-icon">${item.icon}</div>
            <div class="shop-item-content">
              <div class="shop-item-name">${item.title}</div>
              <div class="shop-item-desc">${item.description}</div>
              ${chanceHTML}
            </div>
            <div class="shop-item-action">
              <div class="shop-item-price">${currencyIcon} ${item.price.amount}</div>
              <button class="shop-buy-button" data-sku="${item.sku}">
                ÐšÑƒÐ¿Ð¸Ñ‚Ð¸
              </button>
            </div>
          `;

          container.appendChild(card);
        });

        // Add click handlers
        container.querySelectorAll('.shop-buy-button').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            const sku = btn.dataset.sku;
            console.log('Buying product:', sku);
            navigation.buyProduct(sku);
          });
        });
      },

      loadShopCards(elementFilter = 'all') {
        const profile = userProfile.getProfile();
        if (!profile) return;

        const container = document.getElementById('cards-container');
        if (!container) return;

        container.innerHTML = '';

        // Get all cards
        let allCards = window.ALL_CARDS || [];
        
        // Filter by element
        const filteredCards = elementFilter === 'all' 
          ? allCards 
          : allCards.filter(c => c.element === elementFilter);

        // Display cards with prices (use cardRenderer/createCardView if available)
        filteredCards.forEach(card => {
          const cardDiv = document.createElement('div');
          cardDiv.className = 'product-card';

          const displayPower = window.getPower ? window.getPower(card, 1) : (card.basePower || card.power || 0);
          // Price based on rarity/power
          const prices = {
            gears: Math.max(1, Math.ceil(displayPower * 2)),
            bolts: Math.max(1, Math.ceil(displayPower / 1.5)),
            cores: Math.max(1, Math.ceil(displayPower / 3))
          };

          // Render visual: prefer cardRenderer, then createCardView, fallback to element emoji
          let visualHtml = '';
          if (window.cardRenderer && typeof window.cardRenderer.render === 'function') {
            try {
              visualHtml = window.cardRenderer.render({ ...card, power: displayPower });
            } catch (err) {
              console.warn('cardRenderer.render failed for shop card', card.id, err);
              visualHtml = '';
            }
          }
          if (!visualHtml && window.createCardView) {
            try {
              const el = window.createCardView(card);
              visualHtml = el ? el.outerHTML : '';
            } catch (err) {
              console.warn('createCardView failed for shop card', card.id, err);
            }
          }
          if (!visualHtml) {
            const elementEmoji = this.getElementEmoji(card.element);
            visualHtml = `<div class="product-icon">${elementEmoji}</div>`;
          } else {
            // wrap visual into container matching product-icon slot
            visualHtml = `<div class="product-icon">${visualHtml}</div>`;
          }

          cardDiv.innerHTML = `
            <div class="product-header">
              ${visualHtml}
              <div class="product-info">
                <div class="product-title">${card.name}</div>
                <div class="product-desc">Ð¡Ð¸Ð»Ð°: ${displayPower}</div>
              </div>
            </div>
            <div class="product-footer">
              <div style="display: flex; gap: 8px; flex-direction: column; width: 100%;">
                <button class="product-buy-btn" data-card-id="${card.id}" data-currency="gears" data-price="${prices.gears}" title="Ð¨ÐµÑÑ‚ÐµÑ€Ð½Ñ–">
                  ðŸ”§ ${prices.gears}
                </button>
                <button class="product-buy-btn" data-card-id="${card.id}" data-currency="bolts" data-price="${prices.bolts}" title="Ð‘Ð¾Ð»Ñ‚Ð¸">
                  âš™ï¸ ${prices.bolts}
                </button>
                <button class="product-buy-btn" data-card-id="${card.id}" data-currency="cores" data-price="${prices.cores}" title="ÐŸÐ°Ñ€Ð¾Ð²Ñ– ÑÐ´Ñ€Ð°">
                  ðŸ”¥ ${prices.cores}
                </button>
              </div>
            </div>
          `;

          container.appendChild(cardDiv);
        });

        // Add click handlers for card purchase
        container.querySelectorAll('.product-buy-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const cardId = btn.dataset.cardId;
            const currency = btn.dataset.currency;
            const price = parseInt(btn.dataset.price);
            this.buyCard(cardId, currency, price);
          });
        });
      },

      buyCard(cardId, currency, price) {
        const profile = this.getProfile();
        if (!profile) return;

        // Check balance using Currency System
        if (!window.CurrencySystem.canAfford(profile, currency, price)) {
          const currencyName = window.CurrencySystem.getCurrencyNameGenitive(currency);
          alert(`ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð½ÑŒÐ¾ ${currencyName}! ÐŸÐ¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾ ${price}`);
          return;
        }

        const card = window.getCardById(cardId);
        if (!card) return;

        // Deduct currency using Currency System
        window.CurrencySystem.deduct(profile, currency, price);

        // Add card to collection
        if (!profile.collectionCards) {
          profile.collectionCards = [];
        }
        const newCardEntry = { id: card.id, level: 1 };
        profile.collectionCards.push(newCardEntry);

        // ÐÐ²Ñ‚Ð¾-Ð´Ð¾Ð´Ð°Ð²Ð°Ð½Ð½Ñ Ð² ÐºÐ¾Ð»Ð¾Ð´Ñƒ: ÑÐºÑ‰Ð¾ Ð¼ÐµÐ½ÑˆÐµ 9 ÐºÐ°Ñ€Ñ‚ â€“ Ð´Ð¾Ð´Ð°Ñ”Ð¼Ð¾;
        // Ñ–Ð½Ð°ÐºÑˆÐµ Ð·Ð°Ð¼Ñ–Ð½ÑŽÑ”Ð¼Ð¾ Ð½Ð°Ð¹ÑÐ»Ð°Ð±ÑˆÑƒ ÐºÐ°Ñ€Ñ‚Ñƒ, ÑÐºÑ‰Ð¾ Ð½Ð¾Ð²Ð° ÑÐ¸Ð»ÑŒÐ½Ñ–ÑˆÐ°
        userProfile.autoAddToDeck(profile, newCardEntry);

        // Ð”Ð¾Ð´Ð°Ñ‚Ð¸ Ð² inventory (Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐºÐ°Ñ‡ÐºÐ¸)
        if (!profile.inventory) {
          profile.inventory = {};
        }
        profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;

        // Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÐ²Ð°Ñ‚Ð¸ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑ ÐºÐ°Ñ€Ñ‚Ð¸
        const prog = window.getProgress ? window.getProgress(profile, card.id) : null;

        // Save profile (includes collection + deck changes)
        this.saveProfile(profile);

        // Update UI
        this.loadDeckCards(); // This will update topbar

        // Show success message
        const currencyEmojis = {
          gears: 'âš™ï¸',
          bolts: 'ðŸ”©',
          cores: 'âœ´ï¸Ž'
        };
        alert(`âœ… ${card.name} ÐºÑƒÐ¿Ð»ÐµÐ½Ð¾ Ð·Ð° ${price} ${currencyEmojis[currency]}!`);

        // Reload cards
        this.loadShopCards(this.currentCardFilter || 'all');
      },

      renderProducts(containerId, products) {
        const container = document.getElementById(containerId);
        if (!container) return;

        container.innerHTML = '';

        products.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';

          const currencyEmojis = {
            bolts: 'ðŸ”©',
            gears: 'âš™ï¸',
            cores: 'âœ´ï¸Ž'
          };
          const currencyIcon = currencyEmojis[product.price.currency] || '?';
          const badgeHTML = product.badge 
            ? `<div class="product-badge ${product.badge.class}">${product.badge.text}</div>` 
            : '';
          const bonusHTML = product.bonus 
            ? `<div class="product-bonus">${product.bonus}</div>` 
            : '';

          card.innerHTML = `
            ${badgeHTML}
            <div class="product-header">
              <div class="product-icon">${product.icon}</div>
              <div class="product-info">
                <div class="product-title">${product.title}</div>
                <div class="product-desc">${product.description}</div>
                ${bonusHTML}
              </div>
            </div>
            <div class="product-footer">
              <div class="product-price">
                <span class="currency-icon">${currencyIcon}</span>
                <span>${product.price.amount}</span>
              </div>
              <button class="product-buy-btn" data-sku="${product.sku}">ÐšÑƒÐ¿Ð¸Ñ‚Ð¸</button>
            </div>
          `;

          container.appendChild(card);
        });

        // Add click handlers
        container.querySelectorAll('.product-buy-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const sku = btn.dataset.sku;
            this.buyProduct(sku);
          });
        });
      },

      canAfford(product) {
        const profile = this.getProfile();
        if (!profile) return false;

        const currency = product.price.currency;
        return profile[currency] >= product.price.amount;
      },

      buyProduct(sku) {
        console.log('[BUY] Starting purchase for SKU:', sku);
        const profile = userProfile.getProfile();
        if (!profile) {
          console.error('[BUY] No profile found!');
          return;
        }
        console.log('[BUY] Profile loaded:', profile);

        const allProducts = this.getShopProducts();
        const product = [...allProducts.offers, ...allProducts.singleCards]
          .find(p => p.sku === sku);

        if (!product) {
          console.error('[BUY] Product not found:', sku);
          alert('Ð¢Ð¾Ð²Ð°Ñ€ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾!');
          return;
        }

        // ÐšÐ ÐžÐš 1: ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ– Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸
        const canAfford = this.canAfford(profile, product.price);
        if (!canAfford) {
          console.warn('[BUY] Cannot afford. Need:', product.price.amount, 'Have:', profile[product.price.currency]);
          const currencyNames = {
            bolts: 'Ð±Ð¾Ð»Ñ‚Ñ–Ð²',
            gears: 'ÑˆÐµÑÑ‚ÐµÑ€ÐµÐ½ÑŒ',
            cores: 'Ð¿Ð°Ñ€Ð¾Ð²Ð¸Ñ… ÑÐ´ÐµÑ€'
          };
          const currencyName = currencyNames[product.price.currency] || 'Ð²Ð°Ð»ÑŽÑ‚Ð¸';
          alert(`ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð½ÑŒÐ¾ ${currencyName}! ÐŸÐ¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾ ${product.price.amount}`);
          return;
        }

        // ÐšÐ ÐžÐš 2: Ð¡Ð¿Ð¸ÑÐ°Ð½Ð½Ñ Ð²Ð°Ð»ÑŽÑ‚Ð¸
        const currency = product.price.currency;
        profile[currency] -= product.price.amount;
        console.log('[BUY] Currency deducted. New balance:', profile[currency]);

        // ÐšÐ ÐžÐš 3: Ð’Ð¸Ð´Ð°Ñ‡Ð° Ð½Ð°Ð³Ð¾Ñ€Ð¾Ð´ (ÐºÐ°Ñ€Ñ‚Ð¸ Ð°Ð±Ð¾ Ð²Ð°Ð»ÑŽÑ‚Ð°)
        const rewards = [];

        if (product.contents.cards) {
          console.log('[BUY] Granting pack of', product.contents.cards, 'cards');
          // Mark SKU so grantPack can apply product-specific drop options
          profile._lastPurchasedSku = sku;
          const cards = this.grantPack(profile, product.contents.cards);
          // cleanup helper flag
          delete profile._lastPurchasedSku;
          rewards.push(...cards);
        }

        // Ð’Ð¸Ð´Ð°Ñ‡Ð° Ñ–Ð½ÑˆÐ¸Ñ… Ð½Ð°Ð³Ð¾Ñ€Ð¾Ð´ (Ð³Ð°Ñ€Ð½Ð¸Ð¹ Ð±Ð¾Ð½ÑƒÑ)
        if (product.contents.gears) {
          profile.gears = (profile.gears || 0) + product.contents.gears;
        }
        if (product.contents.cores) {
          profile.cores = (profile.cores || 0) + product.contents.cores;
        }
        if (product.contents.bolts) {
          profile.bolts = (profile.bolts || 0) + product.contents.bolts;
        }

        // ÐšÐ ÐžÐš 4: ÐŸÐ¾Ð·Ð½Ð°Ñ‡Ð¸Ñ‚Ð¸ Ð¾Ð´Ð½Ð¾Ñ€Ð°Ð·Ð¾Ð²Ñ– Ñ‚Ð¾Ð²Ð°Ñ€Ð¸ ÑÐº ÐºÑƒÐ¿Ð»ÐµÐ½Ñ–
        if (sku === 'offer_elements') {
          if (!profile.purchasedOffers) {
            profile.purchasedOffers = [];
          }
          profile.purchasedOffers.push(sku);
        }

        // ÐšÐ ÐžÐš 5: Ð—Ð±ÐµÑ€ÐµÐ¶ÐµÐ½Ð½Ñ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŽ
        userProfile.updateCurrentUser(profile);
        console.log('[BUY] Profile saved');

        // ÐšÐ ÐžÐš 6: ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ UI
        userProfile.updateUI();
        console.log('[BUY] UI updated');

        // ÐšÐ ÐžÐš 7: ÐŸÐµÑ€ÐµÐ·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶Ð¸Ñ‚Ð¸ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½ (Ð¿Ñ€Ð¸Ñ…Ð¾Ð²Ð°Ñ‚Ð¸ Ð¾Ð´Ð½Ð¾Ñ€Ð°Ð·Ð¾Ð²Ñ– Ñ‚Ð¾Ð²Ð°Ñ€Ð¸)
        if (sku === 'offer_elements') {
          this.loadShop();
        }

        // ÐšÐ ÐžÐš 8: ÐŸÐ¾ÐºÐ°Ð· Ð¼Ð¾Ð´Ð°Ð»ÐºÐ¸ Ð· Ð½Ð°Ð³Ð¾Ñ€Ð¾Ð´Ð°Ð¼Ð¸
        console.log('[BUY] Purchase complete! Rewards:', rewards.length, 'cards');
        if (rewards.length > 0) {
          this.showPackModal(rewards);
        } else {
          alert(`âœ… ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ° ÑƒÑÐ¿Ñ–ÑˆÐ½Ð°!`);
        }
      },

      // Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸ Ð¼Ð¾Ð¶Ð»Ð¸Ð²Ð¾ÑÑ‚Ñ– Ð¿Ð¾ÐºÑƒÐ¿ÐºÐ¸
      canAfford(profile, price) {
        const { currency, amount } = price;
        return (profile[currency] ?? 0) >= amount;
      },

      grantPack(profile, count) {
        let allCards = window.ALL_CARDS || [];
        const rewards = [];

        // Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÐ²Ð°Ñ‚Ð¸ Ñ–Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€ ÑÐºÑ‰Ð¾ Ð½Ðµ Ñ–ÑÐ½ÑƒÑ”
        if (!profile.inventory) {
          profile.inventory = {};
        }
        if (!profile.collectionCards) {
          profile.collectionCards = [];
        }

        for (let i = 0; i < count; i++) {
          let card = null;
          const sku = profile._lastPurchasedSku || '';

          // Ð Ð†Ð—ÐÐ† Ð¢Ð˜ÐŸÐ˜ ÐŸÐÐšÐ†Ð’ Ð— Ð Ð†Ð—ÐÐ˜ÐœÐ˜ ÐžÐ‘ÐœÐ•Ð–Ð•ÐÐÐ¯ÐœÐ˜
          if (sku === 'card_uncommon') {
            // "ÐÐµÐ·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð°" - 500 Ð±Ð¾Ð»Ñ‚Ñ–Ð²
            // ÐžÐ‘ÐœÐ•Ð–Ð•ÐÐÐ¯: Ð¢Ñ–Ð»ÑŒÐºÐ¸ R1-R4 (Ð±ÐµÐ· Ð»ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð¸Ñ…/Ð¼Ñ–Ñ„Ñ–Ñ‡Ð½Ð¸Ñ…)
            const rarityRoll = Math.random() * 100;
            let targetRarity;
            
            if (rarityRoll < 60) {
              targetRarity = 'common';       // 60% - Ð—Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð° (R1)
            } else if (rarityRoll < 75) {
              targetRarity = 'uncommon';     // 15% - ÐÐµÐ·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð° (R2)
            } else if (rarityRoll < 90) {
              targetRarity = 'rare';         // 15% - Ð Ñ–Ð´ÐºÑ–ÑÐ½Ð° (R3)
            } else {
              targetRarity = 'epic';         // 10% - Ð•Ð¿Ñ–Ñ‡Ð½Ð° (R4)
            }
            
            // Ð¤Ñ–Ð»ÑŒÑ‚Ñ€ÑƒÑ”Ð¼Ð¾ ÐºÐ°Ñ€Ñ‚Ð¸ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð· Ð´Ð¾Ð·Ð²Ð¾Ð»ÐµÐ½Ð¸Ð¼Ð¸ Ñ€Ñ–Ð´ÐºÐ¾ÑÑ‚ÑÐ¼Ð¸
            const allowedRarities = ['common', 'uncommon', 'rare', 'epic'];
            const candidates = allCards.filter(c => 
              allowedRarities.includes(c.rarity) && c.rarity === targetRarity
            );
            
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              // Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð¸Ð¹ Ð²Ð°Ñ€Ñ–Ð°Ð½Ñ‚: Ð±ÑƒÐ´ÑŒ-ÑÐºÐ° ÐºÐ°Ñ€Ñ‚Ð° R1-R4
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else if (sku === 'card_epic') {
            // "Ð•Ð¿Ñ–Ñ‡Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð°" - 50 ÑˆÐµÑÑ‚ÐµÑ€ÐµÐ½ÑŒ
            // ÐžÐ‘ÐœÐ•Ð–Ð•ÐÐÐ¯: R4-R6 Ð· ÑˆÐ°Ð½ÑÐ°Ð¼Ð¸ 50%/30%/20%
            const rarityRoll = Math.random() * 100;
            let targetRarity;
            
            if (rarityRoll < 50) {
              targetRarity = 'epic';       // 50% - Ð•Ð¿Ñ–Ñ‡Ð½Ð° (R4)
            } else if (rarityRoll < 80) {
              targetRarity = 'legendary';  // 30% - Ð›ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð° (R5)
            } else {
              targetRarity = 'mythic';     // 20% - ÐœÑ–Ñ„Ñ–Ñ‡Ð½Ð° (R6)
            }
            
            // Ð¤Ñ–Ð»ÑŒÑ‚Ñ€ÑƒÑ”Ð¼Ð¾ ÐºÐ°Ñ€Ñ‚Ð¸ Ñ‚Ñ–Ð»ÑŒÐºÐ¸ Ð· Ð´Ð¾Ð·Ð²Ð¾Ð»ÐµÐ½Ð¸Ð¼Ð¸ Ñ€Ñ–Ð´ÐºÐ¾ÑÑ‚ÑÐ¼Ð¸
            const allowedRarities = ['epic', 'legendary', 'mythic'];
            const candidates = allCards.filter(c => 
              allowedRarities.includes(c.rarity) && c.rarity === targetRarity
            );
            
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              // Ð¯ÐºÑ‰Ð¾ Ð½ÐµÐ¼Ð°Ñ” ÐºÐ°Ñ€Ñ‚ Ñ†Ñ–Ñ”Ñ— Ñ€Ñ–Ð´ÐºÐ¾ÑÑ‚Ñ–, Ð±ÐµÑ€ÐµÐ¼Ð¾ Ð±ÑƒÐ´ÑŒ-ÑÐºÑƒ Ð· Ð´Ð¾Ð·Ð²Ð¾Ð»ÐµÐ½Ð¸Ñ…
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else if (sku === 'card_legendary') {
            // "Ð›ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð° ÐºÐ°Ñ€Ñ‚Ð°" - 150 ÑˆÐµÑÑ‚ÐµÑ€ÐµÐ½ÑŒ
            // ÐžÐ‘ÐœÐ•Ð–Ð•ÐÐÐ¯: Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¾Ð²Ð°Ð½Ð¾ Ð»ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð° (R5) Ð°Ð±Ð¾ Ð¼Ñ–Ñ„Ñ–Ñ‡Ð½Ð° (R6)
            const allowedRarities = ['legendary', 'mythic'];
            
            // 80% ÑˆÐ°Ð½Ñ Ð½Ð° R5, 20% Ð½Ð° R6
            const isMythic = Math.random() < 0.2;
            const targetRarity = isMythic ? 'mythic' : 'legendary';
            
            const candidates = allCards.filter(c => c.rarity === targetRarity);
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              // Ð¯ÐºÑ‰Ð¾ Ð½ÐµÐ¼Ð°Ñ” Ð¼Ñ–Ñ„Ñ–Ñ‡Ð½Ð¸Ñ…, Ð±ÐµÑ€ÐµÐ¼Ð¾ Ð»ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ñƒ, Ñ– Ð½Ð°Ð²Ð¿Ð°ÐºÐ¸
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else if (sku === 'offer_elements') {
            // "ÐšÐ¾Ð»ÐµÐºÑ†Ñ–Ñ ÐµÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð»Ñ–Ð²" - 20 ÑˆÐµÑÑ‚ÐµÑ€ÐµÐ½ÑŒ
            // ÐžÐ‘ÐœÐ•Ð–Ð•ÐÐÐ¯: Ð¢Ñ–Ð»ÑŒÐºÐ¸ R1-R4 (Ð±ÐµÐ· Ð»ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð¸Ñ…/Ð¼Ñ–Ñ„Ñ–Ñ‡Ð½Ð¸Ñ…)
            const allowedRarities = ['common', 'uncommon', 'rare', 'epic'];
            
            // Ð”Ð»Ñ Ð½Ð°Ð±Ð¾Ñ€Ñ–Ð² - Ñ€Ñ–Ð²Ð½Ð¾Ð¼Ñ–Ñ€Ð½Ð¸Ð¹ Ñ€Ð¾Ð·Ð¿Ð¾Ð´Ñ–Ð»
            const rarityRoll = Math.random() * 100;
            let targetRarity;
            
            if (rarityRoll < 25) {
              targetRarity = 'common'; // 25% - Ð—Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð°
            } else if (rarityRoll < 50) {
              targetRarity = 'uncommon'; // 25% - ÐÐµÐ·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð°
            } else if (rarityRoll < 75) {
              targetRarity = 'rare'; // 25% - Ð Ñ–Ð´ÐºÑ–ÑÐ½Ð°
            } else {
              targetRarity = 'epic'; // 25% - Ð•Ð¿Ñ–Ñ‡Ð½Ð°
            }
            
            const candidates = allCards.filter(c => c.rarity === targetRarity);
            if (candidates.length > 0) {
              card = candidates[Math.floor(Math.random() * candidates.length)];
              console.log(`[GRANTPACK] ${sku}: ${targetRarity} - ${card.name}`);
            } else {
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
            
          } else {
            // Ð”Ð»Ñ Ñ–Ð½ÑˆÐ¸Ñ… Ñ‚Ð¾Ð²Ð°Ñ€Ñ–Ð² (ÑÐºÑ‰Ð¾ Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ñ‚ÑŒÑÑ dropSystem)
            if (window.dropSystem && typeof window.dropSystem.dropCardWithOptions === 'function') {
              let opts = {};
              
              // ÐÐ°Ð»Ð°ÑˆÑ‚ÑƒÐ²Ð°Ð½Ð½Ñ Ð´Ð»Ñ Ñ€Ñ–Ð·Ð½Ð¸Ñ… SKU
              if (sku && sku.startsWith('card_')) {
                opts = { maxRarity: 'epic' }; // Ð—Ð° Ð·Ð°Ð¼Ð¾Ð²Ñ‡ÑƒÐ²Ð°Ð½Ð½ÑÐ¼ - Ð±ÐµÐ· Ð»ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð¸Ñ…
              }
              
              const res = window.dropSystem.dropCardWithOptions(
                profile, 
                allCards, 
                window.STARTER_CARDS || [], 
                profile.pityCounters || {noLegendary:0, noMythic:0}, 
                opts
              );
              card = res.card;
              profile.pityCounters = res.pityCounters;
              console.log(`[GRANTPACK] ${sku}: DropSystem ${card.rarity} - ${card.name}`);
            } else {
              // Fallback: Ð²Ð¸Ð¿Ð°Ð´ÐºÐ¾Ð²Ð° ÐºÐ°Ñ€Ñ‚Ð° Ð· Ð¾Ð±Ð¼ÐµÐ¶ÐµÐ½Ð½ÑÐ¼Ð¸
              const allowedRarities = ['common', 'uncommon', 'rare', 'epic'];
              const fallback = allCards.filter(c => allowedRarities.includes(c.rarity));
              card = fallback[Math.floor(Math.random() * fallback.length)];
              console.log(`[GRANTPACK] ${sku}: Fallback ${card.rarity} - ${card.name}`);
            }
          }

          const newEntry = { id: card.id, level: 1 };

          // Ð”ÐžÐ”ÐÐ¢Ð˜ Ð’ ÐšÐžÐ›Ð•ÐšÐ¦Ð†Ð®
          profile.collectionCards.push(newEntry);
          userProfile.autoAddToDeck(profile, newEntry);

          // Ð”ÐžÐ”ÐÐ¢Ð˜ Ð’ Ð†ÐÐ’Ð•ÐÐ¢ÐÐ  (Ð´Ð»Ñ Ð¿Ñ€Ð¾ÐºÐ°Ñ‡ÐºÐ¸)
          profile.inventory[card.id] = (profile.inventory[card.id] ?? 0) + 1;

          // Ð—Ð‘Ð•Ð Ð•Ð“Ð¢Ð˜ Ð”Ð›Ð¯ ÐŸÐžÐšÐÐ—Ð£ Ð’ ÐœÐžÐ”ÐÐ›Ð¦Ð†
          rewards.push(card);
        }

        return rewards;
      },

      showPackModal(rewards) {
        const modal = document.getElementById('pack-modal');
        const rewardsContainer = document.getElementById('pack-rewards');
        if (!modal || !rewardsContainer) return;
        rewardsContainer.innerHTML = '';

        // Render rewards: prefer createCardView, then cardRenderer, otherwise fallback HTML
        rewards.forEach(card => {
          const wrapper = document.createElement('div');
          wrapper.className = 'pack-card-wrapper';

          let visualAppended = false;
          if (window.createCardView) {
            try {
              const cardEl = window.createCardView(card);
              if (cardEl) {
                wrapper.appendChild(cardEl);
                visualAppended = true;
              }
            } catch (err) {
              console.warn('createCardView failed in pack modal', err);
            }
          }

          if (!visualAppended && window.cardRenderer && typeof window.cardRenderer.render === 'function') {
            try {
              const html = window.cardRenderer.render(card);
              const frag = document.createElement('div');
              frag.innerHTML = html;
              // append first node
              if (frag.firstElementChild) wrapper.appendChild(frag.firstElementChild);
              visualAppended = true;
            } catch (err) {
              console.warn('cardRenderer.render failed in pack modal', err);
            }
          }

          if (!visualAppended) {
            // Minimal fallback visual
            const el = document.createElement('div');
            el.className = 'sp-card pack-fallback-card ' + (card.element || '');
            el.innerHTML = `
              <div class="corner-gear">${card.element || ''}</div>
              <div class="power-plate"><div class="power-value">${card.basePower || card.power || ''}</div></div>
            `;
            wrapper.appendChild(el);
          }

          // Info under card
          const info = document.createElement('div');
          info.className = 'pack-card-info';
          const nameDiv = document.createElement('div');
          nameDiv.className = 'pack-card-name';
          nameDiv.textContent = card.name || '';
          info.appendChild(nameDiv);
          const elDiv = document.createElement('div');
          elDiv.className = 'pack-card-element';
          let elementName = card.element;
          if (window.ELEMENT_INFO && window.ELEMENT_INFO[card.element] && window.ELEMENT_INFO[card.element].name) {
            elementName = window.ELEMENT_INFO[card.element].name;
          }
          elDiv.textContent = elementName || '';
          info.appendChild(elDiv);

          wrapper.appendChild(info);
          rewardsContainer.appendChild(wrapper);
        });
        modal.classList.add('active');
      },

      closePackModal() {
        const modal = document.getElementById('pack-modal');
        if (modal) {
          modal.classList.remove('active');
        }
      },

      // ========== END SHOP SYSTEM ==========

      loadDeckCards() {
        // ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ Ð´Ð°Ð½Ñ– ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð° Ð½Ð° Ñ‚Ð¾Ð¿Ð±Ð°Ñ€Ñ–
        const profile = userProfile.getProfile();
        if (!profile) {
          console.error('No user profile found');
          return;
        }

        const boltsEl = document.getElementById('deck-bolts');
        const gearsEl = document.getElementById('deck-gears');
        const coresEl = document.getElementById('deck-cores');
        
        if (boltsEl) boltsEl.textContent = profile.bolts || 0;
        if (gearsEl) gearsEl.textContent = profile.gears || 0;
        if (coresEl) coresEl.textContent = profile.cores || 0;

        // Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·ÑƒÐ²Ð°Ñ‚Ð¸ ÐºÐ°Ñ€Ñ‚Ð¸ ÑÐºÑ‰Ð¾ Ñ—Ñ… Ð½ÐµÐ¼Ð°Ñ” (Ð´Ð»Ñ ÑÑ‚Ð°Ñ€Ð¸Ñ… ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñ–Ð²)
        if (!profile.deckCards || !profile.collectionCards) {
          console.log('Initializing cards for existing user...');
          const selectedCards = getRandomCards(16);
          profile.deckCards = selectedCards.slice(0, 9).map(card => ({
            id: card.id,
            level: 1
          }));
          profile.collectionCards = selectedCards.slice(9, 16).map(card => ({
            id: card.id,
            level: 1
          }));
          userProfile.updateCurrentUser(profile);
        }

        // ÐœÑ–Ð³Ñ€Ð°Ñ†Ñ–Ñ ÑÑ‚Ð°Ñ€Ð¸Ñ… ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ñ–Ð²: Ð´Ð¾Ð´Ð°Ñ‚Ð¸ progress Ñ– inventory
        if (!profile.progress) {
          console.log('Migrating profile: adding progress...');
          profile.progress = {};
          const allCards = profile.deckCards.concat(profile.collectionCards || []);
          allCards.forEach(dc => {
            if (dc && dc.id) {
              profile.progress[dc.id] = { level: dc.level || 1, xp: 0 };
            }
          });
        }

        if (!profile.inventory) {
          console.log('Migrating profile: adding inventory...');
          profile.inventory = {};
          const allCards = profile.deckCards.concat(profile.collectionCards || []);
          allCards.forEach(dc => {
            if (dc && dc.id) {
              profile.inventory[dc.id] = (profile.inventory[dc.id] || 0) + 1;
            }
          });
        }

        // Ð’Ð¸Ð±Ñ€Ð°Ñ‚Ð¸ ÐºÐ°Ñ€Ñ‚Ð¸ Ð· 16 Ð·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð¸Ñ… ÐºÐ°Ñ€Ñ‚
        const deckCardIds = profile.deckCards.map(dc => dc.id);
        const deckCards = deckCardIds.map(cardId => getCardById(cardId))
          .filter(card => card !== undefined);
        
        // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ° Ñ‡Ð¸ ÐºÐ°Ñ€Ñ‚Ð¸ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ñ–
        if (deckCards.length === 0) {
          console.error('No cards found! Check if card scripts are loaded.');
          document.getElementById('deckGrid').innerHTML = '<p style="color: red; text-align: center; padding: 20px;">ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð·Ð°Ð²Ð°Ð½Ñ‚Ð°Ð¶ÐµÐ½Ð½Ñ ÐºÐ°Ñ€Ñ‚</p>';
          return;
        }
        
        console.log('Loading deck cards:', deckCards.length, 'cards found');
        console.log('First card:', deckCards[0]);
        
        // Ð ÐµÐ½Ð´ÐµÑ€Ð¸Ð½Ð³ ÐºÐ°Ñ€Ñ‚ â€” ÑÑ‚Ð²Ð¾Ñ€ÑŽÑ”Ð¼Ð¾ Ð¿Ð°Ñ€Ð¸ {card, level, originalIndex}, ÑÐ¾Ñ€Ñ‚ÑƒÑ”Ð¼Ð¾ Ð·Ð° Ð·Ñ€Ð¾ÑÑ‚Ð°Ð½Ð½ÑÐ¼ Ð¿Ð¾Ñ‚ÑƒÐ¶Ð½Ð¾ÑÑ‚Ñ–
        const deckGrid = document.getElementById('deckGrid');
        if (deckGrid) {
          const deckPairs = deckCards.map((card, index) => {
            const lvl = (profile.deckCards[index] && profile.deckCards[index].level) || 1;
            return { card, level: lvl, originalIndex: index };
          });

          // Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð½Ñ Ð¿Ð¾Ñ‚ÑƒÐ¶Ð½Ð¾ÑÑ‚Ñ– Ð· ÑƒÑ€Ð°Ñ…ÑƒÐ²Ð°Ð½Ð½ÑÐ¼ Ñ€Ñ–Ð²Ð½Ñ
          const getCardPower = (c, lvl) => {
            try { return (window.getPower ? window.getPower(c, lvl) : getPower(c, lvl)) || 0; }
            catch (e) { return 0; }
          };

          // Sort descending: strongest first
          deckPairs.sort((a, b) => {
            const pa = getCardPower(a.card, a.level);
            const pb = getCardPower(b.card, b.level);
            if (pa === pb) return (b.card.id || '').localeCompare(a.card.id || '');
            return pb - pa;
          });

          const cardsHTML = deckPairs.map(p => this.renderDeckCard(p.card, p.level, p.originalIndex)).join('');

          console.log('Generated HTML length:', cardsHTML.length);
          deckGrid.innerHTML = cardsHTML;
          console.log('Cards rendered to grid (sorted ascending by power)');
          // Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ Ð¿Ð°Ñ€Ð°Ð»Ð°ÐºÑÑƒ Ð´Ð»Ñ ÐºÐ°Ñ€Ñ‚ Ð¿Ñ–ÑÐ»Ñ Ñ€ÐµÐ½Ð´ÐµÑ€Ñƒ
          initCardParallax();

          // ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ ÑÐ¸Ð»Ñƒ ÐºÐ¾Ð»Ð¾Ð´Ð¸ (Ð· ÑƒÑ€Ð°Ñ…ÑƒÐ²Ð°Ð½Ð½ÑÐ¼ ÑÐ¾Ñ€Ñ‚ÑƒÐ²Ð°Ð½Ð½Ñ)
          let totalPower = 0;
          deckPairs.forEach((p) => {
            totalPower += getCardPower(p.card, p.level);
          });
          const powerDisplay = document.getElementById('deck-power-value');
          if (powerDisplay) powerDisplay.textContent = totalPower;

          // ÐŸÑ€Ð¸ÐºÑ€Ñ–Ð¿Ð¸Ñ‚Ð¸ Ð¾Ð±Ñ€Ð¾Ð±Ð½Ð¸ÐºÐ¸ Ð¿Ð¾Ð´Ñ–Ð¹ Ð· ÑƒÑ€Ð°Ñ…ÑƒÐ²Ð°Ð½Ð½ÑÐ¼ Ð¾Ñ€Ð¸Ð³Ñ–Ð½Ð°Ð»ÑŒÐ½Ð¸Ñ… Ñ–Ð½Ð´ÐµÐºÑÑ–Ð²
          const profileForUpgrade = userProfile.getProfile();
          const inventory = this.getInventory(profileForUpgrade);

          const hintEl = document.getElementById('deck-hint');
          if (hintEl) {
            if (this.hasAnyUpgradable(profileForUpgrade.deckCards, inventory)) {
              hintEl.classList.add('hot');
            } else {
              hintEl.classList.remove('hot');
            }
          }

          document.querySelectorAll('#deckGrid .sp-card').forEach((cardEl) => {
            const origAttr = cardEl.getAttribute('data-original-index');
            let originalIndex = origAttr ? parseInt(origAttr, 10) : -1;
            let deckItem = (originalIndex >= 0 && Array.isArray(profileForUpgrade.deckCards)) ? profileForUpgrade.deckCards[originalIndex] : undefined;

            // Fallback: try to resolve deckItem by card-id if originalIndex is invalid
            if (!deckItem) {
              const cardIdAttr = cardEl.getAttribute('data-card-id') || cardEl.getAttribute('data-id');
              if (cardIdAttr && Array.isArray(profileForUpgrade.deckCards)) {
                const foundIndex = profileForUpgrade.deckCards.findIndex(c => c && String(c.id) === String(cardIdAttr));
                if (foundIndex >= 0) {
                  deckItem = profileForUpgrade.deckCards[foundIndex];
                  originalIndex = foundIndex;
                }
              }
            }

            const canUpgrade = deckItem ? this.canUpgradeCard(deckItem, inventory) : false;

            cardEl.addEventListener('click', (e) => {
              e.preventDefault();
              const cardId = deckItem ? deckItem.id : cardEl.getAttribute('data-card-id') || cardEl.getAttribute('data-id');
              this.showCardDetails(cardId, true, originalIndex);
            });
          });
        }
        
        // ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ ÑÐ¸Ð»Ñƒ ÐºÐ¾Ð»Ð¾Ð´Ð¸ (Ð· ÑƒÑ€Ð°Ñ…ÑƒÐ²Ð°Ð½Ð½ÑÐ¼ Ñ€Ñ–Ð²Ð½Ñ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑƒ)
        let totalPower = 0;
        deckCards.forEach((card) => {
          const prog = window.getProgress ? window.getProgress(profile, card.id) : { level: 1, xp: 0 };
          const cardLevel = prog.level;
          totalPower += window.getPower ? window.getPower(card, cardLevel) : getPower(card, cardLevel);
        });
        
        const powerDisplay = document.getElementById('deck-power-value');
        if (powerDisplay) {
          powerDisplay.textContent = totalPower;
        }
        
        // ÐŸÑ€Ð¸ÐºÑ€Ñ–Ð¿Ð¸Ñ‚Ð¸ Ð¾Ð±Ñ€Ð¾Ð±Ð½Ð¸ÐºÐ¸ Ð¿Ð¾Ð´Ñ–Ð¹
        const profileForUpgrade = userProfile.getProfile();
        const inventory = this.getInventory(profileForUpgrade);
        
        // ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ ÑÑ‚Ð°Ð½ hint-Ñƒ
        const hintEl = document.getElementById('deck-hint');
        if (hintEl) {
          if (this.hasAnyUpgradable(profileForUpgrade.deckCards, inventory)) {
            hintEl.classList.add('hot');
          } else {
            hintEl.classList.remove('hot');
          }
        }
        
        // NOTE: event handlers for deck cards are attached above using sorted `deckPairs`
        // (we avoid attaching duplicate handlers here to prevent index mismatch bugs)
      },

      renderDeckCard(cardData, level = 1, originalIndex = -1) {
        const profile = userProfile.getProfile();
        const inventory = this.getInventory(profile);
        const prog = window.getProgress ? window.getProgress(profile, cardData.id) : { level: level, xp: 0 };
        const displayLevel = prog.level || level;
        const displayPower = window.getPower ? window.getPower(cardData, displayLevel) : getPower(cardData, displayLevel);
        const canUpgrade = this.canUpgradeCard({ id: cardData.id, level: displayLevel }, inventory);
        const canAutoLevel = canUpgrade && this.canGuaranteedLevelByBurning(profile, cardData.id);
        
        // Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ CardRenderer ÑÐºÑ‰Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¸Ð¹
          if (window.cardRenderer) {
          // ÐŸÐµÑ€ÐµÐ´Ð°Ñ”Ð¼Ð¾ Ð°Ñ‚Ð°ÐºÑƒ ÑÐº Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ñƒ ÑÐ¸Ð»Ñƒ, Ñ‰Ð¾Ð± Ñ€ÐµÐ½Ð´ÐµÑ€ Ð¿Ð¾ÐºÐ°Ð·ÑƒÐ²Ð°Ð² Ð¿Ñ€Ð¾ÐºÐ°Ñ‡ÐºÑƒ
          const boostedCard = { 
            ...cardData, 
            attack: displayPower,
            power: displayPower,
            stats: { ...(cardData.stats || {}), power: displayPower }
          };
          let html = window.cardRenderer.render(boostedCard, { level: displayLevel, power: displayPower, showUpgrade: canAutoLevel, interactive: true });
          return html;
        }

        // Fallback Ñ€ÐµÐ½Ð´ÐµÑ€Ð¸Ð½Ð³ - Ð¾Ð´Ð½Ð°ÐºÐ¾Ð²Ð¸Ð¹ ÑˆÐ°Ð±Ð»Ð¾Ð½ ÑÐº CardRenderer
        const {
          id = 'unknown',
          element = 'fire',
          rarity = 'R1',
          basePower = 0,
          attack = displayPower
        } = cardData;

        const rarityNames = {
          'R1': 'Ð—Ð’Ð˜Ð§ÐÐ™ÐÐ',
          'R2': 'ÐÐ•Ð—Ð’Ð˜Ð§ÐÐ™ÐÐ',
          'R3': 'Ð Ð†Ð”ÐšÐ†Ð¡ÐÐ',
          'R4': 'Ð•ÐŸÐ†Ð§ÐÐ',
          'R5': 'Ð›Ð•Ð“Ð•ÐÐ”ÐÐ ÐÐ',
          'R6': 'ÐœÐ†Ð¤Ð†Ð§ÐÐ'
        };

        const rarityBadge = rarityNames[rarity] || 'Ð—Ð’Ð˜Ð§ÐÐ™ÐÐ';
        const shownPower = attack || basePower;

        const elementIcons = {
          fire: `<div class="element-emoji fire-emoji">ðŸ”¥</div>`,
          water: `<div class="element-emoji water-emoji">ðŸ’§</div>`,
          air: `<div class="element-emoji air-emoji">ðŸ’¨</div>`,
          earth: `<div class="element-emoji earth-emoji">ðŸƒ</div>`
        };

        const elementIcon = elementIcons[element] || elementIcons.fire;

        return `
          <div class="sp-card ${element} ${rarity} ${canUpgrade ? 'upgradable' : ''}" 
               data-id="${id}"
               data-card-id="${id}"
               data-original-index="${originalIndex}"
               data-element="${element}"
               data-rarity="${rarity}"
               data-power="${shownPower}"
               data-attack="${attack}">
            <!-- Ð”Ð•ÐšÐžÐ ÐÐ¢Ð˜Ð’ÐÐ† Ð›Ð†ÐÐ†Ð‡ -->
            <div class="decor-line line-top"></div>
            <div class="decor-line line-bottom"></div>
            <!-- Ð‘Ð•Ð™Ð”Ð– Ð Ð†Ð”ÐšÐžÐ¡Ð¢Ð† -->
            <div class="rarity-badge">${rarityBadge}</div>
            <!-- Ð’Ð•Ð›Ð˜ÐšÐ Ð”Ð•Ð¢ÐÐ›Ð¬ÐÐ Ð¨Ð•Ð¡Ð¢Ð•Ð ÐÐ¯ -->
            <div class="corner-gear">
              <div class="gear-inner">
                ${elementIcon}
              </div>
            </div>
            <!-- ÐŸÐ›ÐÐ¨ÐšÐ Ð¡Ð˜Ð›Ð˜ Ð²Ð½Ð¸Ð·Ñƒ -->
            <div class="power-plate">
              <div class="power-value">${shownPower}</div>
            </div>
            ${canAutoLevel ? '<div class="upgrade-arrow">â–²</div>' : ''}
          </div>
        `;
      },

      // ÐžÐ½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ ÑÐ¸Ð»Ð¸ ÐºÐ°Ñ€Ñ‚Ð¸ Ð² DOM Ð¿Ñ–ÑÐ»Ñ Ð¿Ñ€Ð¾ÐºÐ°Ñ‡ÐºÐ¸
      refreshCardPowerInDeck(cardId) {
        const profile = userProfile.getProfile();
        const cardData = window.getCardById(cardId);
        if (!cardData) return;

        const prog = window.getProgress ? window.getProgress(profile, cardId) : { level: 1, xp: 0 };
        const newPower = window.getPower ? window.getPower(cardData, prog.level) : cardData.basePower;

        // ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ ÑÐ¸Ð»Ñƒ Ð² DOM
        const powerEl = document.querySelector(
          `.sp-card[data-card-id="${cardId}"] .power-value`
        );
        if (powerEl) {
          powerEl.textContent = String(newPower);
        }

        // ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¸ data-power Ñ‚Ð° data-attack
        const cardEl = document.querySelector(`.sp-card[data-card-id="${cardId}"]`);
        if (cardEl) {
          cardEl.setAttribute('data-power', newPower);
          cardEl.setAttribute('data-attack', newPower);
        }

        // ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ñƒ ÑÐ¸Ð»Ñƒ ÐºÐ¾Ð»Ð¾Ð´Ð¸
        this.loadDeckCards();
      },

      loadCollectionCards() {
        const profile = userProfile.getProfile();
        if (!profile) {
          console.error('No profile found');
          return;
        }

        // Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ñ– ÐºÐ°Ñ€Ñ‚Ð¸ (ID): Ð· ÐºÐ¾Ð»ÐµÐºÑ†Ñ–Ñ— Ñ‚Ð° ÐºÐ¾Ð»Ð¾Ð´Ð¸
        let foundIds = new Set([
          ...((profile.collectionCards || []).map(c => c.id)),
          ...((profile.deckCards || []).map(c => c.id))
        ]);

        // Ð’ÑÐµ ÐºÐ°Ñ€Ñ‚Ñ‹ Ð¿Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°Ð¼
        let allCards = window.ALL_CARDS || [];
        const elements = ['fire', 'water', 'air', 'earth'];
        const elementNames = {
          fire: 'Ð’Ð¾Ð³Ð½ÑÐ½Ð° ÑÑ‚Ð¸Ñ…Ñ–Ñ',
          water: 'Ð’Ð¾Ð´ÑÐ½Ð° ÑÑ‚Ð¸Ñ…Ñ–Ñ',
          air: 'ÐŸÐ¾Ð²Ñ–Ñ‚Ñ€ÑÐ½Ð° ÑÑ‚Ð¸Ñ…Ñ–Ñ',
          earth: 'Ð—ÐµÐ¼Ð»ÑÐ½Ð° ÑÑ‚Ð¸Ñ…Ñ–Ñ'
        };

        elements.forEach(element => {
          const grid = document.getElementById(element + '-collection');
          if (!grid) return;
          const cards = allCards.filter(card => card.element === element);
          let foundCount = 0;
          grid.innerHTML = cards.map(card => {
            const found = foundIds.has(card.id);
            if (found) foundCount++;
            return `
              <div class="collection-card-item${found ? ' found' : ' not-found'}">
                <span class="collection-card-name">${card.name}</span>
                <span class="collection-card-status">${found ? 'Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾' : 'ÐÐµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾'}</span>
              </div>
            `;
          }).join('');
          // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ
          const progress = document.getElementById(element + '-progress');
          if (progress) progress.textContent = `${foundCount}/${cards.length} ÐºÐ°Ñ€Ñ‚`;
        });
      },

      // ========== CARD DETAILS PAGE ==========

      showCardDetails(cardId, fromDeck = false, deckIndex = -1) {
        const profile = userProfile.getProfile();
        const cardData = getCardById(cardId);

        if (!cardData) {
          console.error('Card not found:', cardId);
          return;
        }

        // Ð’Ð¸Ð·Ð½Ð°Ñ‡Ð¸Ñ‚Ð¸ Ñ€Ñ–Ð²ÐµÐ½ÑŒ Ð·Ð° Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÐ¾Ð¼ (Ð¿Ñ€Ð¾ÐºÐ°Ñ‡ÐºÐ°)
        const prog = window.getProgress ? window.getProgress(profile, cardId) : { level: 1, xp: 0 };
        const cardLevel = prog.level;
        const actualPower = window.getPower ? window.getPower(cardData, cardLevel) : Math.round(cardData.basePower * Math.pow(cardData.upgradeMult, cardLevel - 1));

        // Ð ÐµÐ½Ð´ÐµÑ€Ð¸Ñ‚Ð¸ Ð¾ÑÐ½Ð¾Ð²Ð½Ñƒ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ Ð¿Ñ€Ð¾ ÐºÐ°Ñ€Ñ‚Ñƒ
        this.renderCardDetails(cardData, cardLevel, actualPower, deckIndex);

        // Ð—Ð½Ð°Ð¹Ð´ÐµÐ½Ñ– ÐºÐ°Ñ€Ñ‚Ð¸ (ID): Ð· ÐºÐ¾Ð»ÐµÐºÑ†Ñ–Ñ— Ñ‚Ð° ÐºÐ¾Ð»Ð¾Ð´Ð¸
        const foundIds = new Set([
          ...((profile.collectionCards || []).map(c => c.id)),
          ...((profile.deckCards || []).map(c => c.id))
        ]);
        // Ð—Ð½Ð°Ð¹Ñ‚Ð¸ Ð²ÑÑ– ÐºÐ°Ñ€Ñ‚Ð¸ Ñ†Ñ–Ñ”Ñ— ÑÑ‚Ð¸Ñ…Ñ–Ñ— (Ð· Ð±Ð°Ð·Ð¸ Ð´Ð°Ð½Ð¸Ñ…)
        const allCards = window.ALL_CARDS || window.CARDS_COMMON || [];
        const sameElementCards = allCards.filter(c => c.element === cardData.element);
        // Ð’Ð¸Ð·Ð½Ð°Ñ‡Ð¸Ñ‚Ð¸ ÑÐ¸Ð»Ñƒ Ñ†Ñ–Ð»ÑŒÐ¾Ð²Ð¾Ñ— ÐºÐ°Ñ€Ñ‚Ð¸ Ñ‡ÐµÑ€ÐµÐ· getPower (Ð· ÑƒÑ€Ð°Ñ…ÑƒÐ²Ð°Ð½Ð½ÑÐ¼ Ñ€Ñ–Ð²Ð½Ñ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑƒ)
        const targetPower = window.getPower ? (window.getPower(cardData, cardLevel)) : (cardData.basePower || cardData.power || 0);
        const deckIds = new Set((profile.deckCards || []).map(c => c.id));
        // Ð’ÑÑ– ÑÐ»Ð°Ð±ÑˆÑ– ÐºÐ°Ñ€Ñ‚Ð¸ Ñ†Ñ–Ñ”Ñ— ÑÑ‚Ð¸Ñ…Ñ–Ñ—, ÑÐºÑ– Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ñ– Ñƒ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»Ñ–, Ð°Ð»Ðµ ÐÐ• Ð² ÐºÐ¾Ð»Ð¾Ð´Ñ–
        const weakerCards = sameElementCards.filter(c => {
          if (!c || !c.id) return false;
          if (!foundIds.has(c.id)) return false;
          if (deckIds.has(c.id)) return false;
          // Ð²Ñ‹Ñ‡Ð¸ÑÐ»Ð¸Ð¼ ÑÐ¸Ð»Ñƒ ÐºÐ°Ð½Ð´Ð¸Ð´Ð°Ñ‚Ð° (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ getPower ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¸ ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ)
          const candProg = window.getProgress ? window.getProgress(profile, c.id) : { level: 1, xp: 0 };
          const candPower = window.getPower ? window.getPower(c, candProg.level) : (c.basePower || c.power || 0);
          return candPower < targetPower && c.id !== cardId;
        });

        // ÐŸÐ¾ÐºÐ°Ð·/ÑÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ° Ð¸ ÑÐ¿Ð¸ÑÐºÐ° ÑÐ»Ð°Ð±ÑˆÐ¸Ñ… ÐºÐ°Ñ€Ñ‚
        const weakerHeader = document.getElementById('weaker-cards-header');
        const weakerList = document.getElementById('weaker-cards-list');
        if (weakerCards.length > 0) {
          if (weakerHeader) weakerHeader.style.display = '';
          if (weakerList) weakerList.style.display = '';
          this.renderWeakerCards(weakerCards, cardId, profile);
        } else {
          if (weakerHeader) weakerHeader.style.display = 'none';
          if (weakerList) {
            weakerList.style.display = 'none';
            weakerList.innerHTML = '';
          }
        }

        // === ÐŸÐ ÐžÐ¡Ð¢Ð Ð’Ð†Ð—Ð£ÐÐ›Ð†Ð—ÐÐ¦Ð†Ð¯ ÐŸÐ ÐžÐšÐÐ§ÐšÐ˜ ===
        // ÐŸÐ¾ÐºÐ°Ð¶ÐµÐ¼Ð¾ Ð¿Ñ€Ð¾ÑÑ‚Ð¸Ð¹ XP-Ð±Ð°Ñ€ Ð°Ð±Ð¾ Ð²Ð¸ÐºÐ»Ð¸Ñ‡ÐµÐ¼Ð¾ Ð²Ð½ÐµÑˆÐ½ÑŽÑŽ Ð¾Ñ‚Ñ€Ð¸ÑÐ¾Ð²ÐºÑƒ, ÑÐºÑ‰Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
        const cardMain = document.getElementById('card-main-info');
        const xpBar = cardMain ? cardMain.querySelector('.xp-bar') : null;
        if (window.renderUpgradeBar) {
          window.renderUpgradeBar(profile, cardId);
        } else if (xpBar) {
          const need = this.xpNeededForLevel(prog.level || 1) || 100;
          xpBar.style.width = `${Math.min(100, Math.round(((prog.xp || 0) / need) * 100))}%`;
        }
        // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ð¸ ÐºÐ½Ð¾Ð¿ÐºÑƒ "ÐÐ°Ð·Ð°Ð´"
        const backBtn = document.getElementById('card-details-back');
        if (backBtn) {
          backBtn.onclick = (e) => {
            e.preventDefault();
            if (fromDeck) {
              this.showPage('deck');
            } else {
              this.showPage('collections');
            }
          };
        }

        // ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚Ð¸ ÑÑ‚Ð¾Ñ€Ñ–Ð½ÐºÑƒ
        this.showPage('card-details');
      },
      renderCardDetails(cardData, level, power, deckIndex) {
        const mainDisplay = document.getElementById('card-main-info');
        if (!mainDisplay) return;

        // Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð±Ð»Ð¾Ðº ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸ â€” Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ cardRenderer Ð¸Ð»Ð¸ createCardView, Ð¸Ð½Ð°Ñ‡Ðµ fallback
        let visualHtml = '';
        if (window.cardRenderer && typeof window.cardRenderer.render === 'function') {
          // ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ power & level Ñ‡ÐµÑ€ÐµÐ· opts, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ€ÐµÐ½Ð´ÐµÑ€ÐµÑ€ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð» Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½ÑƒÑŽ ÑÐ¸Ð»Ñƒ
          visualHtml = window.cardRenderer.render({ ...cardData }, { level, power });
        } else if (window.createCardView) {
          try {
            // Ð•ÑÐ»Ð¸ createCardView ÑƒÐ¼ÐµÐµÑ‚ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð¿Ð¾Ð»Ðµ power Ð² Ð¾Ð±ÑŠÐµÐºÑ‚Ðµ â€” Ð¿Ñ€Ð¾ÐºÐ¸Ð½ÐµÐ¼ ÐµÐ³Ð¾
            const el = window.createCardView({ ...cardData, power, level });
            visualHtml = el ? el.outerHTML : '';
          } catch (err) {
            console.warn('createCardView failed', err);
            visualHtml = '';
          }
        }

        if (!visualHtml) {
          // ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ fallback Ð²Ð¸Ð·ÑƒÐ°Ð»
          const elem = cardData.element || '';
          const shownPower = power || cardData.basePower || 0;
          visualHtml = `
            <div class="sp-card large ${elem}">
              <div class="corner-gear">${elem}</div>
              <div class="power-plate"><div class="power-value">${shownPower}</div></div>
              <div class="card-name">${cardData.name || ''}</div>
            </div>`;
        }

        // Ð˜Ð½Ñ„Ð¾ ÑÐ¿Ñ€Ð°Ð²Ð°: Ð¸Ð¼Ñ, ÑÑ‚Ð¸Ñ…Ð¸Ñ, Ñ€ÐµÐ´ÐºÐ¾ÑÑ‚ÑŒ, ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ
        const prog = (userProfile.getProfile && window.getProgress) ? window.getProgress(userProfile.getProfile(), cardData.id) : { level: level || 1, xp: 0 };
        const levelText = `LV ${prog.level || level || 1}`;
        const need = this.xpNeededForLevel(prog.level || 1) || 100;
        const xpText = `${prog.xp || 0} / ${need} XP`;

        mainDisplay.innerHTML = `
          <div style="display:flex; gap:14px; align-items:flex-start;">
            <div class="card-visual-area">${visualHtml}</div>
            <div class="card-meta" style="flex:1">
              <div class="card-meta-name" style="font-size:18px; font-weight:700; margin-bottom:6px">${cardData.name || ''}</div>
              <div class="card-meta-row">Ð¡Ñ‚Ð¸Ñ…Ñ–Ñ: <strong>${(cardData.element || '').toUpperCase()}</strong></div>
              <div class="card-meta-row">Ð Ñ–Ð´ÐºÑ–ÑÑ‚ÑŒ: <strong>${cardData.rarity || ''}</strong></div>
              <div class="card-meta-row" style="margin-top:8px">Ð Ñ–Ð²ÐµÐ½ÑŒ: <span id="cu-level-inner">${levelText}</span></div>
              <div class="card-meta-row">XP: <span id="cu-xp-text-inner">${xpText}</span></div>
            </div>
          </div>`;

        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ð¿Ñ€Ð¾ÐºÐ°Ñ‡ÐºÐ¸ Ð² ÑÐµÐºÑ†Ð¸Ð¸ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹
        const cuLevel = document.getElementById('cu-level');
        const cuXpText = document.getElementById('cu-xp-text');
        const cuXpFill = document.getElementById('cu-xp-fill');
        if (cuLevel) cuLevel.textContent = levelText;
        if (cuXpText) cuXpText.textContent = xpText;
        if (cuXpFill) cuXpFill.style.width = `${Math.min(100, Math.round(((prog.xp || 0) / need) * 100))}%`;

        // ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ½Ð¾Ð¿Ð¾Ðº Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹
        const addBtn = document.getElementById('card-add-to-deck-btn');
        const removeBtn = document.getElementById('card-remove-btn');
        const upgradeBtn = document.getElementById('card-upgrade-btn');

        if (addBtn) {
          addBtn.onclick = (e) => {
            e.preventDefault();
            const profile = userProfile.getProfile();
            const res = userProfile.autoAddToDeck(profile, { id: cardData.id, level: prog.level || 1 });
            if (res.added || res.replaced) {
              userProfile.updateCurrentUser(profile);
              this.loadDeckCards();
              this.loadCollectionCards();
              alert('ÐšÐ°Ñ€Ñ‚Ð° Ð´Ð¾Ð´Ð°Ð½Ð° Ð² ÐºÐ¾Ð»Ð¾Ð´Ñƒ');
            } else {
              alert('ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ Ð´Ð¾Ð´Ð°Ñ‚Ð¸ ÐºÐ°Ñ€Ñ‚Ñƒ Ð² ÐºÐ¾Ð»Ð¾Ð´Ñƒ');
            }
          };
        }

        if (removeBtn) {
          removeBtn.onclick = (e) => {
            e.preventDefault();
            const profile = userProfile.getProfile();
            // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ°Ñ€Ñ‚Ñƒ Ð¸Ð· ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸ Ð¸/Ð¸Ð»Ð¸ Ð¸Ð· ÐºÐ¾Ð»Ð¾Ð´Ñ‹
            if (profile.collectionCards) {
              for (let i = profile.collectionCards.length - 1; i >= 0; i--) {
                if (profile.collectionCards[i].id === cardData.id) {
                  profile.collectionCards.splice(i, 1);
                  break;
                }
              }
            }
            if (profile.deckCards) {
              for (let i = profile.deckCards.length - 1; i >= 0; i--) {
                if (profile.deckCards[i].id === cardData.id) {
                  profile.deckCards.splice(i, 1);
                  break;
                }
              }
            }
            userProfile.updateCurrentUser(profile);
            this.loadDeckCards();
            this.loadCollectionCards();
            this.showPage('collections');
          };
        }

        // ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¿Ñ€Ð¾ÐºÐ°Ñ‡ÐºÐ¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð° â€” Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð´ÐµÐ»Ð°ÐµÐ¼
        try {
          const upgradeBtnEl = document.getElementById('card-upgrade-btn');
          if (upgradeBtnEl) {
            upgradeBtnEl.style.display = 'none';
            upgradeBtnEl.onclick = null;
          }
          const cuBtn = document.getElementById('cu-upgrade-btn');
          if (cuBtn) cuBtn.remove();
        } catch (err) {
          console.warn('upgrade button cleanup failed', err);
        }
      },

        // Ð ÐµÐ½Ð´ÐµÑ€ ÑÐ¿Ð¸ÑÐºÐ° ÑÐ»Ð°Ð±ÑˆÐ¸Ñ… ÐºÐ°Ñ€Ñ‚: Ð¿Ð»Ð¸Ñ‚ÐºÐ¸ Ñ Ð²Ð¸Ð·ÑƒÐ°Ð»Ð¾Ð¼ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ cardRenderer, ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½)
        renderWeakerCards(weakerCards, targetCardId, profile) {
          const list = document.getElementById('weaker-cards-list');
          if (!list) return;
          const targetCard = window.getCardById ? window.getCardById(targetCardId) : null;

          // Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ ÑÐµÑ‚ÐºÑƒ
          const tiles = weakerCards.map(c => {
            const card = (c && c.id && window.getCardById) ? window.getCardById(c.id) : c;
            if (!card) return '';

            // ÐŸÑ€Ð¾Ñ†ÐµÐ½Ñ‚Ð½Ñ‹Ð¹ Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÐµÐ»ÑŒ: ÑÐºÐ¾Ð»ÑŒÐºÐ¾ XP Ð´Ð°ÑÑ‚ ÑÐ¿Ð°Ð»ÐµÐ½Ð½Ñ ÑÑ‚Ð¾Ð¹ ÐºÐ°Ñ€Ñ‚Ñ‹ Ð¾Ñ‚Ð½Ð¾ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð½ÑƒÐ¶Ð½Ð¾Ð³Ð¾ XP Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ
            const progTarget = (profile && profile.progress && profile.progress[targetCardId]) ? profile.progress[targetCardId] : { level: 1, xp: 0 };
            const need = this.xpNeededForLevel(progTarget.level) || 100;
            const cardPower = card.basePower || card.power || 0;
            const xpGain = cardPower || 10;
            const pct = Math.max(0, Math.min(100, Math.round((xpGain / need) * 100)));

            // Ð ÐµÐ½Ð´ÐµÑ€ Ñ‡ÐµÑ€ÐµÐ· cardRenderer ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
            let cardHtml = '';
            if (window.cardRenderer && typeof window.cardRenderer.render === 'function') {
              cardHtml = window.cardRenderer.render({ ...card, power: cardPower });
            } else if (window.createCardView) {
              const el = window.createCardView(card);
              cardHtml = el ? el.outerHTML : '';
            } else {
              // fallback Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ð¸Ð·ÑƒÐ°Ð»
              cardHtml = `
                <div class="sp-card ${card.element || ''}">
                  <div class="corner-gear">${card.element || ''}</div>
                  <div class="power-plate"><div class="power-value">${cardPower}</div></div>
                  <div class="card-name">${card.name}</div>
                </div>`;
            }

            return `
              <div class="weaker-card-tile" data-card-id="${card.id}">
                <div class="weaker-card-visual">${cardHtml}</div>
                <div class="weaker-card-footer">
                  <div class="weaker-card-power">${cardPower}</div>
                  <div class="weaker-card-pct">+${pct}%</div>
                </div>
              </div>`;
          }).join('');

          list.innerHTML = `<div class="weaker-grid">${tiles}</div>`;

          // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ»Ð¸ÐºÐ° Ð½Ð° Ð¿Ð»Ð¸Ñ‚ÐºÑƒ: Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ð¶Ð¸Ð¼Ð°ÐµÑˆÑŒ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ñƒ â€” Ð¾Ð½Ð° ÑÐ³Ð¾Ñ€Ð°ÐµÑ‚
          list.querySelectorAll('.weaker-card-tile').forEach(tile => {
            tile.addEventListener('click', (e) => {
              const srcId = tile.dataset.cardId;
              if (!srcId) return;
              const result = this.burnCardForXP(profile, srcId, targetCardId);
              if (result && result.success) {
                // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¿Ð»Ð¸Ñ‚ÐºÑƒ Ð¸Ð· DOM
                tile.remove();
                userProfile.updateCurrentUser(profile);
                // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐºÐ¸
                this.loadCollectionCards();
                this.loadDeckCards();
                // ÐžÐ±Ð½Ð¾Ð²Ð¸Ð¼ Ð´ÐµÑ‚Ð°Ð»Ð¸ ÐµÑÐ»Ð¸ Ð¼Ñ‹ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ ÐºÐ°Ñ€Ñ‚ÐºÐ¸
                if (this.currentPage === 'card-details') {
                  this.renderCardDetails(window.getCardById(targetCardId), result.newLevel, result.newPower || 0, -1);
                  if (window.renderUpgradeBar) window.renderUpgradeBar(profile, targetCardId);
                }
                // Ð‘ÐµÐ· alert'Ð° â€” ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ° Ð¸ÑÑ‡ÐµÐ·Ð»Ð° Ð¸ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ Ð¾Ð±Ð½Ð¾Ð²Ð»Ñ‘Ð½
              } else {
                console.warn(result && result.error ? result.error : 'ÐÐµ Ð²Ð´Ð°Ð»Ð¾ÑÑ ÑÐ¿Ð°Ð»Ð¸Ñ‚Ð¸ ÐºÐ°Ñ€Ñ‚Ñƒ');
              }
            });
          });
        },

        // Ð¡Ð¶ÐµÑ‡ÑŒ ÐºÐ°Ñ€Ñ‚Ñƒ Ð¸Ð· ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸/Ñ–Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ Ñ€Ð°Ð´Ð¸ XP Ñ†ÐµÐ»ÐµÐ²Ð¾Ð¹ ÐºÐ°Ñ€Ñ‚Ñ‹ (Ð±ÐµÐ· Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ð¹)
        burnCardForXP(profile, sourceCardId, targetCardId) {
          if (!profile || !sourceCardId || !targetCardId) return { success: false, error: 'ÐÐµÐ²Ñ–Ñ€Ð½Ñ– Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¸' };

          // ÐÐ°Ð¹Ñ‚Ð¸ Ð¸ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¾Ð´Ð½Ñƒ ÐºÐ¾Ð¿Ð¸ÑŽ Ð¸Ð· collectionCards (Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ñ‡Ñ‚Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸Ð· ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸, Ð° Ð½Ðµ Ð¸Ð· ÐºÐ¾Ð»Ð¾Ð´Ñ‹)
          let removed = false;
          let removedFromInventory = false;
          if (Array.isArray(profile.collectionCards)) {
            for (let i = profile.collectionCards.length - 1; i >= 0; i--) {
              if (profile.collectionCards[i].id === sourceCardId) {
                profile.collectionCards.splice(i, 1);
                removed = true;
                break;
              }
            }
          }

          // Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾ Ð² ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸Ð· Ð¸Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€Ñ Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ (inventory ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº)
          if (!removed && profile.inventory && profile.inventory[sourceCardId] > 0) {
            profile.inventory[sourceCardId] = Math.max(0, profile.inventory[sourceCardId] - 1);
            removed = true;
            removedFromInventory = true;
          }

          if (!removed) return { success: false, error: 'ÐšÐ¾Ð¿Ñ–Ñ ÐºÐ°Ñ€Ñ‚Ð¸ Ð½Ðµ Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð´Ð»Ñ ÑÐ¿Ð°Ð»ÐµÐ½Ð½Ñ' };

          // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ XP-Ð³Ð¸Ð² (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐ¸Ð»Ñƒ ÐºÐ°Ñ€Ñ‚Ñ‹ ÐºÐ°Ðº Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ XP)
          const srcCard = window.getCardById ? window.getCardById(sourceCardId) : null;
          const tgtCard = window.getCardById ? window.getCardById(targetCardId) : null;
          const xpGain = srcCard ? (srcCard.basePower || srcCard.power || 10) : 10;

          // Ð£Ð±ÐµÐ´Ð¸Ð¼ÑÑ, Ñ‡Ñ‚Ð¾ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° progress ÐµÑÑ‚ÑŒ
          if (!profile.progress) profile.progress = {};
          if (!profile.progress[targetCardId]) profile.progress[targetCardId] = { level: 1, xp: 0 };

          // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ XP Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ (ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°), Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ñ€Ð°ÑÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð°
          if (window.addXp && window.getProgress) {
            window.addXp(profile, targetCardId, xpGain);
            const prog = window.getProgress(profile, targetCardId);
            var newLevel = prog.level || 1;
            var leveled = true; // Ð½ÐµÐ²Ð°Ð¶Ð½Ð¾ Ñ‚Ð¾Ñ‡Ð½Ð¾ Ñ‡Ð¸ÑÐ»Ð¾ â€” Ð¼Ñ‹ Ð²ÐµÑ€Ð½Ñ‘Ð¼ Ñ„Ð°ÐºÑ‚ ÑƒÑÐ¿ÐµÑ…Ð°
          } else {
            // fallback: Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° (ÑƒÑÑ‚Ð°Ñ€ÐµÐ²ÑˆÐ°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ°)
            profile.progress[targetCardId].xp = (profile.progress[targetCardId].xp || 0) + xpGain;
            let leveledLocal = false;
            let newLevelLocal = profile.progress[targetCardId].level || 1;
            while (profile.progress[targetCardId].xp >= this.xpNeededForLevel(newLevelLocal)) {
              profile.progress[targetCardId].xp -= this.xpNeededForLevel(newLevelLocal);
              newLevelLocal += 1;
              leveledLocal = true;
            }
            profile.progress[targetCardId].level = newLevelLocal;
            var newLevel = newLevelLocal;
            var leveled = leveledLocal;
          }

          // Ð•ÑÐ»Ð¸ ÐºÐ°Ñ€Ñ‚Ð° Ð±Ñ‹Ð»Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð° Ð¸Ð· ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸, Ð½Ðµ Ñ‚Ñ€Ð¾Ð³Ð°ÐµÐ¼ inventory; ÐµÑÐ»Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð° Ð¸Ð· inventory, ÑƒÐ¶Ðµ ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ¸Ð»Ð¸ Ð²Ñ‹ÑˆÐµ

          // Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð² Ð·Ð°Ð¿Ð¸ÑÐ¸ ÐºÐ¾Ð»Ð¾Ð´Ñ‹, ÐµÑÐ»Ð¸ ÐºÐ°Ñ€Ñ‚Ð° Ñ‚Ð°Ð¼ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚
          if (Array.isArray(profile.deckCards)) {
            for (let i = 0; i < profile.deckCards.length; i++) {
              if (profile.deckCards[i] && profile.deckCards[i].id === targetCardId) {
                profile.deckCards[i].level = newLevel;
                break;
              }
            }
          }

          // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÑŽÑ‰ÐµÐ¹ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð¾Ð¹
          const newPower = tgtCard ? (window.getPower ? window.getPower(tgtCard, newLevel) : (tgtCard.basePower || 0)) : null;

          return { success: true, leveled, newLevel, newPower };
        },

      // ========== DUELS (MVP) ==========
      
      // ========== DUELS (MVP) ========== 
      updatePlayerMultiplierPreview() {
        if (!window.CURRENT_DUEL) return;
        const duel = window.CURRENT_DUEL;
        const container = document.getElementById('duelMultipliers');
        if (!container) return;
        
        container.innerHTML = '';
        
        // Create 3 multiplier badges for 3 slots
        for (let i = 0; i < 3; i++) {
          const pCard = duel.player.hand[i];
          const eCard = duel.enemy.hand[i];
          
          if (!pCard || !eCard) {
            container.innerHTML += '<div class="mult-badge" style="opacity:0.3"><span class="mult-text">â€”</span></div>';
            continue;
          }
          
          const mult = (window.MULT[pCard.element]?.[eCard.element]) ?? 1;
          const multClass = mult > 1 ? 'mult-good' : mult < 1 ? 'mult-bad' : 'mult-neutral';
          const multText = mult === 1 ? 'Ã— 1' : `Ã— ${mult.toFixed(1)}`;
          
          container.innerHTML += `
            <div class="mult-badge ${multClass}">
              <span class="swords"></span>
              <span class="mult-text">${multText}</span>
            </div>
          `;
        }
      },
      
      initDuelsPage() {
        const btn = document.getElementById('duel-start-btn');
        if (btn) {
          // Ð¡ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ñ€ÑƒÑ‡Ð½ÑƒÑŽ ÐºÐ½Ð¾Ð¿ÐºÑƒ â€” Ð¿Ð¾Ð¸ÑÐº Ð±ÑƒÐ´ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼
          btn.style.display = 'none';
        }
        // Clear UI and show searching state
        const enemyHpEl = document.getElementById('enemyHp');
        const playerHpEl = document.getElementById('playerHp');
        const enemyHandEl = document.getElementById('enemyHand');
        const playerHandEl = document.getElementById('playerHand');
        const duelLogEl = document.getElementById('duelLog');
        // update both legacy text nodes and new HUD elements
        if (enemyHpEl) enemyHpEl.textContent = '0/0';
        if (playerHpEl) playerHpEl.textContent = '0/0';
        const enemyHpText = document.getElementById('enemyHpText');
        const playerHpText = document.getElementById('playerHpText');
        const enemyHpBar = document.getElementById('enemyHpBar');
        const playerHpBar = document.getElementById('playerHpBar');
        if (enemyHpText) enemyHpText.textContent = '0/0';
        if (playerHpText) playerHpText.textContent = '0/0';
        if (enemyHpBar) enemyHpBar.style.width = '0%';
        if (playerHpBar) playerHpBar.style.width = '0%';
        if (enemyHandEl) enemyHandEl.innerHTML = '';
        if (playerHandEl) playerHandEl.innerHTML = '';
        if (duelLogEl) duelLogEl.innerHTML = 'ÐŸÐ¾ÑˆÑƒÐº Ð²Ð¾Ñ€Ð¾Ð³Ð°...';

        // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð¿Ð¾Ñ‡Ð¸Ð½Ð°Ñ”Ð¼Ð¾ Ð¿Ð¾ÑˆÑƒÐº/Ð·Ð°Ð¿ÑƒÑÐº Ð´ÑƒÐµÐ»Ñ–
        setTimeout(() => this.startRandomDuel(), 250);
      },

      buildDuelDeckFromProfile(profile) {
        // Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ð¼Ð¾ level Ð· progress Ð´Ð»Ñ Ñ€Ð¾Ð·Ñ€Ð°Ñ…ÑƒÐ½ÐºÑƒ ÑÐ¸Ð»Ð¸ Ð² Ð´ÑƒÐµÐ»Ñ–
        return profile.deckCards.map(dc => {
          const card = getCardById(dc.id);
          const prog = window.getProgress ? window.getProgress(profile, dc.id) : { level: 1, xp: 0 };
          const cardLevel = prog.level;
          const power = window.getPower ? window.getPower(card, cardLevel) : Math.round(card.basePower * Math.pow(card.upgradeMult, cardLevel - 1));
          return { id: card.id, element: card.element, power };
        });
      },

      calcDeckPower(deck) {
        return deck.reduce((s, c) => s + (c.power || 0), 0);
      },

      // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð»Ð¾Ð´Ñ‹ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð½Ð¸ÐºÐ°: Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¿Ñ€Ð¸Ð±Ð»Ð¸Ð·Ð¸Ñ‚ÑŒÑÑ Ðº ÑÑƒÐ¼Ð¼Ð°Ñ€Ð½Ð¾Ð¹ ÑÐ¸Ð»Ðµ Ð¸Ð³Ñ€Ð¾ÐºÐ° Â±100
      generateAdaptiveEnemyDeck(playerDeck9, profile) {
        const calcPower = (card, level = 1) => {
          if (window.getPower) return window.getPower(card, level);
          return card.attack || card.basePower || 0;
        };

        // Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ ÑÑƒÐ¼Ð¼Ð°Ñ€Ð½ÑƒÑŽ ÑÐ¸Ð»Ñƒ Ð¸Ð³Ñ€Ð¾ÐºÐ°, Ð¾Ð¿Ð¸Ñ€Ð°ÑÑÑŒ Ð½Ð° Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑ, ÐµÑÐ»Ð¸ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
        let playerTotal = 0;
        try {
          if (profile && profile.deckCards && profile.deckCards.length) {
            profile.deckCards.forEach(dc => {
              const src = (window.ALL_CARDS || []).find(x => x.id === dc.id) || null;
              const prog = window.getProgress ? window.getProgress(profile, dc.id) : { level: dc.level || 1 };
              const lvl = (prog && prog.level) ? prog.level : (dc.level || 1);
              if (src) playerTotal += calcPower(src, lvl) || 0;
            });
          } else {
            playerTotal = playerDeck9.reduce((s, c) => s + (calcPower(c, 1) || 0), 0);
          }
        } catch (err) {
          playerTotal = playerDeck9.reduce((s, c) => s + (calcPower(c, 1) || 0), 0);
        }

        const offset = Math.floor(Math.random() * 201) - 100; // -100..+100
        const targetTotal = Math.max(0, playerTotal + offset);

        // pool: ÐµÑÐ»Ð¸ Ð¼Ð°Ð»Ð¾ ÐºÐ°Ñ€Ñ‚ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ALL_CARDS
        const allCards = window.ALL_CARDS || window.CARDS_COMMON || [];
        let pool = allCards.slice().filter(c => !(String(c.id).startsWith('S')));
        if (pool.length < 9) pool = allCards.slice();

        const cardPower = c => calcPower(c, 1) || 0;

        // Greedy selection
        const selected = [];
        let currentSum = 0;
        for (let slot = 0; slot < 9; slot++) {
          let bestIdx = -1;
          let bestDelta = Infinity;
          for (let i = 0; i < pool.length; i++) {
            const p = cardPower(pool[i]);
            const newSum = currentSum + p;
            const delta = Math.abs(newSum - targetTotal);
            if (delta < bestDelta) { bestDelta = delta; bestIdx = i; }
          }
          if (bestIdx === -1) break;
          const pick = pool.splice(bestIdx, 1)[0];
          selected.push(pick);
          currentSum += cardPower(pick);
        }

        // Fill if not enough
        if (selected.length < 9) {
          const extras = (allCards.concat(selected)).slice(0, 9 - selected.length);
          selected.push(...extras);
        }

        // Level-up selected cards to approach targetTotal
        const enriched = selected.map(c => ({ src: c, level: 1, power: cardPower(c) }));
        let selectedSum = enriched.reduce((s, e) => s + e.power, 0);
        let attempts = 0;
        const maxAttempts = 500;
        while (selectedSum < targetTotal && attempts < maxAttempts) {
          let bestIdx = -1;
          let bestGain = 0;
          for (let i = 0; i < enriched.length; i++) {
            const e = enriched[i];
            const nextLevel = Math.min((e.level || 1) + 1, 20);
            const nextPower = calcPower(e.src, nextLevel) || e.power;
            const gain = nextPower - e.power;
            if (gain > bestGain) { bestGain = gain; bestIdx = i; }
          }
          if (bestIdx === -1 || bestGain <= 0) break;
          enriched[bestIdx].level = Math.min((enriched[bestIdx].level || 1) + 1, 20);
          enriched[bestIdx].power = calcPower(enriched[bestIdx].src, enriched[bestIdx].level) || enriched[bestIdx].power;
          selectedSum = enriched.reduce((s, e) => s + e.power, 0);
          attempts++;
        }

        // Map to lightweight enemy objects compatible with legacy duel
        const enemyDeck9 = enriched.map(e => ({ id: e.src.id, element: e.src.element, power: Math.max(1, Math.round(e.power || 1)) }));
        return enemyDeck9;
      },

      xpNeededForLevel(level) {
        const L = Math.max(1, Number(level) || 1);
        const BASE = 200;    // XP Ð´Ð»Ñ Ñ€Ñ–Ð²Ð½Ñ 1â†’2
        const GROWTH = 1.12; // Ñ‚ÐµÐ¼Ð¿ Ñ€Ð¾ÑÑ‚Ñƒ (1.08..1.18 Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð¾Ð²Ð°Ð½Ð¾)
        return Math.round(BASE * Math.pow(GROWTH, L - 1));
      },

      pendingDuel: null,

      createCardNode(card, isPlayer, slotIdx) {
        const elementIcons = {
          fire: '<div class="element-emoji fire-emoji">ðŸ”¥</div>',
          water: '<div class="element-emoji water-emoji">ðŸ’§</div>',
          air: '<div class="element-emoji air-emoji">ðŸ’¨</div>',
          earth: '<div class="element-emoji earth-emoji">ðŸƒ</div>'
        };
        const elementIcon = elementIcons[card.element] || elementIcons.fire;
        const el = document.createElement('div');
        el.className = `sp-card ${card.element} common`;
        if (slotIdx !== undefined) el.dataset.slot = slotIdx;
        
        el.innerHTML = `
          <div class="corner-gear">
            ${elementIcon}
          </div>
          <div class="power-plate"><div class="power-value">${card.power}</div></div>
        `;
        return el;
      },

      startRandomDuel() {
        const profile = userProfile.getProfile();
        if (!profile || !profile.deckCards || profile.deckCards.length < 9) {
          alert('ÐšÐ¾Ð»Ð¾Ð´Ð° Ð½ÐµÐ¿Ð¾Ð²Ð½Ð°. ÐŸÐ¾Ñ‚Ñ€Ñ–Ð±Ð½Ð¾ 9 ÐºÐ°Ñ€Ñ‚.');
          return;
        }
        const playerDeck9 = this.buildDuelDeckFromProfile(profile);
        const playerPower = this.calcDeckPower(playerDeck9);

        // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð»Ð¾Ð´Ñƒ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð½Ð¸ÐºÐ° Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð½Ð¾Ð²Ð¾Ð¹ Ð»Ð¾Ð³Ð¸ÐºÐ¸ (Ð¿Ñ€Ð¸Ð±Ð»Ð¸Ð¶ÐµÐ½Ð½Ð¾ Ðº playerPower Â±100)
        const enemyDeck9 = this.generateAdaptiveEnemyDeck(playerDeck9, profile);
        let enemyPower = this.calcDeckPower(enemyDeck9);

        // Ð—Ð±ÐµÑ€Ñ–Ð³Ð°Ñ”Ð¼Ð¾ pending
        this.pendingDuel = { playerDeck9, enemyDeck9, playerPower, enemyPower };
        // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¸Ð¹ Ð¿Ð¾ÑˆÑƒÐº/Ð¿Ð¾Ñ‡Ð°Ñ‚Ð¾Ðº Ð±Ð¾ÑŽ â€” Ð¼Ñ–Ð½Ñ–-Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚ Ð´Ð»Ñ Ð²Ñ–Ð´Ñ‡ÑƒÑ‚Ñ‚Ñ Ð¿Ð¾ÑˆÑƒÐºÑƒ
        const logEl = document.getElementById('duelLog');
        if (logEl) logEl.textContent = 'ÐŸÑ€Ð¾Ñ‚Ð¸Ð²Ð½Ð¸Ðº Ð·Ð½Ð°Ð¹Ð´ÐµÐ½Ð¸Ð¹ â€” Ð³Ð¾Ñ‚ÑƒÑ”Ð¼Ð¾ÑÑŒ...';
        setTimeout(() => {
          window.CURRENT_DUEL = window.createDuel(this.pendingDuel.playerDeck9, this.pendingDuel.enemyDeck9);
          this.renderDuel();
        }, 700);
      },

      showPreDuelDialog() {
        const modal = document.getElementById('duel-pre-modal');
        if (!modal || !this.pendingDuel) return;
        const profile = userProfile.getProfile();
        const enemyNameEl = document.getElementById('duel-pre-name');
        const enemyPowerEl = document.getElementById('duel-pre-power');
        const playerPowerEl = document.getElementById('duel-pre-player-power');

        // Ð“ÐµÐ½ÐµÑ€ÑƒÑ”Ð¼Ð¾ Ñ–Ð¼'Ñ Ð²Ð¾Ñ€Ð¾Ð³Ð°
        const names = ['Lucky Harry','Steam Witch','Rust Baron','Copper Shade','Gearmancer','Brass Vex','Coal Phantom'];
        const picked = names[Math.floor(Math.random()*names.length)];
        this.pendingDuel.enemyName = picked;

        if (enemyNameEl) enemyNameEl.textContent = picked;
        if (enemyPowerEl) enemyPowerEl.textContent = this.pendingDuel.enemyPower;
        if (playerPowerEl) playerPowerEl.textContent = this.pendingDuel.playerPower;

        modal.classList.add('active');

        const attackBtn = document.getElementById('duel-pre-attack');
        const rerollBtn = document.getElementById('duel-pre-reroll');
        if (attackBtn) {
          attackBtn.onclick = () => {
            modal.classList.remove('active');
            window.CURRENT_DUEL = window.createDuel(this.pendingDuel.playerDeck9, this.pendingDuel.enemyDeck9);
            this.renderDuel();
          };
        }
        if (rerollBtn) {
          rerollBtn.onclick = () => {
            modal.classList.remove('active');
            this.startRandomDuel();
          };
        }
      },

      renderDuel() {
        const duel = window.CURRENT_DUEL;
        if (!duel) return;

        // Update legacy text nodes if present
        const legacyEnemyHp = document.getElementById('enemyHp');
        const legacyPlayerHp = document.getElementById('playerHp');
        if (legacyEnemyHp) legacyEnemyHp.textContent = `${duel.enemy.hp}/${duel.enemy.maxHp}`;
        if (legacyPlayerHp) legacyPlayerHp.textContent = `${duel.player.hp}/${duel.player.maxHp}`;

        // Update new HUD bars and labels
        const enemyHpText = document.getElementById('enemyHpText');
        const playerHpText = document.getElementById('playerHpText');
        const enemyHpBar = document.getElementById('enemyHpBar');
        const playerHpBar = document.getElementById('playerHpBar');
        if (enemyHpText) enemyHpText.textContent = `${duel.enemy.hp}/${duel.enemy.maxHp}`;
        if (playerHpText) playerHpText.textContent = `${duel.player.hp}/${duel.player.maxHp}`;
        if (enemyHpBar) {
          const pct = Math.max(0, Math.min(100, Math.round((duel.enemy.hp / Math.max(1, duel.enemy.maxHp)) * 100)));
          enemyHpBar.style.width = pct + '%';
        }
        if (playerHpBar) {
          const pctP = Math.max(0, Math.min(100, Math.round((duel.player.hp / Math.max(1, duel.player.maxHp)) * 100)));
          playerHpBar.style.width = pctP + '%';
        }

        const enemyPowerEl = document.getElementById('enemyPower');
        const playerPowerEl = document.getElementById('playerPower');
        if (enemyPowerEl) enemyPowerEl.textContent = duel.enemy.maxHp;
        if (playerPowerEl) playerPowerEl.textContent = duel.player.maxHp;

        const enemyHandEl  = document.getElementById('enemyHand');
        const playerHandEl = document.getElementById('playerHand');
        enemyHandEl.innerHTML = '';
        playerHandEl.innerHTML = '';

        // Render enemy hand (no interactions)
        duel.enemy.hand.forEach((c, idx) => {
          const node = this.createCardNode(c, false, idx);
          enemyHandEl.appendChild(node);
        });

        // Render player hand (click to play)
        duel.player.hand.forEach((c, idx) => {
          const node = this.createCardNode(c, true, idx);
          node.addEventListener('click', () => {
            if (duel.finished) return;
            window.CURRENT_DUEL = window.playTurn(duel, idx);
            this.renderDuel();
            if (window.CURRENT_DUEL.finished) {
              this.showDuelResult(window.CURRENT_DUEL);
            }
          });
          playerHandEl.appendChild(node);
        });

        const logEl = document.getElementById('duelLog');
        logEl.innerHTML = duel.log.map(r => `Ð¥Ñ–Ð´ ${r.turn}: Ð’Ð¸(${r.player.element}) ${r.player.dmg} Ã—${r.player.mult} â†” Ð’Ð¾Ñ€Ð¾Ð³(${r.enemy.element}) ${r.enemy.dmg} Ã—${r.enemy.mult}`).join('<br>');
        
        this.updatePlayerMultiplierPreview();
      },

      showDuelResult(duel) {
        const profile = userProfile.getProfile();
        if (!profile) return;

        const modal = document.getElementById('duel-result-modal');
        const titleEl = document.getElementById('duel-result-title');
        const subtitleEl = document.getElementById('duel-result-subtitle');
        const rewardsEl = document.getElementById('duel-result-rewards');
        const winsInfoEl = document.getElementById('duel-wins-info');
        const summaryHpEl = document.getElementById('duel-summary-player-hp');
        const battleCardsEl = document.getElementById('duel-battle-cards');

        if (!modal) return;

        // Ð’Ð¸Ð·Ð½Ð°Ñ‡Ð¸Ñ‚Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð·Ð° HP (ÑÐºÑ‰Ð¾ HP Ð³Ñ€Ð°Ð²Ñ†Ñ 0 - Ð¿Ð¾Ñ€Ð°Ð·ÐºÐ°, ÑÐºÑ‰Ð¾ Ð²Ð¾Ñ€Ð¾Ð³Ð° 0 - Ð¿ÐµÑ€ÐµÐ¼Ð¾Ð³Ð°)
        let result = duel.result;
        if (duel.player.hp === 0 && duel.enemy.hp > 0) {
          result = 'lose';
        } else if (duel.enemy.hp === 0 && duel.player.hp > 0) {
          result = 'win';
        }

        let xpGain = 0;
        let boltsGain = 0;

        // Helper: exponential bolts reward based on player level
        const boltsReward = (base, growth, level) => {
          const L = Math.max(1, Number(level) || 1);
          return Math.round(base * Math.pow(growth, L - 1));
        };
        let dropInfo = '';

        if (result === 'win') {
          titleEl.textContent = 'ðŸ† ÐŸÐ•Ð Ð•ÐœÐžÐ“Ð';
          xpGain = Math.round(80 * Math.pow(1.08, (profile.level||1)-1));
          boltsGain = boltsReward(55, 1.12, profile.level);
          profile.wins = (profile.wins || 0) + 1;
          // Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð´Ñ€Ð¾Ð¿Ð° ÐºÐ°Ñ€Ñ‚ Ð· ÑƒÑ€Ð°Ñ…ÑƒÐ²Ð°Ð½Ð½ÑÐ¼ Ñ€Ñ–Ð´ÐºÐ¾ÑÑ‚Ñ–
          if (window.dropSystem && window.dropSystem.shouldDrop('win')) {
            // Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ pity Ð»Ñ–Ñ‡Ð¸Ð»ÑŒÐ½Ð¸ÐºÑ–Ð²
            profile.pityCounters = profile.pityCounters || { noLegendary: 0, noMythic: 0 };
            
            const allCards = window.ALL_CARDS || [];
            const starterCards = window.STARTER_CARDS || [];
            
            const dropResult = window.dropSystem.dropCard(
              profile,
              allCards,
              starterCards,
              profile.pityCounters
            );
            
            if (dropResult.card) {
              const card = dropResult.card;
              
              // ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ pity Ð»Ñ–Ñ‡Ð¸Ð»ÑŒÐ½Ð¸ÐºÐ¸
              profile.pityCounters = dropResult.pityCounters;
              
              // Ð”Ð¾Ð´Ð°Ñ‚Ð¸ ÐºÐ°Ñ€Ñ‚Ñƒ Ð² ÐºÐ¾Ð»ÐµÐºÑ†Ñ–ÑŽ
              profile.collectionCards = profile.collectionCards || [];
              const newEntry = { id: card.id, level: 1 };
              profile.collectionCards.push(newEntry);
              userProfile.autoAddToDeck(profile, newEntry);

              // ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ Ñ–Ð½Ð²ÐµÐ½Ñ‚Ð°Ñ€
              profile.inventory = profile.inventory || {};
              profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;
              
              // ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚Ð¸ Ñ–Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–ÑŽ Ð¿Ñ€Ð¾ Ð´Ñ€Ð¾Ð¿
              const rarityNames = { R1: 'Ð·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð°', R2: 'Ð½ÐµÐ·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð°', R3: 'Ñ€Ñ–Ð´ÐºÑ–ÑÐ½Ð°', R4: 'ÐµÐ¿Ñ–Ñ‡Ð½Ð°', R5: 'Ð»ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð°', R6: 'Ð¼Ñ–Ñ„Ñ–Ñ‡Ð½Ð°' };
              const rarityName = rarityNames[card.rarity] || card.rarity;
              const sourceInfo = dropResult.fromStarterPool ? ' (ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð²Ð°)' : '';
              dropInfo = ` + ${rarityName} ÐºÐ°Ñ€Ñ‚Ð° ${card.id}${sourceInfo}`;
            }
          }
        } else if (result === 'lose') {
          titleEl.textContent = 'ðŸ’€ ÐŸÐžÐ ÐÐ—ÐšÐ';
          xpGain = Math.round(30 * Math.pow(1.05, (profile.level||1)-1));
          boltsGain = boltsReward(12, 1.08, profile.level);
          profile.losses = (profile.losses || 0) + 1;
          
          // ÐœÐµÐ½ÑˆÐ¸Ð¹ ÑˆÐ°Ð½Ñ Ð´Ñ€Ð¾Ð¿Ð° Ð¿Ñ€Ð¸ Ð¿Ð¾Ñ€Ð°Ð·Ñ†Ñ– (10%)
          if (window.dropSystem && window.dropSystem.shouldDrop('lose')) {
            profile.pityCounters = profile.pityCounters || { noLegendary: 0, noMythic: 0 };
            
            const allCards = window.ALL_CARDS || [];
            const starterCards = window.STARTER_CARDS || [];
            
            const dropResult = window.dropSystem.dropCard(
              profile,
              allCards,
              starterCards,
              profile.pityCounters
            );
            
            if (dropResult.card) {
              const card = dropResult.card;
              profile.pityCounters = dropResult.pityCounters;
              
              profile.collectionCards = profile.collectionCards || [];
              const newEntry = { id: card.id, level: 1 };
              profile.collectionCards.push(newEntry);
              userProfile.autoAddToDeck(profile, newEntry);

              profile.inventory = profile.inventory || {};
              profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;
              
              const rarityNames = { R1: 'Ð·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð°', R2: 'Ð½ÐµÐ·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð°', R3: 'Ñ€Ñ–Ð´ÐºÑ–ÑÐ½Ð°', R4: 'ÐµÐ¿Ñ–Ñ‡Ð½Ð°', R5: 'Ð»ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð°', R6: 'Ð¼Ñ–Ñ„Ñ–Ñ‡Ð½Ð°' };
              const rarityName = rarityNames[card.rarity] || card.rarity;
              const sourceInfo = dropResult.fromStarterPool ? ' (ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð²Ð°)' : '';
              dropInfo = ` + ${rarityName} ÐºÐ°Ñ€Ñ‚Ð° ${card.id}${sourceInfo}`;
            }
          }
        } else {
          titleEl.textContent = 'âš–ï¸ ÐÐ†Ð§Ð˜Ð¯';
          xpGain = Math.round(45 * Math.pow(1.06, (profile.level||1)-1));
          boltsGain = boltsReward(28, 1.10, profile.level);
          
          // Ð¡ÐµÑ€ÐµÐ´Ð½Ñ–Ð¹ ÑˆÐ°Ð½Ñ Ð´Ñ€Ð¾Ð¿Ð° Ð¿Ñ€Ð¸ Ð½Ñ–Ñ‡Ð¸Ñ— (20%)
          if (window.dropSystem && window.dropSystem.shouldDrop('draw')) {
            profile.pityCounters = profile.pityCounters || { noLegendary: 0, noMythic: 0 };
            
            const allCards = window.ALL_CARDS || [];
            const starterCards = window.STARTER_CARDS || [];
            
            const dropResult = window.dropSystem.dropCard(
              profile,
              allCards,
              starterCards,
              profile.pityCounters
            );
            
            if (dropResult.card) {
              const card = dropResult.card;
              profile.pityCounters = dropResult.pityCounters;
              
              profile.collectionCards = profile.collectionCards || [];
              const newEntry = { id: card.id, level: 1 };
              profile.collectionCards.push(newEntry);
              userProfile.autoAddToDeck(profile, newEntry);

              profile.inventory = profile.inventory || {};
              profile.inventory[card.id] = (profile.inventory[card.id] || 0) + 1;
              
              const rarityNames = { R1: 'Ð·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð°', R2: 'Ð½ÐµÐ·Ð²Ð¸Ñ‡Ð°Ð¹Ð½Ð°', R3: 'Ñ€Ñ–Ð´ÐºÑ–ÑÐ½Ð°', R4: 'ÐµÐ¿Ñ–Ñ‡Ð½Ð°', R5: 'Ð»ÐµÐ³ÐµÐ½Ð´Ð°Ñ€Ð½Ð°', R6: 'Ð¼Ñ–Ñ„Ñ–Ñ‡Ð½Ð°' };
              const rarityName = rarityNames[card.rarity] || card.rarity;
              const sourceInfo = dropResult.fromStarterPool ? ' (ÑÑ‚Ð°Ñ€Ñ‚Ð¾Ð²Ð°)' : '';
              dropInfo = ` + ${rarityName} ÐºÐ°Ñ€Ñ‚Ð° ${card.id}${sourceInfo}`;
            }
          }
        }

        subtitleEl.textContent = 'Ð’Ð¸ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð»Ð¸:';

        // ÐžÐ½Ð¾Ð²Ð¸Ñ‚Ð¸ Ð¿Ñ€Ð¾Ñ„Ñ–Ð»ÑŒ
        profile.xp = (profile.xp || 0) + xpGain;
        // Ensure level is numeric to avoid string/undefined edge cases
        profile.level = Number(profile.level) || 1;
        profile.bolts = (profile.bolts || 0) + boltsGain;
        profile.gamesPlayed = (profile.gamesPlayed || 0) + 1;

        // ÐŸÐµÑ€ÐµÐ²Ñ–Ñ€Ð¸Ñ‚Ð¸ Ñ€Ñ–Ð²ÐµÐ½ÑŒ (ÑˆÐµÑÑ‚ÐµÑ€Ð½Ñ– Ð½Ð°Ñ€Ð°Ñ…Ð¾Ð²ÑƒÑŽÑ‚ÑŒÑÑ Ð»Ð¸ÑˆÐµ Ð¿Ñ€Ð¸ Ð¿Ñ–Ð´Ð²Ð¸Ñ‰ÐµÐ½Ð½Ñ– Ñ€Ñ–Ð²Ð½Ñ)
        let leveled = 0;
        let gearsGained = 0;
        // Diagnostic: log initial values to help debug failed level-ups
        try {
          const needInitial = this.xpNeededForLevel(profile.level || 1);
          console.debug('Level check start:', { level: profile.level, xp: profile.xp, needInitial });
        } catch (e) {
          console.warn('xpNeededForLevel threw', e);
        }

        while (profile.xp >= this.xpNeededForLevel(profile.level || 1)) {
          const need = this.xpNeededForLevel(profile.level || 1);
          console.debug('Leveling: before subtract', { level: profile.level, xp: profile.xp, need });
          profile.xp -= need;
          // Ð—Ð±Ñ–Ð»ÑŒÑˆÑƒÑ”Ð¼Ð¾ Ñ€Ñ–Ð²ÐµÐ½ÑŒ
          profile.level = Number(profile.level) + 1;
          console.info('Leveled up to', profile.level);
          // ÐÐ°Ñ€Ð°Ñ…Ð¾Ð²ÑƒÑ”Ð¼Ð¾ ÑˆÐµÑÑ‚ÐµÑ€Ð½Ñ– Ð·Ð° Ñ†ÐµÐ¹ Ñ€Ñ–Ð²ÐµÐ½ÑŒ (Ð»Ð¾Ð³Ñ–ÐºÐ°: Ð´Ð¾Ð´Ð°Ñ”Ð¼Ð¾ ÐºÑ–Ð»ÑŒÐºÑ–ÑÑ‚ÑŒ ÑˆÐµÑÑ‚ÐµÑ€ÐµÐ½ÑŒ Ñ€Ñ–Ð²Ð½Ñ)
          const gearForThisLevel = profile.level;
          profile.gears = (profile.gears || 0) + gearForThisLevel;
          gearsGained += gearForThisLevel;
          leveled += 1;
        }

        userProfile.updateCurrentUser(profile);
        userProfile.updateUI();

        // ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚Ð¸ Ð»Ð¸ÑˆÐµ Ñ‚Ðµ, Ñ‰Ð¾ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾ Ñƒ Ð±Ð¾ÑŽ: XP, Ð±Ð¾Ð»Ñ‚Ð¸, Ð´Ñ€Ð¾Ð¿, Ñ‚Ð° ÑˆÐµÑÑ‚ÐµÑ€Ð½Ñ– (ÑÐºÑ‰Ð¾ Ð±ÑƒÐ»Ð¸ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ñ– Ñ‡ÐµÑ€ÐµÐ· Ñ€Ñ–Ð²ÐµÐ½ÑŒ)
        const parts = [];
        if (xpGain > 0) parts.push(`XP: +${this.formatCompact ? this.formatCompact(xpGain) : xpGain}`);
        if (boltsGain > 0) parts.push(`ðŸ”© +${this.formatCompact ? this.formatCompact(boltsGain) : boltsGain}`);
        if (gearsGained > 0) parts.push(`âš™ï¸ +${gearsGained}`);
        if (dropInfo) parts.push(dropInfo.trim());
        rewardsEl.textContent = parts.join('  â€¢  ') || 'ÐÑ–Ñ‡Ð¾Ð³Ð¾ Ð½Ðµ Ð¾Ñ‚Ñ€Ð¸Ð¼Ð°Ð½Ð¾';
        winsInfoEl.textContent = `ÐŸÐ¾Ð±Ñ–Ð´ Ð² Ð´ÑƒÐµÐ»ÑÑ…: ðŸ† ${profile.wins || 0}`;
        summaryHpEl.textContent = duel.player.hp;

        // ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚Ð¸ Ð¿Ñ–Ð´ÑÑƒÐ¼ÐºÐ¸ Ð±Ð¾ÑŽ Ð· ÐºÐ°Ñ€Ñ‚Ð°Ð¼Ð¸
        const elementEmojis = {
          fire: 'ðŸ”¥',
          water: 'ðŸ’§',
          air: 'ðŸ’¨',
          earth: 'ðŸƒ'
        };

        battleCardsEl.innerHTML = duel.log.map(log => {
          const pEmoji = elementEmojis[log.player.element] || elementEmojis.fire;
          const eEmoji = elementEmojis[log.enemy.element] || elementEmojis.fire;
          return `
            <div class="duel-battle-card-row">
              <div class="duel-battle-card-player">
                <div class="duel-battle-card-icon" style="--elem: var(--${log.player.element})">
                  <span class="element-emoji">${pEmoji}</span>
                </div>
                <span class="duel-battle-card-dmg">${log.player.dmg}</span>
              </div>
              <span class="duel-battle-vs">âš”</span>
              <div class="duel-battle-card-enemy">
                <span class="duel-battle-card-dmg">${log.enemy.dmg}</span>
                <div class="duel-battle-card-icon" style="--elem: var(--${log.enemy.element})">
                  <span class="element-emoji">${eEmoji}</span>
                </div>
              </div>
            </div>
          `;
        }).join('');

        modal.classList.add('active');
      },

      closeDuelResult() {
        const modal = document.getElementById('duel-result-modal');
        if (modal) {
          modal.classList.remove('active');
          // ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ð¸ Ð´ÑƒÐµÐ»ÑŒ
          this.startRandomDuel();
        }
      }
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // ÐœÐµÐ½ÑŽ "Ð¡ÑƒÐ¼ÐºÐ°"
      document.getElementById('menu-bag-btn')?.addEventListener('click', () => navigation.showPage('bag'));
      document.getElementById('bag-back-btn')?.addEventListener('click', () => navigation.showPage('home'));
      // Initialize auth UI
      authUI.init();
      
      // Update UI with profile data if logged in
      if (userProfile.isLoggedIn()) {
        userProfile.updateUI();
        console.log('User profile loaded:', userProfile.getCurrentUser());
      }
      
      // Navigation handlers for tiles
      document.querySelectorAll('[data-page]').forEach(element => {
        element.addEventListener('click', (e) => {
          e.preventDefault();
          const pageId = element.dataset.page;
          navigation.showPage(pageId);
        });
      });
      
      // Bottom nav handlers
      const navButtons = {
        'nav-home': 'home',
        'nav-profile': 'profile',
        'nav-guild': 'guild'
      };
      
      document.querySelectorAll('.navbtn').forEach(btn => {
        btn.addEventListener('click', () => {
          // Update active state
          document.querySelectorAll('.navbtn').forEach(x => x.classList.remove('active'));
          btn.classList.add('active');
          
          // Navigate to page
          const pageId = navButtons[btn.id];
          if (pageId) {
            navigation.showPage(pageId);
          }
        });
      });
      
      // Logout button handler
      document.querySelector('.logout-btn')?.addEventListener('click', () => {
        if (confirm('Ð’Ð¸ Ð²Ð¿ÐµÐ²Ð½ÐµÐ½Ñ–, Ñ‰Ð¾ Ñ…Ð¾Ñ‡ÐµÑ‚Ðµ Ð²Ð¸Ð¹Ñ‚Ð¸?')) {
          userProfile.logout();
          location.reload();
        }
      });
      
      // Shop tab handlers
      document.querySelectorAll('.shop-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          // Update active tab
          document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          
          // Show corresponding content
          const tabId = this.dataset.tab;
          document.querySelectorAll('.shop-tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(`shop-tab-${tabId}`)?.classList.add('active');
        });
      });

      // Card filter handlers
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          // Update active state
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Load filtered cards
          const element = this.dataset.element;
          navigation.currentCardFilter = element;
          navigation.loadShopCards(element);
        });
      });

      // Pack modal close handler
      document.getElementById('pack-modal-close')?.addEventListener('click', () => {
        navigation.closePackModal();
      });

      

      // Click outside modal to close
      document.getElementById('pack-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'pack-modal') {
          navigation.closePackModal();
        }
      });

      // Duel result modal close handler
      document.getElementById('duel-result-close')?.addEventListener('click', () => {
        navigation.closeDuelResult();
      });

      // Click outside duel modal to close
      document.getElementById('duel-result-modal')?.addEventListener('click', (e) => {
        if (e.target.id === 'duel-result-modal') {
          navigation.closeDuelResult();
        }
      });
    });

    // Accordion (removed since we're using page navigation now)

    // Tiles (removed since we're using page navigation now)

  </script>
</body>
</html>
